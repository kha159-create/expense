<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ</title>
  
  <!-- Meta tags for "Add to Home Screen" -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ">
  <meta name="theme-color" content="#764ba2">
  
  <!-- Favicon and App Icons (SVG to prevent editor issues) -->
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ’°</text></svg>">
  <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%23764ba2'/><text y='.9em' x='50%' text-anchor='middle' font-size='90'>ğŸ’°</text></svg>">
  
  <!-- Web App Manifest -->
  <link rel="manifest" href='data:application/manifest+json,{"name":"Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ","short_name":"Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ","start_url":".","display":"standalone","background_color":"#f9fafb","theme_color":"#764ba2","icons":[{"src":"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1MTIiIGhlaWdodD0iNTEyIj48cmVjdCB3aWR0aD0iNTEyIiBoZWlnaHQ9IjUxMiIgcng9IjgwIiBmaWxsPSIjNzY0YmEyIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGRvbWluYW50LWJhc2VsaW5lPSJjZW50cmFsIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmb250LXNpemU9IjM0MCI+8J+QujwvdGV4dD48L3N2Zz4=","type":"image/svg+xml","sizes":"512x512"}]}' />
  
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  
  <style>
  @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap');
  
  * {
  font-family: 'Cairo', sans-serif;
  }
  
  body {
  background-color: #f9fafb; /* bg-gray-50 */
  }
  
  .gradient-bg {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  }
  
  .card-shadow {
  box-shadow: 0 10px 25px rgba(0,0,0,0.08);
  }
  
  .animate-fade-in {
  animation: fadeIn 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94) both;
  -webkit-animation: fadeIn 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94) both;
  }
  
  @keyframes fadeIn {
  from { opacity: 0; transform: translateY(20px) scale(0.98); }
  to { opacity: 1; transform: translateY(0) scale(1); }
  }
  
  .magical-hover {
  transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
  }
  
  .magical-hover:hover {
  transform: translateY(-6px);
  box-shadow: 0 18px 35px rgba(0,0,0,0.1), 0 8px 15px rgba(0,0,0,0.06);
  }
  
  .magical-button {
  background: linear-gradient(45deg, #667eea, #764ba2, #8a4ba2);
  background-size: 200% 200%;
  animation: gradientShift 4s ease infinite;
  -webkit-animation: gradientShift 4s ease infinite;
  transition: all 0.3s ease;
  }
  
  .magical-button:hover {
  box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
  transform: scale(1.05);
  -webkit-transform: scale(1.05);
  }
  
  .magical-button:active {
  transform: scale(0.95);
  -webkit-transform: scale(0.95);
  }
  
  @keyframes gradientShift {
  0% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
  100% { background-position: 0% 50%; }
  }
  
  .number-display {
  font-family: 'SF Mono', 'Courier New', monospace;
  direction: ltr;
  text-align: left;
  }
  
  /* Custom Modal & Loader Styles */
  .modal-overlay, #loading-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.6);
  backdrop-filter: blur(5px);
  -webkit-backdrop-filter: blur(5px);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 1000;
  opacity: 0;
  visibility: hidden;
  transition: opacity 0.3s, visibility 0.3s;
  }
  
  .modal-overlay.visible, #loading-overlay.visible {
  opacity: 1;
  visibility: visible;
  }
  
  .modal-content {
  background: white;
  padding: 1.5rem;
  border-radius: 1rem;
  width: 90%;
  max-width: 500px;
  box-shadow: 0 20px 40px rgba(0,0,0,0.25);
  transform: scale(0.95);
  -webkit-transform: scale(0.95);
  transition: transform 0.3s;
  }
  
  .modal-overlay.visible .modal-content {
  transform: scale(1);
  -webkit-transform: scale(1);
  }
  
  .loader {
  border: 8px solid #f3f3f3; /* Light grey */
  border-top: 8px solid #764ba2; /* Purple */
  border-radius: 50%;
  width: 80px;
  height: 80px;
  animation: spin 1s linear infinite;
  -webkit-animation: spin 1s linear infinite;
  }
  
  @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  
  .tab-btn {
  color: #4a5568; /* text-gray-700 */
  background-color: transparent;
  }
  
  .tab-btn.active {
  color: white;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  box-shadow: 0 4px 12px rgba(118, 75, 162, 0.3);
  }
  
  /* AI Chat Styles */
  .chat-bubble {
  max-width: 80%;
  padding: 10px 15px;
  border-radius: 20px;
  }
  
  .user-bubble {
  background-color: #667eea;
  color: white;
  border-bottom-right-radius: 5px;
  align-self: flex-end;
  }
  
  .ai-bubble {
  background-color: #f3f4f6;
  color: #1f2937;
  border-bottom-left-radius: 5px;
  align-self: flex-start;
  }
  
  .typing-indicator span {
  display: inline-block;
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background-color: #9ca3af;
  animation: pulse 1.4s infinite ease-in-out both;
  -webkit-animation: pulse 1.4s infinite ease-in-out both;
  }
  
  .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
  .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
  
  @keyframes pulse {
  0%, 80%, 100% { transform: scale(0); }
  40% { transform: scale(1.0); }
  }
  
  </style>
  </head>
  <body class="bg-gray-50 min-h-screen">
  
  <div id="loading-overlay" class="visible">
  <div id="loader-container">
  <div class="loader inline-block"></div>
  <p id="loading-text" class="text-white mt-4"></p>
  </div>
  <div id="config-prompt" class="hidden text-white bg-gray-800 p-8 rounded-lg shadow-lg max-w-lg mx-4 text-right">
  <h2 class="text-2xl font-bold mb-4">ğŸ”‘ Ù…Ø·Ù„ÙˆØ¨ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„</h2>
  <p class="mb-4">Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙˆØ­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø¨Ø´ÙƒÙ„ Ø¢Ù…Ù†ØŒ ÙŠØ±Ø¬Ù‰ ØªÙˆÙÙŠØ± Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase Ø§Ù„Ø®Ø§ØµØ© Ø¨Ùƒ. ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„ÙŠÙ‡Ø§ Ù…Ø¬Ø§Ù†Ø§Ù‹ Ù…Ù† <a href="https://console.firebase.google.com/" target="_blank" class="text-blue-400 hover:underline">Ù…ÙˆÙ‚Ø¹ Firebase</a>.</p>
  <p class="mb-2 text-sm">Ù¡. Ø£Ù†Ø´Ø¦ Ù…Ø´Ø±ÙˆØ¹Ø§Ù‹ Ø¬Ø¯ÙŠØ¯Ø§Ù‹.</p>
  <p class="mb-4 text-sm">Ù¢. ÙÙŠ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ØŒ Ø£Ø¶Ù ØªØ·Ø¨ÙŠÙ‚ ÙˆÙŠØ¨ ÙˆØ§Ù†Ø³Ø® ÙƒØ§Ø¦Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª (firebaseConfig).</p>
  <form id="firebase-config-form">
  <label for="firebase-config-input" class="block mb-2">Ø§Ù„ØµÙ‚ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase Ù‡Ù†Ø§:</label>
  <textarea id="firebase-config-input" rows="8" class="w-full p-2 rounded text-black font-mono text-left" placeholder='{
  "apiKey": "...", "authDomain": "...", ... }'></textarea>
  <button type="submit" class="w-full mt-4 magical-button text-white font-semibold py-2 rounded-lg">Ø­ÙØ¸ ÙˆØ¨Ø¯Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</button>
  </form>
  </div>
  </div>
  
  <header class="gradient-bg text-white py-4 mb-8 shadow-lg">
  <div class="container mx-auto px-4">
    <div class="flex flex-col sm:flex-row justify-between items-center text-center sm:text-right gap-4">
      <div>
        <h1 class="text-2xl sm:text-3xl font-bold tracking-wider">ğŸ’° Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ</h1>
        <p class="mt-1 opacity-80 text-xs sm:text-sm">Ø¥ØµØ¯Ø§Ø± Ø®Ø§Øµ Ø®Ù„ÙŠÙ„ Ø§Ù„ØµØ§Ù†Ø¹</p>
      </div>
      <!-- Date Filter Section -->
      <div class="flex items-center gap-2 bg-white/10 p-2 rounded-lg">
        <select id="year-filter" class="bg-transparent text-white font-semibold border-0 focus:ring-0"></select>
        <select id="month-filter" class="bg-transparent text-white font-semibold border-0 focus:ring-0"></select>
      </div>
    </div>
  </div>
  </header>
  
  <div class="container mx-auto px-2 sm:px-4 max-w-7xl">
  <div class="flex flex-wrap justify-center mb-8 bg-white/70 backdrop-blur-lg rounded-xl p-2 card-shadow">
  <button onclick="app.showTab('summary')" id="tab-summary" class="tab-btn px-3 py-2 sm:px-4 sm:py-3 mx-1 mb-2 rounded-lg font-semibold transition-all duration-300 text-sm">ğŸ“Š Ø§Ù„Ù…Ù„Ø®Øµ</button>
  <button onclick="app.showTab('budget')" id="tab-budget" class="tab-btn px-3 py-2 sm:px-4 sm:py-3 mx-1 mb-2 rounded-lg font-semibold transition-all duration-300 text-sm">âœ¨ Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„Ø°ÙƒÙŠØ©</button>
  <button onclick="app.showTab('investment')" id="tab-investment" class="tab-btn px-3 py-2 sm:px-4 sm:py-3 mx-1 mb-2 rounded-lg font-semibold transition-all duration-300 text-sm">ğŸ’¹ Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø±</button>
  <button onclick="app.showTab('ai-assistant')" id="tab-ai-assistant" class="tab-btn px-3 py-2 sm:px-4 sm:py-3 mx-1 mb-2 rounded-lg font-semibold transition-all duration-300 text-sm">ğŸ¤– Ø§Ù„Ù…Ø­Ù„Ù„ Ø§Ù„Ø°ÙƒÙŠ</button>
  <button onclick="app.showTab('transactions')" id="tab-transactions" class="tab-btn px-3 py-2 sm:px-4 sm:py-3 mx-1 mb-2 rounded-lg font-semibold transition-all duration-300 text-sm">ğŸ’³ Ø§Ù„Ø­Ø±ÙƒØ§Øª</button>
  <button onclick="app.showTab('cards')" id="tab-cards" class="tab-btn px-3 py-2 sm:px-4 sm:py-3 mx-1 mb-2 rounded-lg font-semibold transition-all duration-300 text-sm">ğŸ’³ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª</button>
  <button onclick="app.showTab('bank')" id="tab-bank" class="tab-btn px-3 py-2 sm:px-4 sm:py-3 mx-1 mb-2 rounded-lg font-semibold transition-all duration-300 text-sm">ğŸ¦ Ø§Ù„Ø¨Ù†Ùƒ</button>
  <button onclick="app.showTab('installments')" id="tab-installments" class="tab-btn px-3 py-2 sm:px-4 sm:py-3 mx-1 mb-2 rounded-lg font-semibold transition-all duration-300 text-sm">ğŸ“± Ø§Ù„Ø£Ù‚Ø³Ø§Ø·</button>
  <button onclick="app.showTab('categories')" id="tab-categories" class="tab-btn px-3 py-2 sm:px-4 sm:py-3 mx-1 mb-2 rounded-lg font-semibold transition-all duration-300 text-sm">ğŸ“‚ Ø§Ù„ÙØ¦Ø§Øª</button>
  <button onclick="app.showTab('export')" id="tab-export" class="tab-btn px-3 py-2 sm:px-4 sm:py-3 mx-1 mb-2 rounded-lg font-semibold transition-all duration-300 text-sm">ğŸ’¾ ØªØµØ¯ÙŠØ±</button>
  </div>
  
  <div id="summary-tab" class="tab-content animate-fade-in">
  <div id="summary-cards-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
  
  <div data-id="card-debt" class="bg-white rounded-xl p-4 sm:p-6 card-shadow">
  <h3 class="text-lg sm:text-xl font-bold mb-4 text-gray-800">ğŸ’³ Ù…Ù„Ø®Øµ Ø¯ÙŠÙˆÙ† Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª</h3>
  <div class="space-y-4">
  <div class="bg-gradient-to-br from-blue-500 to-indigo-600 text-white p-4 rounded-lg">
  <h4 class="font-bold text-md">SNB Ø§Ù„Ø£Ù‡Ù„ÙŠ</h4>
  <div class="flex justify-between text-sm mt-2"><span class="opacity-80">Ø§Ù„Ù…Ø³ØªØ­Ù‚:</span><span class="font-bold number-display" id="snb-current-balance">0 Ø±ÙŠØ§Ù„</span></div>
  <div class="flex justify-between text-sm"><span class="opacity-80">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ:</span><span class="font-bold number-display" id="snb-remaining-limit">0 Ø±ÙŠØ§Ù„</span></div>
  <div class="mt-2 bg-white/30 rounded-full h-2"><div class="bg-white rounded-full h-2" style="width: 0%" id="snb-usage-bar"></div></div>
  </div>
  <div class="bg-gradient-to-br from-red-500 to-rose-600 text-white p-4 rounded-lg">
  <h4 class="font-bold text-md">ENBD Ø§Ù„Ø¥Ù…Ø§Ø±Ø§Øª</h4>
  <div class="flex justify-between text-sm mt-2"><span class="opacity-80">Ø§Ù„Ù…Ø³ØªØ­Ù‚:</span><span class="font-bold number-display" id="enbd-current-balance">0 Ø±ÙŠØ§Ù„</span></div>
  <div class="flex justify-between text-sm"><span class="opacity-80">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ:</span><span class="font-bold number-display" id="enbd-remaining-limit">0 Ø±ÙŠØ§Ù„</span></div>
  <div class="mt-2 bg-white/30 rounded-full h-2"><div class="bg-white rounded-full h-2" style="width: 0%" id="enbd-usage-bar"></div></div>
  </div>
  </div>
  <div class="mt-4 p-3 bg-gray-100 rounded-lg">
  <div class="grid grid-cols-3 gap-2 text-center">
  <div>
  <p class="text-gray-600 text-xs">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯ÙŠÙˆÙ†</p>
  <p class="text-lg font-bold text-red-600 number-display" id="total-debt">0 Ø±ÙŠØ§Ù„</p>
  </div>
  <div>
  <p class="text-gray-600 text-xs">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØªØ§Ø­</p>
  <p class="text-lg font-bold text-green-600 number-display" id="total-available">0 Ø±ÙŠØ§Ù„</p>
  </div>
  <div>
  <p class="text-gray-600 text-xs">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­Ø¯ÙˆØ¯</p>
  <p class="text-lg font-bold text-blue-600 number-display" id="total-limits">0 Ø±ÙŠØ§Ù„</p>
  </div>
  </div>
  </div>
  </div>
  
  <div data-id="financial-report" class="bg-white rounded-xl p-4 sm:p-6 card-shadow">
  <h3 class="text-lg sm:text-xl font-bold mb-4 text-gray-800">ğŸ“ˆ ØªÙ‚Ø±ÙŠØ± Ù…Ø§Ù„ÙŠ Ø´Ø§Ù…Ù„</h3>
  <div class="space-y-1 text-sm">
  <div class="flex justify-between"><span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯Ø®Ù„:</span><span class="font-bold text-green-600 number-display" id="report-income">0 Ø±ÙŠØ§Ù„</span></div>
  <div class="flex justify-between"><span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ:</span><span class="font-bold text-red-600 number-display" id="report-expenses">0 Ø±ÙŠØ§Ù„</span></div>
  <hr class="my-1 border-gray-200">
  <div class="flex justify-between text-xs">
  <span class="text-gray-600">Ù…ØµØ§Ø±ÙŠÙ Ø¨Ø·Ø§Ù‚Ø© SNB:</span>
  <span class="font-semibold text-indigo-600 number-display" id="report-snb-expenses">0 Ø±ÙŠØ§Ù„</span>
  </div>
  <div class="flex justify-between text-xs">
  <span class="text-gray-600">Ù…ØµØ§Ø±ÙŠÙ Ø¨Ø·Ø§Ù‚Ø© ENBD:</span>
  <span class="font-semibold text-red-600 number-display" id="report-enbd-expenses">0 Ø±ÙŠØ§Ù„</span>
  </div>
  <hr class="my-1 border-gray-200 border-dashed">
  <div class="flex justify-between text-xs">
  <span class="text-gray-600">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø³Ø¯Ø§Ø¯ SNB:</span>
  <span class="font-semibold text-green-600 number-display" id="report-snb-payments">0 Ø±ÙŠØ§Ù„</span>
  </div>
  <div class="flex justify-between text-xs">
  <span class="text-gray-600">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø³Ø¯Ø§Ø¯ ENBD:</span>
  <span class="font-semibold text-green-600 number-display" id="report-enbd-payments">0 Ø±ÙŠØ§Ù„</span>
  </div>
  <hr class="my-1 border-gray-200">
  <div class="flex justify-between font-bold text-lg"><span>Ø§Ù„ØµØ§ÙÙŠ:</span><span id="report-net" class="number-display">0 Ø±ÙŠØ§Ù„</span></div>
  <hr class="my-1 border-gray-200">
  <div class="flex justify-between"><span>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª:</span><span class="font-bold" id="report-count">0</span></div>
  <div class="flex justify-between"><span>Ù…ØªÙˆØ³Ø· Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©:</span><span class="font-bold number-display" id="report-average">0 Ø±ÙŠØ§Ù„</span></div>
  <div class="flex justify-between"><span>Ø£ÙƒØ¨Ø± Ù…Ø¹Ø§Ù…Ù„Ø©:</span><span class="font-bold number-display" id="report-max">0 Ø±ÙŠØ§Ù„</span></div>
  </div>
  </div>

  <div data-id="category-summary" class="bg-white rounded-xl p-4 sm:p-6 card-shadow">
    <h3 class="text-lg sm:text-xl font-bold mb-4 text-gray-800">ğŸ“Š Ù…Ù„Ø®Øµ Ø§Ù„ÙØ¦Ø§Øª</h3>
    <div id="category-summary-list" class="space-y-2 max-h-96 overflow-y-auto pr-2">
        <!-- JS will populate this -->
    </div>
</div>
  
  </div>
  </div>
  
   <div id="budget-tab" class="tab-content hidden animate-fade-in">
    <div class="bg-white rounded-xl p-6 card-shadow">
      <h3 class="text-xl font-bold mb-4 text-gray-800">âœ¨ Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„Ø´Ù‡Ø±ÙŠØ© Ø§Ù„Ø°ÙƒÙŠØ©</h3>
      <div class="flex flex-col sm:flex-row items-end gap-4 mb-6 p-4 bg-gray-50 rounded-lg">
        <div class="flex-grow">
          <label for="monthly-budget-input" class="block text-sm font-medium text-gray-700 mb-1">Ø£Ø¯Ø®Ù„ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…ÙŠØ²Ø§Ù†ÙŠØªÙƒ Ø§Ù„Ø´Ù‡Ø±ÙŠØ© (Ø±ÙŠØ§Ù„)</label>
          <input type="number" id="monthly-budget-input" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="5000">
        </div>
        <button id="generate-budget-btn" class="w-full sm:w-auto px-6 py-2 magical-button text-white rounded-lg font-semibold flex-shrink-0">âœ¨ Ø¥Ù†Ø´Ø§Ø¡ Ø®Ø·Ø© Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©</button>
      </div>
      <div id="budget-plan-result" class="prose prose-sm max-w-none">
        <p class="text-center text-gray-500">Ø£Ø¯Ø®Ù„ Ù…ÙŠØ²Ø§Ù†ÙŠØªÙƒ Ø£Ø¹Ù„Ø§Ù‡ Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø®Ø·Ø© Ù…Ø®ØµØµØ© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø¥Ù†ÙØ§Ù‚Ùƒ.</p>
      </div>
    </div>
  </div>

  <div id="investment-tab" class="tab-content hidden animate-fade-in">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Left Column: Summary & Actions -->
      <div class="lg:col-span-1 space-y-6">
        <div class="bg-white rounded-xl p-6 card-shadow text-center">
          <h3 class="text-lg font-bold text-gray-800 mb-2">ğŸ’° Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù„Ù„Ù…Ø­ÙØ¸Ø©</h3>
          <p class="text-4xl font-bold text-green-600 number-display" id="investment-current-value">0.00 Ø±ÙŠØ§Ù„</p>
          <p class="text-sm text-gray-500 mt-2">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø³ØªØ«Ù…Ø±: <span id="investment-total-invested" class="font-semibold number-display">0.00 Ø±ÙŠØ§Ù„</span></p>
          <button onclick="app.openUpdateInvestmentValueModal()" class="mt-4 w-full px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition-colors text-sm">âœï¸ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</button>
        </div>
        <div class="bg-white rounded-xl p-6 card-shadow">
          <h3 class="text-lg font-bold text-gray-800 mb-4">ğŸ’¸ Ø¥Ø¶Ø§ÙØ© Ø­Ø±ÙƒØ© Ø§Ø³ØªØ«Ù…Ø§Ø±ÙŠØ©</h3>
          <form id="investment-form" class="space-y-4">
            <div>
              <label for="investment-amount" class="block text-sm font-medium text-gray-700">Ø§Ù„Ù…Ø¨Ù„Øº</label>
              <input type="number" id="investment-amount" class="mt-1 w-full p-2 border border-gray-300 rounded-lg" required>
            </div>
            <div>
              <label for="investment-type" class="block text-sm font-medium text-gray-700">Ù†ÙˆØ¹ Ø§Ù„Ø­Ø±ÙƒØ©</label>
              <select id="investment-type" class="mt-1 w-full p-2 border border-gray-300 rounded-lg">
                <option value="deposit">Ø¥ÙŠØ¯Ø§Ø¹ Ù„Ù„Ù…Ø­ÙØ¸Ø©</option>
                <option value="withdrawal">Ø³Ø­Ø¨ Ù…Ù† Ø§Ù„Ù…Ø­ÙØ¸Ø©</option>
              </select>
            </div>
            <button type="submit" class="w-full magical-button text-white font-semibold py-2 rounded-lg">ØªÙ†ÙÙŠØ° Ø§Ù„Ø­Ø±ÙƒØ©</button>
          </form>
        </div>
      </div>
      <!-- Right Column: AI Coach -->
      <div class="lg:col-span-2 bg-white rounded-xl card-shadow overflow-hidden flex flex-col" style="height: 75vh;">
        <div class="p-4 gradient-bg text-white text-center flex-shrink-0">
          <h3 class="text-xl font-bold">ğŸ¤– Ù…Ø³ØªØ´Ø§Ø±Ùƒ Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø±ÙŠ Ø§Ù„Ø°ÙƒÙŠ</h3>
          <p class="text-sm opacity-80">Ø§Ø³Ø£Ù„ Ø¹Ù† Ø§Ù„Ù…ÙØ§Ù‡ÙŠÙ… ÙˆØ§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ§Øª Ù„Ø§ØªØ®Ø§Ø° Ù‚Ø±Ø§Ø±Ø§Øª Ø£ÙØ¶Ù„</p>
        </div>
        <div id="investment-ai-chat-box" class="p-4 flex-grow overflow-y-auto flex flex-col gap-4">
          <div class="ai-bubble chat-bubble">
            <p>Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ! Ø£Ù†Ø§ Ù…Ø±Ø´Ø¯Ùƒ Ù„ÙÙ‡Ù… Ø¹Ø§Ù„Ù… Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø±. ÙŠÙ…ÙƒÙ†Ùƒ Ø³Ø¤Ø§Ù„ÙŠ Ø¹Ù† Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ§ØªØŒ Ø£Ùˆ Ù…ÙØ§Ù‡ÙŠÙ… Ù…Ø«Ù„ "Ù…Ø§ Ù‡Ùˆ Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø± Ø·ÙˆÙŠÙ„ Ø§Ù„Ø£Ø¬Ù„ØŸ". ØªØ°ÙƒØ±ØŒ Ø£Ù†Ø§ Ù„Ø§ Ø£Ù‚Ø¯Ù… Ù†ØµØ§Ø¦Ø­ Ù…Ø¨Ø§Ø´Ø±Ø© Ù„Ø´Ø±Ø§Ø¡ Ø£Ø³Ù‡Ù… Ù…Ø¹ÙŠÙ†Ø©.</p>
          </div>
        </div>
        <div class="p-4 border-t border-gray-200 flex-shrink-0">
          <form id="investment-ai-input-form" class="flex gap-2">
            <input type="text" id="investment-ai-user-input" class="w-full p-3 border border-gray-300 rounded-full" placeholder="Ø§Ø³Ø£Ù„ Ø¹Ù† Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø±..." required autocomplete="off">
            <button type="submit" class="p-3 magical-button text-white rounded-full flex-shrink-0">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
            </button>
          </form>
        </div>
      </div>
    </div>
</div>

  
<div id="ai-assistant-tab" class="tab-content hidden animate-fade-in">
    <div class="bg-white rounded-xl card-shadow overflow-hidden flex flex-col" style="height: 70vh;">
        <div class="p-4 gradient-bg text-white text-center flex-shrink-0">
            <h3 class="text-xl font-bold">ğŸ¤– Ø§Ù„Ù…Ø­Ù„Ù„ Ø§Ù„Ù…Ø§Ù„ÙŠ Ø§Ù„Ø°ÙƒÙŠ</h3>
            <p class="text-sm opacity-80">Ø§Ø³Ø£Ù„ Ø£ÙŠ Ø´ÙŠØ¡ Ø¹Ù† Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ù„Ù„Ø´Ù‡Ø± Ø§Ù„Ù…Ø­Ø¯Ø¯</p>
        </div>
        <div id="ai-chat-box" class="p-4 flex-grow overflow-y-auto flex flex-col gap-4">
            <div class="ai-bubble chat-bubble">
                <p>Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ! Ø£Ù†Ø§ Ù…Ø³Ø§Ø¹Ø¯Ùƒ Ø§Ù„Ù…Ø§Ù„ÙŠ Ø§Ù„Ø´Ø§Ù…Ù„. ÙŠÙ…ÙƒÙ†Ùƒ Ø£Ù† ØªØ³Ø£Ù„Ù†ÙŠ Ø£Ø³Ø¦Ù„Ø© ØªÙØµÙŠÙ„ÙŠØ© Ø¹Ù† ÙˆØ¶Ø¹Ùƒ Ø§Ù„Ù…Ø§Ù„ÙŠØŒ Ù…Ø«Ù„ "Ù…Ø§ Ù‡Ùˆ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¯ÙŠÙˆÙ†ÙŠØŸ" Ø£Ùˆ "Ù‡Ù„ Ø¥Ù†ÙØ§Ù‚ÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø± ÙŠØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ø£Ù‡Ø¯Ø§ÙÙŠØŸ"</p>
            </div>
        </div>
        <div class="p-4 border-t border-gray-200 flex-shrink-0">
            <form id="ai-input-form" class="flex gap-2">
                <input type="text" id="ai-user-input" class="w-full p-3 border border-gray-300 rounded-full focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ Ù‡Ù†Ø§..." required autocomplete="off">
                <button type="submit" class="p-3 magical-button text-white rounded-full flex-shrink-0">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                </button>
            </form>
        </div>
    </div>
</div>
  
  <div id="transactions-tab" class="tab-content hidden animate-fade-in">
  <!-- Transactions Tab Content -->
  <div class="bg-white rounded-xl p-4 sm:p-6 card-shadow mb-6">
  <div class="flex flex-wrap justify-between items-center mb-4 gap-2">
      <h3 class="text-lg sm:text-xl font-bold text-gray-800">â• Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø§Ù…Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©</h3>
      <div class="flex items-center gap-2">
        <button id="paste-from-clipboard-btn" class="flex items-center gap-2 px-3 py-2 bg-indigo-100 text-indigo-700 rounded-lg hover:bg-indigo-200 transition-colors text-sm font-semibold">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard-plus" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/><path fill-rule="evenodd" d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zM8 7a.5.5 0 0 1 .5.5V9H10a.5.5 0 0 1 0 1H8.5v1.5a.5.5 0 0 1-1 0V10H6a.5.5 0 0 1 0-1h1.5V7.5A.5.5 0 0 1 8 7z"/></svg>
          Ù„ØµÙ‚ Ù…Ù† Ø§Ù„Ø­Ø§ÙØ¸Ø©
        </button>
      </div>
  </div>
  <form id="transaction-form" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 items-end">
  <div>
  <label class="block text-sm font-medium text-gray-700 mb-2">ÙˆØ³ÙŠÙ„Ø© Ø§Ù„Ø¯ÙØ¹</label>
  <select id="payment-method" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
  <option value="mada-bank">ğŸ¦ Ù…Ø¯Ù‰/Ø­Ø³Ø§Ø¨ Ø¨Ù†ÙƒÙŠ</option>
  <option value="cash">ğŸ’µ Ù†Ù‚Ø¯ÙŠ</option>
  <option value="snb-card">ğŸ’³ SNB Ø§Ù„Ø£Ù‡Ù„ÙŠ (Ø¨Ø·Ø§Ù‚Ø©)</option>
  <option value="enbd-card">ğŸ’³ ENBD Ø§Ù„Ø¥Ù…Ø§Ø±Ø§Øª (Ø¨Ø·Ø§Ù‚Ø©)</option>
  <option value="tabby-bnpl">ğŸ“± ØªØ§Ø¨ÙŠ (BNPL)</option>
  <option value="tamara-bnpl">ğŸ“± ØªÙ…Ø§Ø±Ø§ (BNPL)</option>
  </select>
  </div>
  <div>
  <label class="block text-sm font-medium text-gray-700 mb-2">Ù†ÙˆØ¹ Ø§Ù„Ø­Ø±ÙƒØ©</label>
  <select id="transaction-type" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
  <option value="income">ğŸ’° Ø¯Ø®Ù„</option>
  <option value="expense" selected>ğŸ’¸ Ù…ØµØ§Ø±ÙŠÙ</option>
  <option value="snb-payment">ğŸ’³ Ø³Ø¯Ø§Ø¯ Ø¨Ø·Ø§Ù‚Ø© SNB Ø§Ù„Ø£Ù‡Ù„ÙŠ</option>
  <option value="enbd-payment">ğŸ’³ Ø³Ø¯Ø§Ø¯ Ø¨Ø·Ø§Ù‚Ø© ENBD Ø§Ù„Ø¥Ù…Ø§Ø±Ø§Øª</option>
  </select>
  </div>
  <div>
  <label class="block text-sm font-medium text-gray-700 mb-2">Ø§Ù„Ù…Ø¨Ù„Øº (Ø±ÙŠØ§Ù„)</label>
  <input type="number" id="transaction-amount" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="0.00" step="0.01" required>
  </div>
  <div>
  <label class="block text-sm font-medium text-gray-700 mb-2">ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©</label>
  <input type="date" id="transaction-date" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
  </div>
  <div>
  <label class="block text-sm font-medium text-gray-700 mb-2">Ø§Ù„ÙØ¦Ø©</label>
  <select id="transaction-category" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"></select>
  </div>
  <div class="lg:col-span-4">
  <label class="block text-sm font-medium text-gray-700 mb-2">Ø§Ù„ÙˆØµÙ</label>
  <input type="text" id="transaction-description" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="ÙˆØµÙ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©" required>
  </div>
  <div id="installments-field" class="hidden">
  <label class="block text-sm font-medium text-gray-700 mb-2">Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ù‚Ø³Ø§Ø·</label>
  <select id="installments-count" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
  <option value="2">Ù‚Ø³Ø·ÙŠÙ† (2)</option>
  <option value="3">3 Ø£Ù‚Ø³Ø§Ø·</option>
  <option value="4" selected>4 Ø£Ù‚Ø³Ø§Ø·</option>
  </select>
  </div>
  <div class="lg:col-span-1 flex items-end">
  <button type="submit" class="w-full px-8 py-3 magical-button text-white rounded-lg font-semibold">
  âœ¨ Ø¥Ø¶Ø§ÙØ© âœ¨
  </button>
  </div>
  </form>
  </div>
  <div class="bg-white rounded-xl p-4 sm:p-6 card-shadow">
  <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 gap-4">
  <h3 class="text-lg sm:text-xl font-bold text-gray-800">ğŸ“‹ Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª</h3>
  <div class="flex flex-col md:flex-row gap-2 w-full md:w-auto">
  <input type="text" id="search-transactions" placeholder="ğŸ” Ø§Ù„Ø¨Ø­Ø«..." class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent w-full md:w-64">
  <select id="filter-payment-method" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
  <option value="">ÙƒÙ„ Ø§Ù„ÙˆØ³Ø§Ø¦Ù„</option>
  <option value="mada-bank">ğŸ¦ Ø¨Ù†Ùƒ</option>
  <option value="cash">ğŸ’µ Ù†Ù‚Ø¯ÙŠ</option>
  <option value="snb-card">ğŸ’³ SNB</option>
  <option value="enbd-card">ğŸ’³ ENBD</option>
  <option value="tabby-bnpl">ğŸ“± ØªØ§Ø¨ÙŠ</option>
  <option value="tamara-bnpl">ğŸ“± ØªÙ…Ø§Ø±Ø§</option>
  </select>
  </div>
  </div>
  <div class="overflow-x-auto">
  <table class="w-full">
  <thead>
  <tr class="border-b-2 border-gray-200">
  <th class="text-right py-3 px-4 font-semibold text-gray-700 text-sm">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
  <th class="text-right py-3 px-4 font-semibold text-gray-700 text-sm">Ø§Ù„ÙˆØ³ÙŠÙ„Ø©</th>
  <th class="text-right py-3 px-4 font-semibold text-gray-700 text-sm">Ø§Ù„Ù†ÙˆØ¹</th>
  <th class="text-right py-3 px-4 font-semibold text-gray-700 text-sm">Ø§Ù„Ù…Ø¨Ù„Øº</th>
  <th class="text-right py-3 px-4 font-semibold text-gray-700 text-sm">Ø§Ù„ÙØ¦Ø©</th>
  <th class="text-right py-3 px-4 font-semibold text-gray-700 text-sm hidden sm:table-cell">Ø§Ù„ÙˆØµÙ</th>
  <th class="text-center py-3 px-4 font-semibold text-gray-700 text-sm">Ø¥Ø¬Ø±Ø§Ø¡</th>
  </tr>
  </thead>
  <tbody id="transactions-list"></tbody>
  </table>
  </div>
  </div>
  </div>
  
  <div id="cards-tab" class="tab-content hidden animate-fade-in">
  <!-- Cards Tab Content -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
  <div class="bg-gradient-to-br from-blue-500 to-indigo-600 text-white p-6 rounded-xl card-shadow magical-hover">
  <div class="flex items-center justify-between mb-4">
  <h3 class="text-xl font-bold">ğŸ’³ Ø¨Ø·Ø§Ù‚Ø© SNB Ø§Ù„Ø£Ù‡Ù„ÙŠ</h3>
  <button onclick="app.openEditCardModal('snb')" class="text-sm bg-white bg-opacity-20 hover:bg-opacity-30 p-2 rounded-full transition">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
  </div>
  <div class="space-y-3">
  <div class="flex justify-between">
  <span class="text-blue-100">Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…Ø³ØªØ­Ù‚:</span>
  <span class="font-bold number-display" id="snb-balance-display">0 Ø±ÙŠØ§Ù„</span>
  </div>
  <div class="flex justify-between">
  <span class="text-blue-100">Ø§Ù„Ø­Ø¯ Ø§Ù„Ø§Ø¦ØªÙ…Ø§Ù†ÙŠ:</span>
  <span class="font-bold number-display" id="snb-limit-display">26,000 Ø±ÙŠØ§Ù„</span>
  </div>
  <div class="flex justify-between">
  <span class="text-blue-100">Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø­:</span>
  <span class="font-bold number-display text-green-300" id="snb-available-display">0 Ø±ÙŠØ§Ù„</span>
  </div>
  <div class="flex justify-between">
  <span class="text-blue-100">ÙŠÙˆÙ… Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚:</span>
  <span class="font-bold" id="snb-due-day-display">ÙŠÙˆÙ… 15</span>
  </div>
  <div class="mt-4 bg-white/30 rounded-full h-3">
  <div class="bg-white rounded-full h-3" id="snb-progress-bar" style="width: 0%"></div>
  </div>
  <p class="text-xs text-blue-100 text-center">Ù†Ø³Ø¨Ø© Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…: <span id="snb-usage-display">0%</span></p>
  </div>
  </div>
  
  <div class="bg-gradient-to-br from-red-500 to-rose-600 text-white p-6 rounded-xl card-shadow magical-hover">
  <div class="flex items-center justify-between mb-4">
  <h3 class="text-xl font-bold">ğŸ’³ Ø¨Ø·Ø§Ù‚Ø© ENBD Ø§Ù„Ø¥Ù…Ø§Ø±Ø§Øª</h3>
  <button onclick="app.openEditCardModal('enbd')" class="text-sm bg-white bg-opacity-20 hover:bg-opacity-30 p-2 rounded-full transition">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
  </div>
  <div class="space-y-3">
  <div class="flex justify-between">
  <span class="text-red-100">Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…Ø³ØªØ­Ù‚:</span>
  <span class="font-bold number-display" id="enbd-balance-display">0 Ø±ÙŠØ§Ù„</span>
  </div>
  <div class="flex justify-between">
  <span class="text-red-100">Ø§Ù„Ø­Ø¯ Ø§Ù„Ø§Ø¦ØªÙ…Ø§Ù†ÙŠ:</span>
  <span class="font-bold number-display" id="enbd-limit-display">10,000 Ø±ÙŠØ§Ù„</span>
  </div>
  <div class="flex justify-between">
  <span class="text-red-100">Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø­:</span>
  <span class="font-bold number-display text-green-300" id="enbd-available-display">0 Ø±ÙŠØ§Ù„</span>
  </div>
  <div class="flex justify-between">
  <span class="text-red-100">ÙŠÙˆÙ… Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚:</span>
  <span class="font-bold" id="enbd-due-day-display">ÙŠÙˆÙ… 18</span>
  </div>
  <div class="mt-4 bg-white/30 rounded-full h-3">
  <div class="bg-white rounded-full h-3" id="enbd-progress-bar" style="width: 0%"></div>
  </div>
  <p class="text-xs text-red-100 text-center">Ù†Ø³Ø¨Ø© Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…: <span id="enbd-usage-display">0%</span></p>
  </div>
  </div>
  </div>
  <div class="bg-white rounded-xl p-6 card-shadow">
  <h3 class="text-xl font-bold mb-4 text-gray-800">ğŸ“‹ ØªØ§Ø±ÙŠØ® Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª</h3>
  <div class="overflow-x-auto">
  <table class="w-full">
  <thead>
  <tr class="border-b-2 border-gray-200">
  <th class="text-right py-3 px-4 font-semibold text-gray-700">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
  <th class="text-right py-3 px-4 font-semibold text-gray-700">Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©</th>
  <th class="text-right py-3 px-4 font-semibold text-gray-700">Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</th>
  <th class="text-right py-3 px-4 font-semibold text-gray-700">Ø§Ù„Ù…Ø¨Ù„Øº</th>
  <th class="text-right py-3 px-4 font-semibold text-gray-700">Ø§Ù„ÙˆØµÙ</th>
  </tr>
  </thead>
  <tbody id="cards-transactions-list"></tbody>
  </table>
  </div>
  </div>
  </div>
  
  <div id="bank-tab" class="tab-content hidden animate-fade-in">
  <!-- Bank Tab Content -->
  <div class="bg-white rounded-xl p-6 card-shadow mb-6">
  <div class="flex justify-between items-center mb-4">
  <h3 class="text-xl font-bold text-gray-800">ğŸ¦ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¨Ù†ÙƒÙŠ</h3>
  <button onclick="app.openEditBankModal()" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors text-sm">âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±ØµÙŠØ¯ / ØªØ³ÙˆÙŠØ©</button>
  </div>
  <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
  <div class="text-center p-6 bg-blue-50 rounded-lg border border-blue-200">
  <div class="text-3xl mb-3">ğŸ’°</div>
  <p class="text-blue-600 font-semibold">Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ</p>
  <p class="text-2xl font-bold text-blue-700 number-display" id="bank-balance">0 Ø±ÙŠØ§Ù„</p>
  </div>
  <div class="text-center p-6 bg-green-50 rounded-lg border border-green-200">
  <div class="text-3xl mb-3">ğŸ“ˆ</div>
  <p class="text-green-600 font-semibold">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹Ø§Øª</p>
  <p class="text-2xl font-bold text-green-700 number-display" id="bank-deposits">0 Ø±ÙŠØ§Ù„</p>
  </div>
  <div class="text-center p-6 bg-red-50 rounded-lg border border-red-200">
  <div class="text-3xl mb-3">ğŸ“‰</div>
  <p class="text-red-600 font-semibold">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ø­ÙˆØ¨Ø§Øª</p>
  <p class="text-2xl font-bold text-red-700 number-display" id="bank-withdrawals">0 Ø±ÙŠØ§Ù„</p>
  </div>
  </div>
  </div>
  <div class="bg-white rounded-xl p-6 card-shadow">
  <h3 class="text-xl font-bold mb-4 text-gray-800">ğŸ“‹ Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¨Ù†ÙƒÙŠ</h3>
  <div class="overflow-x-auto">
  <table class="w-full">
  <thead>
  <tr class="border-b-2 border-gray-200">
  <th class="text-right py-3 px-4 font-semibold text-gray-700">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
  <th class="text-right py-3 px-4 font-semibold text-gray-700">Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</th>
  <th class="text-right py-3 px-4 font-semibold text-gray-700">Ø§Ù„Ù…Ø¨Ù„Øº</th>
  <th class="text-right py-3 px-4 font-semibold text-gray-700">Ø§Ù„ÙØ¦Ø©</th>
  <th class="text-right py-3 px-4 font-semibold text-gray-700">Ø§Ù„ÙˆØµÙ</th>
  </tr>
  </thead>
  <tbody id="bank-transactions-list"></tbody>
  </table>
  </div>
  </div>
  </div>
  
  <div id="installments-tab" class="tab-content hidden animate-fade-in">
  <!-- Installments Tab Content -->
  <h3 class="text-2xl font-bold mb-4 text-gray-800">ğŸ“± Ø®Ø·Ø· Ø§Ù„Ø£Ù‚Ø³Ø§Ø· Ø§Ù„Ù†Ø´Ø·Ø©</h3>
  <div id="active-installments-list" class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
  </div>
  <div class="bg-white rounded-xl p-6 card-shadow mt-8">
  <h3 class="text-xl font-bold mb-4 text-gray-800">ğŸ“‹ Ø³Ø¬Ù„ Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø§Ù„Ø£Ù‚Ø³Ø§Ø·</h3>
  <div class="overflow-x-auto">
  <table class="w-full">
  <thead>
  <tr class="border-b-2 border-gray-200">
  <th class="text-right py-3 px-4 font-semibold text-gray-700">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
  <th class="text-right py-3 px-4 font-semibold text-gray-700">Ø§Ù„Ù…Ù†ØµØ©</th>
  <th class="text-right py-3 px-4 font-semibold text-gray-700">Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</th>
  <th class="text-right py-3 px-4 font-semibold text-gray-700">Ø§Ù„Ù…Ø¨Ù„Øº</th>
  <th class="text-right py-3 px-4 font-semibold text-gray-700">Ø§Ù„ÙˆØµÙ</th>
  </tr>
  </thead>
  <tbody id="installments-transactions-list"></tbody>
  </table>
  </div>
  </div>
  </div>
  
  <div id="categories-tab" class="tab-content hidden animate-fade-in">
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
  <div class="bg-white rounded-xl p-6 card-shadow">
  <h3 class="text-xl font-bold mb-4 text-gray-800">â• Ø¥Ø¶Ø§ÙØ© ÙØ¦Ø© Ø¬Ø¯ÙŠØ¯Ø©</h3>
  <form id="category-form" class="grid grid-cols-1 sm:grid-cols-2 gap-4 items-end">
  <div class="sm:col-span-2">
  <label for="category-name" class="block text-sm font-medium text-gray-700 mb-1">Ø§Ø³Ù… Ø§Ù„ÙØ¦Ø©</label>
  <input type="text" id="category-name" class="w-full p-2 border border-gray-300 rounded-lg" required>
  </div>
  <div class="flex items-end gap-2 sm:col-span-2">
  <div class="flex-grow">
  <label for="category-icon" class="block text-sm font-medium text-gray-700 mb-1">Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø©</label>
  <input type="text" id="category-icon" class="w-full p-2 border border-gray-300 rounded-lg" required placeholder="ğŸ›’">
  </div>
  <button type="button" id="suggest-icon-btn" title="Ø§Ù‚ØªØ±Ø§Ø­ Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø°ÙƒÙŠØ©" class="p-2 bg-indigo-100 text-indigo-700 rounded-lg hover:bg-indigo-200 transition-colors h-10 w-10 flex-shrink-0">âœ¨</button>
  </div>
  <div class="sm:col-span-2">
  <button type="submit" class="w-full px-6 py-2 magical-button text-white rounded-lg font-semibold">âœ¨ Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙØ¦Ø©</button>
  </div>
  </form>
  </div>
  <div class="bg-white rounded-xl p-6 card-shadow">
  <h3 class="text-xl font-bold mb-4 text-gray-800">ğŸ“‚ Ø§Ù„ÙØ¦Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©</h3>
  <div id="categories-list" class="space-y-2 max-h-64 overflow-y-auto">
  <!-- Categories will be rendered here -->
  </div>
  </div>
  </div>
  </div>
  
  <div id="export-tab" class="tab-content hidden animate-fade-in">
  <!-- Export/Backup Tab Content -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
    <div class="bg-white rounded-xl p-6 card-shadow">
        <h3 class="text-xl font-bold mb-4 text-gray-800">ğŸ“Š ØªØµØ¯ÙŠØ± Ø¥Ù„Ù‰ Excel</h3>
        <p class="text-gray-600 mb-4">Ù‚Ù… Ø¨ØªØµØ¯ÙŠØ± Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© Ø¥Ù„Ù‰ Ù…Ù„Ù Excel.</p>
        <button onclick="app.exportToExcel()" class="w-full mt-4 px-6 py-3 bg-green-600 hover:bg-green-700 text-white rounded-lg font-semibold">
        ğŸ“Š ØªØµØ¯ÙŠØ± Ø¥Ù„Ù‰ Excel
        </button>
    </div>
    <div class="bg-white rounded-xl p-6 card-shadow">
        <h3 class="text-xl font-bold mb-4 text-gray-800">ğŸ“„ ØªÙ‚Ø±ÙŠØ± PDF</h3>
        <p class="text-gray-600 mb-4">Ø¥Ù†Ø´Ø§Ø¡ ØªÙ‚Ø±ÙŠØ± Ù…Ø§Ù„ÙŠ Ø´Ø§Ù…Ù„ Ù„Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© Ø¨ØµÙŠØºØ© PDF.</p>
        <button onclick="app.generatePDFReport()" class="w-full mt-4 px-6 py-3 bg-red-600 hover:bg-red-700 text-white rounded-lg font-semibold">
        ğŸ“„ Ø¥Ù†Ø´Ø§Ø¡ ØªÙ‚Ø±ÙŠØ± PDF
        </button>
    </div>
  </div>

  <div class="bg-white rounded-xl p-6 card-shadow mb-6">
    <h3 class="text-xl font-bold mb-4 text-gray-800">âœ¨ ØªÙ„Ø®ÙŠØµ Ø°ÙƒÙŠ Ù„Ù„ØªÙ‚Ø±ÙŠØ±</h3>
    <p class="text-gray-600 mb-4">Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ù…Ù„Ø®Øµ Ø³Ø±ÙŠØ¹ ÙˆÙ…Ø­ØªØ±Ù Ù„ÙˆØ¶Ø¹Ùƒ Ø§Ù„Ù…Ø§Ù„ÙŠ ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©.</p>
    <button id="smart-summary-btn" class="w-full magical-button text-white font-semibold px-6 py-3 rounded-lg">âœ¨ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ø®Øµ Ø°ÙƒÙŠ</button>
    <div id="smart-summary-result" class="mt-4 p-4 bg-gray-50 rounded-lg text-gray-700 prose prose-sm max-w-none hidden"></div>
  </div>

  <div class="bg-white rounded-xl p-6 card-shadow">
    <h3 class="text-xl font-bold mb-4 text-gray-800">ğŸ’¾ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ ÙˆØ§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©</h3>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
            <h4 class="font-semibold text-gray-700 mb-3">ğŸ“¤ Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©</h4>
            <p class="text-gray-600 mb-4 text-sm">Ø§Ø­ÙØ¸ Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ ÙÙŠ Ù…Ù„Ù Ø¢Ù…Ù†.</p>
            <button onclick="app.createBackup()" class="w-full px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-colors">
            ğŸ’¾ Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
            </button>
        </div>
        <div>
            <h4 class="font-semibold text-gray-700 mb-3">ğŸ“¥ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h4>
            <p class="text-gray-600 mb-4 text-sm">Ø§Ø³ØªØ¹Ø¯ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ù…Ù† Ù…Ù„Ù Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©.</p>
            <input type="file" id="backup-file" accept=".json" class="hidden">
            <button onclick="document.getElementById('backup-file').click()" class="w-full px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg transition-colors">
            ğŸ“¥ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            </button>
        </div>
    </div>
  </div>
  <div class="bg-red-50 text-red-800 rounded-xl p-6 card-shadow mt-6">
    <h3 class="text-xl font-bold mb-2">âš ï¸ Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø®Ø·Ø±</h3>
    <p class="text-sm mb-4">Ø³ÙŠØ¤Ø¯ÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø¥Ù„Ù‰ Ø­Ø°Ù Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© ÙÙŠ Ù…ØªØµÙØ­Ùƒ. Ø³ØªØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ Ø¥Ø¯Ø®Ø§Ù„Ù‡Ø§ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙÙŠ Ø§Ù„Ù…Ø±Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©.</p>
    <button onclick="app.clearFirebaseConfig()" class="w-full px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg transition-colors">Ù…Ø³Ø­ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„</button>
  </div>
</div>
  
  </div>
  
  <div id="custom-modal" class="modal-overlay">
  <div class="modal-content">
  <h2 id="modal-title" class="text-2xl font-bold mb-4 text-gray-800"></h2>
  <div id="modal-body"></div>
  <div class="flex justify-end gap-3 mt-6">
  <button id="modal-cancel" class="px-6 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition-colors">Ø¥Ù„ØºØ§Ø¡</button>
  <button id="modal-confirm" class="px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">Ù…ÙˆØ§ÙÙ‚</button>
  </div>
  </div>
  </div>
  
  <script type="module">
  // --- Firebase SDK Imports ---
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import { getAuth, onAuthStateChanged, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
  import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
  
  // --- App Code ---
  
  // ===================================================================================
  // !!! ØªÙ†Ø¨ÙŠÙ‡ Ø£Ù…Ø§Ù† Ù‡Ø§Ù… Ø¬Ø¯Ø§Ù‹ !!!
  // ===================================================================================
  // Ù‡Ø°Ø§ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø§ØªØµØ§Ù„ Ù…Ø¨Ø§Ø´Ø± Ø¨Ù€ Firebase Ù…Ù† Ø§Ù„Ù…ØªØµÙØ­.
  // Ù„Ø­Ù…Ø§ÙŠØ© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†ØŒ Ù…Ù† Ø§Ù„Ø¶Ø±ÙˆØ±ÙŠ Ø¬Ø¯Ø§Ù‹ Ø£Ù† ØªÙ‚ÙˆÙ… Ø¨ÙˆØ¶Ø¹ "Ù‚ÙˆØ§Ø¹Ø¯ Ø£Ù…Ø§Ù†"
  // (Security Rules) ÙÙŠ Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Firebase Ø§Ù„Ø®Ø§ØµØ© Ø¨Ùƒ.
  // Ø¨Ø¯ÙˆÙ† Ù‡Ø°Ù‡ Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯ØŒ ÙŠÙ…ÙƒÙ† Ù„Ø£ÙŠ Ø´Ø®Øµ Ù„Ø¯ÙŠÙ‡ Ù…ÙØªØ§Ø­ API Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†.
  //
  // Ø§Ø°Ù‡Ø¨ Ø¥Ù„Ù‰: Firestore Database > Rules ÙÙŠ Ù…Ø´Ø±ÙˆØ¹Ùƒ Ø¹Ù„Ù‰ Firebase
  // ÙˆØ§Ù„ØµÙ‚ Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„ØªØ§Ù„ÙŠØ©:
  /*
  rules_version = '2';
  service cloud.firestore {
    match /databases/{database}/documents {
      // Ø§Ø³Ù…Ø­ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§ØªÙ‡ Ø§Ù„Ø®Ø§ØµØ© ÙÙ‚Ø·
      match /artifacts/{appId}/users/{userId}/{document=**} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }
  }
  */
  // Ù‡Ø°Ø§ ÙŠØ¶Ù…Ù† Ø£Ù† ÙƒÙ„ Ù…Ø³ØªØ®Ø¯Ù… ÙŠÙ…ÙƒÙ†Ù‡ ÙÙ‚Ø· Ù‚Ø±Ø§Ø¡Ø© ÙˆÙƒØªØ§Ø¨Ø© Ø¨ÙŠØ§Ù†Ø§ØªÙ‡ØŒ ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ†Ù‡
  // Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ø¢Ø®Ø±ÙŠÙ†.
  // ===================================================================================
  
  window.app = {};
  
  var ExpenseApp = (function() {
  // --- STATE MANAGEMENT ---
  var db, auth, userId, docRef, unsubscribe, apiKey;
  var state = getInitialState();
  var selectedYear, selectedMonth;
  var currentEditTransactionId = null;
  var charts = {}; // To hold chart instances

  const GEMINI_PROMPTS = {
    FINANCIAL_ANALYST: `You are an expert financial analyst assistant, "Ø§Ù„Ù…Ø­Ù„Ù„ Ø§Ù„Ø°ÙƒÙŠ". You have full access to the user's financial data for a specific period. Your purpose is to provide detailed, insightful analysis and answer complex questions in Arabic based ONLY on the data provided for that period.
- Today's date is ${new Date().toLocaleDateString('en-CA')}.
- Analyze the user's provided financial state (transactions, card details, bank balance, investments, installments) for the specified period to answer their query.
- Be thorough. Connect different parts of their financial data to give holistic answers.
- DO NOT just state data, INTERPRET it. Provide insights, identify trends, and offer observations.
- Be friendly, professional, and act as a true financial advisor.`,
    
    INVESTMENT_COACH: `You are an educational investment coach named "Ø§Ù„Ù…Ø³ØªØ´Ø§Ø± Ø§Ù„Ø°ÙƒÙŠ". Your primary role is to educate the user about investment concepts and strategies, particularly within the context of the Saudi stock market (Tadawul).
- You MUST NOT give direct financial advice. Do not recommend buying or selling specific stocks (e.g., "Buy Aramco").
- When asked for a recommendation, you MUST politely decline and instead explain HOW the user can research and make their own informed decisions.
- Your tone should be encouraging, educational, and responsible.
- Keep your answers clear, concise, and in Arabic.`,
    
    PASTE_ANALYZER: `You are an intelligent data extraction tool for Arabic financial transaction SMS messages from Saudi Arabia. Analyze the provided text and respond ONLY with a valid JSON object with the keys: "merchant", "amount", "date", "paymentMethod", and "categoryId".
- The 'date' should be in "YYYY-MM-DD" format. Note that dates in the text might be in "DD/MM/YY" format; correctly convert them (e.g., '01/09/25' becomes '2025-09-01').
- The 'amount' is the primary transaction amount; ignore any remaining balance figures.
- The 'merchant' is the store or service name (e.g., 'BINDAWOOD', 'Adel Inte').
- For the 'paymentMethod', you MUST use one of the following specific values: ['mada-bank', 'snb-card', 'enbd-card', 'tabby-bnpl', 'tamara-bnpl', 'cash'].
- **Mapping Rules for paymentMethod:**
  - If the text contains 'SNB', 'Ø§Ù„Ø£Ù‡Ù„ÙŠ', or 'Ø¥Ø¦ØªÙ…Ø§Ù†ÙŠØ©', use 'snb-card'.
  - If the text contains 'ENBD', 'Ø§Ù„Ø¥Ù…Ø§Ø±Ø§Øª', or 'Visa card', use 'enbd-card'.
  - If the text contains 'Ù…Ø¯Ù‰', 'mada', 'Alrajhi', 'Ø§Ù„Ø±Ø§Ø¬Ø­ÙŠ', 'Inma', 'Ø§Ù„Ø¥Ù†Ù…Ø§Ø¡' or the word 'Ø¨Ù†Ùƒ' or 'Ø­Ø³Ø§Ø¨', use 'mada-bank'.
- For the 'categoryId', analyze the merchant name and suggest the most relevant ID from the provided list of available categories. If unsure, use the ID for 'Ø£Ø®Ø±Ù‰'.`,
    
    ICON_SUGGESTER: "You are an emoji expert. Your task is to suggest a single, relevant emoji for a given category name. You must respond with ONLY the emoji character and nothing else.",

    SMART_SUMMARY_GENERATOR: `You are a professional financial analyst. Your task is to write a concise, one-paragraph summary of a user's financial situation based on the provided data for a specific period. The summary should be in Arabic, professional in tone, and suitable for the beginning of a financial report. Highlight the key figures like total income, total expenses, and the net result for that period.`,
    
    BUDGET_PLANNER: `You are a helpful and encouraging financial planning assistant in Arabic. Your goal is to help the user create a realistic monthly budget based on their spending history and a total budget amount they provide. Use the 50/30/20 rule (50% for Needs, 30% for Wants, 20% for Savings/Debt) as a general framework, but you MUST adapt it to the user's actual spending patterns revealed in their transaction data. Your response MUST be in Arabic and formatted using Markdown. It should contain: 1. A brief, encouraging introductory sentence. 2. A breakdown of the total budget into Needs, Wants, and Savings, with the suggested amount for each. 3. A detailed table with three columns: "Ø§Ù„ÙØ¦Ø©", "Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ù‚ØªØ±Ø­", and "Ù…Ù„Ø§Ø­Ø¸Ø§Øª". 4. In the table, allocate the "Needs" and "Wants" amounts across the user's actual spending categories. 5. The "Notes" column should provide a brief justification. 6. Conclude with a short, motivational tip.`
  };
  
  // --- DOM ELEMENT SELECTORS ---
  var loadingOverlay   = document.getElementById('loading-overlay');
  var transactionForm  = document.getElementById('transaction-form');
  var categoryForm     = document.getElementById('category-form');
  var transactionsList = document.getElementById('transactions-list');
  var aiInputForm      = document.getElementById('ai-input-form');
  var investmentAIForm = document.getElementById('investment-ai-input-form');
  var investmentForm   = document.getElementById('investment-form');
  var pasteBtn         = document.getElementById('paste-from-clipboard-btn');
  var suggestIconBtn   = document.getElementById('suggest-icon-btn');
  var generateBudgetBtn= document.getElementById('generate-budget-btn');
  var smartSummaryBtn  = document.getElementById('smart-summary-btn');
  var yearFilter       = document.getElementById('year-filter');
  var monthFilter      = document.getElementById('month-filter');
      
  // --- INITIALIZATION ---
  function init() {
  Object.assign(window.app, {
  showTab: showTab, 
  createBackup: createBackup, 
  exportToExcel: exportToExcel, 
  generatePDFReport: generatePDFReport,
  openEditCardModal: openEditCardModal, 
  openEditBankModal: openEditBankModal, 
  handlePayInstallment: handlePayInstallment,
  openEditCategoryModal: openEditCategoryModal, 
  handleDeleteCategory: handleDeleteCategory,
  openUpdateInvestmentValueModal: openUpdateInvestmentValueModal, 
  clearFirebaseConfig: clearFirebaseConfig
  });
  initializeEventListeners();
  populateDateFilters();
  initializeFirebase();
  }
  
  function getInitialState() {
  return {
  transactions: [],
  cards: { snb: { limit: 26000, dueDay: 15 }, enbd: { limit: 10000, dueDay: 18 } },
  bank: { balance: 0 },
  categories: [ { id: 'cat-1', name: 'ğŸ›’ Ø¨Ù‚Ø§Ù„Ø©', icon: 'ğŸ›’' }, { id: 'cat-2', name: 'ğŸ” Ù…Ø·Ø§Ø¹Ù…', icon: 'ğŸ”' }, { id: 'cat-3', name: 'â›½ ÙˆÙ‚ÙˆØ¯', icon: 'â›½' }, { id: 'cat-4', name: 'ÙÙˆØ§ØªÙŠØ±', icon: 'ğŸ§¾' }, { id: 'cat-9', name: 'ğŸ’³ Ø³Ø¯Ø§Ø¯ ÙÙˆØ§ØªÙŠØ±', icon: 'ğŸ’³' }, { id: 'cat-5', name: 'ØªØ³ÙˆÙ‚', icon: 'ğŸ›ï¸' }, { id: 'cat-6', name: 'Ø¥ÙŠØ¬Ø§Ø±', icon: 'ğŸ ' },{ id: 'cat-8', name: 'ğŸ’Š ØµÙŠØ¯Ù„ÙŠØ©', icon: 'ğŸ’Š' }, { id: 'cat-7', name: 'Ø£Ø®Ø±Ù‰', icon: 'ğŸ’¸' }, ],
  installments: [],
  investments: {
  currentValue: 0
  }
  };
  }
  
  // --- FIREBASE & AUTH ---
  function initializeFirebase() { 
  try { 
  var firebaseConfig;
  if (typeof __firebase_config !== 'undefined' && __firebase_config) {
  firebaseConfig = JSON.parse(__firebase_config);
  } else {
  var storedConfig = localStorage.getItem('firebaseConfig');
  if (storedConfig) {
  firebaseConfig = JSON.parse(storedConfig);
  }
  }
  
  if (!firebaseConfig) {
  promptForFirebaseConfig();
  return;
  }
  
  apiKey = firebaseConfig.apiKey;
  
  var firebaseApp = initializeApp(firebaseConfig); 
  db = getFirestore(firebaseApp); 
  auth = getAuth(firebaseApp); 
  setupAuthListener(); 
  } catch (error) { 
  console.error("Firebase initialization failed:", error); 
  localStorage.removeItem('firebaseConfig'); // Clear bad config
  showError("ÙØ´Ù„ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚. Ù‚Ø¯ ØªÙƒÙˆÙ† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ØºÙŠØ± ØµØ§Ù„Ø­Ø©. Ø³ÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©.");
  setTimeout(function() { location.reload(); }, 3000);
  } 
  }
  function setupAuthListener() { 
  onAuthStateChanged(auth, async function (user) { 
  if (user) { 
  var appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'; 
  userId = user.uid; 
  docRef = doc(db, `artifacts/${appId}/users/${userId}/expenses-data/main`); 
  setupRealtimeListener(); 
  } else { 
  try { 
  if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) { 
  await signInWithCustomToken(auth, __initial_auth_token); 
  } else { 
  await signInAnonymously(auth); 
  } 
  } catch(error) { 
  console.error("Authentication failed:", error); 
  showError("ÙØ´Ù„ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©. Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª."); 
  } 
  } 
  }); 
  }
  function setupRealtimeListener() { 
  if (unsubscribe) unsubscribe(); 
  unsubscribe = onSnapshot(docRef, function(doc) { 
  if (doc.exists()) { 
  var data = doc.data(); 
  state = { ...getInitialState(), ...data }; 
  if(!state.investments) state.investments = getInitialState().investments; 
  console.log("Data loaded from Firebase."); 
  } else { 
  console.log("No data found, initializing with default state."); 
  saveStateToFirebase(); 
  } 
  renderAll(); 
  showLoadingOverlay(false); 
  }, function(error) { 
  console.error("Error listening to document:", error); 
  showError("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…. Ø­Ø§ÙˆÙ„ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©."); 
  }); 
  }
  async function saveStateToFirebase() {
  if (!docRef) return;
  try {
  var cleanState = JSON.parse(JSON.stringify(state));
  await setDoc(docRef, cleanState, { merge: true });
  console.log("State saved to Firebase.");
  } catch (error) {
  console.error("Error saving state:", error);
  showError("ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.");
  }
  }
  
  // --- UI & RENDERING ---
  function renderAll() {
  var calculations = calculateSummaries();
  renderSummary(calculations);
  renderInvestmentTab(calculations);
  renderCardDetails(calculations);
  renderBankDetails(calculations);
  renderTransactionList();
  renderInstallments();
  renderCategories();
  updateCategoryDropdowns();
  renderCategorySummary(calculations);
  }

  function renderCategorySummary(calc) {
    const listEl = document.getElementById('category-summary-list');
    if (!listEl) return;
    
    const transactions = getFilteredTransactions();
    const totalExpenses = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);

    if (totalExpenses === 0) {
        listEl.innerHTML = `<p class="text-gray-500 text-center p-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ØµØ§Ø±ÙŠÙ Ù…Ø³Ø¬Ù„Ø© ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©.</p>`;
        return;
    }

    const expenseTotals = transactions
        .filter(t => t.type === 'expense')
        .reduce((acc, t) => {
            const categoryId = t.categoryId || 'cat-7'; // Default to 'Other'
            acc[categoryId] = (acc[categoryId] || 0) + t.amount;
            return acc;
        }, {});

    const sortedCategories = Object.entries(expenseTotals)
        .sort(([, a], [, b]) => b - a);

    listEl.innerHTML = sortedCategories.map(([categoryId, total]) => {
        const category = findCategoryById(categoryId);
        const name = category ? `${category.icon} ${category.name}` : 'ØºÙŠØ± Ù…ØµÙ†Ù';
        const percentage = (total / totalExpenses) * 100;
        
        return `
        <div class="flex items-center justify-between text-sm py-1">
            <span class="w-28 truncate" title="${category ? category.name : ''}">${name}</span>
            <div class="flex-1 bg-gray-200 rounded-full h-2.5 mx-2">
                <div class="bg-gradient-to-r from-indigo-400 to-purple-500 h-2.5 rounded-full" style="width: ${percentage.toFixed(1)}%"></div>
            </div>
            <span class="font-bold text-gray-800 number-display w-24 text-left">${formatCurrency(total)} Ø±ÙŠØ§Ù„</span>
        </div>
        `;
    }).join('');
}
  
  function renderSummary(calc) {
  document.getElementById('snb-current-balance').textContent = `${formatCurrency(calc.snb.balance)} Ø±ÙŠØ§Ù„`; 
  document.getElementById('snb-remaining-limit').textContent = `${formatCurrency(calc.snb.available)} Ø±ÙŠØ§Ù„`; 
  document.getElementById('snb-usage-bar').style.width = `${calc.snb.usagePercentage}%`; 
  document.getElementById('enbd-current-balance').textContent = `${formatCurrency(calc.enbd.balance)} Ø±ÙŠØ§Ù„`; 
  document.getElementById('enbd-remaining-limit').textContent = `${formatCurrency(calc.enbd.available)} Ø±ÙŠØ§Ù„`; 
  document.getElementById('enbd-usage-bar').style.width = `${calc.enbd.usagePercentage}%`; 
  document.getElementById('total-debt').textContent = `${formatCurrency(calc.totalDebt)} Ø±ÙŠØ§Ù„`; 
  document.getElementById('total-available').textContent = `${formatCurrency(calc.totalAvailable)} Ø±ÙŠØ§Ù„`; 
  document.getElementById('total-limits').textContent = `${formatCurrency(calc.totalLimits)} Ø±ÙŠØ§Ù„`; 
  document.getElementById('report-income').textContent = `${formatCurrency(calc.totalIncome)} Ø±ÙŠØ§Ù„`; 
  document.getElementById('report-expenses').textContent = `${formatCurrency(calc.totalExpenses)} Ø±ÙŠØ§Ù„`; 
  document.getElementById('report-snb-expenses').textContent = `${formatCurrency(calc.totalSnbExpenses)} Ø±ÙŠØ§Ù„`;
  document.getElementById('report-enbd-expenses').textContent = `${formatCurrency(calc.totalEnbdExpenses)} Ø±ÙŠØ§Ù„`;
  document.getElementById('report-snb-payments').textContent = `${formatCurrency(calc.snbPaymentsTotal)} Ø±ÙŠØ§Ù„`;
  document.getElementById('report-enbd-payments').textContent = `${formatCurrency(calc.enbdPaymentsTotal)} Ø±ÙŠØ§Ù„`;
  var net = calc.totalIncome - (calc.totalExpenses + calc.totalInvestmentDeposits - calc.totalInvestmentWithdrawals);
  var netEl = document.getElementById('report-net'); 
  netEl.textContent = `${formatCurrency(net)} Ø±ÙŠØ§Ù„`; 
  netEl.className = 'number-display ' + (net >= 0 ? 'text-green-600' : 'text-red-600'); 
  document.getElementById('report-count').textContent = calc.transactionStats.count; 
  document.getElementById('report-average').textContent = `${formatCurrency(calc.transactionStats.average)} Ø±ÙŠØ§Ù„`; 
  document.getElementById('report-max').textContent = `${formatCurrency(calc.transactionStats.max)} Ø±ÙŠØ§Ù„`;
  }
  
  function renderInvestmentTab(calc) {
  document.getElementById('investment-current-value').textContent = `${formatCurrency(state.investments.currentValue)} Ø±ÙŠØ§Ù„`;
  document.getElementById('investment-total-invested').textContent = `${formatCurrency(calc.totalInvestmentDeposits)} Ø±ÙŠØ§Ù„`;
  }
  
  function renderCardDetails(calc) { document.getElementById('snb-balance-display').textContent = `${formatCurrency(calc.snb.balance)} Ø±ÙŠØ§Ù„`; document.getElementById('snb-limit-display').textContent = `${formatCurrency(state.cards.snb.limit)} Ø±ÙŠØ§Ù„`; document.getElementById('snb-available-display').textContent = `${formatCurrency(calc.snb.available)} Ø±ÙŠØ§Ù„`; document.getElementById('snb-due-day-display').textContent = `ÙŠÙˆÙ… ${state.cards.snb.dueDay}`; document.getElementById('snb-progress-bar').style.width = `${calc.snb.usagePercentage}%`; document.getElementById('snb-usage-display').textContent = `${calc.snb.usagePercentage.toFixed(1)}%`; document.getElementById('enbd-balance-display').textContent = `${formatCurrency(calc.enbd.balance)} Ø±ÙŠØ§Ù„`; document.getElementById('enbd-limit-display').textContent = `${formatCurrency(state.cards.enbd.limit)} Ø±ÙŠØ§Ù„`; document.getElementById('enbd-available-display').textContent = `${formatCurrency(calc.enbd.available)} Ø±ÙŠØ§Ù„`; document.getElementById('enbd-due-day-display').textContent = `ÙŠÙˆÙ… ${state.cards.enbd.dueDay}`; document.getElementById('enbd-progress-bar').style.width = `${calc.enbd.usagePercentage}%`; document.getElementById('enbd-usage-display').textContent = `${calc.enbd.usagePercentage.toFixed(1)}%`; var cardTransactions = getFilteredTransactions().filter(function(t) { return t.paymentMethod.includes('-card') || t.type.includes('-payment')}).sort(function(a, b) { return new Date(b.date) - new Date(a.date)}); var listEl = document.getElementById('cards-transactions-list'); listEl.innerHTML = cardTransactions.map(function(t) { var isPayment = t.type.includes('-payment'); var amountClass = isPayment ? 'text-green-600' : 'text-red-600'; var cardName = t.paymentMethod.includes('snb') || t.type.includes('snb') ? 'SNB' : 'ENBD'; var typeName = isPayment ? 'Ø³Ø¯Ø§Ø¯' : 'Ù…ØµØ±ÙˆÙ'; return ` <tr class="border-b border-gray-100"> <td class="py-3 px-4 text-sm">${t.date}</td> <td class="py-3 px-4 text-sm font-semibold">${cardName}</td> <td class="py-3 px-4 text-sm">${typeName}</td> <td class="py-3 px-4 font-semibold ${amountClass} number-display">${isPayment ? '+' : '-'}${formatCurrency(t.amount)} Ø±ÙŠØ§Ù„</td> <td class="py-3 px-4 text-sm text-gray-600">${t.description || '-'}</td> </tr> `; }).join(''); }
  function renderBankDetails(calc) { document.getElementById('bank-balance').textContent = `${formatCurrency(calc.bankBalanceAtEndOfPeriod)} Ø±ÙŠØ§Ù„`; document.getElementById('bank-deposits').textContent = `${formatCurrency(calc.bankDeposits)} Ø±ÙŠØ§Ù„`; document.getElementById('bank-withdrawals').textContent = `${formatCurrency(calc.bankWithdrawals)} Ø±ÙŠØ§Ù„`; var bankTransactions = getFilteredTransactions().filter(function(t) { return t.paymentMethod === 'mada-bank'}).sort(function(a, b) { return new Date(b.date) - new Date(a.date)}); var listEl = document.getElementById('bank-transactions-list'); listEl.innerHTML = bankTransactions.map(function(t) { var isIncome = t.type === 'income'; var amountClass = isIncome ? 'text-green-600' : 'text-red-600'; var category = findCategoryById(t.categoryId); return ` <tr class="border-b border-gray-100"> <td class="py-3 px-4 text-sm">${t.date}</td> <td class="py-3 px-4 text-sm">${getTransactionTypeName(t.type)}</td> <td class="py-3 px-4 font-semibold ${amountClass} number-display">${isIncome ? '+' : '-'}${formatCurrency(t.amount)} Ø±ÙŠØ§Ù„</td> <td class="py-3 px-4 text-sm">${category ? `${category.icon} ${category.name}` : '-'}</td> <td class="py-3 px-4 text-sm text-gray-600">${t.description || '-'}</td> </tr> `; }).join(''); }
  function renderTransactionList() { var searchTerm = document.getElementById('search-transactions').value.toLowerCase(); var filterMethod = document.getElementById('filter-payment-method').value; var transactionsToDisplay = getFilteredTransactions().filter(function(t) { var descriptionMatch = t.description ? t.description.toLowerCase().includes(searchTerm) : false; var categoryObject = findCategoryById(t.categoryId); var categoryNameMatch = categoryObject ? categoryObject.name.toLowerCase().includes(searchTerm) : false; var matchesSearch = descriptionMatch || categoryNameMatch; var matchesFilter = !filterMethod || t.paymentMethod === filterMethod || t.type.replace('-payment', '-card') === filterMethod; return matchesSearch && matchesFilter; }).sort(function(a, b) { return new Date(b.date) - new Date(a.date)}); transactionsList.innerHTML = transactionsToDisplay.map(function(t) { var category = findCategoryById(t.categoryId); var isIncome = t.type === 'income'; var isPayment = t.type.includes('payment'); var isInvestment = t.type.includes('investment'); var amountClass = isIncome || isPayment ? 'text-green-600' : 'text-red-600'; var sign = isIncome || isPayment ? '+' : '-'; return ` <tr class="border-b border-gray-100 hover:bg-gray-50 text-sm"> <td class="py-3 px-4">${t.date}</td> <td class="py-3 px-4">${getPaymentMethodName(t.paymentMethod)}</td> <td class="py-3 px-4">${getTransactionTypeName(t.type)}</td> <td class="py-3 px-4 font-semibold ${isInvestment ? 'text-blue-600' : amountClass} number-display">${isInvestment ? ' ' : sign} ${formatCurrency(t.amount)} Ø±ÙŠØ§Ù„</td> <td class="py-3 px-4">${category ? `${category.icon} ${category.name}` : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td> <td class="py-3 px-4 text-gray-600 hidden sm:table-cell">${t.description || '-'}</td> <td class="py-3 px-4 text-center"> <button data-action="edit" data-id="${t.id}" class="text-blue-500 hover:text-blue-700 p-1">âœï¸</button> <button data-action="delete" data-id="${t.id}" class="text-red-500 hover:text-red-700 p-1">ğŸ—‘ï¸</button> </td> </tr> `; }).join(''); }
  function renderInstallments() { var listEl = document.getElementById('active-installments-list'); var activeInstallments = state.installments.filter(function(i) { return i.paid < i.total }); if (activeInstallments.length === 0) { listEl.innerHTML = `<div class="col-span-1 md:col-span-2 text-center p-6 bg-gray-50 rounded-lg"> <p class="text-gray-600">ğŸ‰ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ù‚Ø³Ø§Ø· Ù†Ø´Ø·Ø© Ø­Ø§Ù„ÙŠÙ‹Ø§!</p> </div>`; } else { listEl.innerHTML = activeInstallments.map(function(i) { var remaining = i.total - i.paid; var progress = (i.paid / i.total) * 100; return ` <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200"> <div class="flex justify-between items-start mb-2"> <div> <h4 class="font-bold text-gray-800">${i.description}</h4> <p class="text-sm text-gray-500">${getPaymentMethodName(i.provider)}</p> </div> <span class="font-bold text-purple-600 number-display">${formatCurrency(i.installmentAmount)} Ø±ÙŠØ§Ù„/Ø´Ù‡Ø±</span> </div> <div class="w-full bg-gray-200 rounded-full h-2.5 mb-1"> <div class="bg-purple-600 h-2.5 rounded-full" style="width: ${progress}%"></div> </div> <div class="flex justify-between text-xs text-gray-600"> <span>${i.paid} / ${i.total} Ù…Ø¯ÙÙˆØ¹</span> <span>Ù…ØªØ¨Ù‚ÙŠ: <span class="font-semibold">${remaining}</span></span> </div> <div class="text-center mt-4"> <button onclick="app.handlePayInstallment('${i.id}')" class="px-4 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 transition-colors text-sm w-full sm:w-auto"> Ø¯ÙØ¹ Ø§Ù„Ù‚Ø³Ø· Ø§Ù„ØªØ§Ù„ÙŠ </button> </div> </div> `; }).join(''); } var installmentTransactions = getFilteredTransactions() .filter(function(t) { return t.paymentMethod.includes('-bnpl') || t.isInstallmentPayment}) .sort(function(a, b) { return new Date(b.date) - new Date(a.date)}); document.getElementById('installments-transactions-list').innerHTML = installmentTransactions.map(function(t) { var isPayment = t.isInstallmentPayment; var installment = isPayment ? findInstallmentById(t.installmentId) : null; var provider = isPayment ? (installment ? installment.provider : '') : t.paymentMethod; return ` <tr class="border-b border-gray-100"> <td class="py-3 px-4 text-sm">${t.date}</td> <td class="py-3 px-4 text-sm">${getPaymentMethodName(provider)}</td> <td class="py-3 px-4 text-sm">${isPayment ? 'Ø³Ø¯Ø§Ø¯ Ù‚Ø³Ø·' : 'Ø´Ø±Ø§Ø¡ Ø¬Ø¯ÙŠØ¯'}</td> <td class="py-3 px-4 text-red-600 font-semibold number-display">${formatCurrency(t.amount)} Ø±ÙŠØ§Ù„</td> <td class="py-3 px-4 text-sm text-gray-600">${t.description || '-'}</td> </tr> `; }).join(''); }
  function renderCategories() { var listEl = document.getElementById('categories-list'); listEl.innerHTML = state.categories.map(function(cat) { return ` <div class="flex items-center justify-between p-2 bg-gray-50 rounded-lg"> <span class="font-semibold">${cat.icon} ${cat.name}</span> <div> <button onclick="app.openEditCategoryModal('${cat.id}')" class="text-blue-500 hover:text-blue-700 p-1 text-sm">âœï¸</button> <button onclick="app.handleDeleteCategory('${cat.id}')" class="text-red-500 hover:text-red-700 p-1 text-sm">ğŸ—‘ï¸</button> </div> </div> `}).join(''); }
  
  // --- EVENT LISTENERS ---
  function initializeEventListeners() {
  transactionForm.addEventListener('submit', handleTransactionFormSubmit); 
  categoryForm.addEventListener('submit', handleCategoryFormSubmit); 
  transactionsList.addEventListener('click', handleTransactionActions); 
  document.getElementById('payment-method').addEventListener('change', handlePaymentMethodChange); 
  document.getElementById('transaction-type').addEventListener('change', handleTransactionTypeChange); 
  document.getElementById('search-transactions').addEventListener('input', renderTransactionList); 
  document.getElementById('filter-payment-method').addEventListener('change', renderTransactionList); 
  document.getElementById('modal-cancel').addEventListener('click', hideModal); 
  document.querySelector('.modal-overlay').addEventListener('click', function(e) { if (e.target === e.currentTarget) hideModal(); }); 
  document.getElementById('backup-file').addEventListener('change', handleRestoreBackup);
  aiInputForm.addEventListener('submit', handleAIChatSubmit);
  investmentAIForm.addEventListener('submit', handleInvestmentAIChatSubmit);
  investmentForm.addEventListener('submit', handleInvestmentFormSubmit);
  pasteBtn.addEventListener('click', handlePasteFromClipboard);
  suggestIconBtn.addEventListener('click', handleSuggestCategoryIcon);
  generateBudgetBtn.addEventListener('click', handleGenerateBudget);
  smartSummaryBtn.addEventListener('click', handleSmartSummary);
  
  // Event listeners for the new date filters
  yearFilter.addEventListener('change', handleDateFilterChange);
  monthFilter.addEventListener('change', handleDateFilterChange);

  document.getElementById('transaction-date').value = new Date().toISOString().split('T')[0];
  }
  
  // --- EVENT HANDLERS ---
  function handleTransactionActions(e) { var button = e.target.closest('button'); if (!button) return; var action = button.dataset.action; var id = button.dataset.id; if (action === 'edit') { openEditTransactionModal(id); } else if (action === 'delete') { handleDeleteTransaction(id); } }
  function handleTransactionFormSubmit(e) { 
  e.preventDefault(); 
  
  const description = document.getElementById('transaction-description').value.trim();
  if (!description) {
      showError("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ÙˆØµÙ Ù„Ù„Ù…Ø¹Ø§Ù…Ù„Ø©.");
      return;
  }

  var amount = parseFloat(document.getElementById('transaction-amount').value); 
  if (isNaN(amount) || amount <= 0) { showError("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­."); return; } 
  var formData = { 
  amount: amount, 
  date: document.getElementById('transaction-date').value || new Date().toISOString().split('T')[0], 
  description: description, 
  paymentMethod: document.getElementById('payment-method').value, 
  type: document.getElementById('transaction-type').value, 
  categoryId: document.getElementById('transaction-category').value, 
  }; 
  
  if (currentEditTransactionId) { 
  var index = state.transactions.findIndex(function(t){ return t.id === currentEditTransactionId }); 
  if (index !== -1) { 
  state.transactions[index] = { ...state.transactions[index], ...formData }; 
  } 
  } else { 
  var newTransaction = { id: `trans-${Date.now()}`, ...formData }; 
  if (newTransaction.paymentMethod.includes('bnpl') && newTransaction.type === 'expense') { 
  var installmentsCount = parseInt(document.getElementById('installments-count').value, 10); 
  var installment = { 
  id: `inst-${Date.now()}`, 
  originalTransactionId: newTransaction.id, 
  provider: newTransaction.paymentMethod, 
  description: newTransaction.description, 
  totalAmount: newTransaction.amount, 
  installmentAmount: newTransaction.amount / installmentsCount, 
  total: installmentsCount, paid: 0, 
  createdAt: newTransaction.date 
  }; 
  state.installments.push(installment); 
  } 
  state.transactions.push(newTransaction); 
  } 
  saveStateToFirebase(); 
  transactionForm.reset(); 
  document.getElementById('transaction-date').value = new Date().toISOString().split('T')[0];
  currentEditTransactionId = null; 
  document.querySelector('#transaction-form button[type="submit"]').textContent = 'âœ¨ Ø¥Ø¶Ø§ÙØ© âœ¨'; 
  handleTransactionTypeChange(); 
  showTab('summary'); 
  }
  function handleDeleteTransaction(id) { showModal("Ø­Ø°Ù Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©", "<p>Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø±ØºØ¨ØªÙƒ ÙÙŠ Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.</p>", { confirmText: 'Ù†Ø¹Ù…ØŒ Ø­Ø°Ù', onConfirm: function() { state.transactions = state.transactions.filter(function(t) { return t.id !== id}); saveStateToFirebase(); return true; } }); }
  function handleCategoryFormSubmit(e) { e.preventDefault(); var name = document.getElementById('category-name').value.trim(); var icon = document.getElementById('category-icon').value.trim(); if (!name || !icon) { showError("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… ÙˆØ£ÙŠÙ‚ÙˆÙ†Ø© Ù„Ù„ÙØ¦Ø©."); return; } state.categories.push({ id: `cat-${Date.now()}`, name: name, icon: icon }); saveStateToFirebase(); categoryForm.reset(); }
  function handlePaymentMethodChange(e) { var method = e.target.value; var installmentsField = document.getElementById('installments-field'); var transactionTypeEl = document.getElementById('transaction-type'); if (method.includes('bnpl')) { installmentsField.classList.remove('hidden'); transactionTypeEl.value = 'expense'; transactionTypeEl.disabled = true; } else { installmentsField.classList.add('hidden'); transactionTypeEl.disabled = false; } }
  function handleTransactionTypeChange() {
  var type = document.getElementById('transaction-type').value;
  var paymentMethodEl = document.getElementById('payment-method');
  
  paymentMethodEl.disabled = false;
  for (var i = 0; i < paymentMethodEl.options.length; i++) {
  paymentMethodEl.options[i].style.display = '';
  }
  
  if (type === 'snb-payment') {
  for (var i = 0; i < paymentMethodEl.options.length; i++) {
  if (paymentMethodEl.options[i].value === 'snb-card') {
  paymentMethodEl.options[i].style.display = 'none';
  }
  }
  if (paymentMethodEl.value === 'snb-card') {
  paymentMethodEl.value = 'mada-bank';
  }
  } else if (type === 'enbd-payment') {
  for (var i = 0; i < paymentMethodEl.options.length; i++) {
  if (paymentMethodEl.options[i].value === 'enbd-card') {
  paymentMethodEl.options[i].style.display = 'none';
  }
  }
  if (paymentMethodEl.value === 'enbd-card') {
  paymentMethodEl.value = 'mada-bank';
  }
  }
  
  handlePaymentMethodChange({ target: paymentMethodEl });
  }
  function handlePayInstallment(installmentId) {
  var installment = findInstallmentById(installmentId);
  if (!installment || installment.paid >= installment.total) return;
  var billCategory = state.categories.find(function(c) { 
  return c.name === 'ğŸ’³ Ø³Ø¯Ø§Ø¯ ÙÙˆØ§ØªÙŠØ±' || c.name.toLowerCase().includes('bill'); 
  });
  var categoryId = billCategory ? billCategory.id : '';
  
  var transaction = {
  id: 'trans-' + Date.now(),
  amount: installment.installmentAmount,
  date: new Date().toISOString().split('T')[0],
  description: 'Ø³Ø¯Ø§Ø¯ Ø§Ù„Ù‚Ø³Ø· ' + (installment.paid + 1) + ' Ù„Ù€: ' + installment.description,
  paymentMethod: 'mada-bank',
  type: 'expense',
  categoryId: categoryId,
  isInstallmentPayment: true,
  installmentId: installmentId,
  };
  state.transactions.push(transaction);
  installment.paid += 1;
  saveStateToFirebase();
  }
  function handleDeleteCategory(id) { var isUsed = state.transactions.some(function(t) { return t.categoryId === id}); if (isUsed) { showModal("Ø®Ø·Ø£", "<p>Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„ÙØ¦Ø© Ù„Ø£Ù†Ù‡Ø§ Ù…Ø³ØªØ®Ø¯Ù…Ø© ÙÙŠ Ø¨Ø¹Ø¶ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª.</p>", { confirmText: 'Ù…ÙˆØ§ÙÙ‚', hideCancel: true }); return; } showModal("Ø­Ø°Ù Ø§Ù„ÙØ¦Ø©", "<p>Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„ÙØ¦Ø©ØŸ</p>", { confirmText: 'Ù†Ø¹Ù…ØŒ Ø­Ø°Ù', onConfirm: function() { state.categories = state.categories.filter(function(c) { return c.id !== id}); saveStateToFirebase(); return true; } }); }
  
  
  async function handleAIChatSubmit(e) {
  e.preventDefault();
  var userInput = document.getElementById('ai-user-input');
  var query = userInput.value.trim();
  if (!query) return;
  
  addMessageToChat(query, 'user', 'ai-chat-box');
  userInput.value = '';
  showTypingIndicator(true, 'ai-chat-box');
  
  try {
  var apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
  const filteredData = getFilteredTransactions();

  var requestBody = {
  systemInstruction: { parts: [{ text: GEMINI_PROMPTS.FINANCIAL_ANALYST }] },
  contents: [{
  parts: [
  { text: `User Query: "${query}"` },
  { text: `Financial Data for the period ${selectedYear}-${selectedMonth}: ${JSON.stringify(filteredData)}` }
  ]
  }],
  };
  
  var response = await fetch(apiUrl, {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify(requestBody)
  });
  
  if (!response.ok) {
  var error = new Error(`API call failed with status: ${response.status}`);
  error.status = response.status;
  throw error;
  }
  
  var result = await response.json();
  var aiResponse = getApiResponseText(result) || "Ø¹ÙÙˆØ§Ù‹ØŒ Ù„Ù… Ø£ØªÙ…ÙƒÙ† Ù…Ù† Ù…Ø¹Ø§Ù„Ø¬Ø© Ø·Ù„Ø¨Ùƒ Ø­Ø§Ù„ÙŠØ§Ù‹.";
  addMessageToChat(aiResponse, 'ai', 'ai-chat-box');
  
  } catch (error) {
  console.error("AI Assistant Error:", error);
  var userMessage = "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒÙŠ. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.";
  if (error.status === 403) {
  userMessage = "ØªÙ… Ø±ÙØ¶ Ø§Ù„ÙˆØµÙˆÙ„. ÙŠØ±Ø¬Ù‰ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…ÙØªØ§Ø­ API.";
  showError("ØªÙ… Ø±ÙØ¶ Ø§Ù„ÙˆØµÙˆÙ„ (Ø®Ø·Ø£ 403). ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù‚ÙŠÙˆØ¯ Ù…ÙØªØ§Ø­ API Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ ÙÙŠ Google Cloud Console ÙˆØ§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ù†Ø·Ø§Ù‚ Ø§Ù„Ù†Ø´Ø± (e.g. *.netlify.app).");
  }
  addMessageToChat(userMessage, 'ai', 'ai-chat-box');
  } finally {
  showTypingIndicator(false, 'ai-chat-box');
  }
  }
  
  async function handlePasteFromClipboard() {
  try {
  if (!navigator.clipboard || !navigator.clipboard.readText) {
  throw new Error("Clipboard API not supported or blocked.");
  }
  var clipboardText = await navigator.clipboard.readText();
  if (!clipboardText) {
  showModal("Ø§Ù„Ø­Ø§ÙØ¸Ø© ÙØ§Ø±ØºØ©", "<p>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†Øµ ÙÙŠ Ø§Ù„Ø­Ø§ÙØ¸Ø© Ù„Ù„ØµÙ‚Ù‡.</p>", { confirmText: 'Ø­Ø³Ù†Ù‹Ø§', hideCancel: true });
  return;
  }
  analyzePastedText(clipboardText);
  } catch (error) {
  console.warn("Clipboard read failed, falling back to modal:", error);
  var body = `
  <p class="text-sm text-gray-600 mb-2">ØªØ¹Ø°Ø± Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§ÙØ¸Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹. ÙŠØ±Ø¬Ù‰ Ù„ØµÙ‚ Ù†Øµ Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙÙŠ Ø§Ù„Ù…Ø±Ø¨Ø¹ Ø£Ø¯Ù†Ø§Ù‡:</p>
  <textarea id="paste-textarea" class="w-full h-32 p-2 border border-gray-300 rounded-lg"></textarea>
  `;
  showModal("Ù„ØµÙ‚ Ø§Ù„Ù†Øµ ÙŠØ¯ÙˆÙŠØ§Ù‹", body, {
  confirmText: 'ØªØ­Ù„ÙŠÙ„',
  onConfirm: function() {
  var pastedText = document.getElementById('paste-textarea').value;
  if(pastedText) {
  analyzePastedText(pastedText);
  }
  return true;
  }
  });
  }
  }
  
  async function analyzePastedText(text) {
  showLoadingOverlay(true, "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø°ÙƒÙŠ...");
  try {
  var categoriesForAI = state.categories.map(function(c) { return { id: c.id, name: c.name }});
  var apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
  
  var requestBody = {
  systemInstruction: { parts: [{ text: GEMINI_PROMPTS.PASTE_ANALYZER }] },
  contents: [{ parts: [{ text: text }, {text: `Available Categories: ${JSON.stringify(categoriesForAI)}`}] }],
  generationConfig: { responseMimeType: "application/json" }
  };
  
  var response = await fetch(apiUrl, {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify(requestBody)
  });
  
  if (!response.ok) throw new Error(`API call failed with status ${response.status}`);
  
  var result = await response.json();
  var textResponse = getApiResponseText(result);
  
  if (!textResponse) throw new Error("Invalid response from AI model.");
  
  var data = JSON.parse(textResponse);
  
  if (data.amount) document.getElementById('transaction-amount').value = data.amount;
  if (data.merchant) document.getElementById('transaction-description').value = data.merchant;
  if (data.date) document.getElementById('transaction-date').value = data.date;
  if (data.paymentMethod) document.getElementById('payment-method').value = data.paymentMethod;
  if (data.categoryId) document.getElementById('transaction-category').value = data.categoryId;
  
  handlePaymentMethodChange({ target: document.getElementById('payment-method') });
  handleTransactionTypeChange();
  
  showModal("Ù†Ø¬Ø§Ø­", "<p>ØªÙ… ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù†Øµ ÙˆÙ…Ù„Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹. ÙŠØ±Ø¬Ù‰ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù‚Ø¨Ù„ Ø§Ù„Ø­ÙØ¸.</p>", { confirmText: 'Ø­Ø³Ù†Ù‹Ø§', hideCancel: true });
  
  } catch (error) {
  console.error("Paste analysis error:", error);
  showError("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù†Øµ. Ù‚Ø¯ ÙŠÙƒÙˆÙ† Ø§Ù„Ù†Øµ ØºÙŠØ± ØµØ§Ù„Ø­ Ø£Ùˆ Ù‡Ù†Ø§Ùƒ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„.");
  } finally {
  showLoadingOverlay(false);
  }
  }
  
  
  async function handleSuggestCategoryIcon() {
  var categoryNameInput = document.getElementById('category-name');
  var categoryIconInput = document.getElementById('category-icon');
  var categoryName = categoryNameInput.value.trim();
  if (!categoryName) {
  showError("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„ÙØ¦Ø© Ø£ÙˆÙ„Ø§Ù‹.");
  return;
  }
  
  showLoadingOverlay(true, "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø£ÙŠÙ‚ÙˆÙ†Ø©...");
  
  try {
  var apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
  
  var requestBody = {
  systemInstruction: { parts: [{ text: GEMINI_PROMPTS.ICON_SUGGESTER }] },
  contents: [{ parts: [{ text: `Category: ${categoryName}` }] }]
  };
  
  var response = await fetch(apiUrl, {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify(requestBody)
  });
  
  if (!response.ok) {
  var error = new Error(`API call failed with status: ${response.status}`);
  error.status = response.status;
  throw error;
  }
  
  var result = await response.json();
  var emojiResponse = getApiResponseText(result);
  var emoji = emojiResponse ? emojiResponse.trim() : null;
  
  if (emoji) {
  categoryIconInput.value = emoji;
  } else {
  showError("Ù„Ù… Ø£ØªÙ…ÙƒÙ† Ù…Ù† Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø£ÙŠÙ‚ÙˆÙ†Ø© Ù…Ù†Ø§Ø³Ø¨Ø©.");
  }
  } catch (error) {
  console.error("Suggest icon error:", error);
  showError("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù‚ØªØ±Ø§Ø­ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø©.");
  } finally {
  showLoadingOverlay(false);
  }
  }

    async function handleSmartSummary() {
        const resultDiv = document.getElementById('smart-summary-result');
        showLoadingOverlay(true, "Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ù„Ø®Øµ...");
        resultDiv.innerHTML = '';
        resultDiv.classList.add('hidden');

        try {
            const calc = calculateSummaries();
            if (getFilteredTransactions().length < 1) {
                throw new Error("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙƒØ§ÙÙŠØ© ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø© Ù„Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ø®Øµ.");
            }

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            
            const requestBody = {
                systemInstruction: { parts: [{ text: GEMINI_PROMPTS.SMART_SUMMARY_GENERATOR }] },
                contents: [{ parts: [{ text: `Financial Data: ${JSON.stringify(calc)}` }] }]
            };

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestBody)
            });

            if (!response.ok) throw new Error(`API call failed with status: ${response.status}`);

            const result = await response.json();
            const summaryText = getApiResponseText(result);

            if (!summaryText) throw new Error("Ù„Ù… ÙŠØªÙ…ÙƒÙ† Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ù…Ù† Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ø®Øµ.");
            
            resultDiv.innerHTML = `<p>${summaryText}</p>`;
            resultDiv.classList.remove('hidden');

        } catch (error) {
            console.error("Smart Summary Error:", error);
            showError(error.message || "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ù„Ø®Øµ Ø§Ù„Ø°ÙƒÙŠ.");
        } finally {
            showLoadingOverlay(false);
        }
    }

  async function handleGenerateBudget() {
        const budgetInput = document.getElementById('monthly-budget-input');
        const resultDiv = document.getElementById('budget-plan-result');
        const totalBudget = parseFloat(budgetInput.value);

        if (isNaN(totalBudget) || totalBudget <= 0) {
            showError("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¨Ù„Øº Ù…ÙŠØ²Ø§Ù†ÙŠØ© ØµØ­ÙŠØ­.");
            return;
        }

        showLoadingOverlay(true, "Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø®Ø·Ø© Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©...");
        resultDiv.innerHTML = '';

        try {
            const sixtyDaysAgo = new Date();
            sixtyDaysAgo.setDate(sixtyDaysAgo.getDate() - 60);
            const recentTransactions = state.transactions.filter(t => new Date(t.date) >= sixtyDaysAgo && t.type === 'expense');

            if (recentTransactions.length < 5) {
                 throw new Error("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙƒØ§ÙÙŠØ© Ø¹Ù† Ø¥Ù†ÙØ§Ù‚Ùƒ Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø®Ø·Ø© Ø¯Ù‚ÙŠÙ‚Ø©. ÙŠØ±Ø¬Ù‰ Ø¥Ø¶Ø§ÙØ© 5 Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.");
            }

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            
            const userPrompt = `Here is my financial data. Please create a budget plan for me. My total monthly budget is: ${totalBudget} SAR. My spending categories are: ${JSON.stringify(state.categories)}. My transactions from the last 60 days are: ${JSON.stringify(recentTransactions)}`;

            const requestBody = {
                systemInstruction: { parts: [{ text: GEMINI_PROMPTS.BUDGET_PLANNER }] },
                contents: [{ parts: [{ text: userPrompt }] }]
            };

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestBody)
            });

            if (!response.ok) {
                throw new Error(`API call failed with status: ${response.status}`);
            }

            const result = await response.json();
            const budgetPlanMd = getApiResponseText(result);

            if (!budgetPlanMd) {
                throw new Error("Ù„Ù… ÙŠØªÙ…ÙƒÙ† Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ù…Ù† Ø¥Ù†Ø´Ø§Ø¡ Ø®Ø·Ø© Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©.");
            }
            
            let html = budgetPlanMd
                .replace(/### (.*)/g, '<h4 class="text-lg font-bold text-gray-800 mt-3 mb-2">$1</h4>')
                .replace(/\|(.+)\|(.+)\|(.+)\|/g, '<tr><td class="border px-4 py-2">$1</td><td class="border px-4 py-2">$2</td><td class="border px-4 py-2">$3</td></tr>')
                .replace(/\|-+\|/g, '')
                .replace(/<\/tr><tr>/g, '</tr></thead><tbody><tr>') 
                .replace(/<tr>/g, '<table class="w-full table-auto border-collapse"><thead><tr>')
                .replace(/(<\/table>)/g, '</tbody>$1');
            
            resultDiv.innerHTML = html;

        } catch (error) {
            console.error("Budget Generation Error:", error);
            resultDiv.innerHTML = `<p class="text-center text-red-600 p-4">${error.message}</p>`;
        } finally {
            showLoadingOverlay(false);
        }
    }
  
  function addMessageToChat(message, sender, chatBoxId) {
  var chatBox = document.getElementById(chatBoxId);
  var bubble = document.createElement('div');
  bubble.classList.add('chat-bubble', sender === 'user' ? 'user-bubble' : 'ai-bubble');
  bubble.innerHTML = message.replace(/\n/g, '<br>');
  chatBox.appendChild(bubble);
  chatBox.scrollTop = chatBox.scrollHeight;
  }
  
  function showTypingIndicator(show, chatBoxId) {
  var chatBox = document.getElementById(chatBoxId);
  var indicator = document.getElementById('typing-indicator-' + chatBoxId);
  if (show) {
  if (!indicator) {
  indicator = document.createElement('div');
  indicator.id = 'typing-indicator-' + chatBoxId;
  indicator.classList.add('ai-bubble', 'chat-bubble', 'typing-indicator');
  indicator.innerHTML = '<span></span><span></span><span></span>';
  chatBox.appendChild(indicator);
  chatBox.scrollTop = chatBox.scrollHeight;
  }
  } else {
  if (indicator) {
  indicator.remove();
  }
  }
  }
  
  // --- BUSINESS LOGIC & CALCULATIONS ---
  function calculateSummaries() { 
    const transactions = getFilteredTransactions();
    const allTransactionsBeforePeriod = state.transactions.filter(t => new Date(t.date) < getPeriodStartDate());

    var calc = { totalIncome: 0, totalExpenses: 0, totalBankPayments: 0, totalCashExpenses: 0, totalSnbExpenses: 0, totalEnbdExpenses: 0, totalBnplExpenses: 0, snbPaymentsTotal: 0, enbdPaymentsTotal: 0, bankDeposits: 0, bankWithdrawals: 0, totalInvestmentDeposits: 0, totalInvestmentWithdrawals: 0, transactionStats: { count: 0, total: 0, max: 0, average: 0 } }; 
    
    transactions.forEach(function(t) { 
        calc.transactionStats.count++; 
        calc.transactionStats.total += t.amount; 
        if (t.amount > calc.transactionStats.max) {
            calc.transactionStats.max = t.amount;
        } 
        if (t.type === 'income') { 
            calc.totalIncome += t.amount; 
            if(t.paymentMethod === 'mada-bank') {
                calc.bankDeposits += t.amount;
            } 
        } else if (t.type === 'expense') { 
            calc.totalExpenses += t.amount; 
            if (t.paymentMethod === 'mada-bank') { 
                calc.totalBankPayments += t.amount; 
                calc.bankWithdrawals += t.amount; 
            } 
            if (t.paymentMethod === 'cash') {
                calc.totalCashExpenses += t.amount;
            } 
            if (t.paymentMethod === 'snb-card') {
                calc.totalSnbExpenses += t.amount;
            } 
            if (t.paymentMethod === 'enbd-card') {
                calc.totalEnbdExpenses += t.amount;
            } 
            if (t.paymentMethod.includes('bnpl')) {
                calc.totalBnplExpenses += t.amount;
            } 
            if (t.isInstallmentPayment) {
                calc.bankWithdrawals += t.amount;
            } 
        } else if (t.type === 'snb-payment') { 
            calc.snbPaymentsTotal += t.amount; 
            if (t.paymentMethod === 'mada-bank') { 
                calc.bankWithdrawals += t.amount; 
            } else if (t.paymentMethod === 'enbd-card') { 
                calc.totalEnbdExpenses += t.amount; 
            } 
        } else if (t.type === 'enbd-payment') { 
            calc.enbdPaymentsTotal += t.amount; 
            if (t.paymentMethod === 'mada-bank') { 
                calc.bankWithdrawals += t.amount; 
            } else if (t.paymentMethod === 'snb-card') { 
                calc.totalSnbExpenses += t.amount; 
            } 
        } else if (t.type === 'investment-deposit') { 
            calc.totalInvestmentDeposits += t.amount; 
            calc.bankWithdrawals += t.amount; 
        } else if (t.type === 'investment-withdrawal') { 
            calc.totalInvestmentWithdrawals += t.amount; 
            calc.bankDeposits += t.amount; 
        } 
    }); 
    
    calc.transactionStats.average = calc.transactionStats.count > 0 ? (calc.transactionStats.total / calc.transactionStats.count) : 0; 
    
    // Calculate balances up to the END of the selected period
    const allTransactionsUpToPeriodEnd = state.transactions.filter(t => new Date(t.date) <= getPeriodEndDate());
    
    let snbBalance = 0, enbdBalance = 0, bankBalance = 0;
    allTransactionsUpToPeriodEnd.forEach(t => {
        if (t.type === 'expense' && t.paymentMethod === 'snb-card') snbBalance += t.amount;
        if (t.type === 'snb-payment') snbBalance -= t.amount;
        if (t.type === 'expense' && t.paymentMethod === 'enbd-card') enbdBalance += t.amount;
        if (t.type === 'enbd-payment') enbdBalance -= t.amount;

        if (t.paymentMethod === 'mada-bank') {
            if (t.type === 'income') bankBalance += t.amount;
            else if (t.type === 'expense' || t.type.includes('-payment')) bankBalance -= t.amount;
        }
        if (t.type === 'investment-deposit') bankBalance -= t.amount;
        if (t.type === 'investment-withdrawal') bankBalance += t.amount;
    });

    calc.bankBalanceAtEndOfPeriod = bankBalance;
    calc.snb = { balance: snbBalance, available: state.cards.snb.limit - snbBalance, usagePercentage: state.cards.snb.limit > 0 ? (snbBalance / state.cards.snb.limit) * 100 : 0 }; 
    calc.enbd = { balance: enbdBalance, available: state.cards.enbd.limit - enbdBalance, usagePercentage: state.cards.enbd.limit > 0 ? (enbdBalance / state.cards.enbd.limit) * 100 : 0 }; 
    
    calc.totalDebt = snbBalance + enbdBalance; 
    calc.totalAvailable = calc.snb.available + calc.enbd.available; 
    calc.totalLimits = state.cards.snb.limit + state.cards.enbd.limit; 
    calc.totalCardPayments = calc.snbPaymentsTotal + calc.enbdPaymentsTotal; 
    return calc; 
  }
  
  
  // --- MODALS & FORMS ---
  function openUpdateInvestmentValueModal() {
  var body = `
  <div>
  <label class="block text-sm font-medium text-gray-700 mb-1">Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù„Ù„Ù…Ø­ÙØ¸Ø© (Ø±ÙŠØ§Ù„)</label>
  <input type="number" id="edit-investment-value" class="w-full p-2 border border-gray-300 rounded-lg" value="${state.investments.currentValue}">
  <p class="text-xs text-gray-500 mt-2">Ø£Ø¯Ø®Ù„ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø³ÙˆÙ‚ÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù„Ø¬Ù…ÙŠØ¹ Ø§Ø³ØªØ«Ù…Ø§Ø±Ø§ØªÙƒ.</p>
  </div>`;
  showModal('ØªØ­Ø¯ÙŠØ« Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø­ÙØ¸Ø©', body, {
  confirmText: 'Ø­ÙØ¸',
  onConfirm: function() {
  var newValue = parseFloat(document.getElementById('edit-investment-value').value);
  if (isNaN(newValue) || newValue < 0) {
  showError("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù‚ÙŠÙ…Ø© ØµØ­ÙŠØ­Ø©.");
  return false;
  }
  state.investments.currentValue = newValue;
  saveStateToFirebase();
  return true;
  }
  });
  }
  function handleInvestmentFormSubmit(e) {
  e.preventDefault();
  var amount = parseFloat(document.getElementById('investment-amount').value);
  var type = document.getElementById('investment-type').value;
  
  if (isNaN(amount) || amount <= 0) {
  showError("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­.");
  return;
  }
  
  var newTransaction = {
  id: `trans-${Date.now()}`,
  amount: amount,
  date: new Date().toISOString().split('T')[0],
  description: type === 'deposit' ? 'Ø¥ÙŠØ¯Ø§Ø¹ ÙÙŠ Ø§Ù„Ù…Ø­ÙØ¸Ø© Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø±ÙŠØ©' : 'Ø³Ø­Ø¨ Ù…Ù† Ø§Ù„Ù…Ø­ÙØ¸Ø© Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø±ÙŠØ©',
  paymentMethod: 'mada-bank', // Assumes investment comes from/goes to the bank
  type: type === 'deposit' ? 'investment-deposit' : 'investment-withdrawal',
  categoryId: null
  };
  
  state.transactions.push(newTransaction);
  saveStateToFirebase();
  investmentForm.reset();
  }
  async function handleInvestmentAIChatSubmit(e) {
  e.preventDefault();
  var userInput = document.getElementById('investment-ai-user-input');
  var query = userInput.value.trim();
  if (!query) return;
  
  addMessageToChat(query, 'user', 'investment-ai-chat-box');
  userInput.value = '';
  showTypingIndicator(true, 'investment-ai-chat-box');
  
  try {
  var apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
  
  var requestBody = {
  systemInstruction: { parts: [{ text: GEMINI_PROMPTS.INVESTMENT_COACH }] },
  contents: [{ parts: [{ text: query }] }],
  };
  
  var response = await fetch(apiUrl, {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify(requestBody)
  });
  
  if (!response.ok) {
  var error = new Error(`API call failed with status: ${response.status}`);
  error.status = response.status;
  throw error;
  }
  
  var result = await response.json();
  var aiResponse = getApiResponseText(result) || "Ø¹ÙÙˆØ§Ù‹ØŒ Ù„Ù… Ø£ØªÙ…ÙƒÙ† Ù…Ù† Ù…Ø¹Ø§Ù„Ø¬Ø© Ø·Ù„Ø¨Ùƒ Ø­Ø§Ù„ÙŠØ§Ù‹.";
  
  addMessageToChat(aiResponse, 'ai', 'investment-ai-chat-box');
  } catch (error) {
  console.error("Investment AI error:", error);
  var userMessage = "Ø­Ø¯Ø« Ø®Ø·Ø£. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.";
  if (error.status === 403) {
  userMessage = "ØªÙ… Ø±ÙØ¶ Ø§Ù„ÙˆØµÙˆÙ„. ÙŠØ±Ø¬Ù‰ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…ÙØªØ§Ø­ API.";
  showError("ØªÙ… Ø±ÙØ¶ Ø§Ù„ÙˆØµÙˆÙ„ (Ø®Ø·Ø£ 403). ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù‚ÙŠÙˆØ¯ Ù…ÙØªØ§Ø­ API Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ ÙÙŠ Google Cloud Console ÙˆØ§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ù†Ø·Ø§Ù‚ Ø§Ù„Ù†Ø´Ø± (e.g. *.netlify.app).");
  }
  addMessageToChat(userMessage, 'ai', 'investment-ai-chat-box');
  } finally {
  showTypingIndicator(false, 'investment-ai-chat-box');
  }
  }
  
  // --- Helper Functions ---
  
  function getFilteredTransactions() {
    if (!selectedYear || !selectedMonth) return []; 
    
    return state.transactions.filter(t => {
        const transactionDate = new Date(t.date);
        const transactionYear = transactionDate.getFullYear();
        const transactionMonth = transactionDate.getMonth() + 1; // 1-12
        
        if (selectedMonth === 'all') {
            return transactionYear === selectedYear;
        } else {
            return transactionYear === selectedYear && transactionMonth === parseInt(selectedMonth, 10);
        }
    });
  }

  function getPeriodStartDate() {
    if (selectedMonth === 'all') {
        return new Date(selectedYear, 0, 1);
    }
    return new Date(selectedYear, parseInt(selectedMonth, 10) - 1, 1);
  }

  function getPeriodEndDate() {
    if (selectedMonth === 'all') {
        return new Date(selectedYear, 11, 31, 23, 59, 59);
    }
    return new Date(selectedYear, parseInt(selectedMonth, 10), 0, 23, 59, 59);
  }


  function populateDateFilters() {
      const now = new Date();
      const currentYear = now.getFullYear();
      const currentMonth = now.getMonth() + 1;

      // Populate years
      const startYear = 2020;
      for (let y = currentYear + 1; y >= startYear; y--) {
          const option = document.createElement('option');
          option.value = y;
          option.textContent = y;
          yearFilter.appendChild(option);
      }

      // Populate months
      const months = ["ÙŠÙ†Ø§ÙŠØ±", "ÙØ¨Ø±Ø§ÙŠØ±", "Ù…Ø§Ø±Ø³", "Ø£Ø¨Ø±ÙŠÙ„", "Ù…Ø§ÙŠÙˆ", "ÙŠÙˆÙ†ÙŠÙˆ", "ÙŠÙˆÙ„ÙŠÙˆ", "Ø£ØºØ³Ø·Ø³", "Ø³Ø¨ØªÙ…Ø¨Ø±", "Ø£ÙƒØªÙˆØ¨Ø±", "Ù†ÙˆÙÙ…Ø¨Ø±", "Ø¯ÙŠØ³Ù…Ø¨Ø±"];
      monthFilter.innerHTML = `<option value="all">ÙƒÙ„ Ø§Ù„Ø´Ù‡ÙˆØ±</option>`;
      months.forEach((month, index) => {
          const option = document.createElement('option');
          option.value = index + 1;
          option.textContent = month;
          monthFilter.appendChild(option);
      });

      // Set default values
      yearFilter.value = currentYear;
      monthFilter.value = currentMonth;
      
      // Initialize global filter state
      selectedYear = currentYear;
      selectedMonth = currentMonth;
  }

  function handleDateFilterChange() {
      selectedYear = parseInt(yearFilter.value, 10);
      selectedMonth = monthFilter.value === 'all' ? 'all' : parseInt(monthFilter.value, 10);
      console.log(`Filter changed to: Year ${selectedYear}, Month ${selectedMonth}`);
      renderAll();
  }


  function showModal(title, body, options) { if(options === undefined) { options = {}; } var config = { onConfirm: function(){ return true }, confirmText: 'Ù…ÙˆØ§ÙÙ‚', cancelText: 'Ø¥Ù„ØºØ§Ø¡', hideCancel: false, ...options }; document.getElementById('modal-title').textContent = title; document.getElementById('modal-body').innerHTML = body; var modal = document.getElementById('custom-modal'); var confirmBtn = document.getElementById('modal-confirm'); var cancelBtn = document.getElementById('modal-cancel'); confirmBtn.textContent = config.confirmText; cancelBtn.textContent = config.cancelText; cancelBtn.style.display = config.hideCancel ? 'none' : 'inline-block'; var newConfirmBtn = confirmBtn.cloneNode(true); confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn); newConfirmBtn.addEventListener('click', function() { if (config.onConfirm() !== false) { hideModal(); } }); modal.classList.add('visible'); }
  function hideModal() { document.getElementById('custom-modal').classList.remove('visible'); }
  function openEditTransactionModal(id) { var transaction = state.transactions.find(function(t) { return t.id === id }); if (!transaction) return; currentEditTransactionId = id; document.getElementById('transaction-amount').value = transaction.amount; document.getElementById('transaction-date').value = transaction.date; document.getElementById('transaction-description').value = transaction.description || ''; document.getElementById('payment-method').value = transaction.paymentMethod; document.getElementById('transaction-type').value = transaction.type; var categoryExists = state.categories.some(function(c) { return c.id === transaction.categoryId}); document.getElementById('transaction-category').value = categoryExists ? transaction.categoryId : ''; handleTransactionTypeChange(); showTab('transactions'); window.scrollTo(0, 0); document.querySelector('#transaction-form button[type="submit"]').textContent = 'âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©'; }
  function openEditCardModal(cardKey) {
  var card = state.cards[cardKey];
  var title = cardKey === 'snb' ? 'ØªØ¹Ø¯ÙŠÙ„ Ø¨Ø·Ø§Ù‚Ø© SNB' : 'ØªØ¹Ø¯ÙŠÙ„ Ø¨Ø·Ø§Ù‚Ø© ENBD';
  var calc = calculateSummaries();
  var currentBalance = calc[cardKey].balance;
  var body = `<div class="space-y-4"><div><label class="block text-sm font-medium text-gray-700 mb-1">Ø§Ù„Ø­Ø¯ Ø§Ù„Ø§Ø¦ØªÙ…Ø§Ù†ÙŠ (Ø±ÙŠØ§Ù„)</label><input type="number" id="edit-card-limit" class="w-full p-2 border border-gray-300 rounded-lg" value="${card.limit}"></div><div><label class="block text-sm font-medium text-gray-700 mb-1">Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…Ø³ØªØ­Ù‚ (Ù„Ù„ØªØ³ÙˆÙŠØ©)</label><input type="number" step="0.01" id="edit-card-balance" class="w-full p-2 border border-gray-300 rounded-lg" value="${currentBalance.toFixed(2)}"></div><div><label class="block text-sm font-medium text-gray-700 mb-1">ÙŠÙˆÙ… Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚ (1-31)</label><input type="number" id="edit-card-due-day" class="w-full p-2 border border-gray-300 rounded-lg" value="${card.dueDay}" min="1" max="31"></div></div>`;
  showModal(title, body, {
  confirmText: 'Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª',
  onConfirm: function() {
  var newLimit = parseFloat(document.getElementById('edit-card-limit').value);
  var newDueDay = parseInt(document.getElementById('edit-card-due-day').value, 10);
  var newBalance = parseFloat(document.getElementById('edit-card-balance').value);
  if (isNaN(newLimit) || newLimit < 0 || isNaN(newDueDay) || newDueDay < 1 || newDueDay > 31 || isNaN(newBalance)) {
  showError("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù‚ÙŠÙ… ØµØ§Ù„Ø­Ø©.");
  return false;
  }
  state.cards[cardKey].limit = newLimit;
  state.cards[cardKey].dueDay = newDueDay;
  var adjustment = newBalance - currentBalance;
  if (Math.abs(adjustment) > 0.01) {
  var transaction;
  var otherCategory = state.categories.find(function(c) {
  return c.name === 'Ø£Ø®Ø±Ù‰';
  });
  var categoryId = otherCategory ? otherCategory.id : '';
  if (adjustment > 0) {
  transaction = {
  id: `trans-${Date.now()}`,
  amount: adjustment,
  date: new Date().toISOString().split('T')[0],
  description: 'ØªØ³ÙˆÙŠØ© Ø±ØµÙŠØ¯ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©',
  paymentMethod: `${cardKey}-card`,
  type: 'expense',
  categoryId: categoryId,
  };
  } else {
  transaction = {
  id: `trans-${Date.now()}`,
  amount: Math.abs(adjustment),
  date: new Date().toISOString().split('T')[0],
  description: 'ØªØ³ÙˆÙŠØ© Ø±ØµÙŠØ¯ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© (ØªØ®ÙÙŠØ¶)',
  paymentMethod: 'reconciliation',
  type: `${cardKey}-payment`,
  };
  }
  state.transactions.push(transaction);
  }
  saveStateToFirebase();
  return true;
  }
  });
  }
  function openEditBankModal() { var body = `<div><label class="block text-sm font-medium text-gray-700 mb-1">Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„ÙØ¹Ù„ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ (Ø±ÙŠØ§Ù„)</label><input type="number" id="edit-bank-balance" class="w-full p-2 border border-gray-300 rounded-lg" value="${state.bank.balance}"><p class="text-xs text-gray-500 mt-2">Ù…Ù„Ø§Ø­Ø¸Ø©: Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø³ÙŠÙ‚ÙˆÙ… Ø¨ØªØ³ÙˆÙŠØ© Ø§Ù„Ø±ØµÙŠØ¯ ÙˆÙ„Ù† ÙŠØ¤Ø«Ø± Ø¹Ù„Ù‰ Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠ.</p></div>`; showModal('ØªØ³ÙˆÙŠØ© Ø±ØµÙŠØ¯ Ø§Ù„Ø¨Ù†Ùƒ', body, { confirmText: 'Ø­ÙØ¸', onConfirm: function() { var newBalance = parseFloat(document.getElementById('edit-bank-balance').value); if (isNaN(newBalance)) { showError("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­."); return false; } var settlementAmount = newBalance - state.bank.balance; if(settlementAmount !== 0) { var otherCategory = state.categories.find(function(c) { return c.name === 'Ø£Ø®Ø±Ù‰'; }); var categoryId = ''; if (otherCategory) { categoryId = otherCategory.id; } var transaction = { id: `trans-${Date.now()}`, amount: Math.abs(settlementAmount), date: new Date().toISOString().split('T')[0], description: `ØªØ³ÙˆÙŠØ© Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø³Ø§Ø¨`, paymentMethod: 'mada-bank', type: settlementAmount > 0 ? 'income' : 'expense', categoryId: categoryId, }; state.transactions.push(transaction); } saveStateToFirebase(); return true; } }); }
  function openEditCategoryModal(id) { var category = findCategoryById(id); if(!category) return; var body = `<div class="space-y-4"><div><label class="block text-sm font-medium text-gray-700 mb-1">Ø§Ø³Ù… Ø§Ù„ÙØ¦Ø©</label><input type="text" id="edit-category-name" class="w-full p-2 border border-gray-300 rounded-lg" value="${category.name}"></div><div><label class="block text-sm font-medium text-gray-700 mb-1">Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© (Emoji)</label><input type="text" id="edit-category-icon" class="w-full p-2 border border-gray-300 rounded-lg" value="${category.icon}"></div></div>`; showModal('ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙØ¦Ø©', body, { confirmText: 'Ø­ÙØ¸', onConfirm: function() { var name = document.getElementById('edit-category-name').value.trim(); var icon = document.getElementById('edit-category-icon').value.trim(); if(!name || !icon) { showError("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… ÙˆØ£ÙŠÙ‚ÙˆÙ†Ø©."); return false; } var index = state.categories.findIndex(function(c) { return c.id === id}); if (index !== -1) { state.categories[index] = { ...category, name: name, icon: icon }; saveStateToFirebase(); } return true; } }); }
  
  // --- TABS & UTILS ---
  function getApiResponseText(result) {
  if (result && result.candidates && result.candidates.length > 0) {
  var candidate = result.candidates[0];
  if (candidate && candidate.content && candidate.content.parts && candidate.content.parts.length > 0) {
  return candidate.content.parts[0].text;
  }
  }
  return null;
  }
  function showTab(tabName) { document.querySelectorAll('.tab-content').forEach(function(tab) { return tab.classList.add('hidden')}); document.getElementById(`${tabName}-tab`).classList.remove('hidden'); document.querySelectorAll('.tab-btn').forEach(function(btn) { return btn.classList.remove('active')}); document.getElementById(`tab-${tabName}`).classList.add('active'); }
  function formatCurrency(value) { return (value || 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }); }
  function findCategoryById(id) { return state.categories.find(function(c) { return c.id === id}); }
  function findInstallmentById(id) { return state.installments.find(function(i) { return i.id === id}); }
  function getPaymentMethodName(key) { var names = { 'mada-bank': 'ğŸ¦ Ø¨Ù†Ùƒ', 'cash': 'ğŸ’µ Ù†Ù‚Ø¯ÙŠ', 'snb-card': 'ğŸ’³ SNB', 'enbd-card': 'ğŸ’³ ENBD', 'tabby-bnpl': 'ğŸ“± ØªØ§Ø¨ÙŠ', 'tamara-bnpl': 'ğŸ“± ØªÙ…Ø§Ø±Ø§', 'reconciliation': 'ğŸ”„ ØªØ³ÙˆÙŠØ©' }; return names[key] || key; }
  function getTransactionTypeName(key) { var names = { 'income': 'ğŸ’° Ø¯Ø®Ù„', 'expense': 'ğŸ’¸ Ù…ØµØ§Ø±ÙŠÙ', 'snb-payment': 'ğŸ’³ Ø³Ø¯Ø§Ø¯ SNB', 'enbd-payment': 'ğŸ’³ Ø³Ø¯Ø§Ø¯ ENBD', 'investment-deposit': 'ğŸ’¹ Ø¥ÙŠØ¯Ø§Ø¹ Ø§Ø³ØªØ«Ù…Ø§Ø±ÙŠ', 'investment-withdrawal': 'ğŸ’¹ Ø³Ø­Ø¨ Ø§Ø³ØªØ«Ù…Ø§Ø±ÙŠ' }; return names[key] || key; }
  function showError(message) { console.error(message); if (!loadingOverlay.classList.contains('visible') || document.getElementById('config-prompt').classList.contains('hidden')) { showModal("Ø®Ø·Ø£", `<p>${message}</p>`, { confirmText: 'Ù…ÙˆØ§ÙÙ‚', hideCancel: true }); } else { var prompt = document.getElementById('config-prompt'); var errorEl = document.getElementById('config-error'); if(!errorEl) { errorEl = document.createElement('p'); errorEl.id = 'config-error'; errorEl.className = 'mt-4 p-2 bg-red-500 text-white rounded'; prompt.appendChild(errorEl); } errorEl.textContent = message; } }
  function updateCategoryDropdowns() { var optionsHTML = state.categories.map(function(cat) { return `<option value="${cat.id}">${cat.icon} ${cat.name}</option>`}).join(''); document.getElementById('transaction-category').innerHTML = optionsHTML; }
  function showLoadingOverlay(show, text) { if(text === undefined) { text = "" }; var overlay = document.getElementById('loading-overlay'); var loadingText = document.getElementById('loading-text'); loadingText.textContent = text; if (show) { overlay.classList.add('visible'); } else { overlay.classList.remove('visible'); } }
  function promptForFirebaseConfig() { document.getElementById('loader-container').classList.add('hidden'); document.getElementById('config-prompt').classList.remove('hidden'); document.getElementById('firebase-config-form').addEventListener('submit', function(e) { e.preventDefault(); var configInput = document.getElementById('firebase-config-input').value; try { var configStr = configInput; var startIndex = configInput.indexOf('{'); var endIndex = configInput.lastIndexOf('}'); if (startIndex !== -1 && endIndex !== -1) { configStr = configInput.substring(startIndex, endIndex + 1); } var config = JSON.parse(configStr); if (!config.apiKey || !config.authDomain) { throw new Error("Invalid config object"); } localStorage.setItem('firebaseConfig', JSON.stringify(config)); location.reload(); } catch (error) { showError("Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªÙŠ Ø£Ø¯Ø®Ù„ØªÙ‡Ø§ ØºÙŠØ± ØµØ§Ù„Ø­Ø©. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ù†Ø³Ø® Ø§Ù„ÙƒØ§Ø¦Ù† ÙƒØ§Ù…Ù„Ø§Ù‹."); } }); }
  function clearFirebaseConfig() { showModal( "Ù…Ø³Ø­ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª", "<p>Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø±ØºØ¨ØªÙƒ ÙÙŠ Ù…Ø³Ø­ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ Ø³ØªØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ Ø¥Ø¯Ø®Ø§Ù„Ù‡Ø§ Ù…Ø¬Ø¯Ø¯Ø§Ù‹ ÙÙŠ Ø§Ù„Ù…Ø±Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©.</p>", { confirmText: 'Ù†Ø¹Ù…ØŒ Ø§Ù…Ø³Ø­', onConfirm: function() { localStorage.removeItem('firebaseConfig'); showModal("ØªÙ…", "<p>ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¨Ù†Ø¬Ø§Ø­. Ø³ÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚.</p>", { confirmText: 'Ù…ÙˆØ§ÙÙ‚', hideCancel: true, onConfirm: function() { return location.reload()} }); return true; } } ); }
  
  // --- EXPORT & BACKUP ---
  function createBackup() { var backupData = JSON.stringify(state, null, 2); var blob = new Blob([backupData], { type: 'application/json' }); var url = URL.createObjectURL(blob); var a = document.createElement('a'); a.href = url; a.download = `expenses_backup_${new Date().toISOString().split('T')[0]}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); }
  function handleRestoreBackup(event) {
  var file = event.target.files[0];
  if (!file) return;
  var reader = new FileReader();
  reader.onload = function(e) {
  try {
  var restoredState = JSON.parse(e.target.result);
  if (restoredState && typeof restoredState === 'object' && 'transactions' in restoredState && Array.isArray(restoredState.transactions)) {
  showModal( "Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©", "<p>Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù‡Ø°Ù‡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ Ø³ÙŠØªÙ… Ø§Ù„ÙƒØªØ§Ø¨Ø© ÙÙˆÙ‚ Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø§Ù„Ø­Ø§Ù„ÙŠØ©.</p>", { confirmText: 'Ù†Ø¹Ù…ØŒ Ø§Ø³ØªØ¹Ø§Ø¯Ø©', onConfirm: function() { state = { ...getInitialState(), ...restoredState }; saveStateToFirebase(); showModal("Ù†Ø¬Ø§Ø­", "<p>ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!</p>", { confirmText: 'Ø­Ø³Ù†Ù‹Ø§', hideCancel: true }); return true; } } );
  } else {
  throw new Error("Invalid backup file format.");
  }
  } catch (error) {
  console.error("Failed to restore backup:", error);
  showModal("Ø®Ø·Ø£", "<p>ÙØ´Ù„ ÙÙŠ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©. Ø§Ù„Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­.</p>", { confirmText: 'Ù…ÙˆØ§ÙÙ‚', hideCancel: true });
  }
  };
  reader.readAsText(file);
  event.target.value = '';
  }
  function exportToExcel() {
  var wb = XLSX.utils.book_new();
  const transactionsData = getFilteredTransactions().map(function(t) {
  var category = findCategoryById(t.categoryId);
  var categoryName = category ? category.name : 'N/A';
  return {
  'Ø§Ù„ØªØ§Ø±ÙŠØ®': t.date,
  'Ø§Ù„Ù†ÙˆØ¹': getTransactionTypeName(t.type),
  'Ø§Ù„ÙˆØ³ÙŠÙ„Ø©': getPaymentMethodName(t.paymentMethod),
  'Ø§Ù„Ù…Ø¨Ù„Øº': t.amount,
  'Ø§Ù„ÙØ¦Ø©': categoryName,
  'Ø§Ù„ÙˆØµÙ': t.description
  };
  });
  var ws_transactions = XLSX.utils.json_to_sheet(transactionsData);
  XLSX.utils.book_append_sheet(wb, ws_transactions, "Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª");
  var calc = calculateSummaries();
  var summaryData = [
  { "Ø§Ù„Ø¨Ù†Ø¯": "Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯Ø®Ù„", "Ø§Ù„Ù…Ø¨Ù„Øº": calc.totalIncome },
  { "Ø§Ù„Ø¨Ù†Ø¯": "Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ", "Ø§Ù„Ù…Ø¨Ù„Øº": calc.totalExpenses },
  { "Ø§Ù„Ø¨Ù†Ø¯": "Ø±ØµÙŠØ¯ Ø¨Ù†Ùƒ SNB Ø§Ù„Ù…Ø³ØªØ­Ù‚", "Ø§Ù„Ù…Ø¨Ù„Øº": calc.snb.balance },
  { "Ø§Ù„Ø¨Ù†Ø¯": "Ø±ØµÙŠØ¯ Ø¨Ù†Ùƒ ENBD Ø§Ù„Ù…Ø³ØªØ­Ù‚", "Ø§Ù„Ù…Ø¨Ù„Øº": calc.enbd.balance },
  { "Ø§Ù„Ø¨Ù†Ø¯": "Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¨Ù†ÙƒÙŠ", "Ø§Ù„Ù…Ø¨Ù„Øº": calc.bankBalanceAtEndOfPeriod },
  ];
  var ws_summary = XLSX.utils.json_to_sheet(summaryData);
  XLSX.utils.book_append_sheet(wb, ws_summary, "Ø§Ù„Ù…Ù„Ø®Øµ");
  XLSX.writeFile(wb, `Expense_Report_${selectedYear}_${selectedMonth}.xlsx`);
  }
  
  function generatePDFReport() {
  var { jsPDF } = window.jspdf;
  var doc = new jsPDF();
  
  // It's recommended to use a font that supports Arabic characters
  // For this example, we'll proceed but be aware that characters might not render correctly without a proper font.
  doc.setRTL(true);
  doc.setFont("Helvetica", "bold");
  doc.text(`ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„Ø´Ø§Ù…Ù„ - ${monthFilter.options[monthFilter.selectedIndex].text} ${selectedYear}`, 105, 20, null, null, "center");
  
  var calc = calculateSummaries();
  doc.autoTable({
  startY: 30,
  head: [['Ø§Ù„Ø¨Ù†Ø¯', 'Ø§Ù„Ù…Ø¨Ù„Øº']],
  body: [
  ['Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯Ø®Ù„', `${formatCurrency(calc.totalIncome)} Ø±ÙŠØ§Ù„`],
  ['Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ', `${formatCurrency(calc.totalExpenses)} Ø±ÙŠØ§Ù„`],
  ['Ø§Ù„ØµØ§ÙÙŠ', `${formatCurrency(calc.totalIncome - calc.totalExpenses)} Ø±ÙŠØ§Ù„`],
  ['Ø±ØµÙŠØ¯ SNB Ø§Ù„Ù…Ø³ØªØ­Ù‚', `${formatCurrency(calc.snb.balance)} Ø±ÙŠØ§Ù„`],
  ['Ø±ØµÙŠØ¯ ENBD Ø§Ù„Ù…Ø³ØªØ­Ù‚', `${formatCurrency(calc.enbd.balance)} Ø±ÙŠØ§Ù„`],
  ],
  headStyles: { halign: 'center' },
  bodyStyles: { halign: 'right' }
  });
  doc.text("Ø¢Ø®Ø± Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª", 200, doc.autoTable.previous.finalY + 15, null, null, "right");
  var transactionData = getFilteredTransactions().slice(0, 15).map(function(t) {
  var category = findCategoryById(t.categoryId);
  var categoryName = category ? category.name : '-';
  var description = t.description ? t.description.substring(0, 20) : '-';
  return [
  t.date,
  getPaymentMethodName(t.paymentMethod),
  getTransactionTypeName(t.type),
  formatCurrency(t.amount),
  categoryName,
  description
  ]
  });
  doc.autoTable({
  startY: doc.autoTable.previous.finalY + 20,
  head: [['Ø§Ù„ØªØ§Ø±ÙŠØ®', 'Ø§Ù„ÙˆØ³ÙŠÙ„Ø©', 'Ø§Ù„Ù†ÙˆØ¹', 'Ø§Ù„Ù…Ø¨Ù„Øº', 'Ø§Ù„ÙØ¦Ø©', 'Ø§Ù„ÙˆØµÙ']],
  body: transactionData,
  headStyles: { halign: 'center' },
  bodyStyles: { halign: 'right' }
  });
  doc.save(`financial_report_${selectedYear}_${selectedMonth}.pdf`);
  }
  
  return { init: init };
  })();
  
  document.addEventListener('DOMContentLoaded', function() {
  ExpenseApp.init();
  window.app.showTab('summary');
  });
  </script>
  </body>
  </html>

