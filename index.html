<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ุงููุตุงุฑูู | ููุญุฉ ุงูุชุญูู</title>

  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="ุงููุตุงุฑูู">
  <meta name="theme-color" content="#1e293b">

  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>๐ฐ</text></svg>">
  <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%231e293b'/><text y='.9em' x='50%' text-anchor='middle' font-size='90'>๐ฐ</text></svg>">

  <link rel="manifest" href='data:application/manifest+json,{"name":"ูุธุงู ุฅุฏุงุฑุฉ ุงููุตุงุฑูู","short_name":"ุงููุตุงุฑูู","start_url":".","display":"standalone","background_color":"#0f172a","theme_color":"#1e293b","icons":[{"src":"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1MTIiIGhlaWdodD0iNTEyIj48cmVjdCB3aWR0aD0iNTEyIiBoZWlnaHQ9IjUxMiIgcng9IjgwIiBmaWxsPSIjMWUyOTNiIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGRvbWluYW50LWJhc2VsaW5lPSJjZW50cmFsIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmb250LXNpemU9IjM0MCI+8J+QujwvdGV4dD48L3N2Zz4=","type":"image/svg+xml","sizes":"512x512"}]}' />

  <script src="https://cdn.tailwindcss.com"></script>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap');
    :root { --bg-dark: #0f172a; --card-dark: #1e293b; --border-dark: #334155; --text-light: #cbd5e1; --text-bright: #f1f5f9; --accent-purple: #8b5cf6; --accent-green: #10b981; --accent-red: #ef4444; }
    * { font-family: 'Cairo', sans-serif; }
    body { background-color: var(--bg-dark); color: var(--text-light); }
    .glass-card { background: rgba(30, 41, 59, 0.5); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid var(--border-dark); border-radius: 1rem; transition: all 0.3s ease; }
    .glass-card:hover { border-color: rgba(139, 92, 246, 0.5); transform: translateY(-5px); }
    .number-display { font-family: 'SF Mono', 'Courier New', monospace; direction: ltr; text-align: left; }
    .tab-bar { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); }
    .tab-btn { color: var(--text-light); background-color: transparent; transition: all 0.3s ease; }
    .tab-btn:hover { background-color: rgba(51, 65, 85, 0.7); }
    .tab-btn.active { color: var(--text-bright); background: var(--accent-purple); box-shadow: 0 4px 14px rgba(139, 92, 246, 0.25); }
    input, select, textarea { background-color: #334155 !important; color: var(--text-bright) !important; border: 1px solid #475569 !important; border-radius: 0.5rem; }
    input::placeholder, textarea::placeholder { color: #94a3b8; }
    .animate-fade-in { animation: fadeIn 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94) both; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(15px) scale(0.98); } to { opacity: 1; transform: translateY(0) scale(1); } }
    .modal-overlay, #loading-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; }
    .modal-overlay.visible, #loading-overlay.visible { opacity: 1; visibility: visible; }
    .modal-content { background: var(--card-dark); padding: 1.5rem; border-radius: 1rem; width: 90%; max-width: 500px; border: 1px solid var(--border-dark); box-shadow: 0 20px 40px rgba(0,0,0,0.3); transform: scale(0.95); transition: transform 0.3s; }
    .modal-overlay.visible .modal-content { transform: scale(1); }
    .loader { border: 6px solid #334155; border-top: 6px solid var(--accent-purple); border-radius: 50%; width: 70px; height: 70px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .chat-bubble { max-width: 80%; padding: 10px 15px; border-radius: 20px; }
    .user-bubble { background-color: var(--accent-purple); color: white; border-bottom-right-radius: 5px; align-self: flex-end; }
    .ai-bubble { background-color: var(--card-dark); color: var(--text-light); border-bottom-left-radius: 5px; align-self: flex-start; border: 1px solid var(--border-dark); }
    .typing-indicator span { display: inline-block; width: 8px; height: 8px; border-radius: 50%; background-color: #9ca3af; animation: pulse 1.4s infinite ease-in-out both; }
    .typing-indicator span:nth-child(1) { animation-delay: -0.32s; } .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
    @keyframes pulse { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.0); } }
    .prose { color: var(--text-light); } .prose h4 { color: var(--text-bright); } .prose table { width: 100%; } .prose td, .prose th { border: 1px solid var(--border-dark); padding: 8px; } .prose thead { background-color: #334155; }
    .magical-button { background-color: var(--accent-purple); }
    .magical-button:hover { background-color: #7c3aed; }
  </style>
</head>
<body class="bg-slate-900 min-h-screen">

  <div id="loading-overlay" class="visible">
    <div id="loader-container">
      <div class="loader inline-block"></div>
      <p id="loading-text" class="text-slate-200 mt-4 text-center"></p>
    </div>
    <div id="config-prompt" class="hidden glass-card p-8 max-w-lg mx-4 text-right">
      <h2 class="text-2xl font-bold mb-4 text-white">๐ ูุทููุจ ุฅุนุฏุงุฏุงุช ุงูุงุชุตุงู</h2>
      <p class="mb-4 text-slate-300">ูุชุดุบูู ุงูุชุทุจูู ูุญูุธ ุจูุงูุงุชู ุจุดูู ุขููุ ูุฑุฌู ุชูููุฑ ุฅุนุฏุงุฏุงุช Firebase ุงูุฎุงุตุฉ ุจู.</p>
      <form id="firebase-config-form">
        <label for="firebase-config-input" class="block mb-2 text-slate-300">ุงูุตู ุฅุนุฏุงุฏุงุช Firebase ููุง:</label>
        <textarea id="firebase-config-input" rows="8" class="w-full p-2 font-mono text-left bg-slate-900 border-slate-600 text-slate-200" placeholder='{ "apiKey": "...", "authDomain": "...", ... }'></textarea>
        <button type="submit" class="w-full mt-4 bg-violet-600 hover:bg-violet-700 text-white font-semibold py-2.5 rounded-lg transition-all duration-300">ุญูุธ ูุจุฏุก ุงูุชุทุจูู</button>
      </form>
    </div>
  </div>

  <header class="bg-slate-900/50 backdrop-blur-lg sticky top-0 z-50 border-b border-slate-800 py-3">
    <div class="container mx-auto px-4">
      <div class="flex flex-col sm:flex-row justify-between items-center text-center sm:text-right gap-4">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 bg-violet-500/20 rounded-lg flex items-center justify-center text-xl">๐ฐ</div>
          <div>
            <h1 class="text-xl font-bold text-white tracking-wide">ููุญุฉ ุงูุชุญูู ุงููุงููุฉ</h1>
            <p class="text-xs text-slate-400">ุฅุตุฏุงุฑ ุฎุงุต ุฎููู ุงูุตุงูุน</p>
          </div>
        </div>
        <div class="flex items-center gap-2 bg-slate-800 p-1.5 rounded-lg">
          <select id="year-filter" class="bg-slate-800 text-white font-semibold border-0 focus:ring-0 appearance-none p-2 rounded-md"></select>
          <select id="month-filter" class="bg-slate-800 text-white font-semibold border-0 focus:ring-0 appearance-none p-2 rounded-md"></select>
        </div>
      </div>
    </div>
  </header>

  <main class="container mx-auto px-2 sm:px-4 max-w-7xl mt-8 mb-20">
    <div class="flex flex-wrap justify-center mb-8 tab-bar rounded-xl p-2">
        <button onclick="app.showTab('summary')" id="tab-summary" class="tab-btn px-4 py-2 mx-1 mb-1 rounded-lg font-semibold text-sm flex items-center gap-2">๐ ุงูููุฎุต</button>
        <button onclick="app.showTab('budget')" id="tab-budget" class="tab-btn px-4 py-2 mx-1 mb-1 rounded-lg font-semibold text-sm flex items-center gap-2">โจ ุงูููุฒุงููุฉ</button>
        <button onclick="app.showTab('investment')" id="tab-investment" class="tab-btn px-4 py-2 mx-1 mb-1 rounded-lg font-semibold text-sm flex items-center gap-2">๐น ุงูุงุณุชุซูุงุฑ</button>
        <button onclick="app.showTab('ai-assistant')" id="tab-ai-assistant" class="tab-btn px-4 py-2 mx-1 mb-1 rounded-lg font-semibold text-sm flex items-center gap-2">๐ค ุงููุญูู ุงูุฐูู</button>
        <button onclick="app.showTab('transactions')" id="tab-transactions" class="tab-btn px-4 py-2 mx-1 mb-1 rounded-lg font-semibold text-sm flex items-center gap-2">๐ณ ุงูุญุฑูุงุช</button>
        <button onclick="app.showTab('cards')" id="tab-cards" class="tab-btn px-4 py-2 mx-1 mb-1 rounded-lg font-semibold text-sm flex items-center gap-2">๐ณ ุงูุจุทุงูุงุช</button>
        <button onclick="app.showTab('bank')" id="tab-bank" class="tab-btn px-4 py-2 mx-1 mb-1 rounded-lg font-semibold text-sm flex items-center gap-2">๐ฆ ุงูุจูู</button>
        <button onclick="app.showTab('installments')" id="tab-installments" class="tab-btn px-4 py-2 mx-1 mb-1 rounded-lg font-semibold text-sm flex items-center gap-2">๐ฑ ุงูุฃูุณุงุท</button>
        <button onclick="app.showTab('categories')" id="tab-categories" class="tab-btn px-4 py-2 mx-1 mb-1 rounded-lg font-semibold text-sm flex items-center gap-2">๐ ุงููุฆุงุช</button>
        <button onclick="app.showTab('export')" id="tab-export" class="tab-btn px-4 py-2 mx-1 mb-1 rounded-lg font-semibold text-sm flex items-center gap-2">๐พ ุชุตุฏูุฑ</button>
    </div>

    <div id="summary-tab" class="tab-content animate-fade-in">
        <div id="summary-cards-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <div data-id="card-debt" class="glass-card p-6">
                <h3 class="text-lg font-bold mb-4 text-white">๐ณ ููุฎุต ุฏููู ุงูุจุทุงูุงุช</h3>
                <div class="space-y-4">
                    <div class="bg-slate-800 p-4 rounded-lg">
                        <h4 class="font-bold text-md text-slate-200">SNB ุงูุฃููู</h4>
                        <div class="flex justify-between text-sm mt-2"><span class="text-slate-400">ุงููุณุชุญู:</span><span class="font-bold number-display text-slate-200" id="snb-current-balance">0 ุฑูุงู</span></div>
                        <div class="flex justify-between text-sm"><span class="text-slate-400">ุงููุชุจูู:</span><span class="font-bold number-display text-emerald-400" id="snb-remaining-limit">0 ุฑูุงู</span></div>
                        <div class="mt-3 bg-slate-700 rounded-full h-2"><div class="bg-blue-500 rounded-full h-2" style="width: 0%" id="snb-usage-bar"></div></div>
                    </div>
                    <div class="bg-slate-800 p-4 rounded-lg">
                        <h4 class="font-bold text-md text-slate-200">ENBD ุงูุฅูุงุฑุงุช</h4>
                        <div class="flex justify-between text-sm mt-2"><span class="text-slate-400">ุงููุณุชุญู:</span><span class="font-bold number-display text-slate-200" id="enbd-current-balance">0 ุฑูุงู</span></div>
                        <div class="flex justify-between text-sm"><span class="text-slate-400">ุงููุชุจูู:</span><span class="font-bold number-display text-emerald-400" id="enbd-remaining-limit">0 ุฑูุงู</span></div>
                        <div class="mt-3 bg-slate-700 rounded-full h-2"><div class="bg-red-500 rounded-full h-2" style="width: 0%" id="enbd-usage-bar"></div></div>
                    </div>
                </div>
                <div class="mt-4 p-3 bg-slate-800 rounded-lg">
                    <div class="grid grid-cols-3 gap-2 text-center">
                        <div><p class="text-slate-400 text-xs">ุฅุฌูุงูู ุงูุฏููู</p><p class="text-lg font-bold text-red-400 number-display" id="total-debt">0 ุฑูุงู</p></div>
                        <div><p class="text-slate-400 text-xs">ุฅุฌูุงูู ุงููุชุงุญ</p><p class="text-lg font-bold text-emerald-400 number-display" id="total-available">0 ุฑูุงู</p></div>
                        <div><p class="text-slate-400 text-xs">ุฅุฌูุงูู ุงูุญุฏูุฏ</p><p class="text-lg font-bold text-sky-400 number-display" id="total-limits">0 ุฑูุงู</p></div>
                    </div>
                </div>
            </div>
            <div data-id="financial-report" class="glass-card p-6">
                <h3 class="text-lg font-bold mb-4 text-white">๐ ุชูุฑูุฑ ูุงูู ุดุงูู</h3>
                <div class="space-y-2 text-sm">
                    <div class="flex justify-between"><span>ุฅุฌูุงูู ุงูุฏุฎู:</span><span class="font-bold text-emerald-400 number-display" id="report-income">0 ุฑูุงู</span></div>
                    <div class="flex justify-between"><span>ุฅุฌูุงูู ุงููุตุงุฑูู:</span><span class="font-bold text-red-400 number-display" id="report-expenses">0 ุฑูุงู</span></div>
                    <hr class="my-2 border-slate-700">
                    <div class="flex justify-between text-xs"><span class="text-slate-400">ูุตุงุฑูู ุจุทุงูุฉ SNB:</span><span class="font-semibold text-blue-400 number-display" id="report-snb-expenses">0 ุฑูุงู</span></div>
                    <div class="flex justify-between text-xs"><span class="text-slate-400">ูุตุงุฑูู ุจุทุงูุฉ ENBD:</span><span class="font-semibold text-red-400 number-display" id="report-enbd-expenses">0 ุฑูุงู</span></div>
                    <hr class="my-2 border-slate-700 border-dashed">
                    <div class="flex justify-between text-xs"><span class="text-slate-400">ุฅุฌูุงูู ุณุฏุงุฏ SNB:</span><span class="font-semibold text-emerald-400 number-display" id="report-snb-payments">0 ุฑูุงู</span></div>
                    <div class="flex justify-between text-xs"><span class="text-slate-400">ุฅุฌูุงูู ุณุฏุงุฏ ENBD:</span><span class="font-semibold text-emerald-400 number-display" id="report-enbd-payments">0 ุฑูุงู</span></div>
                    <hr class="my-2 border-slate-700">
                    <div class="flex justify-between font-bold text-lg"><span>ุงูุตุงูู:</span><span id="report-net" class="number-display">0 ุฑูุงู</span></div>
                    <hr class="my-2 border-slate-700">
                    <div class="flex justify-between"><span>ุนุฏุฏ ุงููุนุงููุงุช:</span><span class="font-bold text-white" id="report-count">0</span></div>
                    <div class="flex justify-between"><span>ูุชูุณุท ุงููุนุงููุฉ:</span><span class="font-bold number-display text-white" id="report-average">0 ุฑูุงู</span></div>
                    <div class="flex justify-between"><span>ุฃูุจุฑ ูุนุงููุฉ:</span><span class="font-bold number-display text-white" id="report-max">0 ุฑูุงู</span></div>
                </div>
            </div>
            <div data-id="category-summary" class="glass-card p-6">
                <h3 class="text-lg font-bold mb-4 text-white">๐ ููุฎุต ุงููุฆุงุช</h3>
                <div id="category-summary-list" class="space-y-2 max-h-96 overflow-y-auto pr-2"></div>
            </div>
        </div>
    </div>
    <div id="budget-tab" class="tab-content hidden animate-fade-in">
        <div class="glass-card p-6">
            <h3 class="text-xl font-bold mb-4 text-white">โจ ุงูููุฒุงููุฉ ุงูุดูุฑูุฉ ุงูุฐููุฉ</h3>
            <div class="flex flex-col sm:flex-row items-end gap-4 mb-6 p-4 bg-slate-800/50 rounded-lg">
                <div class="flex-grow">
                    <label for="monthly-budget-input" class="block text-sm font-medium text-slate-300 mb-1">ุฃุฏุฎู ุฅุฌูุงูู ููุฒุงููุชู ุงูุดูุฑูุฉ (ุฑูุงู)</label>
                    <input type="number" id="monthly-budget-input" class="w-full p-2" placeholder="5000">
                </div>
                <button id="generate-budget-btn" class="w-full sm:w-auto px-6 py-2 magical-button text-white rounded-lg font-semibold flex-shrink-0">โจ ุฅูุดุงุก ุฎุทุฉ ุงูููุฒุงููุฉ</button>
            </div>
            <div id="budget-plan-result" class="prose max-w-none">
                <p class="text-center text-slate-400">ุฃุฏุฎู ููุฒุงููุชู ุฃุนูุงู ููุญุตูู ุนูู ุฎุทุฉ ูุฎุตุตุฉ ุจูุงุกู ุนูู ุฅููุงูู.</p>
            </div>
        </div>
    </div>
    <div id="investment-tab" class="tab-content hidden animate-fade-in">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-1 space-y-6">
                <div class="glass-card p-6 text-center">
                    <h3 class="text-lg font-bold text-white mb-2">๐ฐ ุงููููุฉ ุงูุญุงููุฉ ูููุญูุธุฉ</h3>
                    <p class="text-4xl font-bold text-emerald-400 number-display" id="investment-current-value">0.00 ุฑูุงู</p>
                    <p class="text-sm text-slate-400 mt-2">ุฅุฌูุงูู ุงููุจูุบ ุงููุณุชุซูุฑ: <span id="investment-total-invested" class="font-semibold number-display text-slate-300">0.00 ุฑูุงู</span></p>
                    <button onclick="app.openUpdateInvestmentValueModal()" class="mt-4 w-full px-4 py-2 bg-slate-600 text-slate-200 rounded-lg hover:bg-slate-700 transition-colors text-sm">โ๏ธ ุชุญุฏูุซ ุงููููุฉ ุงูุญุงููุฉ</button>
                </div>
                <div class="glass-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4">๐ธ ุฅุถุงูุฉ ุญุฑูุฉ ุงุณุชุซูุงุฑูุฉ</h3>
                    <form id="investment-form" class="space-y-4">
                        <div><label for="investment-amount" class="block text-sm font-medium text-slate-300">ุงููุจูุบ</label><input type="number" id="investment-amount" class="mt-1 w-full p-2" required></div>
                        <div><label for="investment-type" class="block text-sm font-medium text-slate-300">ููุน ุงูุญุฑูุฉ</label><select id="investment-type" class="mt-1 w-full p-2"><option value="deposit">ุฅูุฏุงุน ูููุญูุธุฉ</option><option value="withdrawal">ุณุญุจ ูู ุงููุญูุธุฉ</option></select></div>
                        <button type="submit" class="w-full magical-button text-white font-semibold py-2 rounded-lg">ุชูููุฐ ุงูุญุฑูุฉ</button>
                    </form>
                </div>
            </div>
            <div class="lg:col-span-2 glass-card overflow-hidden flex flex-col" style="height: 75vh;">
                <div class="p-4 bg-slate-800 text-center flex-shrink-0"><h3 class="text-xl font-bold text-white">๐ค ูุณุชุดุงุฑู ุงูุงุณุชุซูุงุฑู ุงูุฐูู</h3><p class="text-sm text-slate-400">ุงุณุฃู ุนู ุงูููุงููู ูุงูุงุณุชุฑุงุชูุฌูุงุช ูุงุชุฎุงุฐ ูุฑุงุฑุงุช ุฃูุถู</p></div>
                <div id="investment-ai-chat-box" class="p-4 flex-grow overflow-y-auto flex flex-col gap-4">
                    <div class="ai-bubble chat-bubble"><p>ุฃููุงู ุจู! ุฃูุง ูุฑุดุฏู ูููู ุนุงูู ุงูุงุณุชุซูุงุฑ. ููููู ุณุคุงูู ุนู ุงุณุชุฑุงุชูุฌูุงุชุ ุฃู ููุงููู ูุซู "ูุง ูู ุงูุงุณุชุซูุงุฑ ุทููู ุงูุฃุฌูุ". ุชุฐูุฑุ ุฃูุง ูุง ุฃูุฏู ูุตุงุฆุญ ูุจุงุดุฑุฉ ูุดุฑุงุก ุฃุณูู ูุนููุฉ.</p></div>
                </div>
                <div class="p-4 border-t border-slate-700 flex-shrink-0">
                    <form id="investment-ai-input-form" class="flex gap-2">
                        <input type="text" id="investment-ai-user-input" class="w-full p-3" placeholder="ุงุณุฃู ุนู ุงูุงุณุชุซูุงุฑ..." required autocomplete="off">
                        <button type="submit" class="p-3 magical-button text-white rounded-lg flex-shrink-0"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg></button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <div id="ai-assistant-tab" class="tab-content hidden animate-fade-in">
        <div class="glass-card overflow-hidden flex flex-col" style="height: 70vh;">
            <div class="p-4 bg-slate-800 text-center flex-shrink-0"><h3 class="text-xl font-bold text-white">๐ค ุงููุญูู ุงููุงูู ุงูุฐูู</h3><p class="text-sm text-slate-400">ุงุณุฃู ุฃู ุดูุก ุนู ุจูุงูุงุชู ุงููุงููุฉ ููุดูุฑ ุงููุญุฏุฏ</p></div>
            <div id="ai-chat-box" class="p-4 flex-grow overflow-y-auto flex flex-col gap-4">
                <div class="ai-bubble chat-bubble"><p>ุฃููุงู ุจู! ุฃูุง ูุณุงุนุฏู ุงููุงูู ุงูุดุงูู. ููููู ุฃู ุชุณุฃููู ุฃุณุฆูุฉ ุชูุตูููุฉ ุนู ูุถุนู ุงููุงููุ ูุซู "ูุง ูู ุฅุฌูุงูู ุฏููููุ" ุฃู "ูู ุฅููุงูู ูุฐุง ุงูุดูุฑ ูุชูุงูู ูุน ุฃูุฏุงููุ"</p></div>
            </div>
            <div class="p-4 border-t border-slate-700 flex-shrink-0">
                <form id="ai-input-form" class="flex gap-2">
                    <input type="text" id="ai-user-input" class="w-full p-3" placeholder="ุงูุชุจ ุณุคุงูู ููุง..." required autocomplete="off">
                    <button type="submit" class="p-3 magical-button text-white rounded-lg flex-shrink-0"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg></button>
                </form>
            </div>
        </div>
    </div>
    <div id="transactions-tab" class="tab-content hidden animate-fade-in">
        <div class="glass-card p-6 mb-6">
            <div class="flex flex-wrap justify-between items-center mb-4 gap-2">
                <h3 class="text-lg sm:text-xl font-bold text-white">โ ุฅุถุงูุฉ ูุนุงููุฉ ุฌุฏูุฏุฉ</h3>
                <button id="paste-from-clipboard-btn" class="flex items-center gap-2 px-3 py-2 bg-violet-500/20 text-violet-300 rounded-lg hover:bg-violet-500/30 transition-colors text-sm font-semibold">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard-plus" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/><path fill-rule="evenodd" d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zM8 7a.5.5 0 0 1 .5.5V9H10a.5.5 0 0 1 0 1H8.5v1.5a.5.5 0 0 1-1 0V10H6a.5.5 0 0 1 0-1h1.5V7.5A.5.5 0 0 1 8 7z"/></svg>
                    ูุตู ูู ุงูุญุงูุธุฉ
                </button>
            </div>
            <form id="transaction-form" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 items-end">
                <div><label class="block text-sm font-medium text-slate-300 mb-2">ูุณููุฉ ุงูุฏูุน</label><select id="payment-method" class="w-full p-3"><option value="mada-bank">๐ฆ ูุฏู/ุญุณุงุจ ุจููู</option><option value="cash">๐ต ููุฏู</option><option value="snb-card">๐ณ SNB ุงูุฃููู (ุจุทุงูุฉ)</option><option value="enbd-card">๐ณ ENBD ุงูุฅูุงุฑุงุช (ุจุทุงูุฉ)</option><option value="tabby-bnpl">๐ฑ ุชุงุจู (BNPL)</option><option value="tamara-bnpl">๐ฑ ุชูุงุฑุง (BNPL)</option></select></div>
                <div><label class="block text-sm font-medium text-slate-300 mb-2">ููุน ุงูุญุฑูุฉ</label><select id="transaction-type" class="w-full p-3"><option value="income">๐ฐ ุฏุฎู</option><option value="expense" selected>๐ธ ูุตุงุฑูู</option><option value="snb-payment">๐ณ ุณุฏุงุฏ ุจุทุงูุฉ SNB</option><option value="enbd-payment">๐ณ ุณุฏุงุฏ ุจุทุงูุฉ ENBD</option></select></div>
                <div><label class="block text-sm font-medium text-slate-300 mb-2">ุงููุจูุบ (ุฑูุงู)</label><input type="number" id="transaction-amount" class="w-full p-3" placeholder="0.00" step="0.01" required></div>
                <div><label class="block text-sm font-medium text-slate-300 mb-2">ุชุงุฑูุฎ ุงููุนุงููุฉ</label><input type="date" id="transaction-date" class="w-full p-3"></div>
                <div><label class="block text-sm font-medium text-slate-300 mb-2">ุงููุฆุฉ</label><select id="transaction-category" class="w-full p-3"></select></div>
                <div class="lg:col-span-4"><label class="block text-sm font-medium text-slate-300 mb-2">ุงููุตู</label><input type="text" id="transaction-description" class="w-full p-3" placeholder="ูุตู ุงููุนุงููุฉ" required></div>
                
                <div id="installments-field" class="hidden"><label class="block text-sm font-medium text-slate-300 mb-2">ุนุฏุฏ ุงูุฃูุณุงุท</label><select id="installments-count" class="w-full p-3"><option value="2">ูุณุทูู (2)</option><option value="3">3 ุฃูุณุงุท</option><option value="4" selected>4 ุฃูุณุงุท</option></select></div>
                
                <div id="bnpl-payment-source-field" class="hidden">
                    <label class="block text-sm font-medium text-slate-300 mb-2">ูุตุฏุฑ ุงูุฏูุนุฉ ุงูุฃููู</label>
                    <select id="bnpl-payment-source" class="w-full p-3">
                        <option value="mada-bank">๐ฆ ูุฏู/ุญุณุงุจ ุจููู</option>
                        <option value="snb-card">๐ณ SNB ุงูุฃููู (ุจุทุงูุฉ)</option>
                        <option value="enbd-card">๐ณ ENBD ุงูุฅูุงุฑุงุช (ุจุทุงูุฉ)</option>
                        <option value="cash">๐ต ููุฏู</option>
                    </select>
                </div>

                <div class="lg:col-span-1 flex items-end"><button type="submit" class="w-full px-8 py-3 magical-button text-white rounded-lg font-semibold">โจ ุฅุถุงูุฉ โจ</button></div>
            </form>
        </div>
        <div class="glass-card p-6">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 gap-4">
                <h3 class="text-lg sm:text-xl font-bold text-white">๐ ุณุฌู ุงููุนุงููุงุช</h3>
                <div class="flex flex-col md:flex-row gap-2 w-full md:w-auto">
                    <input type="text" id="search-transactions" placeholder="๐ ุงูุจุญุซ..." class="p-2 w-full md:w-64">
                    <select id="filter-payment-method" class="p-2"><option value="">ูู ุงููุณุงุฆู</option><option value="mada-bank">๐ฆ ุจูู</option><option value="cash">๐ต ููุฏู</option><option value="snb-card">๐ณ SNB</option><option value="enbd-card">๐ณ ENBD</option><option value="tabby-bnpl">๐ฑ ุชุงุจู</option><option value="tamara-bnpl">๐ฑ ุชูุงุฑุง</option></select>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-sm">
                    <thead class="border-b border-slate-700"><tr><th class="text-right py-3 px-4 font-semibold">ุงูุชุงุฑูุฎ</th><th class="text-right py-3 px-4 font-semibold">ุงููุณููุฉ</th><th class="text-right py-3 px-4 font-semibold">ุงูููุน</th><th class="text-right py-3 px-4 font-semibold">ุงููุจูุบ</th><th class="text-right py-3 px-4 font-semibold">ุงููุฆุฉ</th><th class="text-right py-3 px-4 font-semibold hidden sm:table-cell">ุงููุตู</th><th class="text-center py-3 px-4 font-semibold">ุฅุฌุฑุงุก</th></tr></thead>
                    <tbody id="transactions-list"></tbody>
                </table>
            </div>
        </div>
    </div>
    <div id="cards-tab" class="tab-content hidden animate-fade-in">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <div class="glass-card p-6">
                <div class="flex items-center justify-between mb-4"><h3 class="text-xl font-bold text-white">๐ณ ุจุทุงูุฉ SNB ุงูุฃููู</h3><button onclick="app.openEditCardModal('snb')" class="text-sm bg-slate-700/50 hover:bg-slate-700 p-2 rounded-full transition">โ๏ธ ุชุนุฏูู</button></div>
                <div class="space-y-3">
                    <div class="flex justify-between"><span>ุงูุฑุตูุฏ ุงููุณุชุญู:</span><span class="font-bold number-display" id="snb-balance-display">0 ุฑูุงู</span></div>
                    <div class="flex justify-between"><span>ุงูุญุฏ ุงูุงุฆุชูุงูู:</span><span class="font-bold number-display" id="snb-limit-display">26,000 ุฑูุงู</span></div>
                    <div class="flex justify-between"><span>ุงูุฑุตูุฏ ุงููุชุงุญ:</span><span class="font-bold number-display text-emerald-400" id="snb-available-display">0 ุฑูุงู</span></div>
                    <div class="flex justify-between"><span>ููู ุงูุงุณุชุญูุงู:</span><span class="font-bold" id="snb-due-day-display">ููู 15</span></div>
                    <div class="mt-4 bg-slate-700 rounded-full h-3"><div class="bg-blue-500 rounded-full h-3" id="snb-progress-bar" style="width: 0%"></div></div>
                    <p class="text-xs text-slate-400 text-center">ูุณุจุฉ ุงูุงุณุชุฎุฏุงู: <span id="snb-usage-display">0%</span></p>
                </div>
            </div>
            <div class="glass-card p-6">
                <div class="flex items-center justify-between mb-4"><h3 class="text-xl font-bold text-white">๐ณ ุจุทุงูุฉ ENBD ุงูุฅูุงุฑุงุช</h3><button onclick="app.openEditCardModal('enbd')" class="text-sm bg-slate-700/50 hover:bg-slate-700 p-2 rounded-full transition">โ๏ธ ุชุนุฏูู</button></div>
                <div class="space-y-3">
                    <div class="flex justify-between"><span>ุงูุฑุตูุฏ ุงููุณุชุญู:</span><span class="font-bold number-display" id="enbd-balance-display">0 ุฑูุงู</span></div>
                    <div class="flex justify-between"><span>ุงูุญุฏ ุงูุงุฆุชูุงูู:</span><span class="font-bold number-display" id="enbd-limit-display">10,000 ุฑูุงู</span></div>
                    <div class="flex justify-between"><span>ุงูุฑุตูุฏ ุงููุชุงุญ:</span><span class="font-bold number-display text-emerald-400" id="enbd-available-display">0 ุฑูุงู</span></div>
                    <div class="flex justify-between"><span>ููู ุงูุงุณุชุญูุงู:</span><span class="font-bold" id="enbd-due-day-display">ููู 18</span></div>
                    <div class="mt-4 bg-slate-700 rounded-full h-3"><div class="bg-red-500 rounded-full h-3" id="enbd-progress-bar" style="width: 0%"></div></div>
                    <p class="text-xs text-slate-400 text-center">ูุณุจุฉ ุงูุงุณุชุฎุฏุงู: <span id="enbd-usage-display">0%</span></p>
                </div>
            </div>
        </div>
        <div class="glass-card p-6">
            <h3 class="text-xl font-bold mb-4 text-white">๐ ุชุงุฑูุฎ ูุนุงููุงุช ุงูุจุทุงูุงุช</h3>
            <div class="overflow-x-auto"><table class="w-full text-sm"><thead class="border-b border-slate-700"><tr><th class="text-right p-3 font-semibold">ุงูุชุงุฑูุฎ</th><th class="text-right p-3 font-semibold">ุงูุจุทุงูุฉ</th><th class="text-right p-3 font-semibold">ููุน ุงูุนูููุฉ</th><th class="text-right p-3 font-semibold">ุงููุจูุบ</th><th class="text-right p-3 font-semibold">ุงููุตู</th></tr></thead><tbody id="cards-transactions-list"></tbody></table></div>
        </div>
    </div>
    <div id="bank-tab" class="tab-content hidden animate-fade-in">
        <div class="glass-card p-6 mb-6">
            <div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold text-white">๐ฆ ุฅุฏุงุฑุฉ ุงูุญุณุงุจ ุงูุจููู</h3><button onclick="app.openEditBankModal()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm">โ๏ธ ุชุนุฏูู ุงูุฑุตูุฏ / ุชุณููุฉ</button></div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="text-center p-6 bg-blue-900/30 rounded-lg border border-blue-500/30"><div class="text-3xl mb-3">๐ฐ</div><p class="text-blue-300 font-semibold">ุงูุฑุตูุฏ ุงูุญุงูู</p><p class="text-2xl font-bold text-blue-300 number-display" id="bank-balance">0 ุฑูุงู</p></div>
                <div class="text-center p-6 bg-emerald-900/30 rounded-lg border border-emerald-500/30"><div class="text-3xl mb-3">๐</div><p class="text-emerald-300 font-semibold">ุฅุฌูุงูู ุงูุฅูุฏุงุนุงุช</p><p class="text-2xl font-bold text-emerald-300 number-display" id="bank-deposits">0 ุฑูุงู</p></div>
                <div class="text-center p-6 bg-red-900/30 rounded-lg border border-red-500/30"><div class="text-3xl mb-3">๐</div><p class="text-red-300 font-semibold">ุฅุฌูุงูู ุงูุณุญูุจุงุช</p><p class="text-2xl font-bold text-red-300 number-display" id="bank-withdrawals">0 ุฑูุงู</p></div>
            </div>
        </div>
        <div class="glass-card p-6">
            <h3 class="text-xl font-bold mb-4 text-white">๐ ูุนุงููุงุช ุงูุญุณุงุจ ุงูุจููู</h3>
            <div class="overflow-x-auto"><table class="w-full text-sm"><thead class="border-b border-slate-700"><tr><th class="text-right p-3 font-semibold">ุงูุชุงุฑูุฎ</th><th class="text-right p-3 font-semibold">ุงูููุน</th><th class="text-right p-3 font-semibold">ุงููุจูุบ</th><th class="text-right p-3 font-semibold">ุงููุฆุฉ</th><th class="text-right p-3 font-semibold">ุงููุตู</th></tr></thead><tbody id="bank-transactions-list"></tbody></table></div>
        </div>
    </div>
    <div id="installments-tab" class="tab-content hidden animate-fade-in">
        <h3 class="text-2xl font-bold mb-4 text-white">๐ฑ ุฎุทุท ุงูุฃูุณุงุท ุงููุดุทุฉ</h3>
        <div id="active-installments-list" class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6"></div>
        <div class="glass-card p-6 mt-8">
            <h3 class="text-xl font-bold mb-4 text-white">๐ ุณุฌู ูุนุงููุงุช ุงูุฃูุณุงุท</h3>
            <div class="overflow-x-auto"><table class="w-full text-sm"><thead class="border-b border-slate-700"><tr><th class="text-right p-3 font-semibold">ุงูุชุงุฑูุฎ</th><th class="text-right p-3 font-semibold">ุงูููุตุฉ/ุงููุตุฏุฑ</th><th class="text-right p-3 font-semibold">ุงูููุน</th><th class="text-right p-3 font-semibold">ุงููุจูุบ</th><th class="text-right p-3 font-semibold">ุงููุตู</th></tr></thead><tbody id="installments-transactions-list"></tbody></table></div>
        </div>
    </div>
    <div id="categories-tab" class="tab-content hidden animate-fade-in">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="glass-card p-6">
                <h3 class="text-xl font-bold text-white mb-4">โ ุฅุถุงูุฉ ูุฆุฉ ุฌุฏูุฏุฉ</h3>
                <form id="category-form" class="space-y-4">
                    <div><label for="category-name" class="block text-sm font-medium text-slate-300 mb-1">ุงุณู ุงููุฆุฉ</label><input type="text" id="category-name" class="w-full p-2" required></div>
                    <div class="flex items-end gap-2">
                        <div class="flex-grow"><label for="category-icon" class="block text-sm font-medium text-slate-300 mb-1">ุงูุฃููููุฉ</label><input type="text" id="category-icon" class="w-full p-2" required placeholder="๐"></div>
                        <button type="button" id="suggest-icon-btn" title="ุงูุชุฑุงุญ ุฃููููุฉ ุฐููุฉ" class="p-2 bg-violet-500/30 text-violet-300 rounded-lg hover:bg-violet-500/40 h-10 w-10 flex-shrink-0">โจ</button>
                    </div>
                    <div><button type="submit" class="w-full px-6 py-2.5 magical-button text-white rounded-lg font-semibold">โจ ุฅุถุงูุฉ ุงููุฆุฉ</button></div>
                </form>
            </div>
            <div class="glass-card p-6">
                <h3 class="text-xl font-bold text-white mb-4">๐ ุงููุฆุงุช ุงูุญุงููุฉ</h3>
                <div id="categories-list" class="space-y-2 max-h-96 overflow-y-auto"></div>
            </div>
        </div>
    </div>
    <div id="export-tab" class="tab-content hidden animate-fade-in">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <div class="glass-card p-6"><h3 class="text-xl font-bold text-white mb-4">๐ ุชุตุฏูุฑ ุฅูู Excel</h3><p class="text-slate-400 mb-4">ูู ุจุชุตุฏูุฑ ุจูุงูุงุช ุงููุชุฑุฉ ุงููุญุฏุฏุฉ ุฅูู ููู Excel.</p><button onclick="app.exportToExcel()" class="w-full mt-4 px-6 py-3 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg font-semibold">๐ ุชุตุฏูุฑ ุฅูู Excel</button></div>
            <div class="glass-card p-6"><h3 class="text-xl font-bold text-white mb-4">๐ ุชูุฑูุฑ PDF</h3><p class="text-slate-400 mb-4">ุฅูุดุงุก ุชูุฑูุฑ ูุงูู ุดุงูู ูููุชุฑุฉ ุงููุญุฏุฏุฉ ุจุตูุบุฉ PDF.</p><button onclick="app.generatePDFReport()" class="w-full mt-4 px-6 py-3 bg-red-600 hover:bg-red-700 text-white rounded-lg font-semibold">๐ ุฅูุดุงุก ุชูุฑูุฑ PDF</button></div>
        </div>
        <div class="glass-card p-6 mb-6">
            <h3 class="text-xl font-bold mb-4 text-white">โจ ุชูุฎูุต ุฐูู ููุชูุฑูุฑ</h3>
            <p class="text-slate-400 mb-4">ุงุญุตู ุนูู ููุฎุต ุณุฑูุน ููุญุชุฑู ููุถุนู ุงููุงูู ูู ุงููุชุฑุฉ ุงููุญุฏุฏุฉ.</p>
            <button id="smart-summary-btn" class="w-full magical-button text-white font-semibold px-6 py-3 rounded-lg">โจ ุฅูุดุงุก ููุฎุต ุฐูู</button>
            <div id="smart-summary-result" class="mt-4 p-4 bg-slate-800 rounded-lg text-slate-300 prose max-w-none hidden"></div>
        </div>
        <div class="glass-card p-6">
            <h3 class="text-xl font-bold text-white mb-4">๐พ ุงููุณุฎ ุงูุงุญุชูุงุทู ูุงูุงุณุชุนุงุฏุฉ</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div><h4 class="font-semibold text-slate-200 mb-3">๐ค ุฅูุดุงุก ูุณุฎุฉ ุงุญุชูุงุทูุฉ</h4><p class="text-slate-400 mb-4 text-sm">ุงุญูุธ ุฌููุน ุจูุงูุงุชู ูู ููู ุขูู.</p><button onclick="app.createBackup()" class="w-full px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">๐พ ุฅูุดุงุก ูุณุฎุฉ ุงุญุชูุงุทูุฉ</button></div>
                <div><h4 class="font-semibold text-slate-200 mb-3">๐ฅ ุงุณุชุนุงุฏุฉ ุงูุจูุงูุงุช</h4><p class="text-slate-400 mb-4 text-sm">ุงุณุชุนุฏ ุจูุงูุงุชู ูู ููู ูุณุฎุฉ ุงุญุชูุงุทูุฉ.</p><input type="file" id="backup-file" accept=".json" class="hidden"><button onclick="document.getElementById('backup-file').click()" class="w-full px-4 py-2 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg transition-colors">๐ฅ ุงุณุชุนุงุฏุฉ ุงูุจูุงูุงุช</button></div>
            </div>
        </div>
        <div class="bg-red-900/30 text-red-300 rounded-xl p-6 border border-red-500/30 mt-6">
            <h3 class="text-xl font-bold mb-2">โ๏ธ ููุทูุฉ ุงูุฎุทุฑ</h3>
            <p class="text-sm mb-4">ุณูุคุฏู ูุฐุง ุงูุฅุฌุฑุงุก ุฅูู ุญุฐู ุฅุนุฏุงุฏุงุช ุงูุงุชุตุงู ุงููุญููุธุฉ ูู ูุชุตูุญู. ุณุชุญุชุงุฌ ุฅูู ุฅุฏุฎุงููุง ูุฑุฉ ุฃุฎุฑู ุนูุฏ ูุชุญ ุงูุชุทุจูู ูู ุงููุฑุฉ ุงููุงุฏูุฉ.</p>
            <button onclick="app.clearFirebaseConfig()" class="w-full px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg transition-colors">ูุณุญ ุฅุนุฏุงุฏุงุช ุงูุงุชุตุงู</button>
        </div>
    </div>
  </main>

  <div id="custom-modal" class="modal-overlay">
    <div class="modal-content">
      <h2 id="modal-title" class="text-2xl font-bold mb-4 text-white"></h2>
      <div id="modal-body" class="text-slate-300"></div>
      <div class="flex justify-end gap-3 mt-6">
        <button id="modal-cancel" class="px-6 py-2 bg-slate-600 text-slate-200 rounded-lg hover:bg-slate-700 transition-colors">ุฅูุบุงุก</button>
        <button id="modal-confirm" class="px-6 py-2 bg-violet-600 text-white rounded-lg hover:bg-violet-700 transition-colors">ููุงูู</button>
      </div>
    </div>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import { getAuth, onAuthStateChanged, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
  import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

  const ExpenseApp = (function() {
    window.app = {};
    var db, auth, userId, docRef, unsubscribe, apiKey;
    var state = getInitialState();
    var selectedYear, selectedMonth;
    var currentEditTransactionId = null;

    const GEMINI_PROMPTS = {
      FINANCIAL_ANALYST: `You are an expert financial analyst assistant, "ุงููุญูู ุงูุฐูู". You have full access to the user's financial data for a specific period. Your purpose is to provide detailed, insightful analysis and answer complex questions in Arabic based ONLY on the data provided for that period.
- Today's date is ${new Date().toLocaleDateString('en-CA')}.
- Analyze the user's provided financial state (transactions, card details, bank balance, investments, installments) for the specified period to answer their query.
- Be thorough. Connect different parts of their financial data to give holistic answers.
- DO NOT just state data, INTERPRET it. Provide insights, identify trends, and offer observations.
- Be friendly, professional, and act as a true financial advisor.`,
      INVESTMENT_COACH: `You are an educational investment coach named "ุงููุณุชุดุงุฑ ุงูุฐูู". Your primary role is to educate the user about investment concepts and strategies, particularly within the context of the Saudi stock market (Tadawul).
- You MUST NOT give direct financial advice. Do not recommend buying or selling specific stocks (e.g., "Buy Aramco").
- When asked for a recommendation, you MUST politely decline and instead explain HOW the user can research and make their own informed decisions.
- Your tone should be encouraging, educational, and responsible.
- Keep your answers clear, concise, and in Arabic.`,
      PASTE_ANALYZER: `You are an intelligent data extraction tool for Arabic financial transaction SMS messages from Saudi Arabia. Analyze the provided text and respond ONLY with a valid JSON object with the keys: "merchant", "amount", "date", "paymentMethod", and "categoryId".
- The 'date' should be in "YYYY-MM-DD" format. Note that dates in the text might be in "DD/MM/YY" format; correctly convert them (e.g., '01/09/25' becomes '2025-09-01').
- The 'amount' is the primary transaction amount; ignore any remaining balance figures.
- The 'merchant' is the store or service name (e.g., 'BINDAWOOD', 'Adel Inte').
- For the 'paymentMethod', you MUST use one of the following specific values: ['mada-bank', 'snb-card', 'enbd-card', 'tabby-bnpl', 'tamara-bnpl', 'cash'].
- **Mapping Rules for paymentMethod:**
  - If the text contains 'SNB', 'ุงูุฃููู', or 'ุฅุฆุชูุงููุฉ', use 'snb-card'.
  - If the text contains 'ENBD', 'ุงูุฅูุงุฑุงุช', or 'Visa card', use 'enbd-card'.
  - If the text contains 'ูุฏู', 'mada', 'Alrajhi', 'ุงูุฑุงุฌุญู', 'Inma', 'ุงูุฅููุงุก' or the word 'ุจูู' or 'ุญุณุงุจ', use 'mada-bank'.
- For the 'categoryId', analyze the merchant name and suggest the most relevant ID from the provided list of available categories. If unsure, use the ID for 'ุฃุฎุฑู'.`,
      ICON_SUGGESTER: "You are an emoji expert. Your task is to suggest a single, relevant emoji for a given category name. You must respond with ONLY the emoji character and nothing else.",
      SMART_SUMMARY_GENERATOR: `You are a professional financial analyst. Your task is to write a concise, one-paragraph summary of a user's financial situation based on the provided data for a specific period. The summary should be in Arabic, professional in tone, and suitable for the beginning of a financial report. Highlight the key figures like total income, total expenses, and the net result for that period.`,
      BUDGET_PLANNER: `You are a helpful and encouraging financial planning assistant in Arabic. Your goal is to help the user create a realistic monthly budget based on their spending history and a total budget amount they provide. Use the 50/30/20 rule (50% for Needs, 30% for Wants, 20% for Savings/Debt) as a general framework, but you MUST adapt it to the user's actual spending patterns revealed in their transaction data. Your response MUST be in Arabic and formatted using Markdown. It should contain: 1. A brief, encouraging introductory sentence. 2. A breakdown of the total budget into Needs, Wants, and Savings, with the suggested amount for each. 3. A detailed table with three columns: "ุงููุฆุฉ", "ุงููุจูุบ ุงูููุชุฑุญ", and "ููุงุญุธุงุช". 4. In the table, allocate the "Needs" and "Wants" amounts across the user's actual spending categories. 5. The "Notes" column should provide a brief justification. 6. Conclude with a short, motivational tip.`
    };
    
    var yearFilter = document.getElementById('year-filter');
    var monthFilter = document.getElementById('month-filter');
      
    function init() {
        Object.assign(window.app, { showTab, createBackup, exportToExcel, generatePDFReport, openEditCardModal, openEditBankModal, handlePayInstallment, openEditCategoryModal, handleDeleteCategory, openUpdateInvestmentValueModal, clearFirebaseConfig });
        initializeEventListeners();
        populateDateFilters();
        initializeFirebase();
    }

    function getInitialState() {
        return {
            transactions: [],
            cards: { snb: { limit: 26000, dueDay: 15 }, enbd: { limit: 10000, dueDay: 18 } },
            bank: { balance: 0 },
            categories: [ { id: 'cat-1', name: 'ุจูุงูุฉ', icon: '๐' }, { id: 'cat-2', name: 'ูุทุงุนู', icon: '๐' }, { id: 'cat-3', name: 'ูููุฏ', icon: 'โฝ' }, { id: 'cat-4', name: 'ููุงุชูุฑ', icon: '๐งพ' }, { id: 'cat-9', name: 'ุณุฏุงุฏ ููุงุชูุฑ', icon: '๐ณ' }, { id: 'cat-5', name: 'ุชุณูู', icon: '๐๏ธ' }, { id: 'cat-6', name: 'ุฅูุฌุงุฑ', icon: '๐' },{ id: 'cat-8', name: 'ุตูุฏููุฉ', icon: '๐' }, { id: 'cat-7', name: 'ุฃุฎุฑู', icon: '๐ธ' }, ],
            installments: [],
            investments: { currentValue: 0 }
        };
    }

    function initializeFirebase() { 
        try { 
            let firebaseConfig;
            if (typeof __firebase_config !== 'undefined' && __firebase_config) {
                firebaseConfig = JSON.parse(__firebase_config);
            } else {
                const storedConfig = localStorage.getItem('firebaseConfig');
                if (storedConfig) {
                    firebaseConfig = JSON.parse(storedConfig);
                }
            }
            if (!firebaseConfig) {
                promptForFirebaseConfig();
                return;
            }
            apiKey = firebaseConfig.apiKey;
            const firebaseApp = initializeApp(firebaseConfig); 
            db = getFirestore(firebaseApp); 
            auth = getAuth(firebaseApp); 
            setupAuthListener(); 
        } catch (error) { 
            console.error("Firebase initialization failed:", error); 
            localStorage.removeItem('firebaseConfig');
            showError("ูุดู ูู ุชููุฆุฉ ุงูุชุทุจูู. ูุฏ ุชููู ุงูุฅุนุฏุงุฏุงุช ุบูุฑ ุตุงูุญุฉ. ุณูุชู ุฅุนุงุฏุฉ ุชุญููู ุงูุตูุญุฉ.");
            setTimeout(() => location.reload(), 3000);
        } 
    }

    function setupAuthListener() { 
        onAuthStateChanged(auth, async (user) => { 
            if (user) { 
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'; 
                userId = user.uid; 
                docRef = doc(db, `artifacts/${appId}/users/${userId}/expenses-data/main`); 
                setupRealtimeListener(); 
            } else { 
                try { 
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) { 
                        await signInWithCustomToken(auth, __initial_auth_token); 
                    } else { 
                        await signInAnonymously(auth); 
                    } 
                } catch(error) { 
                    console.error("Authentication failed:", error); 
                    showError("ูุดู ุงููุตุงุฏูุฉ. ูุง ูููู ุชุญููู ุงูุจูุงูุงุช."); 
                } 
            } 
        }); 
    }

    function setupRealtimeListener() { 
        if (unsubscribe) unsubscribe(); 
        unsubscribe = onSnapshot(docRef, (doc) => { 
            if (doc.exists()) { 
                const data = doc.data(); 
                state = { ...getInitialState(), ...data }; 
                if(!state.investments) state.investments = getInitialState().investments; 
            } else { 
                saveStateToFirebase(); 
            }
            renderAll();
            showLoadingOverlay(false); 
        }, (error) => { 
            console.error("Error listening to document:", error); 
            showError("ุฎุทุฃ ูู ุงูุงุชุตุงู ุจุงูุฎุงุฏู. ุญุงูู ุชุญุฏูุซ ุงูุตูุญุฉ."); 
        }); 
    }

    async function saveStateToFirebase() {
        if (!docRef) return;
        try {
            const cleanState = JSON.parse(JSON.stringify(state));
            await setDoc(docRef, cleanState, { merge: true });
        } catch (error) {
            console.error("Error saving state:", error);
            showError("ูุดู ุญูุธ ุงูุจูุงูุงุช.");
        }
    }

    function renderAll() {
        const calculations = calculateSummaries();
        renderSummary(calculations);
        renderInvestmentTab(calculations);
        renderCardDetails(calculations);
        renderBankDetails(calculations);
        renderTransactionList();
        renderInstallments();
        renderCategories();
        updateCategoryDropdowns();
        renderCategorySummary(calculations);
    }

    function initializeEventListeners() {
        document.getElementById('transaction-form').addEventListener('submit', handleTransactionFormSubmit);
        document.getElementById('category-form').addEventListener('submit', handleCategoryFormSubmit);
        document.getElementById('transactions-list').addEventListener('click', handleTransactionActions);
        document.getElementById('payment-method').addEventListener('change', handlePaymentMethodChange);
        document.getElementById('transaction-type').addEventListener('change', handleTransactionTypeChange);
        document.getElementById('search-transactions').addEventListener('input', renderTransactionList);
        document.getElementById('filter-payment-method').addEventListener('change', renderTransactionList);
        document.getElementById('modal-cancel').addEventListener('click', hideModal);
        document.querySelector('.modal-overlay').addEventListener('click', e => { if (e.target === e.currentTarget) hideModal(); });
        document.getElementById('backup-file').addEventListener('change', handleRestoreBackup);
        document.getElementById('ai-input-form').addEventListener('submit', handleAIChatSubmit);
        document.getElementById('investment-ai-input-form').addEventListener('submit', handleInvestmentAIChatSubmit);
        document.getElementById('investment-form').addEventListener('submit', handleInvestmentFormSubmit);
        document.getElementById('paste-from-clipboard-btn').addEventListener('click', handlePasteFromClipboard);
        document.getElementById('suggest-icon-btn').addEventListener('click', handleSuggestCategoryIcon);
        document.getElementById('generate-budget-btn').addEventListener('click', handleGenerateBudget);
        document.getElementById('smart-summary-btn').addEventListener('click', handleSmartSummary);
        
        yearFilter.addEventListener('change', handleDateFilterChange);
        monthFilter.addEventListener('change', handleDateFilterChange);
    }

    function handleTransactionActions(e) {
        const button = e.target.closest('button');
        if (!button) return;
        const action = button.dataset.action;
        const id = button.dataset.id;
        if (action === 'edit') {
            openEditTransactionModal(id);
        } else if (action === 'delete') {
            handleDeleteTransaction(id);
        }
    }

    function handleTransactionFormSubmit(e) {
        e.preventDefault();
        
        const paymentMethod = document.getElementById('payment-method').value;
        const description = document.getElementById('transaction-description').value.trim();
        const totalAmount = parseFloat(document.getElementById('transaction-amount').value);
        const date = document.getElementById('transaction-date').value || new Date().toISOString().split('T')[0];
        const categoryId = document.getElementById('transaction-category').value;
        const type = document.getElementById('transaction-type').value;

        if (!description) {
            showError("ุงูุฑุฌุงุก ุฅุฏุฎุงู ูุตู ูููุนุงููุฉ.");
            return;
        }
        if (isNaN(totalAmount) || totalAmount <= 0) {
            showError("ุงูุฑุฌุงุก ุฅุฏุฎุงู ูุจูุบ ุตุญูุญ.");
            return;
        }
        
        // --- NEW LOGIC FOR BNPL (Buy Now, Pay Later) ---
        if (paymentMethod.includes('bnpl') && !currentEditTransactionId) {
            const installmentsCount = parseInt(document.getElementById('installments-count').value, 10);
            const firstPaymentSource = document.getElementById('bnpl-payment-source').value;
            const installmentAmount = totalAmount / installmentsCount;

            // 1. Create the Installment Plan
            const newInstallmentPlan = {
                id: `inst-${Date.now()}`,
                provider: paymentMethod,
                description: description,
                totalAmount: totalAmount,
                installmentAmount: installmentAmount,
                total: installmentsCount,
                paid: 1, // First payment is made now
                createdAt: date
            };
            state.installments.push(newInstallmentPlan);

            // 2. Create the Transaction for the FIRST payment
            const firstPaymentTransaction = {
                id: `trans-${Date.now()}`,
                amount: installmentAmount,
                date: date,
                description: `ุงูุฏูุนุฉ ุงูุฃููู ูู: ${description}`,
                paymentMethod: firstPaymentSource, // Source of the payment
                type: 'bnpl-payment',
                categoryId: categoryId, // Original category
                isInstallmentPayment: true,
                installmentId: newInstallmentPlan.id
            };
            state.transactions.push(firstPaymentTransaction);

        } else { // --- EXISTING LOGIC FOR OTHER TRANSACTIONS & EDITS ---
            const formData = {
                amount: totalAmount,
                date,
                description,
                paymentMethod,
                type,
                categoryId,
            };

            if (currentEditTransactionId) {
                const index = state.transactions.findIndex(t => t.id === currentEditTransactionId);
                if (index !== -1) {
                    // Note: Editing BNPL transactions is complex and not fully handled here.
                    // This primarily handles standard transaction edits.
                    state.transactions[index] = { ...state.transactions[index], ...formData };
                }
            } else {
                const newTransaction = { id: `trans-${Date.now()}`, ...formData };
                state.transactions.push(newTransaction);
            }
        }
        
        saveStateToFirebase();
        document.getElementById('transaction-form').reset();
        document.getElementById('transaction-date').value = new Date().toISOString().split('T')[0];
        currentEditTransactionId = null;
        document.querySelector('#transaction-form button[type="submit"]').textContent = 'โจ ุฅุถุงูุฉ โจ';
        handleTransactionTypeChange(); // Reset form fields visibility
        showTab('summary');
    }

    function handleDeleteTransaction(id) {
        showModal("ุญุฐู ุงููุนุงููุฉ", "<p>ูู ุฃูุช ูุชุฃูุฏ ูู ุฑุบุจุชู ูู ุญุฐู ูุฐู ุงููุนุงููุฉุ ูุง ูููู ุงูุชุฑุงุฌุน ุนู ูุฐุง ุงูุฅุฌุฑุงุก.</p>", {
            confirmText: 'ูุนูุ ุญุฐู',
            onConfirm: () => {
                state.transactions = state.transactions.filter(t => t.id !== id);
                // Future improvement: Add logic to handle deleting an installment payment,
                // which might involve adjusting the 'paid' count on the installment plan.
                saveStateToFirebase();
                return true;
            }
        });
    }

    function handleCategoryFormSubmit(e) {
        e.preventDefault();
        const name = document.getElementById('category-name').value.trim();
        const icon = document.getElementById('category-icon').value.trim();
        if (!name || !icon) {
            showError("ุงูุฑุฌุงุก ุฅุฏุฎุงู ุงุณู ูุฃููููุฉ ูููุฆุฉ.");
            return;
        }
        state.categories.push({ id: `cat-${Date.now()}`, name, icon });
        saveStateToFirebase();
        document.getElementById('category-form').reset();
    }

    function handlePaymentMethodChange(e) {
        const method = e.target.value;
        const installmentsField = document.getElementById('installments-field');
        const bnplSourceField = document.getElementById('bnpl-payment-source-field');
        const transactionTypeEl = document.getElementById('transaction-type');

        if (method.includes('bnpl')) {
            installmentsField.classList.remove('hidden');
            bnplSourceField.classList.remove('hidden');
            transactionTypeEl.value = 'expense';
            transactionTypeEl.disabled = true;
        } else {
            installmentsField.classList.add('hidden');
            bnplSourceField.classList.add('hidden');
            transactionTypeEl.disabled = false;
        }
    }

    function handleTransactionTypeChange() {
        const type = document.getElementById('transaction-type').value;
        const paymentMethodEl = document.getElementById('payment-method');
        paymentMethodEl.disabled = false;
        
        for (let i = 0; i < paymentMethodEl.options.length; i++) {
            paymentMethodEl.options[i].style.display = '';
        }

        if (type === 'snb-payment') {
            for (let i = 0; i < paymentMethodEl.options.length; i++) {
                if (paymentMethodEl.options[i].value === 'snb-card' || paymentMethodEl.options[i].value.includes('bnpl')) {
                    paymentMethodEl.options[i].style.display = 'none';
                }
            }
            if (paymentMethodEl.value === 'snb-card') paymentMethodEl.value = 'mada-bank';
        } else if (type === 'enbd-payment') {
            for (let i = 0; i < paymentMethodEl.options.length; i++) {
                if (paymentMethodEl.options[i].value === 'enbd-card' || paymentMethodEl.options[i].value.includes('bnpl')) {
                    paymentMethodEl.options[i].style.display = 'none';
                }
            }
            if (paymentMethodEl.value === 'enbd-card') paymentMethodEl.value = 'mada-bank';
        }
        
        handlePaymentMethodChange({ target: paymentMethodEl });
    }

    function handlePayInstallment(installmentId) {
ย ย ย ย const installment = findInstallmentById(installmentId);
ย ย ย ย if (!installment || installment.paid >= installment.total) return;

ย ย ย ย const body = `
ย ย ย ย ย ย <p class="mb-4">ุงุฎุชุฑ ูุตุฏุฑ ุงูุฏูุน ูุณุฏุงุฏ ูุณุท "${installment.description}" ุจูููุฉ ${formatCurrency(installment.installmentAmount)} ุฑูุงู.</p>
ย ย ย ย ย ย <div>
ย ย ย ย ย ย ย ย <label for="installment-payment-source" class="block text-sm font-medium text-slate-300 mb-2">ูุตุฏุฑ ุงูุฏูุน</label>
ย ย ย ย ย ย ย ย <select id="installment-payment-source" class="w-full p-3">
ย ย ย ย ย ย ย ย ย ย <option value="mada-bank">๐ฆ ูุฏู/ุญุณุงุจ ุจููู</option>
ย ย ย ย ย ย ย ย ย ย <option value="cash">๐ต ููุฏู</option>
ย ย ย ย ย ย ย ย ย ย <option value="snb-card">๐ณ SNB ุงูุฃููู (ุจุทุงูุฉ)</option>
ย ย ย ย ย ย ย ย ย ย <option value="enbd-card">๐ณ ENBD ุงูุฅูุงุฑุงุช (ุจุทุงูุฉ)</option>
ย ย ย ย ย ย ย ย </select>
ย ย ย ย ย ย </div>
ย ย ย ย `;

ย ย ย ย // ุงูุณุทุฑ ุงูุชุงูู ูู ุงูุฐู ุชู ุชุตุญูุญู
ย ย ย ย showModal('ุณุฏุงุฏ ูุณุท', body, {
ย ย ย ย ย ย confirmText: 'ุชุฃููุฏ ุงูุฏูุน',
ย ย ย ย ย ย onConfirm: () => {
ย ย ย ย ย ย ย ย const paymentSource = document.getElementById('installment-payment-source').value;
ย ย ย ย ย ย ย ย 
ย ย ย ย ย ย ย ย const billCategory = state.categories.find(c => c.name === 'ุณุฏุงุฏ ููุงุชูุฑ' || c.name === '๐ณ ุณุฏุงุฏ ููุงุชูุฑ');
ย ย ย ย ย ย ย ย const categoryId = billCategory ? billCategory.id : state.categories.find(c => c.name === 'ุฃุฎุฑู')?.id || '';

ย ย ย ย ย ย ย ย const transaction = {
ย ย ย ย ย ย ย ย ย ย id: 'trans-' + Date.now(),
ย ย ย ย ย ย ย ย ย ย amount: installment.installmentAmount,
ย ย ย ย ย ย ย ย ย ย date: new Date().toISOString().split('T')[0],
ย ย ย ย ย ย ย ย ย ย description: `ุณุฏุงุฏ ุงููุณุท ${installment.paid + 1} ูู: ${installment.description}`,
ย ย ย ย ย ย ย ย ย ย paymentMethod: paymentSource,
ย ย ย ย ย ย ย ย ย ย type: 'bnpl-payment',
ย ย ย ย ย ย ย ย ย ย categoryId: categoryId,
ย ย ย ย ย ย ย ย ย ย isInstallmentPayment: true,
ย ย ย ย ย ย ย ย ย ย installmentId: installmentId,
ย ย ย ย ย ย ย ย };

ย ย ย ย ย ย ย ย state.transactions.push(transaction);
ย ย ย ย ย ย ย ย installment.paid += 1;
ย ย ย ย ย ย ย ย saveStateToFirebase();
ย ย ย ย ย ย ย ย return true; 
ย ย ย ย ย ย }
ย ย ย ย });
ย ย }
    
    function handleDeleteCategory(id) {
        const isUsed = state.transactions.some(t => t.categoryId === id);
        if (isUsed) {
            showModal("ุฎุทุฃ", "<p>ูุง ูููู ุญุฐู ูุฐู ุงููุฆุฉ ูุฃููุง ูุณุชุฎุฏูุฉ ูู ุจุนุถ ุงููุนุงููุงุช.</p>", { confirmText: 'ููุงูู', hideCancel: true });
            return;
        }
        showModal("ุญุฐู ุงููุฆุฉ", "<p>ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ูุฐู ุงููุฆุฉุ</p>", {
            confirmText: 'ูุนูุ ุญุฐู',
            onConfirm: () => {
                state.categories = state.categories.filter(c => c.id !== id);
                saveStateToFirebase();
                return true;
            }
        });
    }

    async function handleAIChatSubmit(e) {
        e.preventDefault();
        const userInput = document.getElementById('ai-user-input');
        const query = userInput.value.trim();
        if (!query) return;
        addMessageToChat(query, 'user', 'ai-chat-box');
        userInput.value = '';
        showTypingIndicator(true, 'ai-chat-box');
        try {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`;
            const filteredData = getFilteredTransactions();
            const requestBody = {
                systemInstruction: { parts: [{ text: GEMINI_PROMPTS.FINANCIAL_ANALYST }] },
                contents: [{ parts: [{ text: `User Query: "${query}"` }, { text: `Financial Data for the period ${selectedYear}-${selectedMonth}: ${JSON.stringify(filteredData)}` }] }],
            };
            const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(requestBody) });
            if (!response.ok) {
                const error = new Error(`API call failed with status: ${response.status}`);
                error.status = response.status;
                throw error;
            }
            const result = await response.json();
            const aiResponse = getApiResponseText(result) || "ุนููุงูุ ูู ุฃุชููู ูู ูุนุงูุฌุฉ ุทูุจู ุญุงููุงู.";
            addMessageToChat(aiResponse, 'ai', 'ai-chat-box');
        } catch (error) {
            console.error("AI Assistant Error:", error);
            let userMessage = "ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงูุงุชุตุงู ุจุงููุณุงุนุฏ ุงูุฐูู. ุงูุฑุฌุงุก ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.";
            if (error.status === 403) {
                userMessage = "ุชู ุฑูุถ ุงููุตูู. ูุฑุฌู ูุฑุงุฌุนุฉ ุฅุนุฏุงุฏุงุช ููุชุงุญ API.";
            }
            addMessageToChat(userMessage, 'ai', 'ai-chat-box');
        } finally {
            showTypingIndicator(false, 'ai-chat-box');
        }
    }

    async function handlePasteFromClipboard() {
        try {
            if (!navigator.clipboard || !navigator.clipboard.readText) {
                throw new Error("Clipboard API not supported.");
            }
            const clipboardText = await navigator.clipboard.readText();
            if (!clipboardText) {
                showModal("ุงูุญุงูุธุฉ ูุงุฑุบุฉ", "<p>ูุง ููุฌุฏ ูุต ูู ุงูุญุงูุธุฉ ููุตูู.</p>", { confirmText: 'ุญุณููุง', hideCancel: true });
                return;
            }
            analyzePastedText(clipboardText);
        } catch (error) {
            const body = `<p class="text-sm text-slate-400 mb-2">ุชุนุฐุฑ ุงููุตูู ุฅูู ุงูุญุงูุธุฉ. ูุฑุฌู ูุตู ูุต ุงูุฑุณุงูุฉ ุฃุฏูุงู:</p><textarea id="paste-textarea" class="w-full h-32 p-2"></textarea>`;
            showModal("ูุตู ุงููุต ูุฏููุงู", body, { confirmText: 'ุชุญููู', onConfirm: () => { const pastedText = document.getElementById('paste-textarea').value; if(pastedText) { analyzePastedText(pastedText); } return true; } });
        }
    }

    async function analyzePastedText(text) {
        showLoadingOverlay(true, "ุฌุงุฑู ุงูุชุญููู ุงูุฐูู...");
        try {
            const categoriesForAI = state.categories.map(c => ({ id: c.id, name: c.name }));
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`;
            const requestBody = {
                systemInstruction: { parts: [{ text: GEMINI_PROMPTS.PASTE_ANALYZER }] },
                contents: [{ parts: [{ text: text }, {text: `Available Categories: ${JSON.stringify(categoriesForAI)}`}] }],
                generationConfig: { responseMimeType: "application/json" }
            };
            const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(requestBody) });
            if (!response.ok) throw new Error(`API call failed with status ${response.status}`);
            const result = await response.json();
            const textResponse = getApiResponseText(result);
            if (!textResponse) throw new Error("Invalid response from AI model.");
            const data = JSON.parse(textResponse);
            if (data.amount) document.getElementById('transaction-amount').value = data.amount;
            if (data.merchant) document.getElementById('transaction-description').value = data.merchant;
            if (data.date) document.getElementById('transaction-date').value = data.date;
            if (data.paymentMethod) document.getElementById('payment-method').value = data.paymentMethod;
            if (data.categoryId) document.getElementById('transaction-category').value = data.categoryId;
            handlePaymentMethodChange({ target: document.getElementById('payment-method') });
            handleTransactionTypeChange();
            showModal("ูุฌุงุญ", "<p>ุชู ุชุญููู ุงููุต ูููุก ุงูุญููู ุชููุงุฆูุงู. ูุฑุฌู ูุฑุงุฌุนุฉ ุงูุจูุงูุงุช ูุจู ุงูุญูุธ.</p>", { confirmText: 'ุญุณููุง', hideCancel: true });
        } catch (error) {
            console.error("Paste analysis error:", error);
            showError("ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุญููู ุงููุต. ูุฏ ูููู ุงููุต ุบูุฑ ุตุงูุญ ุฃู ููุงู ูุดููุฉ ูู ุงูุงุชุตุงู.");
        } finally {
            showLoadingOverlay(false);
        }
    }

    async function handleSuggestCategoryIcon() {
        const categoryName = document.getElementById('category-name').value.trim();
        if (!categoryName) {
            showError("ุงูุฑุฌุงุก ุฅุฏุฎุงู ุงุณู ุงููุฆุฉ ุฃููุงู.");
            return;
        }
        showLoadingOverlay(true, "ุฌุงุฑู ุงูุจุญุซ ุนู ุฃููููุฉ...");
        try {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`;
            const requestBody = {
                systemInstruction: { parts: [{ text: GEMINI_PROMPTS.ICON_SUGGESTER }] },
                contents: [{ parts: [{ text: `Category: ${categoryName}` }] }]
            };
            const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(requestBody) });
            if (!response.ok) throw new Error(`API call failed with status: ${response.status}`);
            const result = await response.json();
            const emoji = getApiResponseText(result)?.trim();
            if (emoji) {
                document.getElementById('category-icon').value = emoji;
            } else {
                showError("ูู ุฃุชููู ูู ุงูุนุซูุฑ ุนูู ุฃููููุฉ ููุงุณุจุฉ.");
            }
        } catch (error) {
            console.error("Suggest icon error:", error);
            showError("ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงูุชุฑุงุญ ุงูุฃููููุฉ.");
        } finally {
            showLoadingOverlay(false);
        }
    }

    async function handleSmartSummary() {
        const resultDiv = document.getElementById('smart-summary-result');
        showLoadingOverlay(true, "ุฌุงุฑู ุฅูุดุงุก ุงูููุฎุต...");
        resultDiv.innerHTML = '';
        resultDiv.classList.add('hidden');
        try {
            const calc = calculateSummaries();
            if (getFilteredTransactions().length < 1) {
                throw new Error("ูุง ุชูุฌุฏ ุจูุงูุงุช ูุงููุฉ ูู ูุฐู ุงููุชุฑุฉ ูุฅูุดุงุก ููุฎุต.");
            }
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`;
            const requestBody = {
                systemInstruction: { parts: [{ text: GEMINI_PROMPTS.SMART_SUMMARY_GENERATOR }] },
                contents: [{ parts: [{ text: `Financial Data: ${JSON.stringify(calc)}` }] }]
            };
            const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(requestBody) });
            if (!response.ok) throw new Error(`API call failed with status: ${response.status}`);
            const result = await response.json();
            const summaryText = getApiResponseText(result);
            if (!summaryText) throw new Error("ูู ูุชููู ุงูุฐูุงุก ุงูุงุตุทูุงุนู ูู ุฅูุดุงุก ููุฎุต.");
            resultDiv.innerHTML = `<p>${summaryText}</p>`;
            resultDiv.classList.remove('hidden');
        } catch (error) {
            console.error("Smart Summary Error:", error);
            showError(error.message || "ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุฅูุดุงุก ุงูููุฎุต ุงูุฐูู.");
        } finally {
            showLoadingOverlay(false);
        }
    }

    async function handleGenerateBudget() {
        const budgetInput = document.getElementById('monthly-budget-input');
        const resultDiv = document.getElementById('budget-plan-result');
        const totalBudget = parseFloat(budgetInput.value);
        if (isNaN(totalBudget) || totalBudget <= 0) {
            showError("ุงูุฑุฌุงุก ุฅุฏุฎุงู ูุจูุบ ููุฒุงููุฉ ุตุญูุญ.");
            return;
        }
        showLoadingOverlay(true, "ุฌุงุฑู ุฅูุดุงุก ุฎุทุฉ ุงูููุฒุงููุฉ...");
        resultDiv.innerHTML = '';
        try {
            const sixtyDaysAgo = new Date();
            sixtyDaysAgo.setDate(sixtyDaysAgo.getDate() - 60);
            const recentTransactions = state.transactions.filter(t => new Date(t.date) >= sixtyDaysAgo && t.type === 'expense');
            if (recentTransactions.length < 5) {
                throw new Error("ูุง ุชูุฌุฏ ุจูุงูุงุช ูุงููุฉ ุนู ุฅููุงูู ูุฅูุดุงุก ุฎุทุฉ ุฏูููุฉ. ูุฑุฌู ุฅุถุงูุฉ 5 ูุนุงููุงุช ุนูู ุงูุฃูู.");
            }
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`;
            const userPrompt = `Here is my financial data. Please create a budget plan for me. My total monthly budget is: ${totalBudget} SAR. My spending categories are: ${JSON.stringify(state.categories)}. My transactions from the last 60 days are: ${JSON.stringify(recentTransactions)}`;
            const requestBody = {
                systemInstruction: { parts: [{ text: GEMINI_PROMPTS.BUDGET_PLANNER }] },
                contents: [{ parts: [{ text: userPrompt }] }]
            };
            const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(requestBody) });
            if (!response.ok) throw new Error(`API call failed with status: ${response.status}`);
            const result = await response.json();
            const budgetPlanMd = getApiResponseText(result);
            if (!budgetPlanMd) throw new Error("ูู ูุชููู ุงูุฐูุงุก ุงูุงุตุทูุงุนู ูู ุฅูุดุงุก ุฎุทุฉ ุงูููุฒุงููุฉ.");
            let html = budgetPlanMd.replace(/### (.*)/g, '<h4 class="text-lg font-bold text-white mt-3 mb-2">$1</h4>').replace(/\|(.+)\|(.+)\|(.+)\|/g, '<tr><td class="border border-slate-700 px-4 py-2">$1</td><td class="border border-slate-700 px-4 py-2">$2</td><td class="border border-slate-700 px-4 py-2">$3</td></tr>').replace(/\|-+\|/g, '').replace(/<\/tr><tr>/g, '</tr></thead><tbody><tr>').replace(/<tr>/g, '<table class="w-full table-auto border-collapse"><thead><tr>').replace(/(<\/table>)/g, '</tbody>$1');
            resultDiv.innerHTML = html;
        } catch (error) {
            console.error("Budget Generation Error:", error);
            resultDiv.innerHTML = `<p class="text-center text-red-400 p-4">${error.message}</p>`;
        } finally {
            showLoadingOverlay(false);
        }
    }

    function addMessageToChat(message, sender, chatBoxId) {
        const chatBox = document.getElementById(chatBoxId);
        const bubble = document.createElement('div');
        bubble.classList.add('chat-bubble', sender === 'user' ? 'user-bubble' : 'ai-bubble');
        bubble.innerHTML = message.replace(/\n/g, '<br>');
        chatBox.appendChild(bubble);
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    function showTypingIndicator(show, chatBoxId) {
        const chatBox = document.getElementById(chatBoxId);
        let indicator = document.getElementById(`typing-indicator-${chatBoxId}`);
        if (show) {
            if (!indicator) {
                indicator = document.createElement('div');
                indicator.id = `typing-indicator-${chatBoxId}`;
                indicator.classList.add('ai-bubble', 'chat-bubble', 'typing-indicator');
                indicator.innerHTML = '<span></span><span></span><span></span>';
                chatBox.appendChild(indicator);
                chatBox.scrollTop = chatBox.scrollHeight;
            }
        } else {
            if (indicator) indicator.remove();
        }
    }

    function calculateSummaries() {
        const transactions = getFilteredTransactions();
        const calc = {
            totalIncome: 0, totalExpenses: 0, totalSnbExpenses: 0, totalEnbdExpenses: 0,
            snbPaymentsTotal: 0, enbdPaymentsTotal: 0, totalInvestmentDeposits: 0,
            totalInvestmentWithdrawals: 0, bankDeposits: 0, bankWithdrawals: 0,
            transactionStats: { count: 0, total: 0, max: 0, average: 0 }
        };

        transactions.forEach(t => {
            calc.transactionStats.count++;
            calc.transactionStats.total += t.amount;
            if (t.amount > calc.transactionStats.max) calc.transactionStats.max = t.amount;
            
            // This switch handles the main report figures for the selected period
            switch (t.type) {
                case 'income':
                    calc.totalIncome += t.amount;
                    if(t.paymentMethod === 'mada-bank') calc.bankDeposits += t.amount;
                    break;
                case 'expense':
                    calc.totalExpenses += t.amount;
                    if (t.paymentMethod.includes('bnpl')) {
                        // This case is for the initial BNPL purchase transaction which is now obsolete.
                        // Kept for backward compatibility if old data exists.
                        // The actual cost is now handled by 'bnpl-payment'.
                    } else if (t.paymentMethod === 'snb-card') {
                        calc.totalSnbExpenses += t.amount;
                    } else if (t.paymentMethod === 'enbd-card') {
                        calc.totalEnbdExpenses += t.amount;
                    } else if (t.paymentMethod === 'mada-bank') {
                        calc.bankWithdrawals += t.amount;
                    }
                    break;
                case 'snb-payment':
                    calc.snbPaymentsTotal += t.amount;
                    if (t.paymentMethod === 'mada-bank') calc.bankWithdrawals += t.amount;
                    break;
                case 'enbd-payment':
                    calc.enbdPaymentsTotal += t.amount;
                    if (t.paymentMethod === 'mada-bank') calc.bankWithdrawals += t.amount;
                    break;
                case 'bnpl-payment': // This is the new type for installment payments
                    calc.totalExpenses += t.amount; // A BNPL payment is a true expense
                    if (t.paymentMethod === 'mada-bank') calc.bankWithdrawals += t.amount;
                    if (t.paymentMethod === 'snb-card') calc.totalSnbExpenses += t.amount; 
                    if (t.paymentMethod === 'enbd-card') calc.totalEnbdExpenses += t.amount;
                    break;
                case 'investment-deposit':
                    calc.totalInvestmentDeposits += t.amount;
                    calc.bankWithdrawals += t.amount;
                    break;
                case 'investment-withdrawal':
                    calc.totalInvestmentWithdrawals += t.amount;
                    calc.bankDeposits += t.amount;
                    break;
            }
        });

        calc.transactionStats.average = calc.transactionStats.count > 0 ? (calc.transactionStats.total / calc.transactionStats.count) : 0;
        
        // This part calculates running balances up to the end of the selected period
        const allTransactionsUpToPeriodEnd = state.transactions.filter(t => new Date(t.date) <= getPeriodEndDate());
        let snbBalance = 0, enbdBalance = 0, bankBalance = 0;

        allTransactionsUpToPeriodEnd.forEach(t => {
            // SNB Card Balance
            if (t.paymentMethod === 'snb-card' && (t.type === 'expense' || t.type === 'bnpl-payment')) {
                snbBalance += t.amount;
            }
            if (t.type === 'snb-payment') {
                snbBalance -= t.amount;
            }
            // ENBD Card Balance
            if (t.paymentMethod === 'enbd-card' && (t.type === 'expense' || t.type === 'bnpl-payment')) {
                enbdBalance += t.amount;
            }
            if (t.type === 'enbd-payment') {
                enbdBalance -= t.amount;
            }
            // Bank Balance
            if (t.paymentMethod === 'mada-bank') {
                if (t.type === 'income' || t.type === 'investment-withdrawal') {
                    bankBalance += t.amount;
                } else if (['expense', 'snb-payment', 'enbd-payment', 'bnpl-payment', 'investment-deposit'].includes(t.type)) {
                    bankBalance -= t.amount;
                }
            }
        });
        
        calc.bankBalanceAtEndOfPeriod = bankBalance;
        calc.snb = { balance: snbBalance, available: state.cards.snb.limit - snbBalance, usagePercentage: state.cards.snb.limit > 0 ? (snbBalance / state.cards.snb.limit) * 100 : 0 };
        calc.enbd = { balance: enbdBalance, available: state.cards.enbd.limit - enbdBalance, usagePercentage: state.cards.enbd.limit > 0 ? (enbdBalance / state.cards.enbd.limit) * 100 : 0 };
        calc.totalDebt = snbBalance + enbdBalance;
        calc.totalAvailable = calc.snb.available + calc.enbd.available;
        calc.totalLimits = state.cards.snb.limit + state.cards.enbd.limit;
        return calc;
    }

    function openUpdateInvestmentValueModal() {
        const body = `<div><label class="block text-sm font-medium text-slate-300 mb-1">ุงููููุฉ ุงูุญุงููุฉ ูููุญูุธุฉ (ุฑูุงู)</label><input type="number" id="edit-investment-value" class="w-full p-2" value="${state.investments.currentValue}"><p class="text-xs text-slate-400 mt-2">ุฃุฏุฎู ุงููููุฉ ุงูุณูููุฉ ุงูุญุงููุฉ ูุฌููุน ุงุณุชุซูุงุฑุงุชู.</p></div>`;
        showModal('ุชุญุฏูุซ ูููุฉ ุงููุญูุธุฉ', body, { confirmText: 'ุญูุธ', onConfirm: () => { const newValue = parseFloat(document.getElementById('edit-investment-value').value); if (isNaN(newValue) || newValue < 0) { showError("ุงูุฑุฌุงุก ุฅุฏุฎุงู ูููุฉ ุตุญูุญุฉ."); return false; } state.investments.currentValue = newValue; saveStateToFirebase(); return true; } });
    }

    function handleInvestmentFormSubmit(e) {
        e.preventDefault();
        const amount = parseFloat(document.getElementById('investment-amount').value);
        const type = document.getElementById('investment-type').value;
        if (isNaN(amount) || amount <= 0) { showError("ุงูุฑุฌุงุก ุฅุฏุฎุงู ูุจูุบ ุตุญูุญ."); return; }
        const newTransaction = { id: `trans-${Date.now()}`, amount: amount, date: new Date().toISOString().split('T')[0], description: type === 'deposit' ? 'ุฅูุฏุงุน ูู ุงููุญูุธุฉ ุงูุงุณุชุซูุงุฑูุฉ' : 'ุณุญุจ ูู ุงููุญูุธุฉ ุงูุงุณุชุซูุงุฑูุฉ', paymentMethod: 'mada-bank', type: type === 'deposit' ? 'investment-deposit' : 'investment-withdrawal', categoryId: null };
        state.transactions.push(newTransaction);
        saveStateToFirebase();
        document.getElementById('investment-form').reset();
    }

    async function handleInvestmentAIChatSubmit(e) {
        e.preventDefault();
        const userInput = document.getElementById('investment-ai-user-input');
        const query = userInput.value.trim();
        if (!query) return;
        addMessageToChat(query, 'user', 'investment-ai-chat-box');
        userInput.value = '';
        showTypingIndicator(true, 'investment-ai-chat-box');
        try {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`;
            const requestBody = { systemInstruction: { parts: [{ text: GEMINI_PROMPTS.INVESTMENT_COACH }] }, contents: [{ parts: [{ text: query }] }], };
            const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(requestBody) });
            if (!response.ok) { const error = new Error(`API call failed with status: ${response.status}`); error.status = response.status; throw error; }
            const result = await response.json();
            const aiResponse = getApiResponseText(result) || "ุนููุงูุ ูู ุฃุชููู ูู ูุนุงูุฌุฉ ุทูุจู ุญุงููุงู.";
            addMessageToChat(aiResponse, 'ai', 'investment-ai-chat-box');
        } catch (error) {
            console.error("Investment AI error:", error);
            let userMessage = "ุญุฏุซ ุฎุทุฃ. ุงูุฑุฌุงุก ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.";
            if (error.status === 403) userMessage = "ุชู ุฑูุถ ุงููุตูู. ูุฑุฌู ูุฑุงุฌุนุฉ ุฅุนุฏุงุฏุงุช ููุชุงุญ API.";
            addMessageToChat(userMessage, 'ai', 'investment-ai-chat-box');
        } finally {
            showTypingIndicator(false, 'investment-ai-chat-box');
        }
    }

    function getFilteredTransactions() {
        if (!selectedYear || !selectedMonth) return [];
        return state.transactions.filter(t => {
            const transactionDate = new Date(t.date);
            const transactionYear = transactionDate.getFullYear();
            const transactionMonth = transactionDate.getMonth() + 1;
            if (selectedMonth === 'all') {
                return transactionYear === selectedYear;
            } else {
                return transactionYear === selectedYear && transactionMonth === parseInt(selectedMonth, 10);
            }
        });
    }

    function getPeriodStartDate() {
        if (selectedMonth === 'all') return new Date(selectedYear, 0, 1);
        return new Date(selectedYear, parseInt(selectedMonth, 10) - 1, 1);
    }
    
    function getPeriodEndDate() {
        if (selectedMonth === 'all') return new Date(selectedYear, 11, 31, 23, 59, 59);
        return new Date(selectedYear, parseInt(selectedMonth, 10), 0, 23, 59, 59);
    }

    function populateDateFilters() {
        const now = new Date();
        const currentYear = now.getFullYear();
        const currentMonth = now.getMonth() + 1;
        const startYear = 2020;
        let yearHTML = '';
        for (let y = currentYear + 1; y >= startYear; y--) { yearHTML += `<option value="${y}">${y}</option>`; }
        yearFilter.innerHTML = yearHTML;
        
        const months = ["ููุงูุฑ", "ูุจุฑุงูุฑ", "ูุงุฑุณ", "ุฃุจุฑูู", "ูุงูู", "ููููู", "ููููู", "ุฃุบุณุทุณ", "ุณุจุชูุจุฑ", "ุฃูุชูุจุฑ", "ููููุจุฑ", "ุฏูุณูุจุฑ"];
        let monthHTML = `<option value="all">ูู ุงูุดููุฑ</option>`;
        months.forEach((month, index) => { monthHTML += `<option value="${index + 1}">${month}</option>`; });
        monthFilter.innerHTML = monthHTML;
        
        yearFilter.value = currentYear;
        monthFilter.value = currentMonth;
        selectedYear = currentYear;
        selectedMonth = currentMonth;
    }

    function handleDateFilterChange() {
        selectedYear = parseInt(yearFilter.value, 10);
        selectedMonth = monthFilter.value === 'all' ? 'all' : parseInt(monthFilter.value, 10);
        renderAll();
    }

    function showModal(title, body, options = {}) {
        const config = { onConfirm: () => true, confirmText: 'ููุงูู', cancelText: 'ุฅูุบุงุก', hideCancel: false, ...options };
        document.getElementById('modal-title').textContent = title;
        document.getElementById('modal-body').innerHTML = body;
        const modal = document.getElementById('custom-modal');
        const confirmBtn = document.getElementById('modal-confirm');
        const cancelBtn = document.getElementById('modal-cancel');
        confirmBtn.textContent = config.confirmText;
        cancelBtn.textContent = config.cancelText;
        cancelBtn.style.display = config.hideCancel ? 'none' : 'inline-block';
        const newConfirmBtn = confirmBtn.cloneNode(true);
        confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
        newConfirmBtn.addEventListener('click', () => { if (config.onConfirm() !== false) hideModal(); });
        modal.classList.add('visible');
    }

    function hideModal() { document.getElementById('custom-modal').classList.remove('visible'); }
    
    function openEditTransactionModal(id) {
        const transaction = state.transactions.find(t => t.id === id);
        if (!transaction) return;
        // Basic editing is enabled. Complex editing (like changing an installment payment) is not fully supported via this simple form.
        currentEditTransactionId = id;
        document.getElementById('transaction-amount').value = transaction.amount;
        document.getElementById('transaction-date').value = transaction.date;
        document.getElementById('transaction-description').value = transaction.description || '';
        document.getElementById('payment-method').value = transaction.paymentMethod;
        document.getElementById('transaction-type').value = transaction.type;
        const categoryExists = state.categories.some(c => c.id === transaction.categoryId);
        document.getElementById('transaction-category').value = categoryExists ? transaction.categoryId : '';
        handleTransactionTypeChange();
        showTab('transactions');
        window.scrollTo(0, 0);
        document.querySelector('#transaction-form button[type="submit"]').textContent = 'โ๏ธ ุชุนุฏูู ุงููุนุงููุฉ';
    }

    function openEditCardModal(cardKey) {
        const card = state.cards[cardKey];
        const title = cardKey === 'snb' ? 'ุชุนุฏูู ุจุทุงูุฉ SNB' : 'ุชุนุฏูู ุจุทุงูุฉ ENBD';
        const calc = calculateSummaries();
        const currentBalance = calc[cardKey].balance;
        const body = `<div class="space-y-4"><div><label class="block text-sm font-medium text-slate-300 mb-1">ุงูุญุฏ ุงูุงุฆุชูุงูู (ุฑูุงู)</label><input type="number" id="edit-card-limit" class="w-full p-2" value="${card.limit}"></div><div><label class="block text-sm font-medium text-slate-300 mb-1">ุงูุฑุตูุฏ ุงููุณุชุญู (ููุชุณููุฉ)</label><input type="number" step="0.01" id="edit-card-balance" class="w-full p-2" value="${currentBalance.toFixed(2)}"></div><div><label class="block text-sm font-medium text-slate-300 mb-1">ููู ุงูุงุณุชุญูุงู (1-31)</label><input type="number" id="edit-card-due-day" class="w-full p-2" value="${card.dueDay}" min="1" max="31"></div></div>`;
        showModal(title, body, { confirmText: 'ุญูุธ ุงูุชุบููุฑุงุช', onConfirm: () => { const newLimit = parseFloat(document.getElementById('edit-card-limit').value); const newDueDay = parseInt(document.getElementById('edit-card-due-day').value, 10); const newBalance = parseFloat(document.getElementById('edit-card-balance').value); if (isNaN(newLimit) || newLimit < 0 || isNaN(newDueDay) || newDueDay < 1 || newDueDay > 31 || isNaN(newBalance)) { showError("ุงูุฑุฌุงุก ุฅุฏุฎุงู ููู ุตุงูุญุฉ."); return false; } state.cards[cardKey].limit = newLimit; state.cards[cardKey].dueDay = newDueDay; const adjustment = newBalance - currentBalance; if (Math.abs(adjustment) > 0.01) { const otherCategory = state.categories.find(c => c.name === 'ุฃุฎุฑู'); const categoryId = otherCategory ? otherCategory.id : ''; let transaction; if (adjustment > 0) { transaction = { id: `trans-${Date.now()}`, amount: adjustment, date: new Date().toISOString().split('T')[0], description: 'ุชุณููุฉ ุฑุตูุฏ ุงูุจุทุงูุฉ', paymentMethod: `${cardKey}-card`, type: 'expense', categoryId: categoryId, }; } else { transaction = { id: `trans-${Date.now()}`, amount: Math.abs(adjustment), date: new Date().toISOString().split('T')[0], description: 'ุชุณููุฉ ุฑุตูุฏ ุงูุจุทุงูุฉ (ุชุฎููุถ)', paymentMethod: 'reconciliation', type: `${cardKey}-payment`, }; } state.transactions.push(transaction); } saveStateToFirebase(); return true; } });
    }

    function openEditBankModal() {
        const body = `<div><label class="block text-sm font-medium text-slate-300 mb-1">ุงูุฑุตูุฏ ุงููุนูู ุงูุญุงูู (ุฑูุงู)</label><input type="number" id="edit-bank-balance" class="w-full p-2" value="${state.bank.balance}"><p class="text-xs text-slate-400 mt-2">ููุงุญุธุฉ: ูุฐุง ุงูุฅุฌุฑุงุก ุณูููู ุจุชุณููุฉ ุงูุฑุตูุฏ ููู ูุคุซุฑ ุนูู ุณุฌู ุงููุนุงููุงุช ุงูุญุงูู.</p></div>`;
        showModal('ุชุณููุฉ ุฑุตูุฏ ุงูุจูู', body, { confirmText: 'ุญูุธ', onConfirm: () => { const newBalance = parseFloat(document.getElementById('edit-bank-balance').value); if (isNaN(newBalance)) { showError("ุงูุฑุฌุงุก ุฅุฏุฎุงู ูุจูุบ ุตุญูุญ."); return false; } const settlementAmount = newBalance - state.bank.balance; if (settlementAmount !== 0) { const otherCategory = state.categories.find(c => c.name === 'ุฃุฎุฑู'); const categoryId = otherCategory ? otherCategory.id : ''; const transaction = { id: `trans-${Date.now()}`, amount: Math.abs(settlementAmount), date: new Date().toISOString().split('T')[0], description: `ุชุณููุฉ ุฑุตูุฏ ุงูุญุณุงุจ`, paymentMethod: 'mada-bank', type: settlementAmount > 0 ? 'income' : 'expense', categoryId, }; state.transactions.push(transaction); } saveStateToFirebase(); return true; } });
    }

    function openEditCategoryModal(id) {
        const category = findCategoryById(id);
        if (!category) return;
        const body = `<div class="space-y-4"><div><label class="block text-sm font-medium text-slate-300 mb-1">ุงุณู ุงููุฆุฉ</label><input type="text" id="edit-category-name" class="w-full p-2" value="${category.name}"></div><div><label class="block text-sm font-medium text-slate-300 mb-1">ุงูุฃููููุฉ (Emoji)</label><input type="text" id="edit-category-icon" class="w-full p-2" value="${category.icon}"></div></div>`;
        showModal('ุชุนุฏูู ุงููุฆุฉ', body, { confirmText: 'ุญูุธ', onConfirm: () => { const name = document.getElementById('edit-category-name').value.trim(); const icon = document.getElementById('edit-category-icon').value.trim(); if (!name || !icon) { showError("ุงูุฑุฌุงุก ุฅุฏุฎุงู ุงุณู ูุฃููููุฉ."); return false; } const index = state.categories.findIndex(c => c.id === id); if (index !== -1) { state.categories[index] = { ...category, name, icon }; saveStateToFirebase(); } return true; } });
    }

    function getApiResponseText(result) {
        return result?.candidates?.[0]?.content?.parts?.[0]?.text || null;
    }
    
    function showTab(tabName) {
        document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
        document.getElementById(`${tabName}-tab`).classList.remove('hidden');
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        document.getElementById(`tab-${tabName}`).classList.add('active');
    }
    
    function formatCurrency(value) { return (value || 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }); }
    function findCategoryById(id) { return state.categories.find(c => c.id === id); }
    function findInstallmentById(id) { return state.installments.find(i => i.id === id); }
    function getPaymentMethodName(key) { const names = { 'mada-bank': '๐ฆ ุจูู', 'cash': '๐ต ููุฏู', 'snb-card': '๐ณ SNB', 'enbd-card': '๐ณ ENBD', 'tabby-bnpl': '๐ฑ ุชุงุจู', 'tamara-bnpl': '๐ฑ ุชูุงุฑุง', 'reconciliation': '๐ ุชุณููุฉ' }; return names[key] || key; }
    function getTransactionTypeName(key) { const names = { 'income': '๐ฐ ุฏุฎู', 'expense': '๐ธ ูุตุงุฑูู', 'snb-payment': '๐ณ ุณุฏุงุฏ SNB', 'enbd-payment': '๐ณ ุณุฏุงุฏ ENBD', 'bnpl-payment': '๐ฑ ุณุฏุงุฏ ูุณุท', 'investment-deposit': '๐น ุฅูุฏุงุน ุงุณุชุซูุงุฑู', 'investment-withdrawal': '๐น ุณุญุจ ุงุณุชุซูุงุฑู' }; return names[key] || key; }
    function showError(message) { showModal("ุฎุทุฃ", `<p>${message}</p>`, { confirmText: 'ููุงูู', hideCancel: true }); }
    function updateCategoryDropdowns() { document.getElementById('transaction-category').innerHTML = state.categories.map(cat => `<option value="${cat.id}">${cat.icon} ${cat.name}</option>`).join(''); }
    function showLoadingOverlay(show, text = "") { const overlay = document.getElementById('loading-overlay'); document.getElementById('loading-text').textContent = text; if (show) { overlay.classList.add('visible'); } else { overlay.classList.remove('visible'); } }
    
    function promptForFirebaseConfig() {
        document.getElementById('loader-container').classList.add('hidden');
        document.getElementById('config-prompt').classList.remove('hidden');
        document.getElementById('firebase-config-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const configInput = document.getElementById('firebase-config-input').value;
            try {
                let configStr = configInput;
                const startIndex = configInput.indexOf('{');
                const endIndex = configInput.lastIndexOf('}');
                if (startIndex !== -1 && endIndex !== -1) {
                    configStr = configInput.substring(startIndex, endIndex + 1);
                }
                const config = JSON.parse(configStr);
                if (!config.apiKey || !config.authDomain) throw new Error("Invalid config object");
                localStorage.setItem('firebaseConfig', JSON.stringify(config));
                location.reload();
            } catch (error) {
                showError("ุงูุฅุนุฏุงุฏุงุช ุงูุชู ุฃุฏุฎูุชูุง ุบูุฑ ุตุงูุญุฉ.");
            }
        });
    }

    function clearFirebaseConfig() {
        showModal("ูุณุญ ุงูุฅุนุฏุงุฏุงุช", "<p>ูู ุฃูุช ูุชุฃูุฏ ูู ุฑุบุจุชู ูู ูุณุญ ุฅุนุฏุงุฏุงุช ุงูุงุชุตุงูุ ุณุชุญุชุงุฌ ุฅูู ุฅุฏุฎุงููุง ูุฌุฏุฏุงู.</p>", {
            confirmText: 'ูุนูุ ุงูุณุญ',
            onConfirm: () => {
                localStorage.removeItem('firebaseConfig');
                showModal("ุชู", "<p>ุชู ูุณุญ ุงูุฅุนุฏุงุฏุงุช. ุณูุชู ุฅุนุงุฏุฉ ุชุญููู ุงูุชุทุจูู.</p>", { confirmText: 'ููุงูู', hideCancel: true, onConfirm: () => location.reload() });
                return true;
            }
        });
    }

    function createBackup() {
        const backupData = JSON.stringify(state, null, 2);
        const blob = new Blob([backupData], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `expenses_backup_${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }
    
    function handleRestoreBackup(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const restoredState = JSON.parse(e.target.result);
                if (restoredState?.transactions) {
                    showModal("ุงุณุชุนุงุฏุฉ ูุณุฎุฉ ุงุญุชูุงุทูุฉ", "<p>ูู ุฃูุช ูุชุฃูุฏุ ุณูุชู ุงููุชุงุจุฉ ููู ุฌููุน ุจูุงูุงุชู ุงูุญุงููุฉ.</p>", {
                        confirmText: 'ูุนูุ ุงุณุชุนุงุฏุฉ',
                        onConfirm: () => {
                            state = { ...getInitialState(), ...restoredState };
                            saveStateToFirebase();
                            showModal("ูุฌุงุญ", "<p>ุชู ุงุณุชุนุงุฏุฉ ุงูุจูุงูุงุช ุจูุฌุงุญ!</p>", { confirmText: 'ุญุณููุง', hideCancel: true });
                            return true;
                        }
                    });
                } else {
                    throw new Error("Invalid backup file format.");
                }
            } catch (error) {
                showError("ูุดู ูู ุงุณุชุนุงุฏุฉ ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ. ุงูููู ุบูุฑ ุตุงูุญ.");
            }
        };
        reader.readAsText(file);
        event.target.value = '';
    }

    function exportToExcel() {
        const wb = XLSX.utils.book_new();
        const transactionsData = getFilteredTransactions().map(t => ({ 'ุงูุชุงุฑูุฎ': t.date, 'ุงูููุน': getTransactionTypeName(t.type), 'ุงููุณููุฉ': getPaymentMethodName(t.paymentMethod), 'ุงููุจูุบ': t.amount, 'ุงููุฆุฉ': findCategoryById(t.categoryId)?.name || 'N/A', 'ุงููุตู': t.description }));
        const ws_transactions = XLSX.utils.json_to_sheet(transactionsData);
        XLSX.utils.book_append_sheet(wb, ws_transactions, "ุงููุนุงููุงุช");
        const calc = calculateSummaries();
        const summaryData = [{ "ุงูุจูุฏ": "ุฅุฌูุงูู ุงูุฏุฎู", "ุงููุจูุบ": calc.totalIncome }, { "ุงูุจูุฏ": "ุฅุฌูุงูู ุงููุตุงุฑูู", "ุงููุจูุบ": calc.totalExpenses }, { "ุงูุจูุฏ": "ุฑุตูุฏ SNB ุงููุณุชุญู", "ุงููุจูุบ": calc.snb.balance }, { "ุงูุจูุฏ": "ุฑุตูุฏ ENBD ุงููุณุชุญู", "ุงููุจูุบ": calc.enbd.balance }, { "ุงูุจูุฏ": "ุฑุตูุฏ ุงูุจูู", "ุงููุจูุบ": calc.bankBalanceAtEndOfPeriod }];
        const ws_summary = XLSX.utils.json_to_sheet(summaryData);
        XLSX.utils.book_append_sheet(wb, ws_summary, "ุงูููุฎุต");
        XLSX.writeFile(wb, `Expense_Report_${selectedYear}_${selectedMonth}.xlsx`);
    }

    function generatePDFReport() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.addFont('https://cdnjs.cloudflare.com/ajax/libs/Cairo/2.0.0/Cairo-Regular.ttf', 'Cairo', 'normal');
        doc.setFont('Cairo');
        doc.setRTL(true);
        doc.text(`ุชูุฑูุฑ ุงููุตุงุฑูู - ${monthFilter.options[monthFilter.selectedIndex].text} ${selectedYear}`, 105, 20, null, null, "center");
        const calc = calculateSummaries();
        doc.autoTable({ startY: 30, head: [['ุงูุจูุฏ', 'ุงููุจูุบ']], body: [['ุฅุฌูุงูู ุงูุฏุฎู', `${formatCurrency(calc.totalIncome)} ุฑูุงู`], ['ุฅุฌูุงูู ุงููุตุงุฑูู', `${formatCurrency(calc.totalExpenses)} ุฑูุงู`], ['ุงูุตุงูู', `${formatCurrency(calc.totalIncome - calc.totalExpenses)} ุฑูุงู`]], theme: 'grid' });
        doc.text("ุขุฎุฑ ุงููุนุงููุงุช", 200, doc.autoTable.previous.finalY + 15, null, null, "right");
        const transactionData = getFilteredTransactions().slice(0, 15).map(t => [t.date, getPaymentMethodName(t.paymentMethod), getTransactionTypeName(t.type), formatCurrency(t.amount), findCategoryById(t.categoryId)?.name || '-', t.description?.substring(0, 20) || '-']);
        doc.autoTable({ startY: doc.autoTable.previous.finalY + 20, head: [['ุงูุชุงุฑูุฎ', 'ุงููุณููุฉ', 'ุงูููุน', 'ุงููุจูุบ', 'ุงููุฆุฉ', 'ุงููุตู']], body: transactionData, theme: 'grid' });
        doc.save(`financial_report_${selectedYear}_${selectedMonth}.pdf`);
    }

    // --- Render Functions for UI components ---
    function renderSummary(calc) {
        document.getElementById('snb-current-balance').textContent = `${formatCurrency(calc.snb.balance)} ุฑูุงู`;
        document.getElementById('snb-remaining-limit').textContent = `${formatCurrency(calc.snb.available)} ุฑูุงู`;
        document.getElementById('snb-usage-bar').style.width = `${Math.min(100,calc.snb.usagePercentage)}%`;
        document.getElementById('enbd-current-balance').textContent = `${formatCurrency(calc.enbd.balance)} ุฑูุงู`;
        document.getElementById('enbd-remaining-limit').textContent = `${formatCurrency(calc.enbd.available)} ุฑูุงู`;
        document.getElementById('enbd-usage-bar').style.width = `${Math.min(100,calc.enbd.usagePercentage)}%`;
        document.getElementById('total-debt').textContent = `${formatCurrency(calc.totalDebt)} ุฑูุงู`;
        document.getElementById('total-available').textContent = `${formatCurrency(calc.totalAvailable)} ุฑูุงู`;
        document.getElementById('total-limits').textContent = `${formatCurrency(calc.totalLimits)} ุฑูุงู`;
        document.getElementById('report-income').textContent = `${formatCurrency(calc.totalIncome)} ุฑูุงู`;
        document.getElementById('report-expenses').textContent = `${formatCurrency(calc.totalExpenses)} ุฑูุงู`;
        document.getElementById('report-snb-expenses').textContent = `${formatCurrency(calc.totalSnbExpenses)} ุฑูุงู`;
        document.getElementById('report-enbd-expenses').textContent = `${formatCurrency(calc.totalEnbdExpenses)} ุฑูุงู`;
        document.getElementById('report-snb-payments').textContent = `${formatCurrency(calc.snbPaymentsTotal)} ุฑูุงู`;
        document.getElementById('report-enbd-payments').textContent = `${formatCurrency(calc.enbdPaymentsTotal)} ุฑูุงู`;
        const net = calc.totalIncome - (calc.totalExpenses + calc.totalInvestmentDeposits - calc.totalInvestmentWithdrawals);
        const netEl = document.getElementById('report-net');
        netEl.textContent = `${formatCurrency(net)} ุฑูุงู`;
        netEl.className = 'number-display ' + (net >= 0 ? 'text-emerald-400' : 'text-red-400');
        document.getElementById('report-count').textContent = calc.transactionStats.count;
        document.getElementById('report-average').textContent = `${formatCurrency(calc.transactionStats.average)} ุฑูุงู`;
        document.getElementById('report-max').textContent = `${formatCurrency(calc.transactionStats.max)} ุฑูุงู`;
    }

    function renderInvestmentTab(calc) {
        document.getElementById('investment-current-value').textContent = `${formatCurrency(state.investments.currentValue)} ุฑูุงู`;
        document.getElementById('investment-total-invested').textContent = `${formatCurrency(calc.totalInvestmentDeposits)} ุฑูุงู`;
    }

    function renderCardDetails(calc) {
        document.getElementById('snb-balance-display').textContent = `${formatCurrency(calc.snb.balance)} ุฑูุงู`;
        document.getElementById('snb-limit-display').textContent = `${formatCurrency(state.cards.snb.limit)} ุฑูุงู`;
        document.getElementById('snb-available-display').textContent = `${formatCurrency(calc.snb.available)} ุฑูุงู`;
        document.getElementById('snb-due-day-display').textContent = `ููู ${state.cards.snb.dueDay}`;
        document.getElementById('snb-progress-bar').style.width = `${Math.min(100,calc.snb.usagePercentage)}%`;
        document.getElementById('snb-usage-display').textContent = `${calc.snb.usagePercentage.toFixed(1)}%`;
        document.getElementById('enbd-balance-display').textContent = `${formatCurrency(calc.enbd.balance)} ุฑูุงู`;
        document.getElementById('enbd-limit-display').textContent = `${formatCurrency(state.cards.enbd.limit)} ุฑูุงู`;
        document.getElementById('enbd-available-display').textContent = `${formatCurrency(calc.enbd.available)} ุฑูุงู`;
        document.getElementById('enbd-due-day-display').textContent = `ููู ${state.cards.enbd.dueDay}`;
        document.getElementById('enbd-progress-bar').style.width = `${Math.min(100,calc.enbd.usagePercentage)}%`;
        document.getElementById('enbd-usage-display').textContent = `${calc.enbd.usagePercentage.toFixed(1)}%`;
        const cardTransactions = getFilteredTransactions().filter(t => t.paymentMethod.includes('-card') || t.type.includes('-payment')).sort((a, b) => new Date(b.date) - new Date(a.date));
        document.getElementById('cards-transactions-list').innerHTML = cardTransactions.map(t => { const isPayment = t.type.includes('-payment'); const amountClass = isPayment ? 'text-emerald-400' : 'text-red-400'; const cardName = t.paymentMethod.includes('snb') || t.type.includes('snb') ? 'SNB' : 'ENBD'; const typeName = isPayment ? 'ุณุฏุงุฏ' : 'ูุตุฑูู'; return `<tr class="border-b border-slate-700/50"><td class="p-3">${t.date}</td><td class="p-3 font-semibold">${cardName}</td><td class="p-3">${typeName}</td><td class="p-3 font-semibold ${amountClass} number-display">${isPayment ? '+' : '-'}${formatCurrency(t.amount)}</td><td class="p-3 text-slate-400">${t.description || '-'}</td></tr>`; }).join('');
    }

    function renderBankDetails(calc) {
        document.getElementById('bank-balance').textContent = `${formatCurrency(calc.bankBalanceAtEndOfPeriod)} ุฑูุงู`;
        document.getElementById('bank-deposits').textContent = `${formatCurrency(calc.bankDeposits)} ุฑูุงู`;
        document.getElementById('bank-withdrawals').textContent = `${formatCurrency(calc.bankWithdrawals)} ุฑูุงู`;
        const bankTransactions = getFilteredTransactions().filter(t => t.paymentMethod === 'mada-bank').sort((a, b) => new Date(b.date) - new Date(a.date));
        document.getElementById('bank-transactions-list').innerHTML = bankTransactions.map(t => { const isIncome = t.type === 'income'; const amountClass = isIncome ? 'text-emerald-400' : 'text-red-400'; const category = findCategoryById(t.categoryId); return `<tr class="border-b border-slate-700/50"><td class="p-3">${t.date}</td><td class="p-3">${getTransactionTypeName(t.type)}</td><td class="p-3 font-semibold ${amountClass} number-display">${isIncome ? '+' : '-'}${formatCurrency(t.amount)}</td><td class="p-3">${category ? `${category.icon} ${category.name}` : '-'}</td><td class="p-3 text-slate-400">${t.description || '-'}</td></tr>`; }).join('');
    }

    ย ย function renderTransactionList() {
ย ย ย ย const searchTerm = document.getElementById('search-transactions').value.toLowerCase();
ย ย ย ย const filterMethod = document.getElementById('filter-payment-method').value;
ย ย ย ย const transactionsToDisplay = getFilteredTransactions().filter(t => { 
ย ย ย ย ย ย const descriptionMatch = t.description?.toLowerCase().includes(searchTerm) || false; 
ย ย ย ย ย ย const categoryObject = findCategoryById(t.categoryId); 
ย ย ย ย ย ย const categoryNameMatch = categoryObject?.name.toLowerCase().includes(searchTerm) || false; 
ย ย ย ย ย ย const matchesSearch = descriptionMatch || categoryNameMatch; 
ย ย ย ย ย ย const matchesFilter = !filterMethod || t.paymentMethod === filterMethod || t.type.replace('-payment', '-card') === filterMethod; 
ย ย ย ย ย ย return matchesSearch && matchesFilter; 
ย ย ย ย }).sort((a, b) => {
            const dateComparison = new Date(b.date) - new Date(a.date);
            if (dateComparison !== 0) {
                return dateComparison; // 1. ุงูุชุฑุชูุจ ุญุณุจ ุงูุชุงุฑูุฎ ุฃููุงู
            }
            // 2. ุฅุฐุง ูุงู ุงูุชุงุฑูุฎ ูุชุณุงููุงูุ ุฑุชุจ ุญุณุจ ููุช ุงูุฅุถุงูุฉ (ุงูุฃุญุฏุซ ุฃููุงู)
            return b.id.slice(6) - a.id.slice(6); 
        });

ย ย ย ย document.getElementById('transactions-list').innerHTML = transactionsToDisplay.map(t => { 
ย ย ย ย ย ย const category = findCategoryById(t.categoryId); 
ย ย ย ย ย ย const isIncome = t.type === 'income'; 
ย ย ย ย ย ย const isPayment = t.type.includes('payment'); 
ย ย ย ย ย ย const isInvestment = t.type.includes('investment'); 
ย ย ย ย ย ย const amountClass = isIncome || isPayment ? 'text-emerald-400' : 'text-red-400'; 
ย ย ย ย ย ย const sign = isIncome || isPayment ? '+' : '-'; 
ย ย ย ย ย ย return `<tr class="border-b border-slate-700/50 hover:bg-slate-700/20 text-sm"><td class="p-3">${t.date}</td><td class="p-3">${getPaymentMethodName(t.paymentMethod)}</td><td class="p-3">${getTransactionTypeName(t.type)}</td><td class="p-3 font-semibold ${isInvestment ? 'text-blue-400' : amountClass} number-display">${isInvestment ? ' ' : sign} ${formatCurrency(t.amount)} ุฑูุงู</td><td class="p-3">${category ? `${category.icon} ${category.name}` : 'ุบูุฑ ูุญุฏุฏ'}</td><td class="p-3 text-slate-400 hidden sm:table-cell">${t.description || '-'}</td><td class="p-3 text-center"><button data-action="edit" data-id="${t.id}" class="text-slate-400 hover:text-white p-1">โ๏ธ</button><button data-action="delete" data-id="${t.id}" class="text-slate-400 hover:text-red-400 p-1">๐๏ธ</button></td></tr>`; 
ย ย ย ย }).join('');
ย ย }

ย ย function renderInstallments() {
ย ย ย ย const listEl = document.getElementById('active-installments-list');
ย ย ย ย const activeInstallments = state.installments.filter(i => i.paid < i.total);
ย ย ย ย if (activeInstallments.length === 0) {
ย ย ย ย ย ย listEl.innerHTML = `<div class="md:col-span-2 text-center p-6 glass-card"><p class="text-slate-400">๐ ูุง ุชูุฌุฏ ุฃูุณุงุท ูุดุทุฉ ุญุงูููุง!</p></div>`;
ย ย ย ย } else {
ย ย ย ย ย ย listEl.innerHTML = activeInstallments.sort((a,b) => new Date(a.createdAt) - new Date(b.createdAt)).map(i => {
                const remaining = i.total - i.paid; 
                const progress = (i.paid / i.total) * 100; 
                return `<div class="glass-card p-4">
                    <div class="flex justify-between items-start mb-2">
                        <div><h4 class="font-bold text-white">${i.description}</h4><p class="text-sm text-slate-400">${getPaymentMethodName(i.provider)}</p></div>
                        <span class="font-bold text-violet-400 number-display">${formatCurrency(i.installmentAmount)} ุฑูุงู/ุดูุฑ</span>
                    </div>
                    <div class="w-full bg-slate-700 rounded-full h-2.5 mb-1"><div class="bg-violet-500 h-2.5 rounded-full" style="width: ${progress}%"></div></div>
                    <div class="flex justify-between text-xs text-slate-400">
                        <span>${i.paid} / ${i.total} ูุฏููุน</span>
                        <span>ูุชุจูู: <span class="font-semibold">${remaining}</span></span>
                    </div>
                    <div class="text-center mt-4"><button onclick="app.handlePayInstallment('${i.id}')" class="px-4 py-2 bg-violet-600 text-white rounded-lg hover:bg-violet-700 transition-colors text-sm w-full sm:w-auto">ุฏูุน ุงููุณุท ุงูุชุงูู</button></div>
                </div>`; 
            }).join('');
ย ย ย ย }
ย ย ย ย 
ย ย ย ย const installmentTransactions = getFilteredTransactions()
ย ย ย ย ย ย .filter(t => t.paymentMethod.includes('-bnpl') || t.isInstallmentPayment)
ย ย ย ย ย ย .sort((a, b) => {
                const dateComparison = new Date(b.date) - new Date(a.date);
                if (dateComparison !== 0) {
                    return dateComparison;
                }
                return b.id.slice(6) - a.id.slice(6); 
            });

ย ย ย ย document.getElementById('installments-transactions-list').innerHTML = installmentTransactions.map(t => {
ย ย ย ย ย ย const isFirstPayment = t.type === 'expense' && t.paymentMethod.includes('bnpl'); // Old way
ย ย ย ย ย ย const isSubsequentPayment = t.isInstallmentPayment;
ย ย ย ย ย ย let providerName = '';

ย ย ย ย ย ย if (isSubsequentPayment) {
ย ย ย ย ย ย ย ย const installment = findInstallmentById(t.installmentId);
ย ย ย ย ย ย ย ย providerName = `${getPaymentMethodName(installment?.provider)} <span class="text-slate-400">ุนุจุฑ</span> ${getPaymentMethodName(t.paymentMethod)}`;
ย ย ย ย ย ย } else if (isFirstPayment) {
ย ย ย ย ย ย ย ย providerName = getPaymentMethodName(t.paymentMethod);
ย ย ย ย ย ย }

ย ย ย ย ย ย return `<tr class="border-b border-slate-700/50">
ย ย ย ย ย ย ย ย <td class="p-3">${t.date}</td>
ย ย ย ย ย ย ย ย <td class="p-3">${providerName}</td>
ย ย ย ย ย ย ย ย <td class="p-3">${isSubsequentPayment ? 'ุณุฏุงุฏ ูุณุท' : 'ุดุฑุงุก ุฌุฏูุฏ'}</td>
ย ย ย ย ย ย ย ย <td class="p-3 text-red-400 font-semibold number-display">${formatCurrency(t.amount)} ุฑูุงู</td>
ย ย ย ย ย ย ย ย <td class="p-3 text-slate-400">${t.description || '-'}</td>
ย ย ย ย ย ย </tr>`;
ย ย ย ย }).join('');
ย ย }

    function renderCategories() {
        document.getElementById('categories-list').innerHTML = state.categories.map(cat => `<div class="flex items-center justify-between p-2 bg-slate-700/50 rounded-lg"><span class="font-semibold text-slate-200">${cat.icon} ${cat.name}</span><div><button onclick="app.openEditCategoryModal('${cat.id}')" class="text-slate-400 hover:text-white p-1 text-sm">โ๏ธ</button><button onclick="app.handleDeleteCategory('${cat.id}')" class="text-slate-400 hover:text-red-400 p-1 text-sm">๐๏ธ</button></div></div>`).join('');
    }
    
    function renderCategorySummary() {
        const listEl = document.getElementById('category-summary-list');
        if (!listEl) return;
        const transactions = getFilteredTransactions();
        
        const expenseTypes = ['expense', 'bnpl-payment'];
        const expenses = transactions.filter(t => expenseTypes.includes(t.type));
        const totalExpenses = expenses.reduce((sum, t) => sum + t.amount, 0);

        if (totalExpenses === 0) {
            listEl.innerHTML = `<p class="text-slate-400 text-center p-4 text-sm">ูุง ุชูุฌุฏ ูุตุงุฑูู ูู ูุฐู ุงููุชุฑุฉ.</p>`;
            return;
        }

        const expenseTotals = expenses.reduce((acc, t) => {
            const categoryId = t.categoryId || 'cat-7'; // Default to 'Other'
            acc[categoryId] = (acc[categoryId] || 0) + t.amount;
            return acc;
        }, {});

        const sortedCategories = Object.entries(expenseTotals).sort(([, a], [, b]) => b - a);

        listEl.innerHTML = sortedCategories.map(([categoryId, total]) => {
            const category = findCategoryById(categoryId);
            const name = category ? `${category.icon} ${category.name}` : 'ุบูุฑ ูุตูู';
            const percentage = (total / totalExpenses) * 100;
            return `<div class="flex items-center justify-between text-sm py-1">
                <span class="w-28 truncate text-slate-300" title="${category ? category.name : ''}">${name}</span>
                <div class="flex-1 bg-slate-700 rounded-full h-2.5 mx-2">
                    <div class="bg-violet-500 h-2.5 rounded-full" style="width: ${percentage.toFixed(1)}%"></div>
                </div>
                <span class="font-bold text-slate-200 number-display w-24 text-left">${formatCurrency(total)} ุฑูุงู</span>
            </div>`;
        }).join('');
    }

    return { init };
  })();

  document.addEventListener('DOMContentLoaded', () => {
    ExpenseApp.init();
    window.app.showTab('summary');
  });
</script>
</body>
</html>
