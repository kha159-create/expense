<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ÿßŸÑŸÖÿµÿßÿ±ŸäŸÅ</title>
  
  <!-- Meta tags for "Add to Home Screen" -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="ÿßŸÑŸÖÿµÿßÿ±ŸäŸÅ">
  <meta name="theme-color" content="#764ba2">
  
  <!-- Favicon and App Icons -->
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üí∞</text></svg>">
  <link rel="apple-touch-icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAALQAAAC0CAYAAAA9zQYdAAAAAXNSR0IArs4c6QAAAbdJREFUeF7t1AEJADAMAsH2/otMINgHHQkETubt2w8AAB5gCgAAjMQUAAAYiSkAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmAADASEwAAYCSmA_s/AAAAAElFTkSuQmCC">
  
  <!-- Web App Manifest -->
  <link rel="manifest" href='data:application/manifest+json,{"name":"ŸÜÿ∏ÿßŸÖ ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖÿµÿßÿ±ŸäŸÅ","short_name":"ÿßŸÑŸÖÿµÿßÿ±ŸäŸÅ","start_url":".","display":"standalone","background_color":"#f9fafb","theme_color":"#764ba2","icons":[{"src":"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1MTIiIGhlaWdodD0iNTEyIj48cmVjdCB3aWR0aD0iNTEyIiBoZWlnaHQ9IjUxMiIgcng9IjgwIiBmaWxsPSIjNzY0YmEyIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGRvbWluYW50LWJhc2VsaW5lPSJjZW50cmFsIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmb250LXNpemU9IjM0MCI+8J+QujwvdGV4dD48L3N2Zz4=","type":"image/svg+xml","sizes":"512x512"}]}' />
  
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  
  <style>
  @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap');
  
  * {
  font-family: 'Cairo', sans-serif;
  }
  
  body {
  background-color: #f9fafb; /* bg-gray-50 */
  }
  
  .gradient-bg {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  }
  
  .card-shadow {
  box-shadow: 0 10px 25px rgba(0,0,0,0.08);
  }
  
  .animate-fade-in {
  animation: fadeIn 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94) both;
  -webkit-animation: fadeIn 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94) both;
  }
  
  @keyframes fadeIn {
  from { opacity: 0; transform: translateY(20px) scale(0.98); }
  to { opacity: 1; transform: translateY(0) scale(1); }
  }
  
  .magical-hover {
  transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
  }
  
  .magical-hover:hover {
  transform: translateY(-6px);
  box-shadow: 0 18px 35px rgba(0,0,0,0.1), 0 8px 15px rgba(0,0,0,0.06);
  }
  
  .magical-button {
  background: linear-gradient(45deg, #667eea, #764ba2, #8a4ba2);
  background-size: 200% 200%;
  animation: gradientShift 4s ease infinite;
  -webkit-animation: gradientShift 4s ease infinite;
  transition: all 0.3s ease;
  }
  
  .magical-button:hover {
  box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
  transform: scale(1.05);
  -webkit-transform: scale(1.05);
  }
  
  .magical-button:active {
  transform: scale(0.95);
  -webkit-transform: scale(0.95);
  }
  
  @keyframes gradientShift {
  0% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
  100% { background-position: 0% 50%; }
  }
  
  .number-display {
  font-family: 'SF Mono', 'Courier New', monospace;
  direction: ltr;
  text-align: left;
  }
  
  /* Custom Modal & Loader Styles */
  .modal-overlay, #loading-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.6);
  backdrop-filter: blur(5px);
  -webkit-backdrop-filter: blur(5px);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 1000;
  opacity: 0;
  visibility: hidden;
  transition: opacity 0.3s, visibility 0.3s;
  }
  
  .modal-overlay.visible, #loading-overlay.visible {
  opacity: 1;
  visibility: visible;
  }
  
  .modal-content {
  background: white;
  padding: 1.5rem;
  border-radius: 1rem;
  width: 90%;
  max-width: 500px;
  box-shadow: 0 20px 40px rgba(0,0,0,0.25);
  transform: scale(0.95);
  -webkit-transform: scale(0.95);
  transition: transform 0.3s;
  }
  
  .modal-overlay.visible .modal-content {
  transform: scale(1);
  -webkit-transform: scale(1);
  }
  
  .loader {
  border: 8px solid #f3f3f3; /* Light grey */
  border-top: 8px solid #764ba2; /* Purple */
  border-radius: 50%;
  width: 80px;
  height: 80px;
  animation: spin 1s linear infinite;
  -webkit-animation: spin 1s linear infinite;
  }
  
  @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  
  .tab-btn {
  color: #4a5568; /* text-gray-700 */
  background-color: transparent;
  }
  
  .tab-btn.active {
  color: white;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  box-shadow: 0 4px 12px rgba(118, 75, 162, 0.3);
  }
  
  /* AI Chat Styles */
  .chat-bubble {
  max-width: 80%;
  padding: 10px 15px;
  border-radius: 20px;
  }
  
  .user-bubble {
  background-color: #667eea;
  color: white;
  border-bottom-right-radius: 5px;
  align-self: flex-end;
  }
  
  .ai-bubble {
  background-color: #f3f4f6;
  color: #1f2937;
  border-bottom-left-radius: 5px;
  align-self: flex-start;
  }
  
  .typing-indicator span {
  display: inline-block;
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background-color: #9ca3af;
  animation: pulse 1.4s infinite ease-in-out both;
  -webkit-animation: pulse 1.4s infinite ease-in-out both;
  }
  
  .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
  .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
  
  @keyframes pulse {
  0%, 80%, 100% { transform: scale(0); }
  40% { transform: scale(1.0); }
  }
  
  </style>
  </head>
  <body class="bg-gray-50 min-h-screen">
  
  <div id="loading-overlay" class="visible">
  <div id="loader-container">
  <div class="loader inline-block"></div>
  <p id="loading-text" class="text-white mt-4"></p>
  </div>
  <div id="config-prompt" class="hidden text-white bg-gray-800 p-8 rounded-lg shadow-lg max-w-lg mx-4 text-right">
  <h2 class="text-2xl font-bold mb-4">üîë ŸÖÿ∑ŸÑŸàÿ® ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿßÿ™ÿµÿßŸÑ</h2>
  <p class="mb-4">ŸÑÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ Ÿàÿ≠ŸÅÿ∏ ÿ®ŸäÿßŸÜÿßÿ™ŸÉ ÿ®ÿ¥ŸÉŸÑ ÿ¢ŸÖŸÜÿå Ÿäÿ±ÿ¨Ÿâ ÿ™ŸàŸÅŸäÿ± ÿ•ÿπÿØÿßÿØÿßÿ™ Firebase ÿßŸÑÿÆÿßÿµÿ© ÿ®ŸÉ. ŸäŸÖŸÉŸÜŸÉ ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸäŸáÿß ŸÖÿ¨ÿßŸÜÿßŸã ŸÖŸÜ <a href="https://console.firebase.google.com/" target="_blank" class="text-blue-400 hover:underline">ŸÖŸàŸÇÿπ Firebase</a>.</p>
  <p class="mb-2 text-sm">Ÿ°. ÿ£ŸÜÿ¥ÿ¶ ŸÖÿ¥ÿ±ŸàÿπÿßŸã ÿ¨ÿØŸäÿØÿßŸã.</p>
  <p class="mb-4 text-sm">Ÿ¢. ŸÅŸä ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπÿå ÿ£ÿ∂ŸÅ ÿ™ÿ∑ÿ®ŸäŸÇ ŸàŸäÿ® ŸàÿßŸÜÿ≥ÿÆ ŸÉÿßÿ¶ŸÜ ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™ (firebaseConfig).</p>
  <form id="firebase-config-form">
  <label for="firebase-config-input" class="block mb-2">ÿßŸÑÿµŸÇ ÿ•ÿπÿØÿßÿØÿßÿ™ Firebase ŸáŸÜÿß:</label>
  <textarea id="firebase-config-input" rows="8" class="w-full p-2 rounded text-black font-mono text-left" placeholder='{
  "apiKey": "...", "authDomain": "...", ... }'></textarea>
  <button type="submit" class="w-full mt-4 magical-button text-white font-semibold py-2 rounded-lg">ÿ≠ŸÅÿ∏ Ÿàÿ®ÿØÿ° ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ</button>
  </form>
  </div>
  </div>
  
  <header class="gradient-bg text-white py-4 mb-8 shadow-lg">
  <div class="container mx-auto px-4">
  <div class="flex flex-col sm:flex-row justify-between items-center text-center sm:text-right gap-2">
  <div>
  <h1 class="text-2xl sm:text-3xl font-bold tracking-wider">üí∞ ŸÜÿ∏ÿßŸÖ ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖÿµÿßÿ±ŸäŸÅ</h1>
  <p class="mt-1 opacity-80 text-xs sm:text-sm">ÿ•ÿµÿØÿßÿ± ÿÆÿßÿµ ÿÆŸÑŸäŸÑ ÿßŸÑÿµÿßŸÜÿπ</p>
  </div>
  <div class="text-center sm:text-right opacity-90">
  <div id="current-date-header" class="text-xs sm:text-sm font-semibold"></div>
  <div id="current-time-header" class="text-xs font-mono tracking-wider"></div>
  </div>
  </div>
  </div>
  </header>
  
  <div class="container mx-auto px-2 sm:px-4 max-w-7xl">
  <div class="flex flex-wrap justify-center mb-8 bg-white/70 backdrop-blur-lg rounded-xl p-2 card-shadow">
  <button onclick="app.showTab('summary')" id="tab-summary" class="tab-btn px-3 py-2 sm:px-4 sm:py-3 mx-1 mb-2 rounded-lg font-semibold transition-all duration-300 text-sm">üìä ÿßŸÑŸÖŸÑÿÆÿµ</button>
  <button onclick="app.showTab('budget')" id="tab-budget" class="tab-btn px-3 py-2 sm:px-4 sm:py-3 mx-1 mb-2 rounded-lg font-semibold transition-all duration-300 text-sm">‚ú® ÿßŸÑŸÖŸäÿ≤ÿßŸÜŸäÿ© ÿßŸÑÿ∞ŸÉŸäÿ©</button>
  <button onclick="app.showTab('investment')" id="tab-investment" class="tab-btn px-3 py-2 sm:px-4 sm:py-3 mx-1 mb-2 rounded-lg font-semibold transition-all duration-300 text-sm">üíπ ÿßŸÑÿßÿ≥ÿ™ÿ´ŸÖÿßÿ±</button>
  <button onclick="app.showTab('ai-assistant')" id="tab-ai-assistant" class="tab-btn px-3 py-2 sm:px-4 sm:py-3 mx-1 mb-2 rounded-lg font-semibold transition-all duration-300 text-sm">ü§ñ ÿßŸÑŸÖÿ≠ŸÑŸÑ ÿßŸÑÿ∞ŸÉŸä</button>
  <button onclick="app.showTab('transactions')" id="tab-transactions" class="tab-btn px-3 py-2 sm:px-4 sm:py-3 mx-1 mb-2 rounded-lg font-semibold transition-all duration-300 text-sm">üí≥ ÿßŸÑÿ≠ÿ±ŸÉÿßÿ™</button>
  <button onclick="app.showTab('cards')" id="tab-cards" class="tab-btn px-3 py-2 sm:px-4 sm:py-3 mx-1 mb-2 rounded-lg font-semibold transition-all duration-300 text-sm">üí≥ ÿßŸÑÿ®ÿ∑ÿßŸÇÿßÿ™</button>
  <button onclick="app.showTab('bank')" id="tab-bank" class="tab-btn px-3 py-2 sm:px-4 sm:py-3 mx-1 mb-2 rounded-lg font-semibold transition-all duration-300 text-sm">üè¶ ÿßŸÑÿ®ŸÜŸÉ</button>
  <button onclick="app.showTab('installments')" id="tab-installments" class="tab-btn px-3 py-2 sm:px-4 sm:py-3 mx-1 mb-2 rounded-lg font-semibold transition-all duration-300 text-sm">üì± ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑</button>
  <button onclick="app.showTab('categories')" id="tab-categories" class="tab-btn px-3 py-2 sm:px-4 sm:py-3 mx-1 mb-2 rounded-lg font-semibold transition-all duration-300 text-sm">üìÇ ÿßŸÑŸÅÿ¶ÿßÿ™</button>
  <button onclick="app.showTab('export')" id="tab-export" class="tab-btn px-3 py-2 sm:px-4 sm:py-3 mx-1 mb-2 rounded-lg font-semibold transition-all duration-300 text-sm">üíæ ÿ™ÿµÿØŸäÿ±</button>
  </div>
  
  <div id="summary-tab" class="tab-content animate-fade-in">
  <div id="summary-cards-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
  
  <div data-id="card-debt" class="bg-white rounded-xl p-4 sm:p-6 card-shadow">
  <h3 class="text-lg sm:text-xl font-bold mb-4 text-gray-800">üí≥ ŸÖŸÑÿÆÿµ ÿØŸäŸàŸÜ ÿßŸÑÿ®ÿ∑ÿßŸÇÿßÿ™</h3>
  <div class="space-y-4">
  <div class="bg-gradient-to-br from-blue-500 to-indigo-600 text-white p-4 rounded-lg">
  <h4 class="font-bold text-md">SNB ÿßŸÑÿ£ŸáŸÑŸä</h4>
  <div class="flex justify-between text-sm mt-2"><span class="opacity-80">ÿßŸÑŸÖÿ≥ÿ™ÿ≠ŸÇ:</span><span class="font-bold number-display" id="snb-current-balance">0 ÿ±ŸäÿßŸÑ</span></div>
  <div class="flex justify-between text-sm"><span class="opacity-80">ÿßŸÑŸÖÿ™ÿ®ŸÇŸä:</span><span class="font-bold number-display" id="snb-remaining-limit">0 ÿ±ŸäÿßŸÑ</span></div>
  <div class="mt-2 bg-white/30 rounded-full h-2"><div class="bg-white rounded-full h-2" style="width: 0%" id="snb-usage-bar"></div></div>
  </div>
  <div class="bg-gradient-to-br from-red-500 to-rose-600 text-white p-4 rounded-lg">
  <h4 class="font-bold text-md">ENBD ÿßŸÑÿ•ŸÖÿßÿ±ÿßÿ™</h4>
  <div class="flex justify-between text-sm mt-2"><span class="opacity-80">ÿßŸÑŸÖÿ≥ÿ™ÿ≠ŸÇ:</span><span class="font-bold number-display" id="enbd-current-balance">0 ÿ±ŸäÿßŸÑ</span></div>
  <div class="flex justify-between text-sm"><span class="opacity-80">ÿßŸÑŸÖÿ™ÿ®ŸÇŸä:</span><span class="font-bold number-display" id="enbd-remaining-limit">0 ÿ±ŸäÿßŸÑ</span></div>
  <div class="mt-2 bg-white/30 rounded-full h-2"><div class="bg-white rounded-full h-2" style="width: 0%" id="enbd-usage-bar"></div></div>
  </div>
  </div>
  <div class="mt-4 p-3 bg-gray-100 rounded-lg">
  <div class="grid grid-cols-3 gap-2 text-center">
  <div>
  <p class="text-gray-600 text-xs">ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿØŸäŸàŸÜ</p>
  <p class="text-lg font-bold text-red-600 number-display" id="total-debt">0 ÿ±ŸäÿßŸÑ</p>
  </div>
  <div>
  <p class="text-gray-600 text-xs">ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖÿ™ÿßÿ≠</p>
  <p class="text-lg font-bold text-green-600 number-display" id="total-available">0 ÿ±ŸäÿßŸÑ</p>
  </div>
  <div>
  <p class="text-gray-600 text-xs">ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿ≠ÿØŸàÿØ</p>
  <p class="text-lg font-bold text-blue-600 number-display" id="total-limits">0 ÿ±ŸäÿßŸÑ</p>
  </div>
  </div>
  </div>
  </div>
  
  <div data-id="financial-report" class="bg-white rounded-xl p-4 sm:p-6 card-shadow">
  <h3 class="text-lg sm:text-xl font-bold mb-4 text-gray-800">üìà ÿ™ŸÇÿ±Ÿäÿ± ŸÖÿßŸÑŸä ÿ¥ÿßŸÖŸÑ</h3>
  <div class="space-y-1 text-sm">
  <div class="flex justify-between"><span>ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿØÿÆŸÑ:</span><span class="font-bold text-green-600 number-display" id="report-income">0 ÿ±ŸäÿßŸÑ</span></div>
  <div class="flex justify-between"><span>ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖÿµÿßÿ±ŸäŸÅ:</span><span class="font-bold text-red-600 number-display" id="report-expenses">0 ÿ±ŸäÿßŸÑ</span></div>
  <hr class="my-1 border-gray-200">
  <div class="flex justify-between text-xs">
  <span class="text-gray-600">ŸÖÿµÿßÿ±ŸäŸÅ ÿ®ÿ∑ÿßŸÇÿ© SNB:</span>
  <span class="font-semibold text-indigo-600 number-display" id="report-snb-expenses">0 ÿ±ŸäÿßŸÑ</span>
  </div>
  <div class="flex justify-between text-xs">
  <span class="text-gray-600">ŸÖÿµÿßÿ±ŸäŸÅ ÿ®ÿ∑ÿßŸÇÿ© ENBD:</span>
  <span class="font-semibold text-red-600 number-display" id="report-enbd-expenses">0 ÿ±ŸäÿßŸÑ</span>
  </div>
  <hr class="my-1 border-gray-200 border-dashed">
  <div class="flex justify-between text-xs">
  <span class="text-gray-600">ÿ•ÿ¨ŸÖÿßŸÑŸä ÿ≥ÿØÿßÿØ SNB:</span>
  <span class="font-semibold text-green-600 number-display" id="report-snb-payments">0 ÿ±ŸäÿßŸÑ</span>
  </div>
  <div class="flex justify-between text-xs">
  <span class="text-gray-600">ÿ•ÿ¨ŸÖÿßŸÑŸä ÿ≥ÿØÿßÿØ ENBD:</span>
  <span class="font-semibold text-green-600 number-display" id="report-enbd-payments">0 ÿ±ŸäÿßŸÑ</span>
  </div>
  <hr class="my-1 border-gray-200">
  <div class="flex justify-between font-bold text-lg"><span>ÿßŸÑÿµÿßŸÅŸä:</span><span id="report-net" class="number-display">0 ÿ±ŸäÿßŸÑ</span></div>
  <hr class="my-1 border-gray-200">
  <div class="flex justify-between"><span>ÿπÿØÿØ ÿßŸÑŸÖÿπÿßŸÖŸÑÿßÿ™:</span><span class="font-bold" id="report-count">0</span></div>
  <div class="flex justify-between"><span>ŸÖÿ™Ÿàÿ≥ÿ∑ ÿßŸÑŸÖÿπÿßŸÖŸÑÿ©:</span><span class="font-bold number-display" id="report-average">0 ÿ±ŸäÿßŸÑ</span></div>
  <div class="flex justify-between"><span>ÿ£ŸÉÿ®ÿ± ŸÖÿπÿßŸÖŸÑÿ©:</span><span class="font-bold number-display" id="report-max">0 ÿ±ŸäÿßŸÑ</span></div>
  </div>
  </div>

  <div data-id="category-summary" class="bg-white rounded-xl p-4 sm:p-6 card-shadow">
    <h3 class="text-lg sm:text-xl font-bold mb-4 text-gray-800">üìä ŸÖŸÑÿÆÿµ ÿßŸÑŸÅÿ¶ÿßÿ™</h3>
    <div id="category-summary-list" class="space-y-2 max-h-96 overflow-y-auto pr-2">
        <!-- JS will populate this -->
    </div>
</div>
  
  </div>
  </div>
  
   <div id="budget-tab" class="tab-content hidden animate-fade-in">
    <div class="bg-white rounded-xl p-6 card-shadow">
      <h3 class="text-xl font-bold mb-4 text-gray-800">‚ú® ÿßŸÑŸÖŸäÿ≤ÿßŸÜŸäÿ© ÿßŸÑÿ¥Ÿáÿ±Ÿäÿ© ÿßŸÑÿ∞ŸÉŸäÿ©</h3>
      <div class="flex flex-col sm:flex-row items-end gap-4 mb-6 p-4 bg-gray-50 rounded-lg">
        <div class="flex-grow">
          <label for="monthly-budget-input" class="block text-sm font-medium text-gray-700 mb-1">ÿ£ÿØÿÆŸÑ ÿ•ÿ¨ŸÖÿßŸÑŸä ŸÖŸäÿ≤ÿßŸÜŸäÿ™ŸÉ ÿßŸÑÿ¥Ÿáÿ±Ÿäÿ© (ÿ±ŸäÿßŸÑ)</label>
          <input type="number" id="monthly-budget-input" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="5000">
        </div>
        <button id="generate-budget-btn" class="w-full sm:w-auto px-6 py-2 magical-button text-white rounded-lg font-semibold flex-shrink-0">‚ú® ÿ•ŸÜÿ¥ÿßÿ° ÿÆÿ∑ÿ© ÿßŸÑŸÖŸäÿ≤ÿßŸÜŸäÿ©</button>
      </div>
      <div id="budget-plan-result" class="prose prose-sm max-w-none">
        <p class="text-center text-gray-500">ÿ£ÿØÿÆŸÑ ŸÖŸäÿ≤ÿßŸÜŸäÿ™ŸÉ ÿ£ÿπŸÑÿßŸá ŸÑŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ÿÆÿ∑ÿ© ŸÖÿÆÿµÿµÿ© ÿ®ŸÜÿßÿ°Ÿã ÿπŸÑŸâ ÿ•ŸÜŸÅÿßŸÇŸÉ.</p>
      </div>
    </div>
  </div>

  <div id="investment-tab" class="tab-content hidden animate-fade-in">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Left Column: Summary & Actions -->
      <div class="lg:col-span-1 space-y-6">
        <div class="bg-white rounded-xl p-6 card-shadow text-center">
          <h3 class="text-lg font-bold text-gray-800 mb-2">üí∞ ÿßŸÑŸÇŸäŸÖÿ© ÿßŸÑÿ≠ÿßŸÑŸäÿ© ŸÑŸÑŸÖÿ≠ŸÅÿ∏ÿ©</h3>
          <p class="text-4xl font-bold text-green-600 number-display" id="investment-current-value">0.00 ÿ±ŸäÿßŸÑ</p>
          <p class="text-sm text-gray-500 mt-2">ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÖÿ≥ÿ™ÿ´ŸÖÿ±: <span id="investment-total-invested" class="font-semibold number-display">0.00 ÿ±ŸäÿßŸÑ</span></p>
          <button onclick="app.openUpdateInvestmentValueModal()" class="mt-4 w-full px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition-colors text-sm">‚úèÔ∏è ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÇŸäŸÖÿ© ÿßŸÑÿ≠ÿßŸÑŸäÿ©</button>
        </div>
        <div class="bg-white rounded-xl p-6 card-shadow">
          <h3 class="text-lg font-bold text-gray-800 mb-4">üí∏ ÿ•ÿ∂ÿßŸÅÿ© ÿ≠ÿ±ŸÉÿ© ÿßÿ≥ÿ™ÿ´ŸÖÿßÿ±Ÿäÿ©</h3>
          <form id="investment-form" class="space-y-4">
            <div>
              <label for="investment-amount" class="block text-sm font-medium text-gray-700">ÿßŸÑŸÖÿ®ŸÑÿ∫</label>
              <input type="number" id="investment-amount" class="mt-1 w-full p-2 border border-gray-300 rounded-lg" required>
            </div>
            <div>
              <label for="investment-type" class="block text-sm font-medium text-gray-700">ŸÜŸàÿπ ÿßŸÑÿ≠ÿ±ŸÉÿ©</label>
              <select id="investment-type" class="mt-1 w-full p-2 border border-gray-300 rounded-lg">
                <option value="deposit">ÿ•ŸäÿØÿßÿπ ŸÑŸÑŸÖÿ≠ŸÅÿ∏ÿ©</option>
                <option value="withdrawal">ÿ≥ÿ≠ÿ® ŸÖŸÜ ÿßŸÑŸÖÿ≠ŸÅÿ∏ÿ©</option>
              </select>
            </div>
            <button type="submit" class="w-full magical-button text-white font-semibold py-2 rounded-lg">ÿ™ŸÜŸÅŸäÿ∞ ÿßŸÑÿ≠ÿ±ŸÉÿ©</button>
          </form>
        </div>
      </div>
      <!-- Right Column: AI Coach -->
      <div class="lg:col-span-2 bg-white rounded-xl card-shadow overflow-hidden flex flex-col" style="height: 75vh;">
        <div class="p-4 gradient-bg text-white text-center flex-shrink-0">
          <h3 class="text-xl font-bold">ü§ñ ŸÖÿ≥ÿ™ÿ¥ÿßÿ±ŸÉ ÿßŸÑÿßÿ≥ÿ™ÿ´ŸÖÿßÿ±Ÿä ÿßŸÑÿ∞ŸÉŸä</h3>
          <p class="text-sm opacity-80">ÿßÿ≥ÿ£ŸÑ ÿπŸÜ ÿßŸÑŸÖŸÅÿßŸáŸäŸÖ ŸàÿßŸÑÿßÿ≥ÿ™ÿ±ÿßÿ™Ÿäÿ¨Ÿäÿßÿ™ ŸÑÿßÿ™ÿÆÿßÿ∞ ŸÇÿ±ÿßÿ±ÿßÿ™ ÿ£ŸÅÿ∂ŸÑ</p>
        </div>
        <div id="investment-ai-chat-box" class="p-4 flex-grow overflow-y-auto flex flex-col gap-4">
          <div class="ai-bubble chat-bubble">
            <p>ÿ£ŸáŸÑÿßŸã ÿ®ŸÉ! ÿ£ŸÜÿß ŸÖÿ±ÿ¥ÿØŸÉ ŸÑŸÅŸáŸÖ ÿπÿßŸÑŸÖ ÿßŸÑÿßÿ≥ÿ™ÿ´ŸÖÿßÿ±. ŸäŸÖŸÉŸÜŸÉ ÿ≥ÿ§ÿßŸÑŸä ÿπŸÜ ÿßÿ≥ÿ™ÿ±ÿßÿ™Ÿäÿ¨Ÿäÿßÿ™ÿå ÿ£Ÿà ŸÖŸÅÿßŸáŸäŸÖ ŸÖÿ´ŸÑ "ŸÖÿß ŸáŸà ÿßŸÑÿßÿ≥ÿ™ÿ´ŸÖÿßÿ± ÿ∑ŸàŸäŸÑ ÿßŸÑÿ£ÿ¨ŸÑÿü". ÿ™ÿ∞ŸÉÿ±ÿå ÿ£ŸÜÿß ŸÑÿß ÿ£ŸÇÿØŸÖ ŸÜÿµÿßÿ¶ÿ≠ ŸÖÿ®ÿßÿ¥ÿ±ÿ© ŸÑÿ¥ÿ±ÿßÿ° ÿ£ÿ≥ŸáŸÖ ŸÖÿπŸäŸÜÿ©.</p>
          </div>
        </div>
        <div class="p-4 border-t border-gray-200 flex-shrink-0">
          <form id="investment-ai-input-form" class="flex gap-2">
            <input type="text" id="investment-ai-user-input" class="w-full p-3 border border-gray-300 rounded-full" placeholder="ÿßÿ≥ÿ£ŸÑ ÿπŸÜ ÿßŸÑÿßÿ≥ÿ™ÿ´ŸÖÿßÿ±..." required autocomplete="off">
            <button type="submit" class="p-3 magical-button text-white rounded-full flex-shrink-0">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
            </button>
          </form>
        </div>
      </div>
    </div>
</div>

  
<div id="ai-assistant-tab" class="tab-content hidden animate-fade-in">
    <div class="bg-white rounded-xl card-shadow overflow-hidden flex flex-col" style="height: 70vh;">
        <div class="p-4 gradient-bg text-white text-center flex-shrink-0">
            <h3 class="text-xl font-bold">ü§ñ ÿßŸÑŸÖÿ≠ŸÑŸÑ ÿßŸÑŸÖÿßŸÑŸä ÿßŸÑÿ∞ŸÉŸä</h3>
            <p class="text-sm opacity-80">ÿßÿ≥ÿ£ŸÑ ÿ£Ÿä ÿ¥Ÿäÿ° ÿπŸÜ ÿ®ŸäÿßŸÜÿßÿ™ŸÉ ÿßŸÑŸÖÿßŸÑŸäÿ©</p>
        </div>
        <div id="ai-chat-box" class="p-4 flex-grow overflow-y-auto flex flex-col gap-4">
            <div class="ai-bubble chat-bubble">
                <p>ÿ£ŸáŸÑÿßŸã ÿ®ŸÉ! ÿ£ŸÜÿß ŸÖÿ≥ÿßÿπÿØŸÉ ÿßŸÑŸÖÿßŸÑŸä ÿßŸÑÿ¥ÿßŸÖŸÑ. ŸäŸÖŸÉŸÜŸÉ ÿ£ŸÜ ÿ™ÿ≥ÿ£ŸÑŸÜŸä ÿ£ÿ≥ÿ¶ŸÑÿ© ÿ™ŸÅÿµŸäŸÑŸäÿ© ÿπŸÜ Ÿàÿ∂ÿπŸÉ ÿßŸÑŸÖÿßŸÑŸäÿå ŸÖÿ´ŸÑ "ŸÖÿß ŸáŸà ÿ•ÿ¨ŸÖÿßŸÑŸä ÿØŸäŸàŸÜŸäÿü" ÿ£Ÿà "ŸáŸÑ ÿ•ŸÜŸÅÿßŸÇŸä Ÿáÿ∞ÿß ÿßŸÑÿ¥Ÿáÿ± Ÿäÿ™ŸàÿßŸÅŸÇ ŸÖÿπ ÿ£ŸáÿØÿßŸÅŸäÿü"</p>
            </div>
        </div>
        <div class="p-4 border-t border-gray-200 flex-shrink-0">
            <form id="ai-input-form" class="flex gap-2">
                <input type="text" id="ai-user-input" class="w-full p-3 border border-gray-300 rounded-full focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="ÿßŸÉÿ™ÿ® ÿ≥ÿ§ÿßŸÑŸÉ ŸáŸÜÿß..." required autocomplete="off">
                <button type="submit" class="p-3 magical-button text-white rounded-full flex-shrink-0">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                </button>
            </form>
        </div>
    </div>
</div>
  
  <div id="transactions-tab" class="tab-content hidden animate-fade-in">
    <input type="file" id="receipt-upload" class="hidden" accept="image/*">
  <!-- Transactions Tab Content -->
  <div class="bg-white rounded-xl p-4 sm:p-6 card-shadow mb-6">
  <div class="flex flex-wrap justify-between items-center mb-4 gap-2">
      <h3 class="text-lg sm:text-xl font-bold text-gray-800">‚ûï ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿπÿßŸÖŸÑÿ© ÿ¨ÿØŸäÿØÿ©</h3>
      <div class="flex items-center gap-2">
        <button id="scan-receipt-btn" class="flex items-center gap-2 px-3 py-2 bg-green-100 text-green-700 rounded-lg hover:bg-green-200 transition-colors text-sm font-semibold">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-camera-fill" viewBox="0 0 16 16"><path d="M10.5 8.5a2.5 2.5 0 1 1-5 0 2.5 2.5 0 0 1 5 0z"/><path d="M2 4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2h-1.172a2 2 0 0 1-1.414-.586l-.828-.828A2 2 0 0 0 9.172 2H6.828a2 2 0 0 0-1.414.586l-.828.828A2 2 0 0 1 3.172 4H2zm.5 2a.5.5 0 1 1 0-1 .5.5 0 0 1 0 1zm9 2.5a3.5 3.5 0 1 1-7 0 3.5 3.5 0 0 1 7 0z"/></svg>
          ŸÖÿ≥ÿ≠ ŸÅÿßÿ™Ÿàÿ±ÿ©
        </button>
        <button id="voice-input-btn" class="flex items-center gap-2 px-3 py-2 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 transition-colors text-sm font-semibold">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-mic-fill" viewBox="0 0 16 16"><path d="M5 3a3 3 0 0 1 6 0v5a3 3 0 0 1-6 0V3z"/><path d="M3.5 6.5A.5.5 0 0 1 4 7v1a4 4 0 0 0 8 0V7a.5.5 0 0 1 1 0v1a5 5 0 0 1-4.5 4.975V15h3a.5.5 0 0 1 0 1h-7a.5.5 0 0 1 0-1h3v-2.025A5 5 0 0 1 3 8V7a.5.5 0 0 1 .5-.5z"/></svg>
          ÿ•ÿØÿÆÿßŸÑ ÿµŸàÿ™Ÿä
        </button>
        <button id="paste-from-clipboard-btn" class="flex items-center gap-2 px-3 py-2 bg-indigo-100 text-indigo-700 rounded-lg hover:bg-indigo-200 transition-colors text-sm font-semibold">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard-plus" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/><path fill-rule="evenodd" d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zM8 7a.5.5 0 0 1 .5.5V9H10a.5.5 0 0 1 0 1H8.5v1.5a.5.5 0 0 1-1 0V10H6a.5.5 0 0 1 0-1h1.5V7.5A.5.5 0 0 1 8 7z"/></svg>
          ŸÑÿµŸÇ
        </button>
      </div>
  </div>
  <form id="transaction-form" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 items-end">
  <div>
  <label class="block text-sm font-medium text-gray-700 mb-2">Ÿàÿ≥ŸäŸÑÿ© ÿßŸÑÿØŸÅÿπ</label>
  <select id="payment-method" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
  <option value="mada-bank">üè¶ ŸÖÿØŸâ/ÿ≠ÿ≥ÿßÿ® ÿ®ŸÜŸÉŸä</option>
  <option value="cash">üíµ ŸÜŸÇÿØŸä</option>
  <option value="snb-card">üí≥ SNB ÿßŸÑÿ£ŸáŸÑŸä (ÿ®ÿ∑ÿßŸÇÿ©)</option>
  <option value="enbd-card">üí≥ ENBD ÿßŸÑÿ•ŸÖÿßÿ±ÿßÿ™ (ÿ®ÿ∑ÿßŸÇÿ©)</option>
  <option value="tabby-bnpl">üì± ÿ™ÿßÿ®Ÿä (BNPL)</option>
  <option value="tamara-bnpl">üì± ÿ™ŸÖÿßÿ±ÿß (BNPL)</option>
  </select>
  </div>
  <div>
  <label class="block text-sm font-medium text-gray-700 mb-2">ŸÜŸàÿπ ÿßŸÑÿ≠ÿ±ŸÉÿ©</label>
  <select id="transaction-type" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
  <option value="income">üí∞ ÿØÿÆŸÑ</option>
  <option value="expense" selected>üí∏ ŸÖÿµÿßÿ±ŸäŸÅ</option>
  <option value="snb-payment">üí≥ ÿ≥ÿØÿßÿØ ÿ®ÿ∑ÿßŸÇÿ© SNB ÿßŸÑÿ£ŸáŸÑŸä</option>
  <option value="enbd-payment">üí≥ ÿ≥ÿØÿßÿØ ÿ®ÿ∑ÿßŸÇÿ© ENBD ÿßŸÑÿ•ŸÖÿßÿ±ÿßÿ™</option>
  </select>
  </div>
  <div>
  <label class="block text-sm font-medium text-gray-700 mb-2">ÿßŸÑŸÖÿ®ŸÑÿ∫ (ÿ±ŸäÿßŸÑ)</label>
  <input type="number" id="transaction-amount" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="0.00" step="0.01" required>
  </div>
  <div>
  <label class="block text-sm font-medium text-gray-700 mb-2">ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑŸÖÿπÿßŸÖŸÑÿ©</label>
  <input type="date" id="transaction-date" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
  </div>
  <div>
  <label class="block text-sm font-medium text-gray-700 mb-2">ÿßŸÑŸÅÿ¶ÿ©</label>
  <select id="transaction-category" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"></select>
  </div>
  <div class="lg:col-span-4">
  <label class="block text-sm font-medium text-gray-700 mb-2">ÿßŸÑŸàÿµŸÅ</label>
  <input type="text" id="transaction-description" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="ŸàÿµŸÅ ÿßŸÑŸÖÿπÿßŸÖŸÑÿ©">
  </div>
  <div id="installments-field" class="hidden">
  <label class="block text-sm font-medium text-gray-700 mb-2">ÿπÿØÿØ ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑</label>
  <select id="installments-count" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
  <option value="2">ŸÇÿ≥ÿ∑ŸäŸÜ (2)</option>
  <option value="3">3 ÿ£ŸÇÿ≥ÿßÿ∑</option>
  <option value="4" selected>4 ÿ£ŸÇÿ≥ÿßÿ∑</option>
  </select>
  </div>
  <div class="lg:col-span-1 flex items-end">
  <button type="submit" class="w-full px-8 py-3 magical-button text-white rounded-lg font-semibold">
  ‚ú® ÿ•ÿ∂ÿßŸÅÿ© ‚ú®
  </button>
  </div>
  </form>
  </div>
  <div class="bg-white rounded-xl p-4 sm:p-6 card-shadow">
  <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 gap-4">
  <h3 class="text-lg sm:text-xl font-bold text-gray-800">üìã ÿ≥ÿ¨ŸÑ ÿßŸÑŸÖÿπÿßŸÖŸÑÿßÿ™</h3>
  <div class="flex flex-col md:flex-row gap-2 w-full md:w-auto">
  <input type="text" id="search-transactions" placeholder="üîç ÿßŸÑÿ®ÿ≠ÿ´..." class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent w-full md:w-64">
  <select id="filter-payment-method" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
  <option value="">ŸÉŸÑ ÿßŸÑŸàÿ≥ÿßÿ¶ŸÑ</option>
  <option value="mada-bank">üè¶ ÿ®ŸÜŸÉ</option>
  <option value="cash">üíµ ŸÜŸÇÿØŸä</option>
  <option value="snb-card">üí≥ SNB</option>
  <option value="enbd-card">üí≥ ENBD</option>
  <option value="tabby-bnpl">üì± ÿ™ÿßÿ®Ÿä</option>
  <option value="tamara-bnpl">üì± ÿ™ŸÖÿßÿ±ÿß</option>
  </select>
  </div>
  </div>
  <div class="overflow-x-auto">
  <table class="w-full">
  <thead>
  <tr class="border-b-2 border-gray-200">
  <th class="text-right py-3 px-4 font-semibold text-gray-700 text-sm">ÿßŸÑÿ™ÿßÿ±ŸäÿÆ</th>
  <th class="text-right py-3 px-4 font-semibold text-gray-700 text-sm">ÿßŸÑŸàÿ≥ŸäŸÑÿ©</th>
  <th class="text-right py-3 px-4 font-semibold text-gray-700 text-sm">ÿßŸÑŸÜŸàÿπ</th>
  <th class="text-right py-3 px-4 font-semibold text-gray-700 text-sm">ÿßŸÑŸÖÿ®ŸÑÿ∫</th>
  <th class="text-right py-3 px-4 font-semibold text-gray-700 text-sm">ÿßŸÑŸÅÿ¶ÿ©</th>
  <th class="text-right py-3 px-4 font-semibold text-gray-700 text-sm hidden sm:table-cell">ÿßŸÑŸàÿµŸÅ</th>
  <th class="text-center py-3 px-4 font-semibold text-gray-700 text-sm">ÿ•ÿ¨ÿ±ÿßÿ°</th>
  </tr>
  </thead>
  <tbody id="transactions-list"></tbody>
  </table>
  </div>
  </div>
  </div>
  
  <div id="cards-tab" class="tab-content hidden animate-fade-in">
  <!-- Cards Tab Content -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
  <div class="bg-gradient-to-br from-blue-500 to-indigo-600 text-white p-6 rounded-xl card-shadow magical-hover">
  <div class="flex items-center justify-between mb-4">
  <h3 class="text-xl font-bold">üí≥ ÿ®ÿ∑ÿßŸÇÿ© SNB ÿßŸÑÿ£ŸáŸÑŸä</h3>
  <button onclick="app.openEditCardModal('snb')" class="text-sm bg-white bg-opacity-20 hover:bg-opacity-30 p-2 rounded-full transition">‚úèÔ∏è ÿ™ÿπÿØŸäŸÑ</button>
  </div>
  <div class="space-y-3">
  <div class="flex justify-between">
  <span class="text-blue-100">ÿßŸÑÿ±ÿµŸäÿØ ÿßŸÑŸÖÿ≥ÿ™ÿ≠ŸÇ:</span>
  <span class="font-bold number-display" id="snb-balance-display">0 ÿ±ŸäÿßŸÑ</span>
  </div>
  <div class="flex justify-between">
  <span class="text-blue-100">ÿßŸÑÿ≠ÿØ ÿßŸÑÿßÿ¶ÿ™ŸÖÿßŸÜŸä:</span>
  <span class="font-bold number-display" id="snb-limit-display">26,000 ÿ±ŸäÿßŸÑ</span>
  </div>
  <div class="flex justify-between">
  <span class="text-blue-100">ÿßŸÑÿ±ÿµŸäÿØ ÿßŸÑŸÖÿ™ÿßÿ≠:</span>
  <span class="font-bold number-display text-green-300" id="snb-available-display">0 ÿ±ŸäÿßŸÑ</span>
  </div>
  <div class="flex justify-between">
  <span class="text-blue-100">ŸäŸàŸÖ ÿßŸÑÿßÿ≥ÿ™ÿ≠ŸÇÿßŸÇ:</span>
  <span class="font-bold" id="snb-due-day-display">ŸäŸàŸÖ 15</span>
  </div>
  <div class="mt-4 bg-white/30 rounded-full h-3">
  <div class="bg-white rounded-full h-3" id="snb-progress-bar" style="width: 0%"></div>
  </div>
  <p class="text-xs text-blue-100 text-center">ŸÜÿ≥ÿ®ÿ© ÿßŸÑÿßÿ≥ÿ™ÿÆÿØÿßŸÖ: <span id="snb-usage-display">0%</span></p>
  </div>
  </div>
  
  <div class="bg-gradient-to-br from-red-500 to-rose-600 text-white p-6 rounded-xl card-shadow magical-hover">
  <div class="flex items-center justify-between mb-4">
  <h3 class="text-xl font-bold">üí≥ ÿ®ÿ∑ÿßŸÇÿ© ENBD ÿßŸÑÿ•ŸÖÿßÿ±ÿßÿ™</h3>
  <button onclick="app.openEditCardModal('enbd')" class="text-sm bg-white bg-opacity-20 hover:bg-opacity-30 p-2 rounded-full transition">‚úèÔ∏è ÿ™ÿπÿØŸäŸÑ</button>
  </div>
  <div class="space-y-3">
  <div class="flex justify-between">
  <span class="text-red-100">ÿßŸÑÿ±ÿµŸäÿØ ÿßŸÑŸÖÿ≥ÿ™ÿ≠ŸÇ:</span>
  <span class="font-bold number-display" id="enbd-balance-display">0 ÿ±ŸäÿßŸÑ</span>
  </div>
  <div class="flex justify-between">
  <span class="text-red-100">ÿßŸÑÿ≠ÿØ ÿßŸÑÿßÿ¶ÿ™ŸÖÿßŸÜŸä:</span>
  <span class="font-bold number-display" id="enbd-limit-display">10,000 ÿ±ŸäÿßŸÑ</span>
  </div>
  <div class="flex justify-between">
  <span class="text-red-100">ÿßŸÑÿ±ÿµŸäÿØ ÿßŸÑŸÖÿ™ÿßÿ≠:</span>
  <span class="font-bold number-display text-green-300" id="enbd-available-display">0 ÿ±ŸäÿßŸÑ</span>
  </div>
  <div class="flex justify-between">
  <span class="text-red-100">ŸäŸàŸÖ ÿßŸÑÿßÿ≥ÿ™ÿ≠ŸÇÿßŸÇ:</span>
  <span class="font-bold" id="enbd-due-day-display">ŸäŸàŸÖ 18</span>
  </div>
  <div class="mt-4 bg-white/30 rounded-full h-3">
  <div class="bg-white rounded-full h-3" id="enbd-progress-bar" style="width: 0%"></div>
  </div>
  <p class="text-xs text-red-100 text-center">ŸÜÿ≥ÿ®ÿ© ÿßŸÑÿßÿ≥ÿ™ÿÆÿØÿßŸÖ: <span id="enbd-usage-display">0%</span></p>
  </div>
  </div>
  </div>
  <div class="bg-white rounded-xl p-6 card-shadow">
  <h3 class="text-xl font-bold mb-4 text-gray-800">üìã ÿ™ÿßÿ±ŸäÿÆ ŸÖÿπÿßŸÖŸÑÿßÿ™ ÿßŸÑÿ®ÿ∑ÿßŸÇÿßÿ™</h3>
  <div class="overflow-x-auto">
  <table class="w-full">
  <thead>
  <tr class="border-b-2 border-gray-200">
  <th class="text-right py-3 px-4 font-semibold text-gray-700">ÿßŸÑÿ™ÿßÿ±ŸäÿÆ</th>
  <th class="text-right py-3 px-4 font-semibold text-gray-700">ÿßŸÑÿ®ÿ∑ÿßŸÇÿ©</th>
  <th class="text-right py-3 px-4 font-semibold text-gray-700">ŸÜŸàÿπ ÿßŸÑÿπŸÖŸÑŸäÿ©</th>
  <th class="text-right py-3 px-4 font-semibold text-gray-700">ÿßŸÑŸÖÿ®ŸÑÿ∫</th>
  <th class="text-right py-3 px-4 font-semibold text-gray-700">ÿßŸÑŸàÿµŸÅ</th>
  </tr>
  </thead>
  <tbody id="cards-transactions-list"></tbody>
  </table>
  </div>
  </div>
  </div>
  
  <div id="bank-tab" class="tab-content hidden animate-fade-in">
  <!-- Bank Tab Content -->
  <div class="bg-white rounded-xl p-6 card-shadow mb-6">
  <div class="flex justify-between items-center mb-4">
  <h3 class="text-xl font-bold text-gray-800">üè¶ ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿ≠ÿ≥ÿßÿ® ÿßŸÑÿ®ŸÜŸÉŸä</h3>
  <button onclick="app.openEditBankModal()" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors text-sm">‚úèÔ∏è ÿ™ÿπÿØŸäŸÑ ÿßŸÑÿ±ÿµŸäÿØ / ÿ™ÿ≥ŸàŸäÿ©</button>
  </div>
  <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
  <div class="text-center p-6 bg-blue-50 rounded-lg border border-blue-200">
  <div class="text-3xl mb-3">üí∞</div>
  <p class="text-blue-600 font-semibold">ÿßŸÑÿ±ÿµŸäÿØ ÿßŸÑÿ≠ÿßŸÑŸä</p>
  <p class="text-2xl font-bold text-blue-700 number-display" id="bank-balance">0 ÿ±ŸäÿßŸÑ</p>
  </div>
  <div class="text-center p-6 bg-green-50 rounded-lg border border-green-200">
  <div class="text-3xl mb-3">üìà</div>
  <p class="text-green-600 font-semibold">ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿ•ŸäÿØÿßÿπÿßÿ™</p>
  <p class="text-2xl font-bold text-green-700 number-display" id="bank-deposits">0 ÿ±ŸäÿßŸÑ</p>
  </div>
  <div class="text-center p-6 bg-red-50 rounded-lg border border-red-200">
  <div class="text-3xl mb-3">üìâ</div>
  <p class="text-red-600 font-semibold">ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿ≥ÿ≠Ÿàÿ®ÿßÿ™</p>
  <p class="text-2xl font-bold text-red-700 number-display" id="bank-withdrawals">0 ÿ±ŸäÿßŸÑ</p>
  </div>
  </div>
  </div>
  <div class="bg-white rounded-xl p-6 card-shadow">
  <h3 class="text-xl font-bold mb-4 text-gray-800">üìã ŸÖÿπÿßŸÖŸÑÿßÿ™ ÿßŸÑÿ≠ÿ≥ÿßÿ® ÿßŸÑÿ®ŸÜŸÉŸä</h3>
  <div class="overflow-x-auto">
  <table class="w-full">
  <thead>
  <tr class="border-b-2 border-gray-200">
  <th class="text-right py-3 px-4 font-semibold text-gray-700">ÿßŸÑÿ™ÿßÿ±ŸäÿÆ</th>
  <th class="text-right py-3 px-4 font-semibold text-gray-700">ŸÜŸàÿπ ÿßŸÑÿπŸÖŸÑŸäÿ©</th>
  <th class="text-right py-3 px-4 font-semibold text-gray-700">ÿßŸÑŸÖÿ®ŸÑÿ∫</th>
  <th class="text-right py-3 px-4 font-semibold text-gray-700">ÿßŸÑŸÅÿ¶ÿ©</th>
  <th class="text-right py-3 px-4 font-semibold text-gray-700">ÿßŸÑŸàÿµŸÅ</th>
  </tr>
  </thead>
  <tbody id="bank-transactions-list"></tbody>
  </table>
  </div>
  </div>
  </div>
  
  <div id="installments-tab" class="tab-content hidden animate-fade-in">
  <!-- Installments Tab Content -->
  <h3 class="text-2xl font-bold mb-4 text-gray-800">üì± ÿÆÿ∑ÿ∑ ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑ ÿßŸÑŸÜÿ¥ÿ∑ÿ©</h3>
  <div id="active-installments-list" class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
  </div>
  <div class="bg-white rounded-xl p-6 card-shadow mt-8">
  <h3 class="text-xl font-bold mb-4 text-gray-800">üìã ÿ≥ÿ¨ŸÑ ŸÖÿπÿßŸÖŸÑÿßÿ™ ÿßŸÑÿ£ŸÇÿ≥ÿßÿ∑</h3>
  <div class="overflow-x-auto">
  <table class="w-full">
  <thead>
  <tr class="border-b-2 border-gray-200">
  <th class="text-right py-3 px-4 font-semibold text-gray-700">ÿßŸÑÿ™ÿßÿ±ŸäÿÆ</th>
  <th class="text-right py-3 px-4 font-semibold text-gray-700">ÿßŸÑŸÖŸÜÿµÿ©</th>
  <th class="text-right py-3 px-4 font-semibold text-gray-700">ŸÜŸàÿπ ÿßŸÑÿπŸÖŸÑŸäÿ©</th>
  <th class="text-right py-3 px-4 font-semibold text-gray-700">ÿßŸÑŸÖÿ®ŸÑÿ∫</th>
  <th class="text-right py-3 px-4 font-semibold text-gray-700">ÿßŸÑŸàÿµŸÅ</th>
  </tr>
  </thead>
  <tbody id="installments-transactions-list"></tbody>
  </table>
  </div>
  </div>
  </div>
  
  <div id="categories-tab" class="tab-content hidden animate-fade-in">
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
  <div class="bg-white rounded-xl p-6 card-shadow">
  <h3 class="text-xl font-bold mb-4 text-gray-800">‚ûï ÿ•ÿ∂ÿßŸÅÿ© ŸÅÿ¶ÿ© ÿ¨ÿØŸäÿØÿ©</h3>
  <form id="category-form" class="grid grid-cols-1 sm:grid-cols-2 gap-4 items-end">
  <div class="sm:col-span-2">
  <label for="category-name" class="block text-sm font-medium text-gray-700 mb-1">ÿßÿ≥ŸÖ ÿßŸÑŸÅÿ¶ÿ©</label>
  <input type="text" id="category-name" class="w-full p-2 border border-gray-300 rounded-lg" required>
  </div>
  <div class="flex items-end gap-2 sm:col-span-2">
  <div class="flex-grow">
  <label for="category-icon" class="block text-sm font-medium text-gray-700 mb-1">ÿßŸÑÿ£ŸäŸÇŸàŸÜÿ©</label>
  <input type="text" id="category-icon" class="w-full p-2 border border-gray-300 rounded-lg" required placeholder="üõí">
  </div>
  <button type="button" id="suggest-icon-btn" title="ÿßŸÇÿ™ÿ±ÿßÿ≠ ÿ£ŸäŸÇŸàŸÜÿ© ÿ∞ŸÉŸäÿ©" class="p-2 bg-indigo-100 text-indigo-700 rounded-lg hover:bg-indigo-200 transition-colors h-10 w-10 flex-shrink-0">‚ú®</button>
  </div>
  <div class="sm:col-span-2">
  <button type="submit" class="w-full px-6 py-2 magical-button text-white rounded-lg font-semibold">‚ú® ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÅÿ¶ÿ©</button>
  </div>
  </form>
  </div>
  <div class="bg-white rounded-xl p-6 card-shadow">
  <h3 class="text-xl font-bold mb-4 text-gray-800">üìÇ ÿßŸÑŸÅÿ¶ÿßÿ™ ÿßŸÑÿ≠ÿßŸÑŸäÿ©</h3>
  <div id="categories-list" class="space-y-2 max-h-64 overflow-y-auto">
  <!-- Categories will be rendered here -->
  </div>
  </div>
  </div>
  </div>
  
  <div id="export-tab" class="tab-content hidden animate-fade-in">
  <!-- Export/Backup Tab Content -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
    <div class="bg-white rounded-xl p-6 card-shadow">
        <h3 class="text-xl font-bold mb-4 text-gray-800">üìä ÿ™ÿµÿØŸäÿ± ÿ•ŸÑŸâ Excel</h3>
        <p class="text-gray-600 mb-4">ŸÇŸÖ ÿ®ÿ™ÿµÿØŸäÿ± ÿ¨ŸÖŸäÿπ ÿ®ŸäÿßŸÜÿßÿ™ŸÉ ÿßŸÑŸÖÿßŸÑŸäÿ© ÿ•ŸÑŸâ ŸÖŸÑŸÅ Excel ŸÑŸÑÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑŸÖÿ™ŸÇÿØŸÖ</p>
        <button onclick="app.exportToExcel()" class="w-full mt-4 px-6 py-3 bg-green-600 hover:bg-green-700 text-white rounded-lg font-semibold">
        üìä ÿ™ÿµÿØŸäÿ± ÿ•ŸÑŸâ Excel
        </button>
    </div>
    <div class="bg-white rounded-xl p-6 card-shadow">
        <h3 class="text-xl font-bold mb-4 text-gray-800">üìÑ ÿ™ŸÇÿ±Ÿäÿ± PDF</h3>
        <p class="text-gray-600 mb-4">ÿ•ŸÜÿ¥ÿßÿ° ÿ™ŸÇÿ±Ÿäÿ± ŸÖÿßŸÑŸä ÿ¥ÿßŸÖŸÑ ÿ®ÿµŸäÿ∫ÿ© PDF</p>
        <button onclick="app.generatePDFReport()" class="w-full mt-4 px-6 py-3 bg-red-600 hover:bg-red-700 text-white rounded-lg font-semibold">
        üìÑ ÿ•ŸÜÿ¥ÿßÿ° ÿ™ŸÇÿ±Ÿäÿ± PDF
        </button>
    </div>
  </div>

  <div class="bg-white rounded-xl p-6 card-shadow mb-6">
    <h3 class="text-xl font-bold mb-4 text-gray-800">‚ú® ÿ™ŸÑÿÆŸäÿµ ÿ∞ŸÉŸä ŸÑŸÑÿ™ŸÇÿ±Ÿäÿ±</h3>
    <p class="text-gray-600 mb-4">ÿßÿ≠ÿµŸÑ ÿπŸÑŸâ ŸÖŸÑÿÆÿµ ÿ≥ÿ±Ÿäÿπ ŸàŸÖÿ≠ÿ™ÿ±ŸÅ ŸÑŸàÿ∂ÿπŸÉ ÿßŸÑŸÖÿßŸÑŸä ÿßŸÑÿ≠ÿßŸÑŸäÿå ŸÖÿ´ÿßŸÑŸä ŸÑÿ•ÿØÿ±ÿßÿ¨Ÿá ŸÅŸä ÿ™ŸÇÿßÿ±Ÿäÿ±ŸÉ.</p>
    <button id="smart-summary-btn" class="w-full magical-button text-white font-semibold px-6 py-3 rounded-lg">‚ú® ÿ•ŸÜÿ¥ÿßÿ° ŸÖŸÑÿÆÿµ ÿ∞ŸÉŸä</button>
    <div id="smart-summary-result" class="mt-4 p-4 bg-gray-50 rounded-lg text-gray-700 prose prose-sm max-w-none hidden"></div>
  </div>

  <div class="bg-white rounded-xl p-6 card-shadow">
    <h3 class="text-xl font-bold mb-4 text-gray-800">üíæ ÿßŸÑŸÜÿ≥ÿÆ ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿä ŸàÿßŸÑÿßÿ≥ÿ™ÿπÿßÿØÿ©</h3>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
            <h4 class="font-semibold text-gray-700 mb-3">üì§ ÿ•ŸÜÿ¥ÿßÿ° ŸÜÿ≥ÿÆÿ© ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ©</h4>
            <p class="text-gray-600 mb-4 text-sm">ÿßÿ≠ŸÅÿ∏ ÿ¨ŸÖŸäÿπ ÿ®ŸäÿßŸÜÿßÿ™ŸÉ ŸÅŸä ŸÖŸÑŸÅ ÿ¢ŸÖŸÜ</p>
            <button onclick="app.createBackup()" class="w-full px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-colors">
            üíæ ÿ•ŸÜÿ¥ÿßÿ° ŸÜÿ≥ÿÆÿ© ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ©
            </button>
        </div>
        <div>
            <h4 class="font-semibold text-gray-700 mb-3">üì• ÿßÿ≥ÿ™ÿπÿßÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™</h4>
            <p class="text-gray-600 mb-4 text-sm">ÿßÿ≥ÿ™ÿπÿØ ÿ®ŸäÿßŸÜÿßÿ™ŸÉ ŸÖŸÜ ŸÖŸÑŸÅ ŸÜÿ≥ÿÆÿ© ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ©</p>
            <input type="file" id="backup-file" accept=".json" class="hidden">
            <button onclick="document.getElementById('backup-file').click()" class="w-full px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg transition-colors">
            üì• ÿßÿ≥ÿ™ÿπÿßÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
            </button>
        </div>
    </div>
  </div>
  <div class="bg-red-50 text-red-800 rounded-xl p-6 card-shadow mt-6">
    <h3 class="text-xl font-bold mb-2">‚ö†Ô∏è ŸÖŸÜÿ∑ŸÇÿ© ÿßŸÑÿÆÿ∑ÿ±</h3>
    <p class="text-sm mb-4">ÿ≥Ÿäÿ§ÿØŸä Ÿáÿ∞ÿß ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ° ÿ•ŸÑŸâ ÿ≠ÿ∞ŸÅ ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿßŸÑŸÖÿ≠ŸÅŸàÿ∏ÿ© ŸÅŸä ŸÖÿ™ÿµŸÅÿ≠ŸÉ. ÿ≥ÿ™ÿ≠ÿ™ÿßÿ¨ ÿ•ŸÑŸâ ÿ•ÿØÿÆÿßŸÑŸáÿß ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ ÿπŸÜÿØ ŸÅÿ™ÿ≠ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ ŸÅŸä ÿßŸÑŸÖÿ±ÿ© ÿßŸÑŸÇÿßÿØŸÖÿ©.</p>
    <button onclick="app.clearFirebaseConfig()" class="w-full px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg transition-colors">ŸÖÿ≥ÿ≠ ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿßÿ™ÿµÿßŸÑ</button>
  </div>
</div>
  
  </div>
  
  <div id="custom-modal" class="modal-overlay">
  <div class="modal-content">
  <h2 id="modal-title" class="text-2xl font-bold mb-4 text-gray-800"></h2>
  <div id="modal-body"></div>
  <div class="flex justify-end gap-3 mt-6">
  <button id="modal-cancel" class="px-6 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition-colors">ÿ•ŸÑÿ∫ÿßÿ°</button>
  <button id="modal-confirm" class="px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">ŸÖŸàÿßŸÅŸÇ</button>
  </div>
  </div>
  </div>
  
  <script type="module">
  // --- Firebase SDK Imports ---
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import { getAuth, onAuthStateChanged, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
  import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
  
  // --- App Code ---
  
  window.app = {};
  
  var ExpenseApp = (function() {
  // --- STATE MANAGEMENT ---
  var db, auth, userId, docRef, unsubscribe, apiKey;
  var state = getInitialState();
  var currentEditTransactionId = null;
  var charts = {}; // To hold chart instances
  
// --- DOM ELEMENT SELECTORS (ÿßÿ≥ÿ™ÿ®ÿØŸÑ ÿßŸÑÿ¨ÿ≤ÿ° ÿßŸÑŸÇÿØŸäŸÖ ÿ®Ÿáÿ∞ÿß ŸÉŸÑŸá) ---
var loadingOverlay    = document.getElementById('loading-overlay');
var transactionForm   = document.getElementById('transaction-form');
var categoryForm      = document.getElementById('category-form');
var transactionsList  = document.getElementById('transactions-list');
var aiInputForm       = document.getElementById('ai-input-form');
var investmentAIForm  = document.getElementById('investment-ai-input-form');
var investmentForm    = document.getElementById('investment-form');
var pasteBtn          = document.getElementById('paste-from-clipboard-btn');
var suggestIconBtn    = document.getElementById('suggest-icon-btn');
var generateBudgetBtn = document.getElementById('generate-budget-btn');
var smartSummaryBtn   = document.getElementById('smart-summary-btn');
var scanReceiptBtn    = document.getElementById('scan-receipt-btn');
var voiceInputBtn     = document.getElementById('voice-input-btn');

// --- Paste from Clipboard with Smart Payment Detection ---
// ŸäŸÇÿ±ÿ£ ÿßŸÑŸÜÿµ ŸÖŸÜ ÿßŸÑŸÉŸÑŸäÿ® ÿ®Ÿàÿ±ÿØÿå ŸäŸÖŸÑÿ£ ÿßŸÑŸàÿµŸÅ/ÿßŸÑŸÖÿ®ŸÑÿ∫ÿå ŸàŸäÿÆÿ™ÿßÿ± Ÿàÿ≥ŸäŸÑÿ© ÿßŸÑÿØŸÅÿπ ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã
if (pasteBtn) {
  pasteBtn.addEventListener("click", async () => {
    try {
      const text = (await navigator.clipboard.readText()) || "";
      if (!text.trim()) return;

      // ÿ∂ÿπ ÿßŸÑŸÜÿµ ŸÅŸä ÿ≠ŸÇŸÑ ÿßŸÑŸàÿµŸÅ (ÿ•ŸÜ Ÿàÿ¨ÿØ)
      const descEl = document.getElementById("transaction-description");
      if (descEl) descEl.value = text.trim();

      // ÿßÿ≠ÿµŸÑ ÿπŸÑŸâ ÿ£ŸàŸÑ ŸÇŸäŸÖÿ© ÿ±ŸÇŸÖŸäÿ© ÿ™ÿ®ÿØŸà ŸÉŸÖÿ®ŸÑÿ∫ (ŸäÿØÿπŸÖ 1,234.56 Ÿà 1234.56 Ÿà 115.00 Ÿà 182)
      const amountMatch = text.match(/(\d{1,3}(?:[.,]\d{3})*(?:[.,]\d+)|\d+(?:[.,]\d+)?)/);
      if (amountMatch) {
        const amountEl = document.getElementById("transaction-amount");
        if (amountEl) amountEl.value = amountMatch[1].replace(/,/g, '').replace(',', '.');
      }

      // ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑÿ™ÿßÿ±ŸäÿÆ ÿßŸÑŸÖÿ≠ÿ™ŸÖŸÑ (ÿ•ŸÜ ŸàŸèÿ¨ÿØ ÿ®ÿµŸäÿ∫ÿ© YYYY-MM-DD ÿ£Ÿà DD/MM/YY ÿ£Ÿà DD/MM/YYYY)
      const dateMatch = text.match(/(\d{4}-\d{2}-\d{2})|(\d{2}\/\d{2}\/\d{2,4})/);
      if (dateMatch) {
        const dateEl = document.getElementById("transaction-date");
        if (dateEl) {
          let raw = dateMatch[0];
          // ÿ™ÿ≠ŸàŸäŸÑ 01/09/25 ÿ•ŸÑŸâ 2025-09-01 (ÿßŸÅÿ™ÿ±ÿßÿ∂ 20xx ŸÑŸêŸÄ yy)
          if (/^\d{2}\/\d{2}\/\d{2}$/.test(raw)) {
            const parts = raw.split('/');
            const day = parts[0], month = parts[1], yy = parts[2];
            const year = (yy.length === 2) ? ('20' + yy) : yy;
            dateEl.value = `${year}-${month.padStart(2,'0')}-${day.padStart(2,'0')}`;
          } else if (/^\d{2}\/\d{2}\/\d{4}$/.test(raw)) {
            const parts = raw.split('/');
            dateEl.value = `${parts[2]}-${parts[1].padStart(2,'0')}-${parts[0].padStart(2,'0')}`;
          } else if (/^\d{4}-\d{2}-\d{2}$/.test(raw)) {
            dateEl.value = raw;
          }
        }
      }

      // --- ÿ∞ŸÉŸä: ÿ™ÿ≠ÿØŸäÿØ Ÿàÿ≥ŸäŸÑÿ© ÿßŸÑÿØŸÅÿπ ---
      // ŸÜÿπÿ™ŸÖÿØ ÿπŸÑŸâ ŸÉŸÑŸÖÿßÿ™ ŸÖŸÅÿ™ÿßÿ≠Ÿäÿ© ÿπÿ±ÿ®Ÿäÿ© Ÿàÿ•ŸÜÿ¨ŸÑŸäÿ≤Ÿäÿ© Ÿàÿ£ŸÜŸÖÿßÿ∑ ÿ®ÿ∑ÿßŸÇÿßÿ™ (Visa/Master/Apple Pay/Mada/ŸÖÿØŸâ)
      const paymentSelect = document.getElementById("payment-method");
      if (paymentSelect) {
        const t = text.toLowerCase();

        // ÿ£ŸàŸÑŸàŸäÿ© ŸÑŸàÿ¨ŸàÿØ ŸÉŸÑŸÖÿßÿ™ ŸÖÿ≠ÿØÿØÿ©
        if (/(enbd|emirates|ÿßŸÑÿ•ŸÖÿßÿ±ÿßÿ™|visa|visa card|visa ****|visa card xx|visa)/i.test(text) ||
            /pos purchase.*visa/i.test(text) ||
            /visa card/i.test(text) ||
            /emirates/i.test(text)) {
          paymentSelect.value = "enbd-card";
        } else if (/(snb|alahli|ÿßŸÑÿ£ŸáŸÑŸä|ÿßŸáŸÑŸä|ÿßŸïÿ¶ÿ™ŸÖÿßŸÜŸäÿ©|ÿßÿ¶ÿ™ŸÖÿßŸÜŸäÿ©|credit card|apple pay).*?/i.test(text) ||
                   /e?ahli/i.test(text) ||
                   /ÿ•ÿ¶ÿ™ŸÖÿßŸÜŸäÿ©/i.test(text)) {
          paymentSelect.value = "snb-card";
        } else if (/(mada|ŸÖÿØŸâ|mada-pay|mada)/i.test(text) || /ŸÖÿØŸâ-ÿßÿ®ŸÑ|mada/i.test(text)) {
          paymentSelect.value = "mada-bank";
        } else if (/(tabby|ÿ™ÿßÿ®Ÿä|bnpl.*tabby)/i.test(text)) {
          paymentSelect.value = "tabby-bnpl";
        } else if (/(tamara|ÿ™ŸÖÿßÿ±ÿß|bnpl.*tamara)/i.test(text)) {
          paymentSelect.value = "tamara-bnpl";
        } else if (/(mastercard|master card|master|master.*card)/i.test(text)) {
          // ŸÑŸà ÿ™ÿ®Ÿä ÿ™ŸÅÿ±ŸÇ ÿ®ŸäŸÜ master ÿ®ŸÜŸÉŸä Ÿàÿ®ÿ∑ÿßŸÇÿ© ÿ™ŸÇÿØÿ± ÿ™ÿ∂ŸäŸÅ ÿ¥ÿ±Ÿàÿ∑ ÿ£ÿØŸÇ
          paymentSelect.value = "enbd-card"; // ÿßŸÅÿ™ÿ±ÿßÿ∂: ÿÆŸÑŸäŸá ENBD ÿ£Ÿà ÿπÿØŸëŸÑŸá ÿ≠ÿ≥ÿ® ÿ≠ÿßÿ¨ÿ™ŸÉ
        } else if (/(cash|ŸÜŸÇÿØ)/i.test(text)) {
          paymentSelect.value = "cash";
        } else {
          // ÿ•ÿ∞ÿß ŸÖÿß ÿπÿ±ŸÅŸÜÿßÿå ŸÜÿ™ÿ±ŸÉŸá ŸÉŸÖÿß ŸáŸà (ÿ£Ÿà ÿ™ÿÆÿ™ÿßÿ± ŸÇŸäŸÖÿ© ÿßŸÅÿ™ÿ±ÿßÿ∂Ÿäÿ©)
          // paymentSelect.value = ""; // ÿßŸÑÿ™ÿπŸÑŸäŸÇ ŸäÿπŸÜŸä ŸÑÿß ÿ™ÿ∫ŸäŸäÿ±
        }
      }

      // ÿßÿÆÿ™Ÿäÿßÿ±Ÿä: ŸÑŸà ŸÅŸäŸá ÿ≤ÿ± ŸÑÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÖÿπÿßŸÖŸÑÿ© ŸÖÿ®ÿßÿ¥ÿ±ÿ© ÿ™ŸÇÿØÿ± ÿ™ŸÅÿπŸëŸÑŸá ŸáŸÜÿß
      // document.getElementById('transaction-form').dispatchEvent(new Event('submit'));

    } catch (err) {
      console.error("ŸÅÿ¥ŸÑ ŸÇÿ±ÿßÿ°ÿ© ÿßŸÑŸÉŸÑŸäÿ® ÿ®Ÿàÿ±ÿØ ÿ£Ÿà ŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑŸÜÿµ:", err);
      alert("ŸÅÿ¥ŸÑ ŸÇÿ±ÿßÿ°ÿ© ÿßŸÑŸÜÿµ ŸÖŸÜ ÿßŸÑÿ≠ÿßŸÅÿ∏ÿ©. ÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ•ÿπÿ∑ÿßÿ° ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿ© ŸÑŸÑŸÖÿ™ÿµŸÅÿ≠.");
    }
  });
}

  // --- INITIALIZATION ---
  function init() {
  Object.assign(window.app, {
  showTab: showTab, 
  createBackup: createBackup, 
  exportToExcel: exportToExcel, 
  generatePDFReport: generatePDFReport,
  openEditCardModal: openEditCardModal, 
  openEditBankModal: openEditBankModal, 
  handlePayInstallment: handlePayInstallment,
  openEditCategoryModal: openEditCategoryModal, 
  handleDeleteCategory: handleDeleteCategory,
  openUpdateInvestmentValueModal: openUpdateInvestmentValueModal, 
  clearFirebaseConfig: clearFirebaseConfig
  });
  initializeEventListeners();
  setupDateTimeHeader();
  initializeFirebase();
  }
  
  function getInitialState() {
  return {
  transactions: [],
  cards: { snb: { limit: 26000, dueDay: 15 }, enbd: { limit: 10000, dueDay: 18 } },
  bank: { balance: 0 },
  categories: [ { id: 'cat-1', name: 'üõí ÿ®ŸÇÿßŸÑÿ©', icon: 'üõí' }, { id: 'cat-2', name: 'üçî ŸÖÿ∑ÿßÿπŸÖ', icon: 'üçî' }, { id: 'cat-3', name: '‚õΩ ŸàŸÇŸàÿØ', icon: '‚õΩ' }, { id: 'cat-4', name: 'ŸÅŸàÿßÿ™Ÿäÿ±', icon: 'üßæ' }, { id: 'cat-9', name: 'üí≥ ÿ≥ÿØÿßÿØ ŸÅŸàÿßÿ™Ÿäÿ±', icon: 'üí≥' }, { id: 'cat-5', name: 'ÿ™ÿ≥ŸàŸÇ', icon: 'üõçÔ∏è' }, { id: 'cat-6', name: 'ÿ•Ÿäÿ¨ÿßÿ±', icon: 'üè†' },{ id: 'cat-8', name: 'üíä ÿµŸäÿØŸÑŸäÿ©', icon: 'üíä' }, { id: 'cat-7', name: 'ÿ£ÿÆÿ±Ÿâ', icon: 'üí∏' }, ],
  installments: [],
  investments: {
  currentValue: 0
  }
  };
  }
  
  // --- FIREBASE & AUTH ---
  function initializeFirebase() { 
  try { 
  var firebaseConfig;
  if (typeof __firebase_config !== 'undefined' && __firebase_config) {
  firebaseConfig = JSON.parse(__firebase_config);
  } else {
  var storedConfig = localStorage.getItem('firebaseConfig');
  if (storedConfig) {
  firebaseConfig = JSON.parse(storedConfig);
  }
  }
  
  if (!firebaseConfig) {
  promptForFirebaseConfig();
  return;
  }
  
  apiKey = firebaseConfig.apiKey;
  
  var firebaseApp = initializeApp(firebaseConfig); 
  db = getFirestore(firebaseApp); 
  auth = getAuth(firebaseApp); 
  setupAuthListener(); 
  } catch (error) { 
  console.error("Firebase initialization failed:", error); 
  localStorage.removeItem('firebaseConfig'); // Clear bad config
  showError("ŸÅÿ¥ŸÑ ŸÅŸä ÿ™ŸáŸäÿ¶ÿ© ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ. ŸÇÿØ ÿ™ŸÉŸàŸÜ ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™ ÿ∫Ÿäÿ± ÿµÿßŸÑÿ≠ÿ©. ÿ≥Ÿäÿ™ŸÖ ÿ•ÿπÿßÿØÿ© ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿµŸÅÿ≠ÿ©.");
  setTimeout(function() { location.reload(); }, 3000);
  } 
  }
  function setupAuthListener() { 
  onAuthStateChanged(auth, async function (user) { 
  if (user) { 
  var appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'; 
  userId = user.uid; 
  docRef = doc(db, `artifacts/${appId}/users/${userId}/expenses-data/main`); 
  setupRealtimeListener(); 
  } else { 
  try { 
  if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) { 
  await signInWithCustomToken(auth, __initial_auth_token); 
  } else { 
  await signInAnonymously(auth); 
  } 
  } catch(error) { 
  console.error("Authentication failed:", error); 
  showError("ŸÅÿ¥ŸÑ ÿßŸÑŸÖÿµÿßÿØŸÇÿ©. ŸÑÿß ŸäŸÖŸÉŸÜ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™."); 
  } 
  } 
  }); 
  }
  function setupRealtimeListener() { 
  if (unsubscribe) unsubscribe(); 
  unsubscribe = onSnapshot(docRef, function(doc) { 
  if (doc.exists()) { 
  var data = doc.data(); 
  state = { ...getInitialState(), ...data }; 
  if(!state.investments) state.investments = getInitialState().investments; 
  console.log("Data loaded from Firebase."); 
  } else { 
  console.log("No data found, initializing with default state."); 
  saveStateToFirebase(); 
  } 
  renderAll(); 
  showLoadingOverlay(false); 
  }, function(error) { 
  console.error("Error listening to document:", error); 
  showError("ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ÿßŸÑÿÆÿßÿØŸÖ. ÿ≠ÿßŸàŸÑ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿµŸÅÿ≠ÿ©."); 
  }); 
  }
  async function saveStateToFirebase() {
  if (!docRef) return;
  try {
  var cleanState = JSON.parse(JSON.stringify(state));
  await setDoc(docRef, cleanState, { merge: true });
  console.log("State saved to Firebase.");
  } catch (error) {
  console.error("Error saving state:", error);
  showError("ŸÅÿ¥ŸÑ ÿ≠ŸÅÿ∏ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™.");
  }
  }
  
  // --- UI & RENDERING ---
  function renderAll() {
  var calculations = calculateSummaries();
  renderSummary(calculations);
  renderInvestmentTab(calculations);
  renderCardDetails(calculations);
  renderBankDetails(calculations);
  renderTransactionList();
  renderInstallments();
  renderCategories();
  updateCategoryDropdowns();
  renderCategorySummary(calculations);
  }

  function renderCategorySummary(calc) {
    const listEl = document.getElementById('category-summary-list');
    if (!listEl) return;

    if (calc.totalExpenses === 0) {
        listEl.innerHTML = `<p class="text-gray-500 text-center p-4">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖÿµÿßÿ±ŸäŸÅ ŸÖÿ≥ÿ¨ŸÑÿ©.</p>`;
        return;
    }

    const expenseTotals = state.transactions
        .filter(t => t.type === 'expense')
        .reduce((acc, t) => {
            const categoryId = t.categoryId || 'cat-7'; // Default to 'Other'
            acc[categoryId] = (acc[categoryId] || 0) + t.amount;
            return acc;
        }, {});

    const sortedCategories = Object.entries(expenseTotals)
        .sort(([, a], [, b]) => b - a);

    if (sortedCategories.length === 0) {
        listEl.innerHTML = `<p class="text-gray-500 text-center p-4">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖÿµÿßÿ±ŸäŸÅ ŸÖÿ≥ÿ¨ŸÑÿ©.</p>`;
        return;
    }

    listEl.innerHTML = sortedCategories.map(([categoryId, total]) => {
        const category = findCategoryById(categoryId);
        const name = category ? `${category.icon} ${category.name}` : 'ÿ∫Ÿäÿ± ŸÖÿµŸÜŸÅ';
        const percentage = (total / calc.totalExpenses) * 100;
        
        return `
        <div class="flex items-center justify-between text-sm py-1">
            <span class="w-28 truncate" title="${category ? category.name : ''}">${name}</span>
            <div class="flex-1 bg-gray-200 rounded-full h-2.5 mx-2">
                <div class="bg-gradient-to-r from-indigo-400 to-purple-500 h-2.5 rounded-full" style="width: ${percentage.toFixed(1)}%"></div>
            </div>
            <span class="font-bold text-gray-800 number-display w-24 text-left">${formatCurrency(total)} ÿ±ŸäÿßŸÑ</span>
        </div>
        `;
    }).join('');
}
  
  function renderSummary(calc) {
  document.getElementById('snb-current-balance').textContent = `${formatCurrency(calc.snb.balance)} ÿ±ŸäÿßŸÑ`; 
  document.getElementById('snb-remaining-limit').textContent = `${formatCurrency(calc.snb.available)} ÿ±ŸäÿßŸÑ`; 
  document.getElementById('snb-usage-bar').style.width = `${calc.snb.usagePercentage}%`; 
  document.getElementById('enbd-current-balance').textContent = `${formatCurrency(calc.enbd.balance)} ÿ±ŸäÿßŸÑ`; 
  document.getElementById('enbd-remaining-limit').textContent = `${formatCurrency(calc.enbd.available)} ÿ±ŸäÿßŸÑ`; 
  document.getElementById('enbd-usage-bar').style.width = `${calc.enbd.usagePercentage}%`; 
  document.getElementById('total-debt').textContent = `${formatCurrency(calc.totalDebt)} ÿ±ŸäÿßŸÑ`; 
  document.getElementById('total-available').textContent = `${formatCurrency(calc.totalAvailable)} ÿ±ŸäÿßŸÑ`; 
  document.getElementById('total-limits').textContent = `${formatCurrency(calc.totalLimits)} ÿ±ŸäÿßŸÑ`; 
  document.getElementById('report-income').textContent = `${formatCurrency(calc.totalIncome)} ÿ±ŸäÿßŸÑ`; 
  document.getElementById('report-expenses').textContent = `${formatCurrency(calc.totalExpenses)} ÿ±ŸäÿßŸÑ`; 
  document.getElementById('report-snb-expenses').textContent = `${formatCurrency(calc.totalSnbExpenses)} ÿ±ŸäÿßŸÑ`;
  document.getElementById('report-enbd-expenses').textContent = `${formatCurrency(calc.totalEnbdExpenses)} ÿ±ŸäÿßŸÑ`;
  document.getElementById('report-snb-payments').textContent = `${formatCurrency(calc.snbPaymentsTotal)} ÿ±ŸäÿßŸÑ`;
  document.getElementById('report-enbd-payments').textContent = `${formatCurrency(calc.enbdPaymentsTotal)} ÿ±ŸäÿßŸÑ`;
  var net = calc.totalIncome - (calc.totalExpenses + calc.totalInvestmentDeposits - calc.totalInvestmentWithdrawals);
  var netEl = document.getElementById('report-net'); 
  netEl.textContent = `${formatCurrency(net)} ÿ±ŸäÿßŸÑ`; 
  netEl.className = 'number-display ' + (net >= 0 ? 'text-green-600' : 'text-red-600'); 
  document.getElementById('report-count').textContent = calc.transactionStats.count; 
  document.getElementById('report-average').textContent = `${formatCurrency(calc.transactionStats.average)} ÿ±ŸäÿßŸÑ`; 
  document.getElementById('report-max').textContent = `${formatCurrency(calc.transactionStats.max)} ÿ±ŸäÿßŸÑ`;
  }
  
  function renderInvestmentTab(calc) {
  document.getElementById('investment-current-value').textContent = `${formatCurrency(state.investments.currentValue)} ÿ±ŸäÿßŸÑ`;
  document.getElementById('investment-total-invested').textContent = `${formatCurrency(calc.totalInvestmentDeposits)} ÿ±ŸäÿßŸÑ`;
  }
  
  function renderCardDetails(calc) { document.getElementById('snb-balance-display').textContent = `${formatCurrency(calc.snb.balance)} ÿ±ŸäÿßŸÑ`; document.getElementById('snb-limit-display').textContent = `${formatCurrency(state.cards.snb.limit)} ÿ±ŸäÿßŸÑ`; document.getElementById('snb-available-display').textContent = `${formatCurrency(calc.snb.available)} ÿ±ŸäÿßŸÑ`; document.getElementById('snb-due-day-display').textContent = `ŸäŸàŸÖ ${state.cards.snb.dueDay}`; document.getElementById('snb-progress-bar').style.width = `${calc.snb.usagePercentage}%`; document.getElementById('snb-usage-display').textContent = `${calc.snb.usagePercentage.toFixed(1)}%`; document.getElementById('enbd-balance-display').textContent = `${formatCurrency(calc.enbd.balance)} ÿ±ŸäÿßŸÑ`; document.getElementById('enbd-limit-display').textContent = `${formatCurrency(state.cards.enbd.limit)} ÿ±ŸäÿßŸÑ`; document.getElementById('enbd-available-display').textContent = `${formatCurrency(calc.enbd.available)} ÿ±ŸäÿßŸÑ`; document.getElementById('enbd-due-day-display').textContent = `ŸäŸàŸÖ ${state.cards.enbd.dueDay}`; document.getElementById('enbd-progress-bar').style.width = `${calc.enbd.usagePercentage}%`; document.getElementById('enbd-usage-display').textContent = `${calc.enbd.usagePercentage.toFixed(1)}%`; var cardTransactions = state.transactions.filter(function(t) { return t.paymentMethod.includes('-card') || t.type.includes('-payment')}).sort(function(a, b) { return new Date(b.date) - new Date(a.date)}); var listEl = document.getElementById('cards-transactions-list'); listEl.innerHTML = cardTransactions.map(function(t) { var isPayment = t.type.includes('-payment'); var amountClass = isPayment ? 'text-green-600' : 'text-red-600'; var cardName = t.paymentMethod.includes('snb') || t.type.includes('snb') ? 'SNB' : 'ENBD'; var typeName = isPayment ? 'ÿ≥ÿØÿßÿØ' : 'ŸÖÿµÿ±ŸàŸÅ'; return ` <tr class="border-b border-gray-100"> <td class="py-3 px-4 text-sm">${t.date}</td> <td class="py-3 px-4 text-sm font-semibold">${cardName}</td> <td class="py-3 px-4 text-sm">${typeName}</td> <td class="py-3 px-4 font-semibold ${amountClass} number-display">${isPayment ? '+' : '-'}${formatCurrency(t.amount)} ÿ±ŸäÿßŸÑ</td> <td class="py-3 px-4 text-sm text-gray-600">${t.description || '-'}</td> </tr> `; }).join(''); }
  function renderBankDetails(calc) { document.getElementById('bank-balance').textContent = `${formatCurrency(state.bank.balance)} ÿ±ŸäÿßŸÑ`; document.getElementById('bank-deposits').textContent = `${formatCurrency(calc.bankDeposits)} ÿ±ŸäÿßŸÑ`; document.getElementById('bank-withdrawals').textContent = `${formatCurrency(calc.bankWithdrawals)} ÿ±ŸäÿßŸÑ`; var bankTransactions = state.transactions.filter(function(t) { return t.paymentMethod === 'mada-bank'}).sort(function(a, b) { return new Date(b.date) - new Date(a.date)}); var listEl = document.getElementById('bank-transactions-list'); listEl.innerHTML = bankTransactions.map(function(t) { var isIncome = t.type === 'income'; var amountClass = isIncome ? 'text-green-600' : 'text-red-600'; var category = findCategoryById(t.categoryId); return ` <tr class="border-b border-gray-100"> <td class="py-3 px-4 text-sm">${t.date}</td> <td class="py-3 px-4 text-sm">${getTransactionTypeName(t.type)}</td> <td class="py-3 px-4 font-semibold ${amountClass} number-display">${isIncome ? '+' : '-'}${formatCurrency(t.amount)} ÿ±ŸäÿßŸÑ</td> <td class="py-3 px-4 text-sm">${category ? `${category.icon} ${category.name}` : '-'}</td> <td class="py-3 px-4 text-sm text-gray-600">${t.description || '-'}</td> </tr> `; }).join(''); }
  function renderTransactionList() { var searchTerm = document.getElementById('search-transactions').value.toLowerCase(); var filterMethod = document.getElementById('filter-payment-method').value; var filteredTransactions = state.transactions.filter(function(t) { var descriptionMatch = t.description ? t.description.toLowerCase().includes(searchTerm) : false; var categoryObject = findCategoryById(t.categoryId); var categoryNameMatch = categoryObject ? categoryObject.name.toLowerCase().includes(searchTerm) : false; var matchesSearch = descriptionMatch || categoryNameMatch; var matchesFilter = !filterMethod || t.paymentMethod === filterMethod || t.type.replace('-payment', '-card') === filterMethod; return matchesSearch && matchesFilter; }).sort(function(a, b) { return new Date(b.date) - new Date(a.date)}); transactionsList.innerHTML = filteredTransactions.map(function(t) { var category = findCategoryById(t.categoryId); var isIncome = t.type === 'income'; var isPayment = t.type.includes('payment'); var isInvestment = t.type.includes('investment'); var amountClass = isIncome || isPayment ? 'text-green-600' : 'text-red-600'; var sign = isIncome || isPayment ? '+' : '-'; return ` <tr class="border-b border-gray-100 hover:bg-gray-50 text-sm"> <td class="py-3 px-4">${t.date}</td> <td class="py-3 px-4">${getPaymentMethodName(t.paymentMethod)}</td> <td class="py-3 px-4">${getTransactionTypeName(t.type)}</td> <td class="py-3 px-4 font-semibold ${isInvestment ? 'text-blue-600' : amountClass} number-display">${isInvestment ? ' ' : sign} ${formatCurrency(t.amount)} ÿ±ŸäÿßŸÑ</td> <td class="py-3 px-4">${category ? `${category.icon} ${category.name}` : 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'}</td> <td class="py-3 px-4 text-gray-600 hidden sm:table-cell">${t.description || '-'}</td> <td class="py-3 px-4 text-center"> <button data-action="edit" data-id="${t.id}" class="text-blue-500 hover:text-blue-700 p-1">‚úèÔ∏è</button> <button data-action="delete" data-id="${t.id}" class="text-red-500 hover:text-red-700 p-1">üóëÔ∏è</button> </td> </tr> `; }).join(''); }
  function renderInstallments() { var listEl = document.getElementById('active-installments-list'); var activeInstallments = state.installments.filter(function(i) { return i.paid < i.total }); if (activeInstallments.length === 0) { listEl.innerHTML = `<div class="col-span-1 md:col-span-2 text-center p-6 bg-gray-50 rounded-lg"> <p class="text-gray-600">üéâ ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ£ŸÇÿ≥ÿßÿ∑ ŸÜÿ¥ÿ∑ÿ© ÿ≠ÿßŸÑŸäŸãÿß!</p> </div>`; } else { listEl.innerHTML = activeInstallments.map(function(i) { var remaining = i.total - i.paid; var progress = (i.paid / i.total) * 100; return ` <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200"> <div class="flex justify-between items-start mb-2"> <div> <h4 class="font-bold text-gray-800">${i.description}</h4> <p class="text-sm text-gray-500">${getPaymentMethodName(i.provider)}</p> </div> <span class="font-bold text-purple-600 number-display">${formatCurrency(i.installmentAmount)} ÿ±ŸäÿßŸÑ/ÿ¥Ÿáÿ±</span> </div> <div class="w-full bg-gray-200 rounded-full h-2.5 mb-1"> <div class="bg-purple-600 h-2.5 rounded-full" style="width: ${progress}%"></div> </div> <div class="flex justify-between text-xs text-gray-600"> <span>${i.paid} / ${i.total} ŸÖÿØŸÅŸàÿπ</span> <span>ŸÖÿ™ÿ®ŸÇŸä: <span class="font-semibold">${remaining}</span></span> </div> <div class="text-center mt-4"> <button onclick="app.handlePayInstallment('${i.id}')" class="px-4 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 transition-colors text-sm w-full sm:w-auto"> ÿØŸÅÿπ ÿßŸÑŸÇÿ≥ÿ∑ ÿßŸÑÿ™ÿßŸÑŸä </button> </div> </div> `; }).join(''); } var installmentTransactions = state.transactions .filter(function(t) { return t.paymentMethod.includes('-bnpl') || t.isInstallmentPayment}) .sort(function(a, b) { return new Date(b.date) - new Date(a.date)}); document.getElementById('installments-transactions-list').innerHTML = installmentTransactions.map(function(t) { var isPayment = t.isInstallmentPayment; var installment = isPayment ? findInstallmentById(t.installmentId) : null; var provider = isPayment ? (installment ? installment.provider : '') : t.paymentMethod; return ` <tr class="border-b border-gray-100"> <td class="py-3 px-4 text-sm">${t.date}</td> <td class="py-3 px-4 text-sm">${getPaymentMethodName(provider)}</td> <td class="py-3 px-4 text-sm">${isPayment ? 'ÿ≥ÿØÿßÿØ ŸÇÿ≥ÿ∑' : 'ÿ¥ÿ±ÿßÿ° ÿ¨ÿØŸäÿØ'}</td> <td class="py-3 px-4 text-red-600 font-semibold number-display">${formatCurrency(t.amount)} ÿ±ŸäÿßŸÑ</td> <td class="py-3 px-4 text-sm text-gray-600">${t.description || '-'}</td> </tr> `; }).join(''); }
  function renderCategories() { var listEl = document.getElementById('categories-list'); listEl.innerHTML = state.categories.map(function(cat) { return ` <div class="flex items-center justify-between p-2 bg-gray-50 rounded-lg"> <span class="font-semibold">${cat.icon} ${cat.name}</span> <div> <button onclick="app.openEditCategoryModal('${cat.id}')" class="text-blue-500 hover:text-blue-700 p-1 text-sm">‚úèÔ∏è</button> <button onclick="app.handleDeleteCategory('${cat.id}')" class="text-red-500 hover:text-red-700 p-1 text-sm">üóëÔ∏è</button> </div> </div> `}).join(''); }
  
  // --- EVENT LISTENERS ---
  function initializeEventListeners() {
  transactionForm.addEventListener('submit', handleTransactionFormSubmit); 
  categoryForm.addEventListener('submit', handleCategoryFormSubmit); 
  transactionsList.addEventListener('click', handleTransactionActions); 
  document.getElementById('payment-method').addEventListener('change', handlePaymentMethodChange); 
  document.getElementById('transaction-type').addEventListener('change', handleTransactionTypeChange); 
  document.getElementById('search-transactions').addEventListener('input', renderTransactionList); 
  document.getElementById('filter-payment-method').addEventListener('change', renderTransactionList); 
  document.getElementById('modal-cancel').addEventListener('click', hideModal); 
  document.querySelector('.modal-overlay').addEventListener('click', function(e) { if (e.target === e.currentTarget) hideModal(); }); 
  document.getElementById('backup-file').addEventListener('change', handleRestoreBackup);
  aiInputForm.addEventListener('submit', handleAIChatSubmit);
  investmentAIForm.addEventListener('submit', handleInvestmentAIChatSubmit);
  investmentForm.addEventListener('submit', handleInvestmentFormSubmit);
  pasteBtn.addEventListener('click', handlePasteFromClipboard);
  suggestIconBtn.addEventListener('click', handleSuggestCategoryIcon);
  generateBudgetBtn.addEventListener('click', handleGenerateBudget);
  smartSummaryBtn.addEventListener('click', handleSmartSummary);
  scanReceiptBtn.addEventListener('click', function() { document.getElementById('receipt-upload').click(); });
  document.getElementById('receipt-upload').addEventListener('change', handleReceiptScan);
   if (!('SpeechRecognition' in window || 'webkitSpeechRecognition' in window)) {
        voiceInputBtn.style.display = 'none';
    } else {
        voiceInputBtn.addEventListener('click', handleVoiceInput);
    }
  }
  
  // --- EVENT HANDLERS ---
  function handleTransactionActions(e) { var button = e.target.closest('button'); if (!button) return; var action = button.dataset.action; var id = button.dataset.id; if (action === 'edit') { openEditTransactionModal(id); } else if (action === 'delete') { handleDeleteTransaction(id); } }
  function handleTransactionFormSubmit(e) { 
  e.preventDefault(); 
  var amount = parseFloat(document.getElementById('transaction-amount').value); 
  if (isNaN(amount) || amount <= 0) { showError("ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿØÿÆÿßŸÑ ŸÖÿ®ŸÑÿ∫ ÿµÿ≠Ÿäÿ≠."); return; } 
  var formData = { 
  amount: amount, 
  date: document.getElementById('transaction-date').value || new Date().toISOString().split('T')[0], 
  description: document.getElementById('transaction-description').value.trim(), 
  paymentMethod: document.getElementById('payment-method').value, 
  type: document.getElementById('transaction-type').value, 
  categoryId: document.getElementById('transaction-category').value, 
  }; 
  
  if (currentEditTransactionId) { 
  var index = state.transactions.findIndex(function(t){ return t.id === currentEditTransactionId }); 
  if (index !== -1) { 
  state.transactions[index] = { ...state.transactions[index], ...formData }; 
  } 
  } else { 
  var newTransaction = { id: `trans-${Date.now()}`, ...formData }; 
  if (newTransaction.paymentMethod.includes('bnpl') && newTransaction.type === 'expense') { 
  var installmentsCount = parseInt(document.getElementById('installments-count').value, 10); 
  var installment = { 
  id: `inst-${Date.now()}`, 
  originalTransactionId: newTransaction.id, 
  provider: newTransaction.paymentMethod, 
  description: newTransaction.description, 
  totalAmount: newTransaction.amount, 
  installmentAmount: newTransaction.amount / installmentsCount, 
  total: installmentsCount, paid: 0, 
  createdAt: newTransaction.date 
  }; 
  state.installments.push(installment); 
  } 
  state.transactions.push(newTransaction); 
  } 
  saveStateToFirebase(); 
  transactionForm.reset(); 
  currentEditTransactionId = null; 
  document.querySelector('#transaction-form button[type="submit"]').textContent = '‚ú® ÿ•ÿ∂ÿßŸÅÿ© ‚ú®'; 
  handleTransactionTypeChange(); 
  showTab('summary'); 
  }
  function handleDeleteTransaction(id) { showModal("ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖÿπÿßŸÖŸÑÿ©", "<p>ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ±ÿ∫ÿ®ÿ™ŸÉ ŸÅŸä ÿ≠ÿ∞ŸÅ Ÿáÿ∞Ÿá ÿßŸÑŸÖÿπÿßŸÖŸÑÿ©ÿü ŸÑÿß ŸäŸÖŸÉŸÜ ÿßŸÑÿ™ÿ±ÿßÿ¨ÿπ ÿπŸÜ Ÿáÿ∞ÿß ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°.</p>", { confirmText: 'ŸÜÿπŸÖÿå ÿ≠ÿ∞ŸÅ', onConfirm: function() { state.transactions = state.transactions.filter(function(t) { return t.id !== id}); saveStateToFirebase(); return true; } }); }
  function handleCategoryFormSubmit(e) { e.preventDefault(); var name = document.getElementById('category-name').value.trim(); var icon = document.getElementById('category-icon').value.trim(); if (!name || !icon) { showError("ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿØÿÆÿßŸÑ ÿßÿ≥ŸÖ Ÿàÿ£ŸäŸÇŸàŸÜÿ© ŸÑŸÑŸÅÿ¶ÿ©."); return; } state.categories.push({ id: `cat-${Date.now()}`, name: name, icon: icon }); saveStateToFirebase(); categoryForm.reset(); }
  function handlePaymentMethodChange(e) { var method = e.target.value; var installmentsField = document.getElementById('installments-field'); var transactionTypeEl = document.getElementById('transaction-type'); if (method.includes('bnpl')) { installmentsField.classList.remove('hidden'); transactionTypeEl.value = 'expense'; transactionTypeEl.disabled = true; } else { installmentsField.classList.add('hidden'); transactionTypeEl.disabled = false; } }
  function handleTransactionTypeChange() {
  var type = document.getElementById('transaction-type').value;
  var paymentMethodEl = document.getElementById('payment-method');
  
  paymentMethodEl.disabled = false;
  for (var i = 0; i < paymentMethodEl.options.length; i++) {
  paymentMethodEl.options[i].style.display = '';
  }
  
  if (type === 'snb-payment') {
  for (var i = 0; i < paymentMethodEl.options.length; i++) {
  if (paymentMethodEl.options[i].value === 'snb-card') {
  paymentMethodEl.options[i].style.display = 'none';
  }
  }
  if (paymentMethodEl.value === 'snb-card') {
  paymentMethodEl.value = 'mada-bank';
  }
  } else if (type === 'enbd-payment') {
  for (var i = 0; i < paymentMethodEl.options.length; i++) {
  if (paymentMethodEl.options[i].value === 'enbd-card') {
  paymentMethodEl.options[i].style.display = 'none';
  }
  }
  if (paymentMethodEl.value === 'enbd-card') {
  paymentMethodEl.value = 'mada-bank';
  }
  }
  
  handlePaymentMethodChange({ target: paymentMethodEl });
  }
  function handlePayInstallment(installmentId) {
  var installment = findInstallmentById(installmentId);
  if (!installment || installment.paid >= installment.total) return;
  var billCategory = state.categories.find(function(c) { 
  return c.name === 'üí≥ ÿ≥ÿØÿßÿØ ŸÅŸàÿßÿ™Ÿäÿ±' || c.name.toLowerCase().includes('bill'); 
  });
  var categoryId = billCategory ? billCategory.id : '';
  
  var transaction = {
  id: 'trans-' + Date.now(),
  amount: installment.installmentAmount,
  date: new Date().toISOString().split('T')[0],
  description: 'ÿ≥ÿØÿßÿØ ÿßŸÑŸÇÿ≥ÿ∑ ' + (installment.paid + 1) + ' ŸÑŸÄ: ' + installment.description,
  paymentMethod: 'mada-bank',
  type: 'expense',
  categoryId: categoryId,
  isInstallmentPayment: true,
  installmentId: installmentId,
  };
  state.transactions.push(transaction);
  installment.paid += 1;
  saveStateToFirebase();
  }
  function handleDeleteCategory(id) { var isUsed = state.transactions.some(function(t) { return t.categoryId === id}); if (isUsed) { showModal("ÿÆÿ∑ÿ£", "<p>ŸÑÿß ŸäŸÖŸÉŸÜ ÿ≠ÿ∞ŸÅ Ÿáÿ∞Ÿá ÿßŸÑŸÅÿ¶ÿ© ŸÑÿ£ŸÜŸáÿß ŸÖÿ≥ÿ™ÿÆÿØŸÖÿ© ŸÅŸä ÿ®ÿπÿ∂ ÿßŸÑŸÖÿπÿßŸÖŸÑÿßÿ™.</p>", { confirmText: 'ŸÖŸàÿßŸÅŸÇ', hideCancel: true }); return; } showModal("ÿ≠ÿ∞ŸÅ ÿßŸÑŸÅÿ¶ÿ©", "<p>ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ≠ÿ∞ŸÅ Ÿáÿ∞Ÿá ÿßŸÑŸÅÿ¶ÿ©ÿü</p>", { confirmText: 'ŸÜÿπŸÖÿå ÿ≠ÿ∞ŸÅ', onConfirm: function() { state.categories = state.categories.filter(function(c) { return c.id !== id}); saveStateToFirebase(); return true; } }); }
  
  
  async function handleAIChatSubmit(e) {
  e.preventDefault();
  var userInput = document.getElementById('ai-user-input');
  var query = userInput.value.trim();
  if (!query) return;
  
  addMessageToChat(query, 'user', 'ai-chat-box');
  userInput.value = '';
  showTypingIndicator(true, 'ai-chat-box');
  
  try {
  var apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
  
  var systemPrompt = `You are an expert financial analyst assistant, "ÿßŸÑŸÖÿ≠ŸÑŸÑ ÿßŸÑÿ∞ŸÉŸä". You have full access to the user's comprehensive financial data. Your purpose is to provide detailed, insightful analysis and answer complex questions in Arabic.
- Today's date is ${new Date().toLocaleDateString('en-CA')}.
- Analyze the user's complete financial state (transactions, card details, bank balance, investments, installments) to answer their query.
- Be thorough. Connect different parts of their financial data to give holistic answers. For example, if asked about affording an item, consider their bank balance, card limits, and upcoming installment payments.
- DO NOT just state data, INTERPRET it. Provide insights, identify trends, and offer observations.
- Be friendly, professional, and act as a true financial advisor.`;
  
  var requestBody = {
  systemInstruction: { parts: [{ text: systemPrompt }] },
  contents: [{
  parts: [
  { text: `User Query: "${query}"` },
  { text: `Full Financial Data JSON: ${JSON.stringify(state)}` }
  ]
  }],
  };
  
  var response = await fetch(apiUrl, {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify(requestBody)
  });
  
  if (!response.ok) {
  var error = new Error(`API call failed with status: ${response.status}`);
  error.status = response.status;
  throw error;
  }
  
  var result = await response.json();
  var aiResponse = getApiResponseText(result) || "ÿπŸÅŸàÿßŸãÿå ŸÑŸÖ ÿ£ÿ™ŸÖŸÉŸÜ ŸÖŸÜ ŸÖÿπÿßŸÑÿ¨ÿ© ÿ∑ŸÑÿ®ŸÉ ÿ≠ÿßŸÑŸäÿßŸã.";
  addMessageToChat(aiResponse, 'ai', 'ai-chat-box');
  
  } catch (error) {
  console.error("AI Assistant Error:", error);
  var userMessage = "ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ÿßŸÑŸÖÿ≥ÿßÿπÿØ ÿßŸÑÿ∞ŸÉŸä. ÿßŸÑÿ±ÿ¨ÿßÿ° ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ© ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ.";
  if (error.status === 403) {
  userMessage = "ÿ™ŸÖ ÿ±ŸÅÿ∂ ÿßŸÑŸàÿµŸàŸÑ. Ÿäÿ±ÿ¨Ÿâ ŸÖÿ±ÿßÿ¨ÿπÿ© ÿ•ÿπÿØÿßÿØÿßÿ™ ŸÖŸÅÿ™ÿßÿ≠ API.";
  showError("ÿ™ŸÖ ÿ±ŸÅÿ∂ ÿßŸÑŸàÿµŸàŸÑ (ÿÆÿ∑ÿ£ 403). Ÿäÿ±ÿ¨Ÿâ ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ŸÇŸäŸàÿØ ŸÖŸÅÿ™ÿßÿ≠ API ÿßŸÑÿÆÿßÿµ ÿ®ŸÉ ŸÅŸä Google Cloud Console ŸàÿßŸÑÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿßŸÑÿ≥ŸÖÿßÿ≠ ÿ®ŸÜÿ∑ÿßŸÇ ÿßŸÑŸÜÿ¥ÿ± (e.g. *.netlify.app).");
  }
  addMessageToChat(userMessage, 'ai', 'ai-chat-box');
  } finally {
  showTypingIndicator(false, 'ai-chat-box');
  }
  }
  
  async function handlePasteFromClipboard() {
  try {
  if (!navigator.clipboard || !navigator.clipboard.readText) {
  throw new Error("Clipboard API not supported or blocked.");
  }
  var clipboardText = await navigator.clipboard.readText();
  if (!clipboardText) {
  showModal("ÿßŸÑÿ≠ÿßŸÅÿ∏ÿ© ŸÅÿßÿ±ÿ∫ÿ©", "<p>ŸÑÿß ŸäŸàÿ¨ÿØ ŸÜÿµ ŸÅŸä ÿßŸÑÿ≠ÿßŸÅÿ∏ÿ© ŸÑŸÑÿµŸÇŸá.</p>", { confirmText: 'ÿ≠ÿ≥ŸÜŸãÿß', hideCancel: true });
  return;
  }
  analyzePastedText(clipboardText);
  } catch (error) {
  console.warn("Clipboard read failed, falling back to modal:", error);
  var body = `
  <p class="text-sm text-gray-600 mb-2">ÿ™ÿπÿ∞ÿ± ÿßŸÑŸàÿµŸàŸÑ ÿ•ŸÑŸâ ÿßŸÑÿ≠ÿßŸÅÿ∏ÿ© ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã. Ÿäÿ±ÿ¨Ÿâ ŸÑÿµŸÇ ŸÜÿµ ÿßŸÑÿ±ÿ≥ÿßŸÑÿ© ŸÅŸä ÿßŸÑŸÖÿ±ÿ®ÿπ ÿ£ÿØŸÜÿßŸá:</p>
  <textarea id="paste-textarea" class="w-full h-32 p-2 border border-gray-300 rounded-lg"></textarea>
  `;
  showModal("ŸÑÿµŸÇ ÿßŸÑŸÜÿµ ŸäÿØŸàŸäÿßŸã", body, {
  confirmText: 'ÿ™ÿ≠ŸÑŸäŸÑ',
  onConfirm: function() {
  var pastedText = document.getElementById('paste-textarea').value;
  if(pastedText) {
  analyzePastedText(pastedText);
  }
  return true;
  }
  });
  }
  }
  
  async function analyzePastedText(text) {
  showLoadingOverlay(true, "ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑÿ∞ŸÉŸä...");
  try {
  var categoriesForAI = state.categories.map(function(c) { return { id: c.id, name: c.name }});
  var apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
  
  var systemPrompt = `You are an intelligent data extraction tool. Analyze the provided bank transaction text and respond ONLY with a valid JSON object with the keys: "merchant", "amount", "date", "paymentMethod", "categoryId".`;
  
  var requestBody = {
  systemInstruction: { parts: [{ text: systemPrompt }] },
  contents: [{ parts: [{ text: text }, {text: `Available Categories: ${JSON.stringify(categoriesForAI)}`}] }],
  generationConfig: { responseMimeType: "application/json" }
  };
  
  var response = await fetch(apiUrl, {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify(requestBody)
  });
  
  if (!response.ok) throw new Error(`API call failed with status ${response.status}`);
  
  var result = await response.json();
  var textResponse = getApiResponseText(result);
  
  if (!textResponse) throw new Error("Invalid response from AI model.");
  
  var data = JSON.parse(textResponse);
  
  if (data.amount) document.getElementById('transaction-amount').value = data.amount;
  if (data.merchant) document.getElementById('transaction-description').value = data.merchant;
  if (data.date) document.getElementById('transaction-date').value = data.date;
  if (data.paymentMethod) document.getElementById('payment-method').value = data.paymentMethod;
  if (data.categoryId) document.getElementById('transaction-category').value = data.categoryId;
  
  handlePaymentMethodChange({ target: document.getElementById('payment-method') });
  handleTransactionTypeChange();
  
  showModal("ŸÜÿ¨ÿßÿ≠", "<p>ÿ™ŸÖ ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑŸÜÿµ ŸàŸÖŸÑÿ° ÿßŸÑÿ≠ŸÇŸàŸÑ ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã. Ÿäÿ±ÿ¨Ÿâ ŸÖÿ±ÿßÿ¨ÿπÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÇÿ®ŸÑ ÿßŸÑÿ≠ŸÅÿ∏.</p>", { confirmText: 'ÿ≠ÿ≥ŸÜŸãÿß', hideCancel: true });
  
  } catch (error) {
  console.error("Paste analysis error:", error);
  showError("ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑŸÜÿµ. ŸÇÿØ ŸäŸÉŸàŸÜ ÿßŸÑŸÜÿµ ÿ∫Ÿäÿ± ÿµÿßŸÑÿ≠ ÿ£Ÿà ŸáŸÜÿßŸÉ ŸÖÿ¥ŸÉŸÑÿ© ŸÅŸä ÿßŸÑÿßÿ™ÿµÿßŸÑ.");
  } finally {
  showLoadingOverlay(false);
  }
  }
  
  
  async function handleSuggestCategoryIcon() {
  var categoryNameInput = document.getElementById('category-name');
  var categoryIconInput = document.getElementById('category-icon');
  var categoryName = categoryNameInput.value.trim();
  if (!categoryName) {
  showError("ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿØÿÆÿßŸÑ ÿßÿ≥ŸÖ ÿßŸÑŸÅÿ¶ÿ© ÿ£ŸàŸÑÿßŸã.");
  return;
  }
  
  showLoadingOverlay(true, "ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ÿ£ŸäŸÇŸàŸÜÿ©...");
  
  try {
  var apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
  
  var systemPrompt = "You are an emoji expert. Your task is to suggest a single, relevant emoji for a given category name. You must respond with ONLY the emoji character and nothing else.";
  var requestBody = {
  systemInstruction: { parts: [{ text: systemPrompt }] },
  contents: [{ parts: [{ text: `Category: ${categoryName}` }] }]
  };
  
  var response = await fetch(apiUrl, {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify(requestBody)
  });
  
  if (!response.ok) {
  var error = new Error(`API call failed with status: ${response.status}`);
  error.status = response.status;
  throw error;
  }
  
  var result = await response.json();
  var emojiResponse = getApiResponseText(result);
  var emoji = emojiResponse ? emojiResponse.trim() : null;
  
  if (emoji) {
  categoryIconInput.value = emoji;
  } else {
  showError("ŸÑŸÖ ÿ£ÿ™ŸÖŸÉŸÜ ŸÖŸÜ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿ£ŸäŸÇŸàŸÜÿ© ŸÖŸÜÿßÿ≥ÿ®ÿ©.");
  }
  } catch (error) {
  console.error("Suggest icon error:", error);
  showError("ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿßŸÇÿ™ÿ±ÿßÿ≠ ÿßŸÑÿ£ŸäŸÇŸàŸÜÿ©.");
  } finally {
  showLoadingOverlay(false);
  }
  }

    async function handleSmartSummary() {
        const resultDiv = document.getElementById('smart-summary-result');
        showLoadingOverlay(true, "ÿ¨ÿßÿ±Ÿä ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑŸÖŸÑÿÆÿµ...");
        resultDiv.innerHTML = '';
        resultDiv.classList.add('hidden');

        try {
            const calc = calculateSummaries();
            if (state.transactions.length < 3) {
                throw new Error("ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™ ŸÉÿßŸÅŸäÿ© ŸÑÿ•ŸÜÿ¥ÿßÿ° ŸÖŸÑÿÆÿµ. Ÿäÿ±ÿ¨Ÿâ ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÖÿ≤ŸäÿØ ŸÖŸÜ ÿßŸÑŸÖÿπÿßŸÖŸÑÿßÿ™.");
            }

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            const systemPrompt = `You are a professional financial analyst. Your task is to write a concise, one-paragraph summary of a user's financial situation based on the provided data. The summary should be in Arabic, professional in tone, and suitable for the beginning of a financial report. Highlight the key figures like total income, total expenses, and the net result.`;
            
            const requestBody = {
                systemInstruction: { parts: [{ text: systemPrompt }] },
                contents: [{ parts: [{ text: `Financial Data: ${JSON.stringify(calc)}` }] }]
            };

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestBody)
            });

            if (!response.ok) throw new Error(`API call failed with status: ${response.status}`);

            const result = await response.json();
            const summaryText = getApiResponseText(result);

            if (!summaryText) throw new Error("ŸÑŸÖ Ÿäÿ™ŸÖŸÉŸÜ ÿßŸÑÿ∞ŸÉÿßÿ° ÿßŸÑÿßÿµÿ∑ŸÜÿßÿπŸä ŸÖŸÜ ÿ•ŸÜÿ¥ÿßÿ° ŸÖŸÑÿÆÿµ.");
            
            resultDiv.innerHTML = `<p>${summaryText}</p>`;
            resultDiv.classList.remove('hidden');

        } catch (error) {
            console.error("Smart Summary Error:", error);
            showError(error.message || "ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑŸÖŸÑÿÆÿµ ÿßŸÑÿ∞ŸÉŸä.");
        } finally {
            showLoadingOverlay(false);
        }
    }

  async function handleGenerateBudget() {
        const budgetInput = document.getElementById('monthly-budget-input');
        const resultDiv = document.getElementById('budget-plan-result');
        const totalBudget = parseFloat(budgetInput.value);

        if (isNaN(totalBudget) || totalBudget <= 0) {
            showError("ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿØÿÆÿßŸÑ ŸÖÿ®ŸÑÿ∫ ŸÖŸäÿ≤ÿßŸÜŸäÿ© ÿµÿ≠Ÿäÿ≠.");
            return;
        }

        showLoadingOverlay(true, "ÿ¨ÿßÿ±Ÿä ÿ•ŸÜÿ¥ÿßÿ° ÿÆÿ∑ÿ© ÿßŸÑŸÖŸäÿ≤ÿßŸÜŸäÿ©...");
        resultDiv.innerHTML = '';

        try {
            const sixtyDaysAgo = new Date();
            sixtyDaysAgo.setDate(sixtyDaysAgo.getDate() - 60);
            const recentTransactions = state.transactions.filter(t => new Date(t.date) >= sixtyDaysAgo && t.type === 'expense');

            if (recentTransactions.length < 5) {
                 throw new Error("ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™ ŸÉÿßŸÅŸäÿ© ÿπŸÜ ÿ•ŸÜŸÅÿßŸÇŸÉ ŸÑÿ•ŸÜÿ¥ÿßÿ° ÿÆÿ∑ÿ© ÿØŸÇŸäŸÇÿ©. Ÿäÿ±ÿ¨Ÿâ ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÖÿ≤ŸäÿØ ŸÖŸÜ ÿßŸÑŸÖÿπÿßŸÖŸÑÿßÿ™.");
            }

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            
            const systemPrompt = `You are a helpful and encouraging financial planning assistant in Arabic. Your goal is to help the user create a realistic monthly budget based on their spending history and a total budget amount they provide. Use the 50/30/20 rule (50% for Needs, 30% for Wants, 20% for Savings/Debt) as a general framework, but you MUST adapt it to the user's actual spending patterns revealed in their transaction data. Your response MUST be in Arabic and formatted using Markdown. It should contain: 1. A brief, encouraging introductory sentence. 2. A breakdown of the total budget into Needs, Wants, and Savings, with the suggested amount for each. 3. A detailed table with three columns: "ÿßŸÑŸÅÿ¶ÿ©", "ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÖŸÇÿ™ÿ±ÿ≠", and "ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™". 4. In the table, allocate the "Needs" and "Wants" amounts across the user's actual spending categories. 5. The "Notes" column should provide a brief justification. 6. Conclude with a short, motivational tip.`;

            const userPrompt = `Here is my financial data. Please create a budget plan for me. My total monthly budget is: ${totalBudget} SAR. My spending categories are: ${JSON.stringify(state.categories)}. My transactions from the last 60 days are: ${JSON.stringify(recentTransactions)}`;

            const requestBody = {
                systemInstruction: { parts: [{ text: systemPrompt }] },
                contents: [{ parts: [{ text: userPrompt }] }]
            };

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestBody)
            });

            if (!response.ok) {
                throw new Error(`API call failed with status: ${response.status}`);
            }

            const result = await response.json();
            const budgetPlanMd = getApiResponseText(result);

            if (!budgetPlanMd) {
                throw new Error("ŸÑŸÖ Ÿäÿ™ŸÖŸÉŸÜ ÿßŸÑÿ∞ŸÉÿßÿ° ÿßŸÑÿßÿµÿ∑ŸÜÿßÿπŸä ŸÖŸÜ ÿ•ŸÜÿ¥ÿßÿ° ÿÆÿ∑ÿ© ÿßŸÑŸÖŸäÿ≤ÿßŸÜŸäÿ©.");
            }
            
            let html = budgetPlanMd
                .replace(/### (.*)/g, '<h4 class="text-lg font-bold text-gray-800 mt-3 mb-2">$1</h4>')
                .replace(/\|(.+)\|(.+)\|(.+)\|/g, '<tr><td class="border px-4 py-2">$1</td><td class="border px-4 py-2">$2</td><td class="border px-4 py-2">$3</td></tr>')
                .replace(/\|-+\|/g, '')
                .replace(/<\/tr><tr>/g, '</tr></thead><tbody><tr>') 
                .replace(/<tr>/g, '<table class="w-full table-auto border-collapse"><thead><tr>')
                .replace(/(<\/table>)/g, '</tbody>$1');
            
            resultDiv.innerHTML = html;

        } catch (error) {
            console.error("Budget Generation Error:", error);
            resultDiv.innerHTML = `<p class="text-center text-red-600 p-4">${error.message}</p>`;
        } finally {
            showLoadingOverlay(false);
        }
    }
  
  function addMessageToChat(message, sender, chatBoxId) {
  var chatBox = document.getElementById(chatBoxId);
  var bubble = document.createElement('div');
  bubble.classList.add('chat-bubble', sender === 'user' ? 'user-bubble' : 'ai-bubble');
  bubble.innerHTML = message.replace(/\n/g, '<br>');
  chatBox.appendChild(bubble);
  chatBox.scrollTop = chatBox.scrollHeight;
  }
  
  function showTypingIndicator(show, chatBoxId) {
  var chatBox = document.getElementById(chatBoxId);
  var indicator = document.getElementById('typing-indicator-' + chatBoxId);
  if (show) {
  if (!indicator) {
  indicator = document.createElement('div');
  indicator.id = 'typing-indicator-' + chatBoxId;
  indicator.classList.add('ai-bubble', 'chat-bubble', 'typing-indicator');
  indicator.innerHTML = '<span></span><span></span><span></span>';
  chatBox.appendChild(indicator);
  chatBox.scrollTop = chatBox.scrollHeight;
  }
  } else {
  if (indicator) {
  indicator.remove();
  }
  }
  }
  
  // --- BUSINESS LOGIC & CALCULATIONS ---
  function calculateSummaries() { 
  var calc = { totalIncome: 0, totalExpenses: 0, totalBankPayments: 0, totalCashExpenses: 0, totalSnbExpenses: 0, totalEnbdExpenses: 0, totalBnplExpenses: 0, snbPaymentsTotal: 0, enbdPaymentsTotal: 0, bankDeposits: 0, bankWithdrawals: 0, totalInvestmentDeposits: 0, totalInvestmentWithdrawals: 0, transactionStats: { count: 0, total: 0, max: 0, average: 0 } }; 
  state.transactions.forEach(function(t) { 
  calc.transactionStats.count++; 
  calc.transactionStats.total += t.amount; 
  if (t.amount > calc.transactionStats.max) {
  calc.transactionStats.max = t.amount;
  } 
  if (t.type === 'income') { 
  calc.totalIncome += t.amount; 
  if(t.paymentMethod === 'mada-bank') {
  calc.bankDeposits += t.amount;
  } 
  } else if (t.type === 'expense') { 
  calc.totalExpenses += t.amount; 
  if (t.paymentMethod === 'mada-bank') { 
  calc.totalBankPayments += t.amount; 
  calc.bankWithdrawals += t.amount; 
  } 
  if (t.paymentMethod === 'cash') {
  calc.totalCashExpenses += t.amount;
  } 
  if (t.paymentMethod === 'snb-card') {
  calc.totalSnbExpenses += t.amount;
  } 
  if (t.paymentMethod === 'enbd-card') {
  calc.totalEnbdExpenses += t.amount;
  } 
  if (t.paymentMethod.includes('bnpl')) {
  calc.totalBnplExpenses += t.amount;
  } 
  if (t.isInstallmentPayment) {
  calc.bankWithdrawals += t.amount;
  } 
  } else if (t.type === 'snb-payment') { 
  calc.snbPaymentsTotal += t.amount; 
  if (t.paymentMethod === 'mada-bank') { 
  calc.bankWithdrawals += t.amount; 
  } else if (t.paymentMethod === 'enbd-card') { 
  calc.totalEnbdExpenses += t.amount; 
  } 
  } else if (t.type === 'enbd-payment') { 
  calc.enbdPaymentsTotal += t.amount; 
  if (t.paymentMethod === 'mada-bank') { 
  calc.bankWithdrawals += t.amount; 
  } else if (t.paymentMethod === 'snb-card') { 
  calc.totalSnbExpenses += t.amount; 
  } 
  } else if (t.type === 'investment-deposit') { 
  calc.totalInvestmentDeposits += t.amount; 
  calc.bankWithdrawals += t.amount; 
  } else if (t.type === 'investment-withdrawal') { 
  calc.totalInvestmentWithdrawals += t.amount; 
  calc.bankDeposits += t.amount; 
  } 
  }); 
  calc.transactionStats.average = calc.transactionStats.count > 0 ? (calc.transactionStats.total / calc.transactionStats.count) : 0; 
  state.bank.balance = calc.bankDeposits - calc.bankWithdrawals;
  var snbBalance = calc.totalSnbExpenses - calc.snbPaymentsTotal; 
  var enbdBalance = calc.totalEnbdExpenses - calc.enbdPaymentsTotal; 
  calc.snb = { balance: snbBalance, available: state.cards.snb.limit - snbBalance, usagePercentage: state.cards.snb.limit > 0 ? (snbBalance / state.cards.snb.limit) * 100 : 0 }; 
  calc.enbd = { balance: enbdBalance, available: state.cards.enbd.limit - enbdBalance, usagePercentage: state.cards.enbd.limit > 0 ? (enbdBalance / state.cards.enbd.limit) * 100 : 0 }; 
  calc.totalDebt = snbBalance + enbdBalance; 
  calc.totalAvailable = calc.snb.available + calc.enbd.available; 
  calc.totalLimits = state.cards.snb.limit + state.cards.enbd.limit; 
  calc.totalCardPayments = calc.snbPaymentsTotal + calc.enbdPaymentsTotal; 
  return calc; 
  }
  
  
  // --- MODALS & FORMS ---
  function openUpdateInvestmentValueModal() {
  var body = `
  <div>
  <label class="block text-sm font-medium text-gray-700 mb-1">ÿßŸÑŸÇŸäŸÖÿ© ÿßŸÑÿ≠ÿßŸÑŸäÿ© ŸÑŸÑŸÖÿ≠ŸÅÿ∏ÿ© (ÿ±ŸäÿßŸÑ)</label>
  <input type="number" id="edit-investment-value" class="w-full p-2 border border-gray-300 rounded-lg" value="${state.investments.currentValue}">
  <p class="text-xs text-gray-500 mt-2">ÿ£ÿØÿÆŸÑ ÿßŸÑŸÇŸäŸÖÿ© ÿßŸÑÿ≥ŸàŸÇŸäÿ© ÿßŸÑÿ≠ÿßŸÑŸäÿ© ŸÑÿ¨ŸÖŸäÿπ ÿßÿ≥ÿ™ÿ´ŸÖÿßÿ±ÿßÿ™ŸÉ.</p>
  </div>`;
  showModal('ÿ™ÿ≠ÿØŸäÿ´ ŸÇŸäŸÖÿ© ÿßŸÑŸÖÿ≠ŸÅÿ∏ÿ©', body, {
  confirmText: 'ÿ≠ŸÅÿ∏',
  onConfirm: function() {
  var newValue = parseFloat(document.getElementById('edit-investment-value').value);
  if (isNaN(newValue) || newValue < 0) {
  showError("ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿØÿÆÿßŸÑ ŸÇŸäŸÖÿ© ÿµÿ≠Ÿäÿ≠ÿ©.");
  return false;
  }
  state.investments.currentValue = newValue;
  saveStateToFirebase();
  return true;
  }
  });
  }
  function handleInvestmentFormSubmit(e) {
  e.preventDefault();
  var amount = parseFloat(document.getElementById('investment-amount').value);
  var type = document.getElementById('investment-type').value;
  
  if (isNaN(amount) || amount <= 0) {
  showError("ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿØÿÆÿßŸÑ ŸÖÿ®ŸÑÿ∫ ÿµÿ≠Ÿäÿ≠.");
  return;
  }
  
  var newTransaction = {
  id: `trans-${Date.now()}`,
  amount: amount,
  date: new Date().toISOString().split('T')[0],
  description: type === 'deposit' ? 'ÿ•ŸäÿØÿßÿπ ŸÅŸä ÿßŸÑŸÖÿ≠ŸÅÿ∏ÿ© ÿßŸÑÿßÿ≥ÿ™ÿ´ŸÖÿßÿ±Ÿäÿ©' : 'ÿ≥ÿ≠ÿ® ŸÖŸÜ ÿßŸÑŸÖÿ≠ŸÅÿ∏ÿ© ÿßŸÑÿßÿ≥ÿ™ÿ´ŸÖÿßÿ±Ÿäÿ©',
  paymentMethod: 'mada-bank', // Assumes investment comes from/goes to the bank
  type: type === 'deposit' ? 'investment-deposit' : 'investment-withdrawal',
  categoryId: null
  };
  
  state.transactions.push(newTransaction);
  saveStateToFirebase();
  investmentForm.reset();
  }
  async function handleInvestmentAIChatSubmit(e) {
  e.preventDefault();
  var userInput = document.getElementById('investment-ai-user-input');
  var query = userInput.value.trim();
  if (!query) return;
  
  addMessageToChat(query, 'user', 'investment-ai-chat-box');
  userInput.value = '';
  showTypingIndicator(true, 'investment-ai-chat-box');
  
  try {
  var apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
  
  var systemPrompt = `You are an educational investment coach named "ÿßŸÑŸÖÿ≥ÿ™ÿ¥ÿßÿ± ÿßŸÑÿ∞ŸÉŸä". Your primary role is to educate the user about investment concepts and strategies, particularly within the context of the Saudi stock market (Tadawul).
  - You MUST NOT give direct financial advice. Do not recommend buying or selling specific stocks (e.g., "Buy Aramco").
  - When asked for a recommendation, you MUST politely decline and instead explain HOW the user can research and make their own informed decisions. For example, explain what metrics to look at, what diversification means, etc.
  - Your tone should be encouraging, educational, and responsible.
  - Keep your answers clear, concise, and in Arabic.`;
  
  var requestBody = {
  systemInstruction: { parts: [{ text: systemPrompt }] },
  contents: [{ parts: [{ text: query }] }],
  };
  
  var response = await fetch(apiUrl, {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify(requestBody)
  });
  
  if (!response.ok) {
  var error = new Error(`API call failed with status: ${response.status}`);
  error.status = response.status;
  throw error;
  }
  
  var result = await response.json();
  var aiResponse = getApiResponseText(result) || "ÿπŸÅŸàÿßŸãÿå ŸÑŸÖ ÿ£ÿ™ŸÖŸÉŸÜ ŸÖŸÜ ŸÖÿπÿßŸÑÿ¨ÿ© ÿ∑ŸÑÿ®ŸÉ ÿ≠ÿßŸÑŸäÿßŸã.";
  
  addMessageToChat(aiResponse, 'ai', 'investment-ai-chat-box');
  } catch (error) {
  console.error("Investment AI error:", error);
  var userMessage = "ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£. ÿßŸÑÿ±ÿ¨ÿßÿ° ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ© ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ.";
  if (error.status === 403) {
  userMessage = "ÿ™ŸÖ ÿ±ŸÅÿ∂ ÿßŸÑŸàÿµŸàŸÑ. Ÿäÿ±ÿ¨Ÿâ ŸÖÿ±ÿßÿ¨ÿπÿ© ÿ•ÿπÿØÿßÿØÿßÿ™ ŸÖŸÅÿ™ÿßÿ≠ API.";
  showError("ÿ™ŸÖ ÿ±ŸÅÿ∂ ÿßŸÑŸàÿµŸàŸÑ (ÿÆÿ∑ÿ£ 403). Ÿäÿ±ÿ¨Ÿâ ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ŸÇŸäŸàÿØ ŸÖŸÅÿ™ÿßÿ≠ API ÿßŸÑÿÆÿßÿµ ÿ®ŸÉ ŸÅŸä Google Cloud Console ŸàÿßŸÑÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿßŸÑÿ≥ŸÖÿßÿ≠ ÿ®ŸÜÿ∑ÿßŸÇ ÿßŸÑŸÜÿ¥ÿ± (e.g. *.netlify.app).");
  }
  addMessageToChat(userMessage, 'ai', 'investment-ai-chat-box');
  } finally {
  showTypingIndicator(false, 'investment-ai-chat-box');
  }
  }
  
    // --- New Feature: Receipt Scan ---
    async function handleReceiptScan(event) {
        const file = event.target.files[0];
        if (!file) return;

        showLoadingOverlay(true, "ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©...");
        try {
            const base64Image = await fileToBase64(file);
            const mimeType = file.type;
            
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            const systemPrompt = `You are an expert data extraction AI for receipts. Analyze the receipt image and respond ONLY with a valid JSON object containing: "merchant" (string), "amount" (number), and "date" (string, "YYYY-MM-DD"). If you cannot find a value, use null.`;
            const userPrompt = "Extract transaction details from this receipt.";

            const requestBody = {
                contents: [{
                    parts: [
                        { text: userPrompt },
                        { inlineData: { mimeType: mimeType, data: base64Image } }
                    ]
                }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: { responseMimeType: "application/json" }
            };

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestBody)
            });

            if (!response.ok) throw new Error(`API call failed with status ${response.status}`);

            const result = await response.json();
            const dataText = getApiResponseText(result);
            if (!dataText) throw new Error("Could not extract data from receipt.");

            const data = JSON.parse(dataText);
            
            document.getElementById('transaction-amount').value = data.amount || '';
            document.getElementById('transaction-description').value = data.merchant || '';
            document.getElementById('transaction-date').value = data.date || new Date().toISOString().split('T')[0];
            
            showModal("ÿ™ŸÖ ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©", "<p>ÿ™ŸÖ ŸÖŸÑÿ° ÿßŸÑÿ≠ŸÇŸàŸÑ ŸÖŸÜ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©. Ÿäÿ±ÿ¨Ÿâ ŸÖÿ±ÿßÿ¨ÿπÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸàÿßÿÆÿ™Ÿäÿßÿ± ÿßŸÑŸÅÿ¶ÿ© ŸàŸàÿ≥ŸäŸÑÿ© ÿßŸÑÿØŸÅÿπ ŸÇÿ®ŸÑ ÿßŸÑÿ≠ŸÅÿ∏.</p>", { confirmText: 'ÿ≠ÿ≥ŸÜŸãÿß', hideCancel: true });

        } catch (error) {
            console.error("Receipt Scan Error:", error);
            showError("ŸÅÿ¥ŸÑ ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©. Ÿäÿ±ÿ¨Ÿâ ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ© ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ ÿ®ÿµŸàÿ±ÿ© ÿ£Ÿàÿ∂ÿ≠.");
        } finally {
            showLoadingOverlay(false);
            event.target.value = ''; // Reset file input
        }
    }

    // --- New Feature: Voice Input ---
    async function handleVoiceInput() {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) {
            showError("ÿπÿ∞ÿ±ÿßŸãÿå ŸÖŸäÿ≤ÿ© ÿßŸÑÿ•ÿØÿÆÿßŸÑ ÿßŸÑÿµŸàÿ™Ÿä ÿ∫Ÿäÿ± ŸÖÿØÿπŸàŸÖÿ© ŸÅŸä ŸÖÿ™ÿµŸÅÿ≠ŸÉ.");
            return;
        }

        const recognition = new SpeechRecognition();
        recognition.lang = 'ar-SA';
        recognition.interimResults = false;
        recognition.maxAlternatives = 1;

        showLoadingOverlay(true, "üé§ ÿßÿ≥ÿ™ŸÖÿπ ÿßŸÑÿ¢ŸÜ...");

        recognition.start();

        recognition.onresult = async (event) => {
            const speechResult = event.results[0][0].transcript;
            showLoadingOverlay(true, "ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑÿ£ŸÖÿ± ÿßŸÑÿµŸàÿ™Ÿä...");
            try {
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                const systemPrompt = `You are an intelligent command parsing tool for a personal finance app. Analyze the provided spoken text in Arabic. Your task is to extract transaction information and respond ONLY with a valid JSON object with the following keys: "description" (string), "amount" (number), and "paymentMethod" (string). The payment method should be one of: 'snb-card', 'enbd-card', 'mada-bank', 'cash'. Map common names like 'ÿßŸÑÿ£ŸáŸÑŸä' to 'snb-card' and 'ÿßŸÑÿ®ŸÜŸÉ' to 'mada-bank'.`;
                const userPrompt = `Parse this command: "${speechResult}". My available categories are: ${JSON.stringify(state.categories)}. Try to match the description to a category.`;
                
                const requestBody = {
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                    contents: [{ parts: [{ text: userPrompt }] }],
                    generationConfig: { responseMimeType: "application/json" }
                };

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });
                 if (!response.ok) throw new Error(`API call failed with status ${response.status}`);

                const result = await response.json();
                const dataText = getApiResponseText(result);
                if (!dataText) throw new Error("Could not understand the voice command.");
                
                const data = JSON.parse(dataText);
                document.getElementById('transaction-amount').value = data.amount || '';
                document.getElementById('transaction-description').value = data.description || '';
                if(data.paymentMethod) {
                    document.getElementById('payment-method').value = data.paymentMethod;
                }
                
                showModal("ÿ™ŸÖ ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑÿ£ŸÖÿ± ÿßŸÑÿµŸàÿ™Ÿä", "<p>ÿ™ŸÖ ŸÖŸÑÿ° ÿßŸÑÿ≠ŸÇŸàŸÑ ŸÖŸÜ ÿ£ŸÖÿ±ŸÉ ÿßŸÑÿµŸàÿ™Ÿä. Ÿäÿ±ÿ¨Ÿâ ÿßŸÑŸÖÿ±ÿßÿ¨ÿπÿ© ŸÇÿ®ŸÑ ÿßŸÑÿ≠ŸÅÿ∏.</p>", { confirmText: 'ÿ≠ÿ≥ŸÜŸãÿß', hideCancel: true });

            } catch(err) {
                 showError("ŸÑŸÖ ÿ£ÿ™ŸÖŸÉŸÜ ŸÖŸÜ ŸÅŸáŸÖ ÿ∑ŸÑÿ®ŸÉ. ÿ≠ÿßŸàŸÑ ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ ÿ®ÿ¨ŸÖŸÑÿ© ÿ£Ÿàÿ∂ÿ≠.");
            } finally {
                showLoadingOverlay(false);
            }
        };

        recognition.onspeechend = () => {
            recognition.stop();
        };

        recognition.onerror = (event) => {
            showLoadingOverlay(false);
            showError(`ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ™ÿπÿ±ŸÅ ÿπŸÑŸâ ÿßŸÑÿµŸàÿ™: ${event.error}`);
        };
    }


  // --- Helper Functions ---
  const fileToBase64 = file => new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onload = () => resolve(reader.result.split(',')[1]);
    reader.onerror = error => reject(error);
  });
  
  // ... other modal functions are the same as before
  function showModal(title, body, options) { if(options === undefined) { options = {}; } var config = { onConfirm: function(){ return true }, confirmText: 'ŸÖŸàÿßŸÅŸÇ', cancelText: 'ÿ•ŸÑÿ∫ÿßÿ°', hideCancel: false, ...options }; document.getElementById('modal-title').textContent = title; document.getElementById('modal-body').innerHTML = body; var modal = document.getElementById('custom-modal'); var confirmBtn = document.getElementById('modal-confirm'); var cancelBtn = document.getElementById('modal-cancel'); confirmBtn.textContent = config.confirmText; cancelBtn.textContent = config.cancelText; cancelBtn.style.display = config.hideCancel ? 'none' : 'inline-block'; var newConfirmBtn = confirmBtn.cloneNode(true); confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn); newConfirmBtn.addEventListener('click', function() { if (config.onConfirm() !== false) { hideModal(); } }); modal.classList.add('visible'); }
  function hideModal() { document.getElementById('custom-modal').classList.remove('visible'); }
  function openEditTransactionModal(id) { var transaction = state.transactions.find(function(t) { return t.id === id }); if (!transaction) return; currentEditTransactionId = id; document.getElementById('transaction-amount').value = transaction.amount; document.getElementById('transaction-date').value = transaction.date; document.getElementById('transaction-description').value = transaction.description || ''; document.getElementById('payment-method').value = transaction.paymentMethod; document.getElementById('transaction-type').value = transaction.type; var categoryExists = state.categories.some(function(c) { return c.id === transaction.categoryId}); document.getElementById('transaction-category').value = categoryExists ? transaction.categoryId : ''; handleTransactionTypeChange(); showTab('transactions'); window.scrollTo(0, 0); document.querySelector('#transaction-form button[type="submit"]').textContent = '‚úèÔ∏è ÿ™ÿπÿØŸäŸÑ ÿßŸÑŸÖÿπÿßŸÖŸÑÿ©'; }
  function openEditCardModal(cardKey) {
  var card = state.cards[cardKey];
  var title = cardKey === 'snb' ? 'ÿ™ÿπÿØŸäŸÑ ÿ®ÿ∑ÿßŸÇÿ© SNB' : 'ÿ™ÿπÿØŸäŸÑ ÿ®ÿ∑ÿßŸÇÿ© ENBD';
  var calc = calculateSummaries();
  var currentBalance = calc[cardKey].balance;
  var body = `<div class="space-y-4"><div><label class="block text-sm font-medium text-gray-700 mb-1">ÿßŸÑÿ≠ÿØ ÿßŸÑÿßÿ¶ÿ™ŸÖÿßŸÜŸä (ÿ±ŸäÿßŸÑ)</label><input type="number" id="edit-card-limit" class="w-full p-2 border border-gray-300 rounded-lg" value="${card.limit}"></div><div><label class="block text-sm font-medium text-gray-700 mb-1">ÿßŸÑÿ±ÿµŸäÿØ ÿßŸÑŸÖÿ≥ÿ™ÿ≠ŸÇ (ŸÑŸÑÿ™ÿ≥ŸàŸäÿ©)</label><input type="number" step="0.01" id="edit-card-balance" class="w-full p-2 border border-gray-300 rounded-lg" value="${currentBalance.toFixed(2)}"></div><div><label class="block text-sm font-medium text-gray-700 mb-1">ŸäŸàŸÖ ÿßŸÑÿßÿ≥ÿ™ÿ≠ŸÇÿßŸÇ (1-31)</label><input type="number" id="edit-card-due-day" class="w-full p-2 border border-gray-300 rounded-lg" value="${card.dueDay}" min="1" max="31"></div></div>`;
  showModal(title, body, {
  confirmText: 'ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿ∫ŸäŸäÿ±ÿßÿ™',
  onConfirm: function() {
  var newLimit = parseFloat(document.getElementById('edit-card-limit').value);
  var newDueDay = parseInt(document.getElementById('edit-card-due-day').value, 10);
  var newBalance = parseFloat(document.getElementById('edit-card-balance').value);
  if (isNaN(newLimit) || newLimit < 0 || isNaN(newDueDay) || newDueDay < 1 || newDueDay > 31 || isNaN(newBalance)) {
  showError("ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿØÿÆÿßŸÑ ŸÇŸäŸÖ ÿµÿßŸÑÿ≠ÿ©.");
  return false;
  }
  state.cards[cardKey].limit = newLimit;
  state.cards[cardKey].dueDay = newDueDay;
  var adjustment = newBalance - currentBalance;
  if (Math.abs(adjustment) > 0.01) {
  var transaction;
  var otherCategory = state.categories.find(function(c) {
  return c.name === 'ÿ£ÿÆÿ±Ÿâ';
  });
  var categoryId = otherCategory ? otherCategory.id : '';
  if (adjustment > 0) {
  transaction = {
  id: `trans-${Date.now()}`,
  amount: adjustment,
  date: new Date().toISOString().split('T')[0],
  description: 'ÿ™ÿ≥ŸàŸäÿ© ÿ±ÿµŸäÿØ ÿßŸÑÿ®ÿ∑ÿßŸÇÿ©',
  paymentMethod: `${cardKey}-card`,
  type: 'expense',
  categoryId: categoryId,
  };
  } else {
  transaction = {
  id: `trans-${Date.now()}`,
  amount: Math.abs(adjustment),
  date: new Date().toISOString().split('T')[0],
  description: 'ÿ™ÿ≥ŸàŸäÿ© ÿ±ÿµŸäÿØ ÿßŸÑÿ®ÿ∑ÿßŸÇÿ© (ÿ™ÿÆŸÅŸäÿ∂)',
  paymentMethod: 'reconciliation',
  type: `${cardKey}-payment`,
  };
  }
  state.transactions.push(transaction);
  }
  saveStateToFirebase();
  return true;
  }
  });
  }
  function openEditBankModal() { var body = `<div><label class="block text-sm font-medium text-gray-700 mb-1">ÿßŸÑÿ±ÿµŸäÿØ ÿßŸÑŸÅÿπŸÑŸä ÿßŸÑÿ≠ÿßŸÑŸä (ÿ±ŸäÿßŸÑ)</label><input type="number" id="edit-bank-balance" class="w-full p-2 border border-gray-300 rounded-lg" value="${state.bank.balance}"><p class="text-xs text-gray-500 mt-2">ŸÖŸÑÿßÿ≠ÿ∏ÿ©: Ÿáÿ∞ÿß ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ° ÿ≥ŸäŸÇŸàŸÖ ÿ®ÿ™ÿ≥ŸàŸäÿ© ÿßŸÑÿ±ÿµŸäÿØ ŸàŸÑŸÜ Ÿäÿ§ÿ´ÿ± ÿπŸÑŸâ ÿ≥ÿ¨ŸÑ ÿßŸÑŸÖÿπÿßŸÖŸÑÿßÿ™ ÿßŸÑÿ≠ÿßŸÑŸä.</p></div>`; showModal('ÿ™ÿ≥ŸàŸäÿ© ÿ±ÿµŸäÿØ ÿßŸÑÿ®ŸÜŸÉ', body, { confirmText: 'ÿ≠ŸÅÿ∏', onConfirm: function() { var newBalance = parseFloat(document.getElementById('edit-bank-balance').value); if (isNaN(newBalance)) { showError("ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿØÿÆÿßŸÑ ŸÖÿ®ŸÑÿ∫ ÿµÿ≠Ÿäÿ≠."); return false; } var settlementAmount = newBalance - state.bank.balance; if(settlementAmount !== 0) { var otherCategory = state.categories.find(function(c) { return c.name === 'ÿ£ÿÆÿ±Ÿâ'; }); var categoryId = ''; if (otherCategory) { categoryId = otherCategory.id; } var transaction = { id: `trans-${Date.now()}`, amount: Math.abs(settlementAmount), date: new Date().toISOString().split('T')[0], description: `ÿ™ÿ≥ŸàŸäÿ© ÿ±ÿµŸäÿØ ÿßŸÑÿ≠ÿ≥ÿßÿ®`, paymentMethod: 'mada-bank', type: settlementAmount > 0 ? 'income' : 'expense', categoryId: categoryId, }; state.transactions.push(transaction); } saveStateToFirebase(); return true; } }); }
  function openEditCategoryModal(id) { var category = findCategoryById(id); if(!category) return; var body = `<div class="space-y-4"><div><label class="block text-sm font-medium text-gray-700 mb-1">ÿßÿ≥ŸÖ ÿßŸÑŸÅÿ¶ÿ©</label><input type="text" id="edit-category-name" class="w-full p-2 border border-gray-300 rounded-lg" value="${category.name}"></div><div><label class="block text-sm font-medium text-gray-700 mb-1">ÿßŸÑÿ£ŸäŸÇŸàŸÜÿ© (Emoji)</label><input type="text" id="edit-category-icon" class="w-full p-2 border border-gray-300 rounded-lg" value="${category.icon}"></div></div>`; showModal('ÿ™ÿπÿØŸäŸÑ ÿßŸÑŸÅÿ¶ÿ©', body, { confirmText: 'ÿ≠ŸÅÿ∏', onConfirm: function() { var name = document.getElementById('edit-category-name').value.trim(); var icon = document.getElementById('edit-category-icon').value.trim(); if(!name || !icon) { showError("ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿØÿÆÿßŸÑ ÿßÿ≥ŸÖ Ÿàÿ£ŸäŸÇŸàŸÜÿ©."); return false; } var index = state.categories.findIndex(function(c) { return c.id === id}); if (index !== -1) { state.categories[index] = { ...category, name: name, icon: icon }; saveStateToFirebase(); } return true; } }); }
  
  // --- TABS & UTILS ---
  function getApiResponseText(result) {
  if (result && result.candidates && result.candidates.length > 0) {
  var candidate = result.candidates[0];
  if (candidate && candidate.content && candidate.content.parts && candidate.content.parts.length > 0) {
  return candidate.content.parts[0].text;
  }
  }
  return null;
  }
  function showTab(tabName) { document.querySelectorAll('.tab-content').forEach(function(tab) { return tab.classList.add('hidden')}); document.getElementById(`${tabName}-tab`).classList.remove('hidden'); document.querySelectorAll('.tab-btn').forEach(function(btn) { return btn.classList.remove('active')}); document.getElementById(`tab-${tabName}`).classList.add('active'); }
  function formatCurrency(value) { return (value || 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }); }
  function findCategoryById(id) { return state.categories.find(function(c) { return c.id === id}); }
  function findInstallmentById(id) { return state.installments.find(function(i) { return i.id === id}); }
  function getPaymentMethodName(key) { var names = { 'mada-bank': 'üè¶ ÿ®ŸÜŸÉ', 'cash': 'üíµ ŸÜŸÇÿØŸä', 'snb-card': 'üí≥ SNB', 'enbd-card': 'üí≥ ENBD', 'tabby-bnpl': 'üì± ÿ™ÿßÿ®Ÿä', 'tamara-bnpl': 'üì± ÿ™ŸÖÿßÿ±ÿß', 'reconciliation': 'üîÑ ÿ™ÿ≥ŸàŸäÿ©' }; return names[key] || key; }
  function getTransactionTypeName(key) { var names = { 'income': 'üí∞ ÿØÿÆŸÑ', 'expense': 'üí∏ ŸÖÿµÿßÿ±ŸäŸÅ', 'snb-payment': 'üí≥ ÿ≥ÿØÿßÿØ SNB', 'enbd-payment': 'üí≥ ÿ≥ÿØÿßÿØ ENBD', 'investment-deposit': 'üíπ ÿ•ŸäÿØÿßÿπ ÿßÿ≥ÿ™ÿ´ŸÖÿßÿ±Ÿä', 'investment-withdrawal': 'üíπ ÿ≥ÿ≠ÿ® ÿßÿ≥ÿ™ÿ´ŸÖÿßÿ±Ÿä' }; return names[key] || key; }
  function setupDateTimeHeader() { var dateEl = document.getElementById('current-date-header'); var timeEl = document.getElementById('current-time-header'); function updateTime() { var now = new Date(); dateEl.textContent = now.toLocaleDateString('ar-SA', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', calendar: 'gregory' }); timeEl.textContent = now.toLocaleTimeString('ar-SA'); } updateTime(); setInterval(updateTime, 1000); }
  function showError(message) { console.error(message); if (!loadingOverlay.classList.contains('visible') || document.getElementById('config-prompt').classList.contains('hidden')) { showModal("ÿÆÿ∑ÿ£", `<p>${message}</p>`, { confirmText: 'ŸÖŸàÿßŸÅŸÇ', hideCancel: true }); } else { var prompt = document.getElementById('config-prompt'); var errorEl = document.getElementById('config-error'); if(!errorEl) { errorEl = document.createElement('p'); errorEl.id = 'config-error'; errorEl.className = 'mt-4 p-2 bg-red-500 text-white rounded'; prompt.appendChild(errorEl); } errorEl.textContent = message; } }
  function updateCategoryDropdowns() { var optionsHTML = state.categories.map(function(cat) { return `<option value="${cat.id}">${cat.icon} ${cat.name}</option>`}).join(''); document.getElementById('transaction-category').innerHTML = optionsHTML; }
  function getExpensesForCurrentMonth() { var now = new Date(); var startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1); var endOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0); return state.transactions.filter(function(t) { var tDate = new Date(t.date); return t.type === 'expense' && tDate >= startOfMonth && tDate <= endOfMonth; }); }
  function getIncomeExpenseByMonth(numMonths) { var result = { labels: [], income: [], expenses: [] }; var today = new Date(); for (var i = numMonths - 1; i >= 0; i--) { var d = new Date(today.getFullYear(), today.getMonth() - i, 1); var month = d.getMonth() + 1; var year = d.getFullYear(); var monthString = `${year}-${String(month).padStart(2, '0')}`; result.labels.push(d.toLocaleDateString('ar-SA', { month: 'short', year: 'numeric' })); var monthlyIncome = 0; var monthlyExpenses = 0; state.transactions.forEach(function(t) { if (t.date.startsWith(monthString)) { if (t.type === 'income') monthlyIncome += t.amount; if (t.type === 'expense') monthlyExpenses += t.amount; } }); result.income.push(monthlyIncome); result.expenses.push(monthlyExpenses); } return result; }
  function showLoadingOverlay(show, text) { if(text === undefined) { text = "" }; var overlay = document.getElementById('loading-overlay'); var loadingText = document.getElementById('loading-text'); loadingText.textContent = text; if (show) { overlay.classList.add('visible'); } else { overlay.classList.remove('visible'); } }
  function promptForFirebaseConfig() { document.getElementById('loader-container').classList.add('hidden'); document.getElementById('config-prompt').classList.remove('hidden'); document.getElementById('firebase-config-form').addEventListener('submit', function(e) { e.preventDefault(); var configInput = document.getElementById('firebase-config-input').value; try { var configStr = configInput; var startIndex = configInput.indexOf('{'); var endIndex = configInput.lastIndexOf('}'); if (startIndex !== -1 && endIndex !== -1) { configStr = configInput.substring(startIndex, endIndex + 1); } var config = JSON.parse(configStr); if (!config.apiKey || !config.authDomain) { throw new Error("Invalid config object"); } localStorage.setItem('firebaseConfig', JSON.stringify(config)); location.reload(); } catch (error) { showError("ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿ™Ÿä ÿ£ÿØÿÆŸÑÿ™Ÿáÿß ÿ∫Ÿäÿ± ÿµÿßŸÑÿ≠ÿ©. ÿßŸÑÿ±ÿ¨ÿßÿ° ÿßŸÑÿ™ÿ£ŸÉÿØ ŸÖŸÜ ŸÜÿ≥ÿÆ ÿßŸÑŸÉÿßÿ¶ŸÜ ŸÉÿßŸÖŸÑÿßŸã."); } }); }
  function clearFirebaseConfig() { showModal( "ŸÖÿ≥ÿ≠ ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™", "<p>ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ±ÿ∫ÿ®ÿ™ŸÉ ŸÅŸä ŸÖÿ≥ÿ≠ ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ÿü ÿ≥ÿ™ÿ≠ÿ™ÿßÿ¨ ÿ•ŸÑŸâ ÿ•ÿØÿÆÿßŸÑŸáÿß ŸÖÿ¨ÿØÿØÿßŸã ŸÅŸä ÿßŸÑŸÖÿ±ÿ© ÿßŸÑŸÇÿßÿØŸÖÿ©.</p>", { confirmText: 'ŸÜÿπŸÖÿå ÿßŸÖÿ≥ÿ≠', onConfirm: function() { localStorage.removeItem('firebaseConfig'); showModal("ÿ™ŸÖ", "<p>ÿ™ŸÖ ŸÖÿ≥ÿ≠ ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™ ÿ®ŸÜÿ¨ÿßÿ≠. ÿ≥Ÿäÿ™ŸÖ ÿ•ÿπÿßÿØÿ© ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ.</p>", { confirmText: 'ŸÖŸàÿßŸÅŸÇ', hideCancel: true, onConfirm: function() { return location.reload()} }); return true; } } ); }
  
  // --- EXPORT & BACKUP ---
  function createBackup() { var backupData = JSON.stringify(state, null, 2); var blob = new Blob([backupData], { type: 'application/json' }); var url = URL.createObjectURL(blob); var a = document.createElement('a'); a.href = url; a.download = `expenses_backup_${new Date().toISOString().split('T')[0]}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); }
  function handleRestoreBackup(event) {
  var file = event.target.files[0];
  if (!file) return;
  var reader = new FileReader();
  reader.onload = function(e) {
  try {
  var restoredState = JSON.parse(e.target.result);
  if (restoredState && typeof restoredState === 'object' && 'transactions' in restoredState && Array.isArray(restoredState.transactions)) {
  showModal( "ÿßÿ≥ÿ™ÿπÿßÿØÿ© ŸÜÿ≥ÿÆÿ© ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ©", "<p>ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿßÿ≥ÿ™ÿπÿßÿØÿ© Ÿáÿ∞Ÿá ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ÿü ÿ≥Ÿäÿ™ŸÖ ÿßŸÑŸÉÿ™ÿßÿ®ÿ© ŸÅŸàŸÇ ÿ¨ŸÖŸäÿπ ÿ®ŸäÿßŸÜÿßÿ™ŸÉ ÿßŸÑÿ≠ÿßŸÑŸäÿ©.</p>", { confirmText: 'ŸÜÿπŸÖÿå ÿßÿ≥ÿ™ÿπÿßÿØÿ©', onConfirm: function() { state = { ...getInitialState(), ...restoredState }; saveStateToFirebase(); showModal("ŸÜÿ¨ÿßÿ≠", "<p>ÿ™ŸÖ ÿßÿ≥ÿ™ÿπÿßÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ®ŸÜÿ¨ÿßÿ≠!</p>", { confirmText: 'ÿ≠ÿ≥ŸÜŸãÿß', hideCancel: true }); return true; } } );
  } else {
  throw new Error("Invalid backup file format.");
  }
  } catch (error) {
  console.error("Failed to restore backup:", error);
  showModal("ÿÆÿ∑ÿ£", "<p>ŸÅÿ¥ŸÑ ŸÅŸä ÿßÿ≥ÿ™ÿπÿßÿØÿ© ÿßŸÑŸÜÿ≥ÿÆÿ© ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ©. ÿßŸÑŸÖŸÑŸÅ ÿ∫Ÿäÿ± ÿµÿßŸÑÿ≠.</p>", { confirmText: 'ŸÖŸàÿßŸÅŸÇ', hideCancel: true });
  }
  };
  reader.readAsText(file);
  event.target.value = '';
  }
  function exportToExcel() {
  var wb = XLSX.utils.book_new();
  var transactionsData = state.transactions.map(function(t) {
  var category = findCategoryById(t.categoryId);
  var categoryName = category ? category.name : 'N/A';
  return {
  'ÿßŸÑÿ™ÿßÿ±ŸäÿÆ': t.date,
  'ÿßŸÑŸÜŸàÿπ': getTransactionTypeName(t.type),
  'ÿßŸÑŸàÿ≥ŸäŸÑÿ©': getPaymentMethodName(t.paymentMethod),
  'ÿßŸÑŸÖÿ®ŸÑÿ∫': t.amount,
  'ÿßŸÑŸÅÿ¶ÿ©': categoryName,
  'ÿßŸÑŸàÿµŸÅ': t.description
  };
  });
  var ws_transactions = XLSX.utils.json_to_sheet(transactionsData);
  XLSX.utils.book_append_sheet(wb, ws_transactions, "ÿßŸÑŸÖÿπÿßŸÖŸÑÿßÿ™");
  var calc = calculateSummaries();
  var summaryData = [
  { "ÿßŸÑÿ®ŸÜÿØ": "ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿØÿÆŸÑ", "ÿßŸÑŸÖÿ®ŸÑÿ∫": calc.totalIncome },
  { "ÿßŸÑÿ®ŸÜÿØ": "ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖÿµÿßÿ±ŸäŸÅ", "ÿßŸÑŸÖÿ®ŸÑÿ∫": calc.totalExpenses },
  { "ÿßŸÑÿ®ŸÜÿØ": "ÿ±ÿµŸäÿØ ÿ®ŸÜŸÉ SNB ÿßŸÑŸÖÿ≥ÿ™ÿ≠ŸÇ", "ÿßŸÑŸÖÿ®ŸÑÿ∫": calc.snb.balance },
  { "ÿßŸÑÿ®ŸÜÿØ": "ÿ±ÿµŸäÿØ ÿ®ŸÜŸÉ ENBD ÿßŸÑŸÖÿ≥ÿ™ÿ≠ŸÇ", "ÿßŸÑŸÖÿ®ŸÑÿ∫": calc.enbd.balance },
  { "ÿßŸÑÿ®ŸÜÿØ": "ÿ±ÿµŸäÿØ ÿßŸÑÿ≠ÿ≥ÿßÿ® ÿßŸÑÿ®ŸÜŸÉŸä", "ÿßŸÑŸÖÿ®ŸÑÿ∫": state.bank.balance },
  ];
  var ws_summary = XLSX.utils.json_to_sheet(summaryData);
  XLSX.utils.book_append_sheet(wb, ws_summary, "ÿßŸÑŸÖŸÑÿÆÿµ");
  XLSX.writeFile(wb, "Expense_Report.xlsx");
  }
  
  function generatePDFReport() {
  var { jsPDF } = window.jspdf;
  var doc = new jsPDF();
  doc.setRTL(true);
  doc.setFont("Helvetica", "bold");
  doc.text("ÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑŸÖÿµÿßÿ±ŸäŸÅ ÿßŸÑÿ¥ÿßŸÖŸÑ", 105, 20, null, null, "center");
  var calc = calculateSummaries();
  doc.autoTable({
  startY: 30,
  head: [['ÿßŸÑÿ®ŸÜÿØ', 'ÿßŸÑŸÖÿ®ŸÑÿ∫']],
  body: [
  ['ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿØÿÆŸÑ', `${formatCurrency(calc.totalIncome)} ÿ±ŸäÿßŸÑ`],
  ['ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖÿµÿßÿ±ŸäŸÅ', `${formatCurrency(calc.totalExpenses)} ÿ±ŸäÿßŸÑ`],
  ['ÿßŸÑÿµÿßŸÅŸä', `${formatCurrency(calc.totalIncome - calc.totalExpenses)} ÿ±ŸäÿßŸÑ`],
  ['ÿ±ÿµŸäÿØ SNB ÿßŸÑŸÖÿ≥ÿ™ÿ≠ŸÇ', `${formatCurrency(calc.snb.balance)} ÿ±ŸäÿßŸÑ`],
  ['ÿ±ÿµŸäÿØ ENBD ÿßŸÑŸÖÿ≥ÿ™ÿ≠ŸÇ', `${formatCurrency(calc.enbd.balance)} ÿ±ŸäÿßŸÑ`],
  ],
  headStyles: { halign: 'center', font: 'Helvetica' },
  bodyStyles: { halign: 'right', font: 'Helvetica' }
  });
  doc.text("ÿ¢ÿÆÿ± ÿßŸÑŸÖÿπÿßŸÖŸÑÿßÿ™", 200, doc.autoTable.previous.finalY + 15, null, null, "right");
  var transactionData = state.transactions.slice(0, 15).map(function(t) {
  var category = findCategoryById(t.categoryId);
  var categoryName = category ? category.name : '-';
  var description = t.description ? t.description.substring(0, 20) : '-';
  return [
  t.date,
  getPaymentMethodName(t.paymentMethod),
  getTransactionTypeName(t.type),
  formatCurrency(t.amount),
  categoryName,
  description
  ]
  });
  doc.autoTable({
  startY: doc.autoTable.previous.finalY + 20,
  head: [['ÿßŸÑÿ™ÿßÿ±ŸäÿÆ', 'ÿßŸÑŸàÿ≥ŸäŸÑÿ©', 'ÿßŸÑŸÜŸàÿπ', 'ÿßŸÑŸÖÿ®ŸÑÿ∫', 'ÿßŸÑŸÅÿ¶ÿ©', 'ÿßŸÑŸàÿµŸÅ']],
  body: transactionData,
  styles: { font: 'Helvetica' },
  headStyles: { halign: 'center' },
  bodyStyles: { halign: 'right' }
  });
  doc.save("financial_report.pdf");
  }
  
  return { init: init };
  })();
  
  document.addEventListener('DOMContentLoaded', function() {
  ExpenseApp.init();
  window.app.showTab('summary');
  });
  </script>
  </body>
  </html>



